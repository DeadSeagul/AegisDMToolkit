<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="canonical" href="https://aegis-dm-toolkit.com/" />
    <meta name="description" content="The comprehensive web toolkit for DMs. Features a Combat Tracker, Monster Generator, Loot Splitter, Campaign Manager, and ambient Soundboard for D&D 5e."/>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Aegis DM Toolkit</title>

    <meta name="google-site-verification" content="IwjH6sQ5oT61kp6rc3ptU0EOTJAAo21RS75idfg838g" />
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Aegis DM">

    <meta name="google-site-verification" content="0LFQpDG_-xgwXcXXlgqZlo-4Cs5_Ese6cLBpimp1GdM" />
    
    <script src="https://cdn.tailwindcss.com"></script>

    

    <script async src="https://www.googletagmanager.com/gtag/js?id=G-Q9GJJDR52K"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-Q9GJJDR52K');
</script>

<script>
  // üü¢ HELPER: Send custom events to Google Analytics
  window.sendEvent = function(eventName, params = {}) {
    if (typeof gtag === 'function') {
      gtag('event', eventName, params);
      console.log(`üìä Tracked: ${eventName}`, params);
    } else {
      console.log(`‚ö†Ô∏è Analytics not loaded. Would have tracked: ${eventName}`);
    }
  };
</script>

    <meta name="description" content="A free, all-in-one DM Toolkit for D&D 5e and SW5e. Features a Combat Tracker, Monster Generator, Loot Splitter, and Soundboard. No login required.">
    <meta name="keywords" content="D&D 5e, Dungeon Master Tools, Combat Tracker, NPC Generator, SW5e, Star Wars 5e, Loot Generator, TTRPG, Tabletop">
    <meta name="author" content="Aegis Toolkit">

    <meta property="og:title" content="Aegis DM Toolkit | Free 5e Tools">
    <meta property="og:description" content="Run your sessions faster. Combat tracking, instant NPC stats, and loot generation in one clean dashboard.">
    <meta property="og:image" content="https://i.imgur.com/xnP6b0k.png"> <meta property="og:url" content="https://aegis-dm-toolkit.com">
    <meta property="og:type" content="website">
    <meta name="theme-color" content="#6366f1">

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const svgString = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64" width="180" height="180"><rect width="64" height="64" fill="#1e293b"/><path d="M32 4 L12 14 V30 C12 43 21 54 32 58 C43 54 52 43 52 30 V14 Z" fill="#1f2933" stroke="#f4d28b" stroke-width="2.5" stroke-linejoin="round" /><g><path d="M31 10 L33 10 L33 48 L32 52 L31 48 Z" fill="#cbd5e1" stroke="#94a3b8" stroke-width="1"/><path d="M24 15 L40 15 L40 18 L24 18 Z" fill="#f4d28b" stroke="#b45309" stroke-width="1"/><path d="M31 2 L33 2 L33 10 L31 10 Z" fill="#8b4513" stroke="#f4d28b" stroke-width="1"/><circle cx="32" cy="2" r="2.5" fill="#f4d28b" stroke="#b45309" stroke-width="1"/></g><polygon points="32,18 24,24 24,34 32,40 40,34 40,24" fill="#8b4513" stroke="#f4d28b" stroke-width="1.5" stroke-linejoin="round" /><text x="32" y="30" text-anchor="middle" font-size="8" fill="#f9f9f9" font-family="system-ui, sans-serif">20</text></svg>`;
            const canvas = document.createElement('canvas'); canvas.width = 180; canvas.height = 180;
            const ctx = canvas.getContext('2d'); const img = new Image();
            img.src = 'data:image/svg+xml;base64,' + btoa(svgString);
            img.onload = function() { ctx.drawImage(img, 0, 0); const link = document.createElement('link'); link.rel = 'apple-touch-icon'; link.href = canvas.toDataURL('image/png'); document.head.appendChild(link); const fav = document.createElement('link'); fav.rel = 'icon'; fav.href = canvas.toDataURL('image/png'); document.head.appendChild(fav); };
        });
    </script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@700&family=IM+Fell+English+SC&display=swap" rel="stylesheet">

    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
<script type="text/javascript">
   (function(){
      // PASTE YOUR PUBLIC KEY HERE
      emailjs.init("d8xFKgE8_MNF8Y3B4");
   })();
</script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Libre+Baskerville:wght@400;700&display=swap');

       
/* üëë PRO MASTER THEME & BACKGROUND FIX */
:root {
    --pro-bg: #030712;    /* Master Background */
    --pro-card: #111827;  /* Card Background */
    --pro-accent: #4f46e5;
    --pro-text: #f3f4f6;
}

/* Kill white flashes globally */
html, body, .min-h-screen {
    background-color: var(--pro-bg) !important;
    color: var(--pro-text) !important;
    margin: 0;
    min-height: 100vh;
}

/* Force dark theme on standard utility classes */
.bg-white, .bg-gray-50, .bg-slate-50, .bg-gray-100 {
    background-color: var(--pro-bg) !important;
}

/* Themed Cards & Panels */
.card, .tab-content, .bg-gray-900, .bg-gray-800 {
    background-color: var(--pro-card) !important;
    border-color: rgba(255, 255, 255, 0.05) !important;
}

/* üü¢ PRO FEATURE: Modern Note Grid Design */
#notes-list-container.pro-grid-view {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 1.25rem;
}

/* üü¢ PRO FEATURE: Ad-Removal Killswitch */
body.pro-theme #gear-sidebar, 
body.pro-theme .ad-banner,
body.pro-theme [id*="google_ads"] {
    display: none !important;
}

        /* üü¢ PARCHMENT CARD STYLES üü¢ */
        .parchment-card {
            background-color: #f4e4bc;
            background-image: url('https://www.transparenttextures.com/patterns/aged-paper.png');
            border: 8px solid transparent;
            border-image: url('https://i.imgur.com/xnP6b0k.png') 30 round;
            padding: 2rem;
            text-align: center;
            color: #3e2723;
            font-family: 'IM Fell English SC', serif;
            box-shadow: 0 10px 20px rgba(0,0,0,0.5);
            max-width: 500px;
            margin: 20px auto;
            overflow: hidden; 
        }
        .card-title { font-family: 'Cinzel Decorative', cursive; font-size: 1.8rem; color: #2c1b18; margin-bottom: 1rem; text-transform: uppercase; letter-spacing: 1px; line-height: 1.2; }
        .card-image { display: block; width: 100%; height: auto; max-height: 250px; object-fit: contain; margin: 0.5rem auto 1rem auto; filter: drop-shadow(0px 4px 6px rgba(0,0,0,0.2)); border-radius: 4px; }
        .card-meta-1 { font-weight: bold; font-size: 1rem; margin-top: 0.5rem; border-top: 2px solid #3e2723; padding-top: 0.5rem; display: inline-block; }
        .card-meta-2 { font-weight: bold; font-size: 1.1rem; margin-bottom: 1rem; }
        .card-body { font-size: 1rem; line-height: 1.5; white-space: pre-wrap; text-align: left; padding: 0 1rem; }

        /* Existing Styles */
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #f8fafc; transition: background-color 0.5s, color 0.5s; }
        .tab-button.active { border-bottom: 3px solid #6366f1; color: #c7d2fe; }
        .sub-tab-button.active { border-bottom: 2px solid #34d399; color: #34d399; }
        .card { background-color: #1e293b; border: 1px solid #334155; transition: background-color 0.5s, border-color 0.5s; }
        .input-style { background-color: #334155; border: 1px solid #475569; color: #f8fafc; }
        .glow-shadow { box-shadow: 0 0 10px rgba(99, 102, 241, 0.5); }

        /* Christmas Mode */
        body.christmas-mode { background-color: #0b291b !important; color: #fef3c7; }
        body.christmas-mode .card { background-color: #2f0a0a; border-color: #b45309; box-shadow: 0 4px 6px -1px rgba(220, 38, 38, 0.2); position: relative; overflow: visible; margin-top: 25px; border-top: none; }
        body.christmas-mode .card::before { content: ""; position: absolute; top: -12px; left: -1px; right: -1px; height: 15px; background-color: #f1f5f9; border-radius: 10px 10px 4px 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); z-index: 10; border-bottom: 2px solid #e2e8f0; }
        body.christmas-mode .card::after { content: ""; position: absolute; top: -25px; right: 20px; width: 10px; height: 25px; background: repeating-linear-gradient(45deg, #dc2626, #dc2626 4px, #ffffff 4px, #ffffff 8px); border-radius: 4px 4px 0 0; transform: rotate(15deg); box-shadow: -2px 2px 2px rgba(0,0,0,0.3), -15px 5px 0 -1px rgba(0,0,0,0.2), -20px 2px 0 0 #ffffff; z-index: 0; }
        body.christmas-mode .input-style { background-color: #451a1a; border-color: #7f1d1d; color: #fef3c7; }
        body.christmas-mode .tab-button.active { border-bottom-color: #ef4444; color: #fca5a5; }
        body.christmas-mode .tab-button:not(.active) { color: #b45309; }
        body.christmas-mode h1 span { filter: hue-rotate(140deg) brightness(1.2); }

        /* Utils */
        #snow-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: -1; }
        .scrollable-content { max-height: 60vh; overflow-y: auto; }
        .scrollable-content::-webkit-scrollbar { width: 8px; }
        .scrollable-content::-webkit-scrollbar-track { background: #1e293b; }
        .scrollable-content::-webkit-scrollbar-thumb { background-color: #475569; border-radius: 20px; border: 2px solid #1e293b; }
        .loading-spinner { border: 4px solid rgba(255, 255, 255, 0.3); border-top: 4px solid #fff; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .collapsible-header { cursor: pointer; display: flex; justify-content: space-between; align-items: center; padding: 10px; background-color: #334155; border-radius: 8px; }
        .collapsible-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; padding: 0 10px; }
        .collapsible-content.expanded { max-height: 8000px; padding: 10px; }
        .arrow-icon { transition: transform 0.3s ease; }
        .expanded .arrow-icon { transform: rotate(90deg); }
        .sound-btn { transition: all 0.1s ease; }
        .sound-btn:active { transform: scale(0.95); }
        .sound-btn.active-loop { border-color: #34d399; background-color: #059669; box-shadow: 0 0 15px #34d399; animation: pulse-green 2s infinite; }
        @keyframes pulse-green { 0% { box-shadow: 0 0 0 0 rgba(52, 211, 153, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(52, 211, 153, 0); } 100% { box-shadow: 0 0 0 0 rgba(52, 211, 153, 0); } }
        input[type=range] { -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%; background: #34d399; cursor: pointer; margin-top: -6px; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: #475569; border-radius: 2px; }
        
        /* D&D Statblock */
        .dnd-statblock { background-color: #fdf1dc; color: #58180d; font-family: 'Libre Baskerville', serif; padding: 15px; border: 1px solid #d4b57e; box-shadow: 0 0 15px rgba(0,0,0,0.3); position: relative; }
        .dnd-statblock::before, .dnd-statblock::after { content: ""; display: block; height: 4px; background: #e69a28; margin: 4px 0; border-radius: 2px; }
        .dnd-header { font-family: 'Libre Baskerville', serif; font-variant: small-caps; font-weight: 700; color: #58180d; font-size: 1.5em; line-height: 1.1; }
        .tapered-rule { display: block; height: 2px; background: #58180d; margin: 10px 0; border: none; background: linear-gradient(to right, transparent, #58180d, transparent); }
        .dnd-property-line { font-size: 0.9rem; line-height: 1.4; margin-bottom: 2px; }
        .dnd-property-line strong { color: #58180d; }
        .dnd-section-title { font-variant: small-caps; font-weight: bold; font-size: 1.2em; color: #58180d; border-bottom: 1px solid #7a200d; margin-top: 10px; margin-bottom: 5px; }
        .dnd-action-name { font-weight: bold; font-style: italic; }

        /* Aegis Logo */
        .aegis-logo { display: inline-flex; align-items: center; gap: 0.4rem; font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; color: #e2e8f0; }
        .aegis-icon { width: 48px; height: 48px; }
        .aegis-text { display: flex; flex-direction: column; line-height: 1.1; }
        .aegis-title { font-size: 1.2rem; font-weight: 700; letter-spacing: 0.06em; text-transform: uppercase; color: #818cf8; }
        .aegis-subtitle { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.16em; opacity: 0.8; color: #cbd5e1; }

        #ad-spotlight {
    transition: all 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}
.ad-active {
    transform: translateY(0) scale(1) !important;
    opacity: 1 !important;
}

/* Base Button Styling */
.system-btn {
    border: 1px solid #4f46e5;
    background: rgba(79, 70, 229, 0.1);
    color: #a5b4fc;
}

/* --- üöÄ MASTER SW5E SYSTEM STYLES --- */
body.sw5e-mode {
    --bg-main: #020b14;
    --card-bg: #0b1929;
    --accent: #00d2ff;
    --text-highlight: #39ff14;
}

body.sw5e-mode .card {
    background-color: var(--card-bg);
    border-color: var(--accent);
    box-shadow: 0 0 10px rgba(0, 210, 255, 0.2);
}

body.sw5e-mode .system-btn {
    border-color: #00d2ff;
    background: rgba(0, 210, 250, 0.1);
    color: #00d2ff;
    box-shadow: 0 0 10px rgba(0, 210, 255, 0.3);
}

/* --- üõ∞Ô∏è FUTURISTIC HOLONET STATBLOCK --- */
.sw5e-mode .stat-block {
    /* 1. Reset Parchment & Apply Tech Background */
    background-color: #020810 !important;
    background-image: 
        linear-gradient(rgba(0, 255, 255, 0.05) 1px, transparent 1px),
        linear-gradient(90deg, rgba(0, 255, 255, 0.05) 1px, transparent 1px) !important;
    background-size: 20px 20px !important; 
    border: 2px solid #00ffff !important;
    border-radius: 0px !important; 
    box-shadow: 0 0 20px rgba(0, 255, 255, 0.2), inset 0 0 15px rgba(0, 255, 255, 0.1) !important;
    color: #00ffff !important;
    font-family: 'Share Tech Mono', 'Courier New', monospace !important;
    padding: 24px !important;
    position: relative;
    overflow: hidden;
}

/* 2. Scanning Line Animation */
.sw5e-mode .stat-block::after {
    content: "";
    position: absolute;
    top: 0; left: 0; width: 100%; height: 2px;
    background: linear-gradient(90deg, transparent, rgba(0, 255, 255, 0.5), transparent);
    animation: scanline 4s linear infinite;
    pointer-events: none;
}

@keyframes scanline {
    0% { transform: translateY(-100%); }
    100% { transform: translateY(1000%); }
}

/* 3. Header & Text Styling */
.sw5e-mode .stat-header h2 {
    color: #00ffff !important;
    text-transform: uppercase !important;
    letter-spacing: 3px !important;
    border-bottom: 2px solid #00ffff !important;
    text-shadow: 0 0 10px rgba(0, 255, 255, 0.5) !important;
}

.sw5e-mode .ability-score {
    background: rgba(0, 255, 255, 0.1) !important;
    border: 1px solid #00ffff !important;
    border-radius: 0px !important;
    color: #00ffff !important;
}

.sw5e-mode .stat-property-label {
    color: #ffaa00 !important; /* Amber for technical readout */
    font-weight: bold !important;
    text-transform: uppercase !important;
    font-size: 0.75rem !important;
}

.sw5e-mode hr {
    border-color: #004444 !important;
    opacity: 0.5 !important;
}

/* Import Futuristic Fonts */
@import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Share+Tech+Mono&display=swap');

/* Default Header Style (D&D) */
#site-title {
    transition: all 0.5s ease;
    font-family: 'Cinzel Decorative', cursive; /* Your existing D&D font */
}

/* üöÄ SW5E NEON LIGHTSABER STYLE */
.sw5e-mode #site-title {
    font-family: 'Orbitron', sans-serif !important;
    letter-spacing: 5px;
    color: #fff !important;
    /* Neon Blue Lightsaber Glow */
    text-shadow: 
        0 0 5px #fff, 
        0 0 10px #fff, 
        0 0 20px #00ffff, 
        0 0 30px #00ffff, 
        0 0 40px #00ffff, 
        0 0 55px #00ffff, 
        0 0 75px #00ffff !important;
    animation: lightsaber-flicker 2s infinite alternate;
}

/* Subtle flicker to make it look like a humming blade */
@keyframes lightsaber-flicker {
    0%, 100% { opacity: 1; }
    92% { opacity: 0.95; }
    96% { opacity: 1; }
    98% { opacity: 0.9; }
}

/* Target only the AEGIS span */
#aegis-text {
    transition: all 0.5s ease;
}

/* Lightsaber look for AEGIS only */
.sw5e-mode #aegis-text {
    font-family: 'Orbitron', sans-serif !important;
    color: #fff !important;
    text-shadow: 
        0 0 5px #fff, 
        0 0 10px #fff, 
        0 0 20px #00ffff, 
        0 0 40px #00ffff !important;
    animation: lightsaber-flicker 2s infinite alternate;
}

/* Base style for the Aegis part */
.aegis-title {
    transition: all 0.5s ease;
}

/* üöÄ NEON LIGHTSABER IGNITION */
.sw5e-mode .aegis-title {
    font-family: 'Orbitron', sans-serif !important;
    color: #fff !important;
    /* Electric Cyan Glow */
    text-shadow: 
        0 0 5px #fff, 
        0 0 10px #fff, 
        0 0 20px #00ffff, 
        0 0 30px #00ffff, 
        0 0 40px #00ffff !important;
    letter-spacing: 2px;
    animation: lightsaber-hum 2s infinite alternate;
}

/* Subtle hum flicker */
@keyframes lightsaber-hum {
    0% { opacity: 1; text-shadow: 0 0 20px #00ffff, 0 0 40px #00ffff; }
    100% { opacity: 0.9; text-shadow: 0 0 15px #00ffff, 0 0 30px #00ffff; }
}

/* Optional: Make the subtitle look like terminal text */
.sw5e-mode .aegis-subtitle {
    color: #00ffff !important;
    opacity: 0.7;
    font-family: 'Share Tech Mono', monospace !important;
}

/* High-Contrast Sci-Fi Text */
.sw5e-mode .neon-text {
    color: #e0ffff !important; /* Very bright Cyan-White */
    text-shadow: 0 0 8px rgba(0, 255, 255, 0.4);
    font-family: 'Share Tech Mono', monospace;
    font-size: 0.95rem;
    line-height: 1.4;
}

.sw5e-mode .neon-label {
    color: #ffcc00 !important; /* Bright Amber for Action Names */
    font-weight: 900;
    text-transform: uppercase;
    letter-spacing: 1px;
}

/* Ensure the container doesn't darken the children */
.sw5e-mode .stat-block div {
    color: inherit;
}

.art-placeholder {
    width: 100%;
    aspect-ratio: 4 / 3;
    background: #0f172a;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    border: 1px solid #334155;
    position: relative;
    overflow: hidden;
}

.art-placeholder::after {
    content: "SIGNAL LOST";
    font-family: 'Share Tech Mono', monospace;
    color: #ef4444;
    font-size: 10px;
    letter-spacing: 2px;
    font-weight: bold;
    z-index: 2;
}

/* Optional: Animated Scanline for the placeholder */
.art-placeholder::before {
    content: "";
    position: absolute;
    top: 0; left: 0; width: 100%; height: 2px;
    background: rgba(255, 255, 255, 0.05);
    animation: scanline 3s linear infinite;
}

/* Push main content down to make room for the fixed top bar */
body { 
    padding-top: 4.5rem !important; 
}

/* Custom Scrollbar for the Drawer */
.custom-scrollbar::-webkit-scrollbar { width: 4px; }
.custom-scrollbar::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }

/* üõë PREVENT IMAGE DRAGGING */
img {
    -webkit-user-drag: none;
    -khtml-user-drag: none;
    -moz-user-drag: none;
    -o-user-drag: none;
    user-drag: none;
    user-select: none; /* Prevents highlighting */
}

/* Ensure Canvas handles interactions */
canvas {
    touch-action: none; /* Fixes touch/scroll issues */
}
        
    </style>
</head>
<body class="p-4 sm:p-8">
    
    <div class="max-w-4xl mx-auto">
        <!-- Header -->
        <div class="flex flex-col md:flex-row justify-between items-center mb-6 bg-gray-800 p-3 rounded-lg border border-gray-700 shadow-lg gap-4 md:gap-0">
            <div class="flex items-center">
    <h1 class="aegis-logo">
      <svg class="aegis-icon" viewBox="0 0 64 64" aria-hidden="true">
        <path
          d="M32 4 L12 14 V30 C12 43 21 54 32 58 C43 54 52 43 52 30 V14 Z"
          fill="#1f2933"
          stroke="#f4d28b"
          stroke-width="2.5"
          stroke-linejoin="round"
        />
        ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬†¬†
        <g>
          <path d="M31 10 L33 10 L33 48 L32 52 L31 48 Z" fill="#cbd5e1" stroke="#94a3b8" stroke-width="1"/>
          <path d="M24 15 L40 15 L40 18 L24 18 Z" fill="#f4d28b" stroke="#b45309" stroke-width="1"/>
          <path d="M31 2 L33 2 L33 10 L31 10 Z" fill="#8b4513" stroke="#f4d28b" stroke-width="1"/>
          <circle cx="32" cy="2" r="2.5" fill="#f4d28b" stroke="#b45309" stroke-width="1"/>
        </g>

        <polygon
          points="32,18 24,24 24,34 32,40 40,34 40,24"
          fill="#8b4513"
          stroke="#f4d28b"
          stroke-width="1.5"
          stroke-linejoin="round"
        />
        ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬†¬†
        <text
          x="32"
          y="30"
          text-anchor="middle"
          font-size="8"
          fill="#f9f9f9"
          font-family="system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif"
        >
          20
        </text>
      </svg>

      <div class="aegis-text">
        <span class="aegis-title">Aegis</span>
        <span class="aegis-subtitle flex items-center gap-1">
            DM Toolkit
            <span id="pro-header-crown" class="hidden text-yellow-500 text-sm animate-pulse" title="Warlord Active">üëë</span>
        </span>
      </div>
    </h1>
</div>

<div class="flex flex-wrap justify-center md:justify-end items-center gap-1.5 w-full md:w-auto">
    
    <div class="flex items-center gap-1 bg-gray-800/50 px-2 py-1 rounded-full border border-gray-600/50 backdrop-blur-sm">
        <span class="text-[9px] uppercase font-bold text-gray-400 hidden lg:inline tracking-wider">Campaign:</span>
        <select id="campaign-selector" 
                class="bg-transparent text-emerald-400 font-bold text-xs outline-none cursor-pointer hover:text-emerald-300 transition w-24 border-none p-0 focus:ring-0"
                onchange="window.switchCampaign(this.value)">
        </select>
        <button onclick="window.createNewCampaign()" class="text-gray-500 hover:text-white leading-none text-sm px-1 border-l border-gray-600 transition" title="New">+</button>
        <button onclick="window.deleteCurrentCampaign()" class="text-red-900 hover:text-red-500 leading-none text-xs px-1 border-l border-gray-600 transition" title="Delete">üóëÔ∏è</button>
    </div>

    <button onclick="window.toggleSystem()" id="system-toggle" 
        class="bg-blue-900/60 border border-blue-400 text-blue-200 px-2 py-1 rounded text-[10px] font-bold whitespace-nowrap transition-colors hover:bg-blue-800">
        üöÄ SW5e
    </button>

    
    
    <button onclick="document.getElementById('share-modal').classList.remove('hidden')" class="p-1 hover:bg-gray-700 rounded-lg transition text-gray-400 hover:text-white" title="Share App">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"></path></svg>
    </button>

    <a href="https://ko-fi.com/aegisdmtool" target="_blank" class="bg-yellow-600/20 hover:bg-yellow-600/40 text-yellow-200 border border-yellow-600/50 text-[10px] font-bold py-1.5 px-2 rounded-lg transition no-underline flex items-center gap-1">
        <span>‚òï</span> <span class="hidden sm:inline">Tip</span>
    </a>

    <div class="flex items-center">
        <button id="login-btn" onclick="window.openLoginModal()" class="bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-1.5 px-3 rounded-lg text-[11px] flex items-center gap-1 transition border border-indigo-400">
            <svg class="w-3 h-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
            Login
        </button>
        <div id="user-profile" class="hidden flex items-center gap-2">
            <img id="user-avatar" src="" class="w-7 h-7 rounded-full border border-indigo-500">
            <button onclick="logoutUser()" class="text-[10px] text-red-400 px-1">Sign Out</button>
        </div>
        <button onclick="window.openSettings()" class="text-gray-400 hover:text-white px-3 transition-colors" title="Settings">
    ‚öôÔ∏è
</button>
    </div>
</div>
        </div>
        
        <!-- Nav -->
        <div class="fixed top-0 left-0 right-0 z-[100] bg-gray-900/90 backdrop-blur-xl border-b border-gray-700 px-4 py-2 flex justify-between items-center h-14">
    <div class="flex items-center gap-4">
        <button onclick="window.toggleDrawer()" class="p-2 hover:bg-gray-800 rounded-lg transition-colors group">
            <div class="w-6 h-0.5 bg-cyan-400 mb-1.5 transition-all group-hover:w-4"></div>
            <div class="w-6 h-0.5 bg-cyan-400 mb-1.5"></div>
            <div class="w-6 h-0.5 bg-cyan-400 transition-all group-hover:w-5"></div>
        </button>
        <span onclick="switchTab('home')" class="text-xs font-bold uppercase tracking-widest text-indigo-300 cursor-pointer hover:text-cyan-400 transition-colors select-none">
    Aegis Toolkit
</span>
    </div>
    <div id="active-tab-indicator" class="text-[10px] font-black uppercase text-cyan-500 tracking-tighter bg-cyan-500/10 px-3 py-1 rounded-full border border-cyan-500/30">
        üîÆ Prep Mode
    </div>
</div>

<div id="side-drawer" class="fixed inset-y-0 left-0 w-72 bg-gray-900 border-r border-gray-700 shadow-2xl transform -translate-x-full transition-transform duration-300 ease-in-out z-[200] flex flex-col">
    <div class="p-6 border-b border-gray-800 bg-black/20">
        <h2 class="text-2xl font-black text-white italic tracking-tighter">AEGIS <span class="text-cyan-500">DM</span></h2>
        <p class="text-[10px] text-gray-500 uppercase tracking-widest mt-1">Dungeon Master Command</p>
    </div>

    <nav class="flex-1 overflow-y-auto p-4 space-y-2 custom-scrollbar pb-32">
        <p class="text-[9px] font-bold text-gray-600 uppercase mb-2 ml-2">Campaign Tools</p>

        <nav class="flex-1 overflow-y-auto p-4 space-y-2 no-scrollbar">

            
        
        <button onclick="window.navTo('home', 'Home Dashboard')" id="nav-home" class="w-full mb-4 px-4 py-3 bg-gray-800 hover:bg-gray-700 rounded-lg text-white font-bold transition-all border border-gray-700 hover:border-teal-400 flex items-center justify-center gap-2 shadow-lg">
            <span>üè†</span> <span>Home Dashboard</span>
        </button>

       <div class="mt-auto pt-4 border-t border-gray-800">
    <button onclick="document.getElementById('pro-modal').classList.remove('hidden')" class="w-full group relative overflow-hidden rounded-lg bg-gradient-to-r from-yellow-600 to-amber-500 p-3 text-center shadow-lg transition-transform hover:scale-105">
        <div class="relative z-10 flex items-center justify-center gap-2 font-black text-black uppercase tracking-widest text-xs">
            <span>üëë</span> Upgrade to Pro
        </div>
        <div class="absolute inset-0 -translate-x-full bg-gradient-to-r from-transparent via-white/30 to-transparent transition-transform duration-1000 group-hover:translate-x-full"></div>
    </button>
</div>

        
        <div class="flex items-center gap-1 group">

            <button onclick="window.navTo('improv', 'üîÆ Prep')" class="drawer-btn flex-1 text-left p-3 rounded-l-lg hover:bg-indigo-600/20 text-indigo-200 transition flex items-center gap-3">
                <span>üîÆ</span> <span class="font-bold text-sm">Prep</span>
            </button>
            <button onclick="window.togglePin('improv', 'üîÆ Prep')" class="p-3 bg-gray-800/30 hover:bg-gray-700 rounded-r-lg text-gray-500 hover:text-yellow-400 transition text-xs">üìå</button>
        </div>

        <div class="flex items-center gap-1 group">
            <button onclick="window.navTo('combat', '‚öîÔ∏è Combat')" class="drawer-btn flex-1 text-left p-3 rounded-l-lg hover:bg-red-600/20 text-red-200 transition flex items-center gap-3">
                <span>‚öîÔ∏è</span> <span class="font-bold text-sm">Combat</span>
            </button>
            <button onclick="window.togglePin('combat', '‚öîÔ∏è Combat')" class="p-3 bg-gray-800/30 hover:bg-gray-700 rounded-r-lg text-gray-500 hover:text-yellow-400 transition text-xs">üìå</button>
        </div>

        <div class="flex items-center gap-1 group">
            <button onclick="window.navTo('statblocks', 'üëπ Stats')" class="drawer-btn flex-1 text-left p-3 rounded-l-lg hover:bg-yellow-600/20 text-yellow-200 transition flex items-center gap-3">
                <span>üëπ</span> <span class="font-bold text-sm">NPC Stats</span>
            </button>
            <button onclick="window.togglePin('statblocks', 'üëπ Stats')" class="p-3 bg-gray-800/30 hover:bg-gray-700 rounded-r-lg text-gray-500 hover:text-yellow-400 transition text-xs">üìå</button>
        </div>

        <div class="flex items-center gap-1 group">
            <button onclick="window.navTo('monsters', 'üê≤ Monsters')" class="drawer-btn flex-1 text-left p-3 rounded-l-lg hover:bg-emerald-600/20 text-emerald-200 transition flex items-center gap-3">
                <span>üê≤</span> <span class="font-bold text-sm">Monsters</span>
            </button>
            <button onclick="window.togglePin('monsters', 'üê≤ Monsters')" class="p-3 bg-gray-800/30 hover:bg-gray-700 rounded-r-lg text-gray-500 hover:text-yellow-400 transition text-xs">üìå</button>
        </div>

        <div class="flex items-center gap-1 group">
            <button onclick="window.navTo('loot', 'üí∞ Loot')" class="drawer-btn flex-1 text-left p-3 rounded-l-lg hover:bg-amber-600/20 text-amber-200 transition flex items-center gap-3">
                <span>üí∞</span> <span class="font-bold text-sm">Loot</span>
            </button>
            <button onclick="window.togglePin('loot', 'üí∞ Loot')" class="p-3 bg-gray-800/30 hover:bg-gray-700 rounded-r-lg text-gray-500 hover:text-yellow-400 transition text-xs">üìå</button>
        </div>

        <div class="flex items-center gap-1 group">
            <button onclick="window.navTo('travel', '‚õ∫ Journey')" class="drawer-btn flex-1 text-left p-3 rounded-l-lg hover:bg-green-600/20 text-green-200 transition flex items-center gap-3">
                <span>‚õ∫</span> <span class="font-bold text-sm">Journey</span>
            </button>
            <button onclick="window.togglePin('travel', '‚õ∫ Journey')" class="p-3 bg-gray-800/30 hover:bg-gray-700 rounded-r-lg text-gray-500 hover:text-yellow-400 transition text-xs">üìå</button>
        </div>

        <div class="flex items-center gap-1 group">
            <button onclick="window.navTo('soundboard', 'üîä Sound')" class="drawer-btn flex-1 text-left p-3 rounded-l-lg hover:bg-pink-600/20 text-pink-200 transition flex items-center gap-3">
                <span>üîä</span> <span class="font-bold text-sm">Soundboard</span>
            </button>
            <button onclick="window.togglePin('soundboard', 'üîä Sound')" class="p-3 bg-gray-800/30 hover:bg-gray-700 rounded-r-lg text-gray-500 hover:text-yellow-400 transition text-xs">üìå</button>
        </div>

        <div class="flex items-center gap-1 group">
            <button onclick="window.navTo('gallery-tab', 'üé® Art')" class="drawer-btn flex-1 text-left p-3 rounded-l-lg hover:bg-orange-600/20 text-orange-200 transition flex items-center gap-3">
                <span>üé®</span> <span class="font-bold text-sm">Art Guild</span>
            </button>
            <button onclick="window.togglePin('gallery-tab', 'üé® Art')" class="p-3 bg-gray-800/30 hover:bg-gray-700 rounded-r-lg text-gray-500 hover:text-yellow-400 transition text-xs">üìå</button>
        </div>

        <div class="flex items-center gap-1 group">
            <button onclick="window.navTo('notes', 'üìú Notes')" class="drawer-btn flex-1 text-left p-3 rounded-l-lg hover:bg-cyan-600/20 text-cyan-200 transition flex items-center gap-3">
                <span>üìú</span> <span class="font-bold text-sm">Notes & Lore</span>
            </button>
            <button onclick="window.togglePin('notes', 'üìú Notes')" class="p-3 bg-gray-800/30 hover:bg-gray-700 rounded-r-lg text-gray-500 hover:text-yellow-400 transition text-xs">üìå</button>
        </div>

        <div class="flex items-center gap-1 group">
            <button onclick="window.navTo('maps', 'üó∫Ô∏è Maps')" class="drawer-btn flex-1 text-left p-3 rounded-l-lg hover:bg-teal-600/20 text-teal-200 transition flex items-center gap-3">
                <span>üó∫Ô∏è</span> <span class="font-bold text-sm">Maps</span>
            </button>
            <button onclick="window.togglePin('maps', 'üó∫Ô∏è Maps')" class="p-3 bg-gray-800/30 hover:bg-gray-700 rounded-r-lg text-gray-500 hover:text-yellow-400 transition text-xs">üìå</button>
        </div>

        <div class="flex items-center gap-1 group">
            <button onclick="window.navTo('homebrew', 'üç∫ Homebrew')" class="drawer-btn flex-1 text-left p-3 rounded-l-lg hover:bg-blue-600/20 text-blue-200 transition flex items-center gap-3">
                <span>üç∫</span> <span class="font-bold text-sm">Homebrew</span>
            </button>
            <button onclick="window.togglePin('homebrew', 'üç∫ Homebrew')" class="p-3 bg-gray-800/30 hover:bg-gray-700 rounded-r-lg text-gray-500 hover:text-yellow-400 transition text-xs">üìå</button>
        </div>

        <div class="flex items-center gap-1 group">
            <button onclick="window.navTo('rules', 'üìñ Rules')" class="drawer-btn flex-1 text-left p-3 rounded-l-lg hover:bg-purple-600/20 text-purple-200 transition flex items-center gap-3">
                <span>üìñ</span> <span class="font-bold text-sm">Rules</span>
            </button>
            <button onclick="window.togglePin('rules', 'üìñ Rules')" class="p-3 bg-gray-800/30 hover:bg-gray-700 rounded-r-lg text-gray-500 hover:text-yellow-400 transition text-xs">üìå</button>
        </div>

        <div class="flex items-center gap-1 group">
            <button onclick="window.navTo('help', '‚ùì Help')" class="drawer-btn flex-1 text-left p-3 rounded-l-lg hover:bg-gray-600/20 text-gray-200 transition flex items-center gap-3">
                <span>‚ùì</span> <span class="font-bold text-sm">Help</span>
            </button>
            <button onclick="window.togglePin('help', '‚ùì Help')" class="p-3 bg-gray-800/30 hover:bg-gray-700 rounded-r-lg text-gray-500 hover:text-yellow-400 transition text-xs">üìå</button>
        </div>
        
<div class="p-4 border-t border-gray-800 bg-black/40">
    <button id="admin-export-btn" 
            onclick="window.exportNewsletterList()" 
            class="hidden w-full flex items-center justify-center gap-2 bg-amber-600/20 hover:bg-amber-600/40 text-amber-500 border border-amber-600/50 text-[10px] font-bold py-3 rounded-lg transition-all uppercase tracking-[0.2em] mt-2">
        <span>üìú</span> Export Raven Scrolls
    </button>
</div>

    </nav>
</div>

<div id="drawer-overlay" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[150] hidden opacity-0 transition-opacity duration-300" onclick="window.toggleDrawer()"></div>

<div id="pinned-tabs-bar" class="hidden flex flex-wrap items-center justify-between gap-2 px-6 py-2 bg-gray-900/80 border-b border-gray-800 backdrop-blur-md sticky top-14 z-[40]">
    <div id="pinned-container" class="flex flex-wrap gap-2">
        </div>
    
    <button onclick="window.clearAllPins()" class="text-[9px] font-black text-red-500/60 hover:text-red-400 uppercase tracking-tighter transition-colors">
        üóëÔ∏è Reset Pins
    </button>
</div>

        <!-- Content -->
        <div id="content-area">

<div id="tab-home" class="tab-section hidden p-6 max-w-6xl mx-auto animate-fade-in">
    
    <div class="text-center mb-10">
        <h1 class="text-5xl font-black text-transparent bg-clip-text bg-gradient-to-r from-teal-400 to-blue-500 mb-2">
            AEGIS TOOLKIT
        </h1>
        <p class="text-gray-400">Session Status: <span id="home-connection-status" class="text-green-400 font-bold">Online</span></p>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-12">
        
        <button onclick="switchTab('combat')" class="p-6 bg-gray-800 border border-gray-700 rounded-xl hover:border-red-500 hover:bg-gray-750 transition-all group text-left">
            <div class="text-3xl mb-2 group-hover:scale-110 transition-transform">‚öîÔ∏è</div>
            <h3 class="font-bold text-white text-lg">Run Combat</h3>
            <p class="text-xs text-gray-400 mt-1">Track Initiative, HP, and Conditions.</p>
        </button>

        <button onclick="switchTab('combat'); if(window.toggleVTTMode) window.toggleVTTMode();" class="p-6 bg-gray-800 border border-gray-700 rounded-xl hover:border-blue-500 hover:bg-gray-750 transition-all group text-left">
            <div class="text-3xl mb-2 group-hover:scale-110 transition-transform">üó∫Ô∏è</div>
            <h3 class="font-bold text-white text-lg">Virtual Tabletop</h3>
            <p class="text-xs text-gray-400 mt-1">Send tactical maps to player phones.</p>
        </button>

        <button onclick="switchTab('soundboard')" class="p-6 bg-gray-800 border border-gray-700 rounded-xl hover:border-purple-500 hover:bg-gray-750 transition-all group text-left">
            <div class="text-3xl mb-2 group-hover:scale-110 transition-transform">üîä</div>
            <h3 class="font-bold text-white text-lg">DJ Soundboard</h3>
            <p class="text-xs text-gray-400 mt-1">Ambiance for Taverns, Dungeons & Cities.</p>
        </button>

        <button onclick="switchTab('improv')" class="p-6 bg-gray-800 border border-gray-700 rounded-xl hover:border-yellow-500 hover:bg-gray-750 transition-all group text-left">
            <div class="text-3xl mb-2 group-hover:scale-110 transition-transform">üé≤</div>
            <h3 class="font-bold text-white text-lg">Improv Tools</h3>
            <p class="text-xs text-gray-400 mt-1">Loot, NPCs, and Dice Physics.</p>
        </button>

        <button onclick="switchTab('help')" class="p-6 bg-gray-800 border border-gray-700 rounded-xl hover:border-cyan-500 hover:bg-gray-750 transition-all group text-left">
            <div class="text-3xl mb-2 group-hover:scale-110 transition-transform">‚ùì</div>
            <h3 class="font-bold text-white text-lg">Help & Manual</h3>
            <p class="text-xs text-gray-400 mt-1">Tutorials, Formatting Guides & Tips.</p>
        </button>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        
        
        </div>

        <div class="bg-gray-800/50 border border-gray-700 rounded-xl p-6">
            <h2 class="text-xl font-bold text-orange-400 mb-4">üì¢ System Updates</h2>
            <ul class="space-y-3 text-sm text-gray-400">
                <li class="flex gap-2">
                    <span class="text-green-500">‚úî</span>
                    <span><strong>VTT Uplink:</strong> Online & Syncing</span>
                </li>
                <li class="flex gap-2">
                    <span class="text-green-500">‚úî</span>
                    <span><strong>Dice Engine:</strong> 3D Physics Active</span>
                </li>
                <li class="flex gap-2">
                    <span class="text-green-500">‚úî</span>
                    <span><strong>Audio:</strong> Mobile Audio Unlocked</span>
                </li>
            </ul>
        </div>
    </div>
</div>

            <!-- Prep Tab -->
            <div id="improv" class="tab-content">

                <!-- Combat NPC Stats -->
                <div class="card p-4 rounded-lg shadow-xl mb-6 bg-gray-900 border border-gray-700">
    <h2 id="prep-npc-title" class="text-xl font-semibold mb-4 text-green-300">Combat NPC Stats</h2>
    
    <div class="grid grid-cols-12 gap-3 mb-4">
        <div class="col-span-3">
            <label class="block text-xs font-medium text-gray-400 mb-1">Level/CR</label>
            <input type="number" id="npc-level" value="3" class="w-full p-2 rounded-lg input-style text-sm bg-gray-800 text-white border border-gray-600 outline-none focus:border-green-500">
        </div>


        <div class="col-span-4">
            <label class="block text-xs font-medium text-gray-400 mb-1">Class</label>
            <select id="npc-spell-class" class="w-full p-2 rounded-lg text-xs bg-gray-800 text-white border border-gray-600 outline-none focus:border-green-500 cursor-pointer">
    <option value="">- None (Generic) -</option>
    <optgroup label="Martial Classes">
        <option value="barbarian">Barbarian</option>
        <option value="fighter">Fighter</option>
        <option value="monk">Monk</option>
        <option value="rogue">Rogue</option>
    </optgroup>
    <optgroup label="Half-Casters">
        <option value="paladin">Paladin</option>
        <option value="ranger">Ranger</option>
        <option value="artificer">Artificer</option>
        <option value="blood hunter">Blood Hunter</option>
    </optgroup>
    <optgroup label="Full Casters">
        <option value="bard">Bard</option>
        <option value="cleric">Cleric</option>
        <option value="druid">Druid</option>
        <option value="sorcerer">Sorcerer</option>
        <option value="warlock">Warlock</option>
        <option value="wizard">Wizard</option>
    </optgroup>
    <optgroup label="Subclasses">
        <option value="eldritch knight">Fighter (Eldritch Knight)</option>
        <option value="arcane trickster">Rogue (Arcane Trickster)</option>
    </optgroup>
</select>
        </div>
    </div>

    <button onclick="window.generateCombatNpc()" id="generate-combat-button" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 rounded-lg flex items-center justify-center transition transform active:scale-95 mb-3">
        <span>Generate Stats</span>
        <div id="combat-loading-spinner" class="ml-2 hidden w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
    </button>

    <div id="combat-status-message" class="hidden p-3 bg-black/40 rounded border border-gray-700 text-sm text-gray-300 animate-fade-in">
        </div>
</div>

<div class="card p-4 rounded-lg shadow-xl mb-6">
    <h2 id="name-gen-title" class="text-xl font-semibold mb-4 text-pink-300">Name Generator</h2>
    <div class="flex gap-2 mb-4">
       <select id="name-race" class="flex-1 p-2 rounded-lg input-style text-sm">
            <option value="Human" id="race-1">Human</option>
            <option value="Elf" id="race-2">Elf</option>
            <option value="Dwarf" id="race-3">Dwarf</option>
            <option value="Orc" id="race-4">Orc/Half-Orc</option>
            <option value="Halfling" id="race-5">Halfling</option>
            <option value="Tiefling" id="race-6">Tiefling</option>
            <option value="Dragonborn" id="race-7">Dragonborn</option>
            <option value="Gnome" id="race-8">Gnome</option>
            <option value="Goblin" id="race-9">Goblin</option>
            <option value="Tabaxi" id="race-10">Tabaxi (Catfolk)</option>
            <option value="Kenku" id="race-11">Kenku</option>
            <option value="Genasi" id="race-12">Genasi</option>
        </select>
        <select id="name-gender" class="w-24 p-2 rounded-lg input-style text-sm">
            <option value="male">Male</option>
            <option value="female">Female</option>
        </select>
        <button onclick="window.generateNames()" class="bg-pink-700 hover:bg-pink-600 text-white font-bold px-4 rounded-lg text-sm">Generate</button>
    </div>
    <div id="name-output" class="text-gray-300 text-sm min-h-[2rem] flex flex-col gap-1">
        <p class="text-gray-500 text-xs italic">Select options to generate names.</p>
    </div>
</div>

                <!-- Creative Lore -->
                <div class="card p-4 rounded-lg shadow-xl mb-6">
                    <h2 class="text-xl font-semibold mb-4 text-indigo-300">Creative Lore</h2>
                    <textarea id="improv-prompt" rows="3" class="w-full p-3 rounded-lg input-style resize-none" placeholder="Enter a prompt..."></textarea>
                    <button onclick="window.generateCreativeIdea()" id="generate-button" class="mt-4 w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 rounded-lg flex items-center justify-center"><span id="generate-text">Generate Idea</span><div id="creative-loading-spinner" class="loading-spinner ml-2 hidden"></div></button>
                </div>

                <!-- Settlement Generator -->
                <div class="card p-4 rounded-lg shadow-xl mb-6">
                    <h2 class="text-xl font-semibold mb-4 text-teal-300">Settlement Generator</h2>
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div><label class="block text-xs font-medium text-gray-400 mb-1">Type</label><select id="settlement-type" class="w-full p-2 rounded-lg input-style text-sm"><option value="Village">Village</option><option value="Town">Town</option><option value="City">City</option></select></div>
                        <div><label class="block text-xs font-medium text-gray-400 mb-1">Vibe</label><input type="text" id="settlement-vibe" value="haunted fishing village" class="w-full p-2 rounded-lg input-style text-sm"></div>
                    </div>
                    <button onclick="window.generateSettlement()" id="generate-settlement-button" class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 rounded-lg flex items-center justify-center"><span id="generate-settlement-text">Generate</span><div id="settlement-loading-spinner" class="loading-spinner ml-2 hidden"></div></button>
                </div>
                
                <!-- Result Display Card -->
                <div class="card p-4 rounded-lg shadow-xl">
                    <h2 class="text-xl font-semibold mb-4 text-indigo-300">Result</h2>
                    <div id="ai-image-output" class="mb-4 hidden rounded-lg overflow-hidden shadow-lg"><img id="generated-image" class="w-full h-auto object-cover bg-gray-700/30 min-h-[150px]"><p id="image-loading-status" class="text-center text-gray-400 p-3 bg-gray-800"></p></div>
                    <div id="ai-output" class="whitespace-pre-wrap min-h-[100px] bg-gray-700/30 p-3 rounded-lg text-gray-300">Results appear here.</div>
                    <p id="npc-save-status" class="mt-2 text-sm text-center hidden"></p>
                    <div id="save-options-creative" class="mt-4 hidden">
                        <p class="text-sm text-center text-gray-400 mb-2">Save to:</p>
                        <div class="grid grid-cols-3 gap-2"><button onclick="window.saveGeneratedContent('prepNotes')" class="save-notes-btn bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 rounded-lg text-xs">Notes</button><button onclick="window.saveGeneratedContent('enemyNotes')" class="save-notes-btn bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 rounded-lg text-xs">Enemies</button><button onclick="window.saveGeneratedContent('npcNotes')" class="save-notes-btn bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 rounded-lg text-xs">NPCs</button></div>
                    </div>
                </div>
            </div>

            <!-- Combat Tab -->
           <div id="combat" class="tab-content hidden h-[calc(100vh-140px)]">
    
    <div id="combat-workspace" class="flex h-full w-full bg-[#0b0c10] overflow-hidden relative">
        
        <div id="vtt-viewport" class="w-0 overflow-hidden relative bg-gray-900 border-none flex flex-col transition-all duration-300 select-none">
    
    <div class="absolute top-4 left-4 z-50 flex flex-col gap-2">
    
    <div class="flex flex-row gap-2">
        <button onclick="window.openTokenModal()" class="bg-indigo-600 hover:bg-indigo-500 text-white p-2 rounded-lg shadow-xl border border-indigo-400 font-bold text-xs uppercase tracking-wider flex flex-col items-center gap-1 transition group w-12">
            <span>‚ôüÔ∏è</span><span class="text-[8px]">Token</span>
        </button>

        <button onclick="window.fog.toggleControls()" id="btn-fog-toggle" class="bg-gray-700 hover:bg-gray-600 text-gray-400 hover:text-white p-2 rounded-lg shadow-xl border border-gray-600 font-bold text-xs uppercase tracking-wider flex flex-col items-center gap-1 transition group w-12 relative">
            <span>‚òÅÔ∏è</span><span class="text-[8px]">Fog</span>
            
        </button>

        <button onclick="window.saveCurrentScene()" class="bg-green-700 hover:bg-green-600 text-white p-2 rounded-lg shadow-xl border border-green-500 font-bold text-xs uppercase tracking-wider flex flex-col items-center gap-1 transition group w-12">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path></svg>
            <span class="text-[8px]">Save</span>
        </button>

        <button onclick="window.openSceneSelector()" class="bg-blue-700 hover:bg-blue-600 text-white p-2 rounded-lg shadow-xl border border-blue-500 font-bold text-xs uppercase tracking-wider flex flex-col items-center gap-1 transition group w-12">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
            <span class="text-[8px]">Load</span>
        </button>
    </div>

    <div class="flex flex-row gap-2 bg-gray-900/80 p-1.5 rounded-lg border border-gray-700 backdrop-blur-sm">

    <button id="btn-snap" onclick="window.toggleGridSnap()" class="p-2 rounded hover:bg-white/10 text-gray-400 flex flex-col items-center gap-1 w-10 transition" title="Toggle Snap-to-Grid">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
    </button>

    <input type="number" id="grid-size-input" value="50" oninput="window.renderGrid(); window.updateAllTokenSizes()" class="w-14 bg-black/50 border border-gray-600 rounded text-xs text-center text-white p-1 h-full focus:outline-none focus:border-indigo-500" title="Grid Size (px)">

    <button id="btn-grid-vis" onclick="window.toggleGridVisibility()" class="p-2 rounded hover:bg-white/10 text-gray-400 flex flex-col items-center gap-1 w-8 transition" title="Show/Hide Grid Lines">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path></svg>
    </button>

    <div class="relative">
        <button onclick="document.getElementById('grid-settings-menu').classList.toggle('hidden')" class="p-2 rounded hover:bg-white/10 text-gray-400 flex flex-col items-center gap-1 w-8 transition" title="Grid Settings">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
        </button>

        <div id="grid-settings-menu" class="hidden absolute top-12 right-0 bg-gray-900 border border-gray-600 p-3 rounded-lg shadow-xl flex flex-col gap-3 w-40 z-[60]">
            <div class="flex items-center justify-between">
                <span class="text-[10px] text-gray-400 font-bold uppercase">Color</span>
                <input type="color" id="grid-color" value="#06b6d4" oninput="window.renderGrid()" class="w-6 h-6 rounded cursor-pointer border-none bg-transparent">
            </div>
            <div>
                <div class="flex justify-between text-[10px] text-gray-400 font-bold mb-1">
                    <span>Thickness</span>
                    <span id="grid-width-val">1px</span>
                </div>
                <input type="range" id="grid-width" min="1" max="5" step="0.5" value="1" oninput="window.renderGrid()" class="w-full h-1 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-indigo-500">
            </div>
            <div>
                <div class="flex justify-between text-[10px] text-gray-400 font-bold mb-1">
                    <span>Opacity</span>
                    <span id="grid-opacity-val">60%</span>
                </div>
                <input type="range" id="grid-opacity" min="0.1" max="1.0" step="0.1" value="0.6" oninput="window.renderGrid()" class="w-full h-1 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-indigo-500">
            </div>
        </div>
    </div>


<div class="w-px bg-gray-700 h-6 my-auto"></div>

        <button id="btn-ruler" onclick="window.activateRuler()" class="p-2 rounded hover:bg-white/10 text-gray-400 flex flex-col items-center gap-1 w-10 transition" title="Measure Distance">
    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.4 7.34L16.66 4.6A2 2 0 0 0 14 4.6L2 16.6V22h5.4l12-12a2 2 0 0 0 0-2.82zM15 7l-2 2M11 11l-2 2M7 15l-2 2"></path>
    </svg>
</button>

<div class="flex items-center gap-1 border-l border-gray-700 pl-2 ml-2">
    <button id="btn-wall" onclick="window.toggleWallTool()" class="p-2 rounded hover:bg-white/10 text-gray-400 flex flex-col items-center gap-1 w-8 transition" title="Draw Wall">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
    </button>

    <button id="btn-wall-eraser" onclick="window.toggleWallEraser()" class="p-2 rounded hover:bg-white/10 text-gray-400 flex flex-col items-center gap-1 w-8 transition" title="Delete Wall Line">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
    </button>

    <button onclick="window.undoLastWall()" class="text-[8px] text-gray-500 hover:text-white uppercase font-bold px-1" title="Undo Last">‚Ü©</button>
</div>

        <div class="w-px bg-gray-700 h-6 my-auto"></div>

        <button onclick="window.revealTokenVision()" class="p-2 rounded hover:bg-white/10 text-gray-400 flex flex-col items-center gap-1 w-10 transition" title="Reveal Vision">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
        </button>

    </div>

<div id="fog-toolbar" class="hidden absolute top-20 left-4 bg-gray-900 border border-gray-600 p-2 rounded shadow-xl z-50 flex flex-row items-center gap-3">
    
    <div class="text-[10px] uppercase font-bold text-gray-500 tracking-widest select-none cursor-grab">
        FOG
    </div>
    
    <div class="w-px h-6 bg-gray-700"></div>

    <div class="flex gap-1">
        <button id="btn-fog-reveal" onclick="window.fog.setMode('reveal')" class="p-2 bg-indigo-600 text-white rounded hover:bg-indigo-500" title="Reveal Tool (Eraser)">
            üëÅÔ∏è
        </button>
        <button id="btn-fog-shroud" onclick="window.fog.setMode('shroud')" class="p-2 bg-gray-700 text-gray-400 rounded hover:bg-gray-600" title="Shroud Tool (Paint)">
            ‚òÅÔ∏è
        </button>
    </div>

    <div class="w-px h-6 bg-gray-700"></div>

    <div class="flex gap-1">
        <button onclick="window.fog.fillFog()" class="p-2 bg-gray-800 text-red-400 border border-red-900/30 rounded hover:bg-red-900/20 text-xs font-bold" title="Fill Screen (Black)">
            ‚óº Fill
        </button>
        <button onclick="window.fog.clearFog()" class="p-2 bg-gray-800 text-green-400 border border-green-900/30 rounded hover:bg-green-900/20 text-xs font-bold" title="Reset Map (Clear)">
            ‚òÄ Reset
        </button>
    </div>

    <div class="w-px h-6 bg-gray-700"></div>

    <div class="flex flex-col justify-center w-32">
        <label class="text-[8px] text-gray-400 text-center uppercase">Size: <span id="brush-size-label">60px</span></label>
        <input id="fog-brush-slider" type="range" min="10" max="200" value="60" class="w-full h-1 bg-gray-600 rounded-lg appearance-none cursor-pointer">
    </div>
</div>
</div>

    <div class="flex-grow overflow-auto bg-gray-900 flex relative cursor-move" id="map-scroll-area">
        
        <div id="dm-map-container" class="relative w-fit h-fit m-auto shadow-2xl origin-center transition-transform duration-200">
    
    <img id="active-battlemap" src="" class="block max-w-full max-h-[85vh] w-auto h-auto transition-opacity duration-300" style="opacity: 0;">

    <svg id="grid-layer" class="absolute inset-0 w-full h-full pointer-events-none z-[5] opacity-60"></svg>
    
    <canvas id="fow-canvas" class="absolute inset-0 w-full h-full z-20 pointer-events-none opacity-90"></canvas>

    <svg id="ruler-layer" class="absolute inset-0 w-full h-full pointer-events-none z-[60]" style="overflow: visible;"></svg>

    <svg id="wall-layer" class="absolute inset-0 w-full h-full z-[15] pointer-events-none"></svg>

    <div id="vtt-token-layer" class="absolute inset-0 w-full h-full z-50 pointer-events-none"></div>
    

            
            <div id="map-placeholder-text" class="absolute inset-0 flex items-center justify-center pointer-events-none z-0">
                <div class="text-center opacity-30">
                    <h3 class="text-white font-black text-2xl uppercase tracking-widest">Tactical View</h3>
                    <p class="text-gray-400 text-xs">Upload an image to begin</p>
                </div>
            </div>
        </div>

    </div>
</div>

        <div id="tracker-panel" class="w-full shrink-0 flex flex-col h-full transition-all duration-300 relative z-40"> 
            
            <div class="card rounded-none md:rounded-l-lg shadow-xl bg-gray-900 border-l border-gray-700 flex flex-col h-full w-full"> 

                <div class="p-3 bg-gray-800 border-b border-gray-700 flex justify-between items-center shrink-0">
                    <div class="flex items-center gap-3">
                        <h2 class="text-xl font-semibold text-indigo-300" id="tracker-title">Tracker</h2>
                        <button onclick="window.toggleVTTMode()" id="vtt-toggle-btn" class="px-2 py-1 bg-indigo-600 hover:bg-indigo-500 text-[10px] font-bold text-white rounded uppercase tracking-tighter transition-all border border-indigo-400/50">
                            Open Map
                        </button>
                    </div>
                    
                    <div class="flex items-center gap-2">
                        <span id="db-status" class="text-[10px] px-2 py-1 rounded bg-gray-700 text-gray-400">Status</span>
                        <div class="flex items-center gap-1 bg-gray-900 px-2 py-1 rounded-lg border border-gray-700 shadow-inner">
                            <input type="number" id="timer-min" value="00" min="0" max="99" class="w-8 bg-transparent text-red-400 font-mono font-bold text-lg text-center outline-none p-0 border-none focus:ring-0 placeholder-red-400/50 appearance-none" onfocus="this.select()">
                            <span class="text-red-400 font-bold">:</span>
                            <input type="number" id="timer-sec" value="00" min="0" max="59" class="w-8 bg-transparent text-red-400 font-mono font-bold text-lg text-center outline-none p-0 border-none focus:ring-0 placeholder-red-400/50 appearance-none" onfocus="this.select()">
                            <button onclick="window.toggleTimer()" id="btn-timer-toggle" class="ml-1 text-[10px] bg-green-700 hover:bg-green-600 text-white px-2 py-1 rounded font-bold transition">‚ñ∂</button>
                            <button onclick="window.resetTimer()" class="text-[10px] bg-gray-600 hover:bg-gray-500 text-white px-2 py-1 rounded font-bold transition">‚Ü∫</button>
                        </div>
                    </div>
                </div>

                <div class="flex-1 overflow-y-auto p-4 scrollbar-hide relative">
                    
                    <div id="view-initiative" class="tracker-view space-y-4">
                        
                        <div class="flex flex-wrap gap-2">
                            <div class="flex-1 min-w-[100px]"><label class="block text-xs font-medium text-gray-400 mb-1">Name</label><input id="combatant-name" type="text" placeholder="Name" class="w-full p-2 rounded-lg input-style"></div>
                            <div class="w-14"><label class="block text-xs font-medium text-gray-400 mb-1">#</label><input id="combatant-count" type="number" value="1" min="1" class="w-full p-2 rounded-lg input-style text-center text-sm font-bold"></div>
                            <div class="w-16"><label class="block text-xs font-medium text-gray-400 mb-1">Init</label><input id="combatant-init" type="number" placeholder="Roll" class="w-full p-2 rounded-lg input-style text-center text-sm"></div>
                            <div class="w-14"><label class="block text-xs font-medium text-gray-400 mb-1">AC</label><input id="combatant-ac" type="number" placeholder="-" class="w-full p-2 rounded-lg input-style text-center text-sm"></div>
                            <div class="w-16"><label class="block text-xs font-medium text-gray-400 mb-1">HP</label><input id="combatant-hp" type="number" placeholder="-" class="w-full p-2 rounded-lg input-style text-center text-sm"></div>
                            <button onclick="addCombatant()" id="add-combatant-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold px-3 py-2 rounded-lg text-sm self-end h-[42px]">+</button>
                        </div>

                        <div class="card p-3 rounded-lg shadow-inner bg-gray-800/50 border border-gray-700">
                            <h3 class="text-xs font-semibold mb-2 text-indigo-400 uppercase tracking-wider">Dice Roller</h3>
                            <div class="flex gap-2 mb-2">
                                <div class="flex items-center gap-2 bg-gray-900/50 p-1.5 rounded border border-gray-700 flex-1"><span class="text-[10px] text-gray-400">Color</span><input type="color" id="dice-color-picker" value="#6366f1" class="w-4 h-4 bg-transparent border-none cursor-pointer rounded"></div>
                                <div class="flex items-center gap-2 bg-gray-900/50 p-1.5 rounded border border-gray-700 flex-[2]"><span class="text-[10px] text-gray-400">Tex</span><input type="file" id="dice-texture-input" accept="image/*" onchange="window.uploadDiceTexture(this)" class="text-[10px] text-gray-500 w-full"></div>
                            </div>
                            <div class="flex items-center space-x-2 mb-3 pb-3 border-b border-gray-700">
                                <button onclick="window.rollD20()" class="w-1/3 bg-green-600 hover:bg-green-700 text-white font-bold py-2 rounded text-xs">Init D20</button>
                                <div id="last-roll-display" class="w-1/3 text-2xl font-extrabold text-center text-yellow-400 border-2 border-yellow-400 p-1 rounded bg-gray-900/50 select-none">?</div>
                                <div class="w-1/3 flex flex-col gap-1">
                                    <select id="combatant-selector" class="w-full p-1 rounded input-style text-[10px]"><option value="" disabled selected>Target</option></select>
                                    <button onclick="window.assignInitiativeRoll()" id="assign-roll-button" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-1 rounded text-[10px] disabled:opacity-50" disabled>Set Init</button>
                                </div>
                            </div>
                            <div class="grid grid-cols-7 gap-1 mb-3">
                                <button onclick="window.rollSimple(4)" class="bg-gray-700 hover:bg-gray-600 text-white text-[10px] font-bold py-1 rounded">d4</button>
                                <button onclick="window.rollSimple(6)" class="bg-gray-700 hover:bg-gray-600 text-white text-[10px] font-bold py-1 rounded">d6</button>
                                <button onclick="window.rollSimple(8)" class="bg-gray-700 hover:bg-gray-600 text-white text-[10px] font-bold py-1 rounded">d8</button>
                                <button onclick="window.rollSimple(10)" class="bg-gray-700 hover:bg-gray-600 text-white text-[10px] font-bold py-1 rounded">d10</button>
                                <button onclick="window.rollSimple(12)" class="bg-gray-700 hover:bg-gray-600 text-white text-[10px] font-bold py-1 rounded">d12</button>
                                <button onclick="window.rollSimple(20)" class="bg-gray-700 hover:bg-gray-600 text-white text-[10px] font-bold py-1 rounded">d20</button>
                                <button onclick="window.rollSimple(100)" class="bg-gray-700 hover:bg-gray-600 text-white text-[10px] font-bold py-1 rounded">d100</button>
                            </div>
                            <div class="flex items-center gap-1 bg-gray-900/30 p-1 rounded">
                                <input id="dice-num" type="number" value="1" class="w-8 p-1 text-center text-xs rounded bg-gray-700 text-white border-none"><span class="text-gray-500 text-xs">d</span>
                                <input id="dice-type" type="number" value="20" class="w-8 p-1 text-center text-xs rounded bg-gray-700 text-white border-none"><span class="text-gray-500 text-xs">+</span>
                                <input id="dice-mod" type="number" value="0" class="w-8 p-1 text-center text-xs rounded bg-gray-700 text-white border-none">
                                <button onclick="window.rollCustomDice()" class="flex-1 bg-purple-600 hover:bg-purple-500 text-white font-bold py-1 rounded text-xs">Roll</button>
                            </div>
                            <div class="mt-2 text-center"><div id="dice-roll-result" class="text-lg font-bold text-green-400"></div><div id="dice-roll-details" class="text-[10px] text-gray-500"></div></div>
                        </div>

                        <div class="flex justify-between items-center gap-2">
                            <button onclick="window.sortInitiative()" class="flex-1 bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 rounded-lg text-xs">Sort</button>
                            <button onclick="window.nextTurn()" class="flex-1 bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 rounded-lg text-xs">Next Turn</button>
                            <button onclick="window.clearCombat()" class="flex-1 bg-red-900/50 hover:bg-red-800 text-red-200 font-bold py-2 rounded-lg text-xs border border-red-800">Clear</button>
                        </div>

                        <div class="card p-3 rounded-lg shadow-inner bg-indigo-950/20 border border-indigo-500/30 mb-4">
                            <div class="flex items-center justify-between mb-2"><h3 class="text-[10px] font-bold text-indigo-400 uppercase tracking-[0.2em]">Visual Uplink</h3><span id="uplink-status" class="text-[9px] text-indigo-300/50 italic">Ready</span></div>
                            <div class="flex gap-2">
                                <input type="file" id="uplink-image-input" class="hidden" accept="image/*" onchange="window.handleMapUpload(this)">
                                <button onclick="document.getElementById('uplink-image-input').click()" class="flex-[2] bg-indigo-600 hover:bg-indigo-500 text-white text-[10px] font-bold py-2 rounded transition-all uppercase shadow-lg border border-indigo-400/20">Upload Reveal</button>
                                <button onclick="window.clearUplinkImage()" class="flex-1 bg-red-950/40 hover:bg-red-900/60 text-red-400 text-[10px] font-bold py-2 rounded border border-red-900/50 transition-all uppercase">Clear</button>
                            </div>
                        </div>

                        <button onclick="window.shareCombatLink()" class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white font-bold py-2 rounded-lg shadow text-xs flex items-center justify-center gap-2">Broadcast Link</button>
                        <div id="initiative-list" class="space-y-2 pb-10"><p class="text-center text-gray-500 pt-8 text-sm">Initiative is empty.</p></div>
                    </div>

                    <div id="view-enemies" class="tracker-view hidden p-2"><input type="text" placeholder="Search Enemies..." class="w-full p-2 mb-3 bg-gray-800 rounded border border-gray-600 text-sm text-white focus:border-indigo-500 outline-none" onkeyup="window.filterTrackerNotes(this.value, 'view-enemies')"><div id="enemies-list-container" class="space-y-2"><p class="text-gray-500 text-center mt-10 text-sm">Loading Enemies...</p></div></div>
                    <div id="view-npcs" class="tracker-view hidden p-2"><input type="text" placeholder="Search NPCs..." class="w-full p-2 mb-3 bg-gray-800 rounded border border-gray-600 text-sm text-white focus:border-indigo-500 outline-none" onkeyup="window.filterTrackerNotes(this.value, 'view-npcs')"><div id="npcs-list-container" class="space-y-2"><p class="text-gray-500 text-center mt-10 text-sm">Loading NPCs...</p></div></div>
                </div>

                <div class="flex border-t border-gray-700 bg-gray-800 rounded-b-lg shrink-0">
                    <button onclick="switchTrackerTab('initiative')" class="tracker-tab-btn flex-1 py-4 text-center text-xs font-bold text-indigo-400 border-b-2 border-indigo-500 bg-gray-700/50 uppercase tracking-wider transition">‚öîÔ∏è Tracker</button>
                    <button onclick="switchTrackerTab('enemies')" class="tracker-tab-btn flex-1 py-4 text-center text-xs font-bold text-gray-500 hover:text-indigo-300 hover:bg-gray-700 uppercase tracking-wider transition">üíÄ Enemies</button>
                    <button onclick="switchTrackerTab('npcs')" class="tracker-tab-btn flex-1 py-4 text-center text-xs font-bold text-gray-500 hover:text-indigo-300 hover:bg-gray-700 uppercase tracking-wider transition">üë• NPCs</button>
                </div>
            </div>
            </div>
    </div>
</div>


            <!-- Statblocks Tab -->
            <div id="statblocks" class="tab-content hidden">
                <div class="card p-4 rounded-lg shadow-xl mb-6">
                    <h2 class="text-xl font-semibold mb-4 text-indigo-300">Save NPC</h2>
                    <div class="grid grid-cols-2 gap-2 mb-4">
                        <input id="stat-name" type="text" placeholder="Name" class="col-span-2 p-2 rounded-lg input-style">
                        <input id="stat-hp" type="number" placeholder="HP" class="p-2 rounded-lg input-style text-center text-sm">
                        <input id="stat-ac" type="number" placeholder="AC" class="p-2 rounded-lg input-style text-center text-sm">
                        <input id="stat-tohit" type="number" placeholder="Hit Mod" class="p-2 rounded-lg input-style text-center text-sm">
                        <input id="stat-init-mod" type="number" placeholder="Init Mod" class="p-2 rounded-lg input-style text-center text-sm">
                        <input id="stat-dmg" type="text" placeholder="Damage" class="col-span-2 p-2 rounded-lg input-style">
                    </div>
                    <button onclick="saveStatblock()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 rounded-lg">Save</button>
                    <p id="statblock-status" class="mt-2 text-sm text-center text-gray-400"></p>
                </div>
                <div class="card p-4 rounded-lg shadow-xl">
                    <h2 class="text-xl font-semibold mb-4 text-indigo-300">Saved</h2>
                    <div id="statblocks-list" class="scrollable-content space-y-2"><p class="text-center text-gray-500 pt-8">No stats saved.</p></div>
                </div>
            </div>

            <!-- Monsters Tab -->
            <div id="monsters" class="tab-content hidden">
                
                <div class="card p-4 rounded-lg shadow-xl mb-6 border border-blue-500/30">
                    <h2 class="text-xl font-semibold mb-4 text-blue-300">üìö SRD Compendium</h2>
                    <div class="flex gap-2 mb-4">
                        <input type="text" id="compendium-search" placeholder="Name..." class="flex-1 p-2 rounded-lg input-style text-sm" onkeypress="if(event.key==='Enter') window.searchCompendium()">
                        <select id="compendium-cr" class="w-24 p-2 rounded-lg input-style text-sm font-bold text-center" onchange="window.searchCompendium()">
                            <option value="">Any CR</option><option value="0">0</option><option value="1/8">1/8</option><option value="1/4">1/4</option><option value="1/2">1/2</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option><option value="9">9</option><option value="10">10</option><option value="11">11</option><option value="12">12</option><option value="13">13</option><option value="14">14</option><option value="15">15</option><option value="16">16</option><option value="17">17</option><option value="18">18</option><option value="19">19</option><option value="20">20</option><option value="21">21</option><option value="22">22</option><option value="23">23</option><option value="24">24</option><option value="30">30</option>
                        </select>
                        <button onclick="window.searchCompendium()" class="bg-blue-600 hover:bg-blue-500 text-white font-bold px-3 rounded-lg text-sm">üîç</button>
                    </div>
                    <div id="compendium-results" class="scrollable-content space-y-2 max-h-[500px]">
    <p class="text-center text-gray-500 text-xs">Search by Name or CR.</p>
</div>

               </div> <div class="card p-4 rounded-lg shadow-xl mb-6 border border-red-500/30">
                    <h2 class="text-xl font-semibold mb-4 text-red-300">‚öñÔ∏è Encounter Calculator</h2>
                    <div class="grid grid-cols-2 gap-4 mb-4 pb-4 border-b border-gray-700">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Party Size</label>
                            <input type="number" id="calc-party-size" value="4" min="1" class="w-full p-2 rounded-lg input-style text-center font-bold" onchange="window.calcEncounter()">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Avg Level</label>
                            <input type="number" id="calc-party-level" value="3" min="1" max="20" class="w-full p-2 rounded-lg input-style text-center font-bold" onchange="window.calcEncounter()">
                        </div>
                    </div>
                    <div class="flex gap-2 mb-4">
                        <select id="calc-cr" class="flex-1 p-2 rounded-lg input-style text-sm">
                            <option value="10">CR 0</option><option value="25">CR 1/8</option><option value="50">CR 1/4</option><option value="100">CR 1/2</option>
                            <option value="200">CR 1</option><option value="450">CR 2</option><option value="700">CR 3</option><option value="1100">CR 4</option>
                            <option value="1800">CR 5</option><option value="2300">CR 6</option><option value="2900">CR 7</option><option value="3900">CR 8</option>
                            <option value="5000">CR 9</option><option value="5900">CR 10</option><option value="7200">CR 11</option><option value="8400">CR 12</option>
                            <option value="10000">CR 13</option><option value="11500">CR 14</option><option value="13000">CR 15</option><option value="15000">CR 16</option>
                            <option value="18000">CR 17</option><option value="20000">CR 18</option><option value="22000">CR 19</option><option value="25000">CR 20</option>
                        </select>
                        <input type="number" id="calc-count" value="1" min="1" class="w-16 p-2 rounded-lg input-style text-center font-bold" placeholder="#">
                        <button onclick="window.addCalcMonster()" class="bg-red-700 hover:bg-red-600 text-white font-bold px-4 rounded-lg shadow-lg">+</button>
                    </div>
                    <div id="calc-monster-list" class="flex flex-wrap gap-2 mb-4 min-h-[2rem]"></div>
                    <div id="calc-result" class="bg-gray-900 p-4 rounded-lg text-center border border-gray-700 transition duration-300">
                        <div class="text-gray-500 text-xs uppercase tracking-widest mb-1">Difficulty</div>
                        <div id="calc-difficulty-text" class="text-2xl font-bold text-gray-500">Add Monsters...</div>
                        <div id="calc-xp-details" class="text-[10px] text-gray-500 mt-1"></div>
                    </div>
                    <button onclick="window.clearCalc()" class="mt-2 text-xs text-red-400 underline w-full text-center">Reset Calculator</button>
                    <details class="mt-4 pt-2 border-t border-gray-700 text-xs text-gray-400 select-none group">
                        <summary class="cursor-pointer hover:text-indigo-300 transition font-bold list-none flex items-center gap-2"><span>‚ÑπÔ∏è What is Daily Budget?</span></summary>
                        <div class="mt-2 pl-3 border-l-2 border-indigo-500 bg-gray-800/50 p-2 rounded">
                            <p class="mb-2">The <strong>Daily Budget</strong> is the total XP a party can handle before a <strong>Long Rest</strong>.</p>
                            <ul class="list-disc list-inside space-y-1"><li><strong>33%</strong>: Safe (~2 more fights).</li><li><strong>50%</strong>: Taxing.</li><li><strong>100%+</strong>: <span class="text-red-400">NOVA (Rest needed).</span></li></ul>
                        </div>
                    </details>
                </div>

                <div class="card p-4 rounded-lg shadow-xl mb-6">
                    <h2 class="text-xl font-semibold mb-4 text-green-300">Monster Generator</h2>
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div><label class="block text-xs font-medium text-gray-400 mb-1">Name</label><input type="text" id="monster-name" value="Cave Troll" class="w-full p-2 rounded-lg input-style text-sm"></div>
                        <div><label class="block text-xs font-medium text-gray-400 mb-1">CR</label><input type="text" id="monster-cr" value="4" class="w-full p-2 rounded-lg input-style text-sm"></div>
                    </div>
                    <button onclick="generateMonsterStatblock()" id="generate-monster-button" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 rounded-lg flex items-center justify-center"><span id="generate-monster-text">Generate</span><div id="monster-loading-spinner" class="loading-spinner ml-2 hidden"></div></button>
                    <p id="monster-status-message" class="mt-2 text-sm text-center text-red-400 hidden"></p>
                </div>

                <div class="card p-4 rounded-lg shadow-xl">
                    <h2 class="text-xl font-semibold mb-4 text-indigo-300">Result</h2>
                    <div id="monster-output" class="min-h-[100px] bg-gray-700/30 p-3 rounded-lg text-gray-300">Stat block will appear here.</div>
                    <p id="monster-save-status" class="mt-2 text-sm text-center hidden"></p>
                    <div id="save-options-monster" class="mt-4 hidden">
                        <div class="grid grid-cols-2 gap-2"><button onclick="addMonsterToStatblocks()" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 rounded-lg text-xs">Save to Stats</button><button onclick="saveMonsterToNotes()" class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 rounded-lg text-xs">Save to Notes</button></div>
                    </div>
                </div>
            </div>
            
            <!-- Loot Tab -->
           <div id="loot" class="tab-content hidden">
    <div class="card p-4 rounded-lg shadow-xl mb-6">
        <h2 id="loot-gen-title" class="text-xl font-semibold mb-4 text-yellow-300">Loot Generator</h2>
        <div class="grid grid-cols-2 gap-4 mb-4">
            <div class="col-span-2">
                <label class="block text-xs font-medium text-gray-400 mb-1">Source</label>
                <select id="loot-source" class="w-full p-2 rounded-lg input-style text-sm">
                    <option value="ai">AI Generator (Creative)</option>
                    <option value="wiki">Official Wiki (Rules)</option>
                </select>
            </div>
            <div>
                <label class="block text-xs font-medium text-gray-400 mb-1">Level/CR</label>
                <input type="text" id="loot-level" value="3" class="w-full p-2 rounded-lg input-style text-sm">
            </div>
            <div>
                <label class="block text-xs font-medium text-gray-400 mb-1">Type</label>
                <select id="loot-type" class="w-full p-2 rounded-lg input-style text-sm">
                    <option value="Individual">Individual</option>
                    <option value="Hoard">Hoard</option>
                    <option value="Shop Inventory">Shop</option>
                </select>
            </div>
        </div>
        <button onclick="generateLoot()" id="generate-loot-button" class="w-full bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 rounded-lg flex items-center justify-center">
            <span id="generate-loot-text">Generate</span>
            <div id="loot-loading-spinner" class="loading-spinner ml-2 hidden"></div>
        </button>
    </div>

    <div class="card p-4 rounded-lg shadow-xl mb-6">
        <h2 id="loot-result-title" class="text-xl font-semibold mb-4 text-indigo-300">Result</h2>
        <div id="loot-output" class="whitespace-pre-wrap min-h-[100px] bg-gray-700/30 p-3 rounded-lg text-gray-300">Loot appears here.</div>
        <button onclick="saveGeneratedContent('lootNotes')" class="mt-4 w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 rounded-lg text-sm">Save to Loot Notes</button>
    </div>
    
    <div class="card p-4 rounded-lg shadow-xl mt-6 border border-yellow-700/30">
    <h2 id="splitter-title" class="text-xl font-semibold mb-4 text-yellow-400">üí∞ Loot Splitter</h2>
    
    <div id="coin-headers" class="grid grid-cols-5 gap-2 mb-1 text-center text-[10px] font-bold text-gray-500 uppercase tracking-wider">
        <div>PP</div><div>GP</div><div>EP</div><div>SP</div><div>CP</div>
    </div>
    
    <div id="coin-inputs" class="grid grid-cols-5 gap-2 mb-4">
        <input type="number" id="loot-pp" class="p-2 rounded bg-gray-800 text-white text-center border border-gray-600 focus:border-yellow-500 outline-none" placeholder="0">
        <input type="number" id="loot-gp" class="p-2 rounded bg-gray-800 text-white text-center border border-gray-600 focus:border-yellow-500 outline-none" placeholder="0">
        <input type="number" id="loot-ep" class="p-2 rounded bg-gray-800 text-white text-center border border-gray-600 focus:border-yellow-500 outline-none" placeholder="0">
        <input type="number" id="loot-sp" class="p-2 rounded bg-gray-800 text-white text-center border border-gray-600 focus:border-yellow-500 outline-none" placeholder="0">
        <input type="number" id="loot-cp" class="p-2 rounded bg-gray-800 text-white text-center border border-gray-600 focus:border-yellow-500 outline-none" placeholder="0">
    </div>

    <div class="flex gap-3 items-center mb-4 bg-gray-900/30 p-2 rounded">
        <span class="text-sm text-gray-300 font-bold">Party Size:</span>
        <input type="number" id="loot-party-size" value="4" class="w-16 p-2 rounded bg-gray-800 text-white text-center border border-gray-600 font-bold">
        <button onclick="window.splitLoot()" class="flex-1 bg-yellow-600 hover:bg-yellow-500 text-white font-bold py-2 rounded transition shadow-lg shadow-yellow-900/20">Split Loot</button>
    </div>

    <div class="bg-gray-800 p-4 rounded-lg border border-gray-700">
        <h3 id="quick-split-label" class="text-sm font-bold text-gray-400 uppercase mb-3">Quick Total Splitter</h3>
        <div class="flex items-center gap-2">
    <input type="number" id="total-loot" placeholder="Total" class="bg-gray-900 border border-gray-600 rounded p-2 text-white w-full">
    <span id="splitter-currency" class="font-bold text-yellow-500 min-w-[30px]">GP</span>
</div>
        <div id="split-results" class="mt-3 text-sm text-gray-300 italic">Enter total to split...</div>
    </div>
</div>
</div>

            <div id="travel" class="tab-content hidden">
                
                <div class="card p-4 rounded-lg shadow-xl mb-6 border border-green-800/50">
                    <h2 class="text-xl font-semibold mb-4 text-green-300 flex items-center gap-2">
                        <span>üó∫Ô∏è Travel Calculator</span>
                    </h2>
                    
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Distance (Miles)</label>
                            <input type="number" id="travel-dist" value="24" class="w-full p-2 rounded-lg input-style text-center font-bold">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Pace</label>
                            <select id="travel-pace" class="w-full p-2 rounded-lg input-style text-sm">
                                <option value="fast">Fast (30m/day)</option>
                                <option value="normal" selected>Normal (24m/day)</option>
                                <option value="slow">Slow (18m/day)</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Party Size</label>
                            <input type="number" id="travel-party" value="4" class="w-full p-2 rounded-lg input-style text-center font-bold">
                        </div>
                    </div>

                    <button onclick="window.calcTravel()" class="w-full bg-green-700 hover:bg-green-600 text-white font-bold py-2 rounded-lg transition mb-4 shadow-lg">Calculate Journey</button>

                    <div id="travel-result" class="hidden bg-gray-900/50 p-4 rounded-lg border border-gray-700 text-sm space-y-2">
                        </div>
                </div>

                <div class="card p-4 rounded-lg shadow-xl mb-6 border border-blue-500/30">
                    <h2 class="text-xl font-semibold mb-4 text-blue-300">‚õàÔ∏è Weather & Atmosphere</h2>
                    <div class="flex gap-2 mb-4">
                        <select id="weather-biome" class="flex-1 p-2 rounded-lg input-style text-sm">
                            <option value="temperate">Temperate / Forest</option>
                            <option value="desert">Desert / Wasteland</option>
                            <option value="arctic">Arctic / Tundra</option>
                            <option value="swamp">Swamp / Jungle</option>
                            <option value="underdark">Underdark / Cave</option>
                            <option value="coast">Coastal / Sea</option>
                        </select>
                        <button onclick="window.genWeather()" class="bg-blue-600 hover:bg-blue-500 text-white font-bold px-4 rounded-lg">Roll</button>
                    </div>
                    <div id="weather-output" class="text-center text-gray-400 italic text-sm min-h-[1.5rem]">Select biome and roll weather...</div>
                </div>

                <div class="card p-4 rounded-lg shadow-xl mb-6 border border-red-500/30">
                    <h2 class="text-xl font-semibold mb-4 text-red-300 flex items-center gap-2">
                        <span>‚öîÔ∏è Random Encounter</span>
                    </h2>
                    
                    <div class="flex gap-2 mb-4">
                        <select id="encounter-terrain" class="flex-1 p-2 rounded-lg input-style text-sm">
                            <option value="Road">Road / Highway</option>
                            <option value="Forest">Forest / Woods</option>
                            <option value="Mountain">Mountain / Hill</option>
                            <option value="Swamp">Swamp / Bog</option>
                            <option value="Desert">Desert / Wasteland</option>
                            <option value="Arctic">Arctic / Tundra</option>
                            <option value="Coast">Coast / Sea</option>
                            <option value="Underdark">Underdark / Cave</option>
                            <option value="Urban">City / Alley</option>
                            <option value="Dungeon">Dungeon / Ruins</option>
                        </select>
                        <select id="encounter-danger" class="w-1/3 p-2 rounded-lg input-style text-sm">
                            <option value="Low">Safe / Social</option>
                            <option value="Medium" selected>Moderate</option>
                            <option value="High">Dangerous</option>
                            <option value="Deadly">Deadly</option>
                        </select>
                    </div>

                    <button onclick="window.genEncounter()" id="btn-gen-encounter" class="w-full bg-red-700 hover:bg-red-600 text-white font-bold py-2 rounded-lg transition mb-4 shadow-lg border border-red-600">
                        Roll Encounter
                    </button>

                    <div id="encounter-output" class="hidden bg-gray-900/50 p-4 rounded-lg border border-gray-700 text-sm text-gray-300 leading-relaxed whitespace-pre-wrap mb-2"></div>
                    
                    <button onclick="window.saveEncounterToNotes()" id="btn-save-encounter" class="hidden w-full bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 rounded-lg text-xs transition">
                        üíæ Save to Prep Notes
                    </button>
                </div>

                <div class="card p-4 rounded-lg shadow-xl mb-6 border border-yellow-600/30">
                    <h2 class="text-xl font-semibold mb-4 text-yellow-300">üç∫ Downtime Activities</h2>
                    
                    <div class="flex gap-2 mb-4">
                        <select id="downtime-activity" class="flex-1 p-2 rounded-lg input-style text-sm">
                            <option value="crafting">Crafting an Item</option>
                            <option value="training">Training (Language/Tool)</option>
                            <option value="research">Researching Lore</option>
                            <option value="carousing">Carousing (Party)</option>
                            <option value="crime">Crime / Heist</option>
                            <option value="work">Working a Job</option>
                            <option value="gambling">Gambling</option>
                        </select>
                        <button onclick="window.resolveDowntime()" class="bg-yellow-700 hover:bg-yellow-600 text-white font-bold px-4 rounded-lg">Check</button>
                    </div>

                    <div id="downtime-result" class="bg-gray-900 p-4 rounded border border-gray-700 text-sm text-gray-300 leading-relaxed hidden"></div>
                </div>

                <div class="card p-4 rounded-lg shadow-xl border border-orange-500/30 text-center">
                    <h2 class="text-xl font-semibold mb-2 text-orange-300">üî• Campfire Chat</h2>
                    <p class="text-xs text-gray-500 mb-4">Click to generate a question for your players during a Long Rest.</p>
                    
                    <div id="campfire-prompt" class="text-lg font-serif text-orange-100 italic mb-4 min-h-[3rem] flex items-center justify-center">
                        "The fire crackles..."
                    </div>
                    
                    <button onclick="window.genCampfirePrompt()" class="bg-orange-800 hover:bg-orange-700 text-white font-bold py-2 px-6 rounded-full transition shadow-lg border border-orange-600">
                        Spark Conversation
                    </button>
                </div>

            </div>

            <div id="soundboard" class="tab-content hidden">
                <div class="card p-4 rounded-lg shadow-xl mb-6">
                    <h2 class="text-xl font-semibold mb-4 text-pink-300">Synth Soundboard</h2>
                    <div class="mb-6 flex items-center gap-4 bg-gray-800 p-3 rounded-lg border border-gray-700">
                        <label for="master-volume" class="text-sm font-bold text-indigo-400">Master Volume:</label>
                        <input type="range" id="master-volume" min="0" max="1" step="0.01" value="0.5" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-green-400">
                    </div>
                    <div class="grid grid-cols-2 sm:grid-cols-3 gap-4 mb-6">
                        <button onclick="playTone('success')" class="sound-btn bg-green-600 hover:bg-green-500 text-white font-bold py-4 rounded-lg shadow-lg border-b-4 border-green-800 flex flex-col items-center justify-center"><span class="text-2xl mb-1">‚ú®</span><span class="text-xs">Success</span></button>
                        <button onclick="playTone('critical')" class="sound-btn bg-green-700 hover:bg-green-600 text-white font-bold py-4 rounded-lg shadow-lg border-b-4 border-green-900 flex flex-col items-center justify-center"><span class="text-2xl mb-1">üéâ</span><span class="text-xs">Crit</span></button>
                        <button onclick="playTone('fail')" class="sound-btn bg-red-600 hover:bg-red-500 text-white font-bold py-4 rounded-lg shadow-lg border-b-4 border-red-800 flex flex-col items-center justify-center"><span class="text-2xl mb-1">‚ùå</span><span class="text-xs">Fail</span></button>
                        <button onclick="playTone('combat_start')" class="sound-btn bg-orange-600 hover:bg-orange-500 text-white font-bold py-4 rounded-lg shadow-lg border-b-4 border-orange-800 flex flex-col items-center justify-center"><span class="text-2xl mb-1">‚öîÔ∏è</span><span class="text-xs">Combat</span></button>
                        <button onclick="playTone('spell')" class="sound-btn bg-purple-600 hover:bg-purple-500 text-white font-bold py-4 rounded-lg shadow-lg border-b-4 border-purple-800 flex flex-col items-center justify-center"><span class="text-2xl mb-1">üîÆ</span><span class="text-xs">Spell</span></button>
                        <button onclick="playTone('mystery')" class="sound-btn bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-4 rounded-lg shadow-lg border-b-4 border-indigo-800 flex flex-col items-center justify-center"><span class="text-2xl mb-1">üëª</span><span class="text-xs">Mystery</span></button>
                        <button onclick="playTone('rest')" class="sound-btn bg-blue-600 hover:bg-blue-500 text-white font-bold py-4 rounded-lg shadow-lg border-b-4 border-blue-800 flex flex-col items-center justify-center"><span class="text-2xl mb-1">üí§</span><span class="text-xs">Rest</span></button>
                        <button onclick="playTone('trap')" class="sound-btn bg-yellow-600 hover:bg-yellow-500 text-white font-bold py-4 rounded-lg shadow-lg border-b-4 border-yellow-800 flex flex-col items-center justify-center"><span class="text-2xl mb-1">‚ö†Ô∏è</span><span class="text-xs">Trap</span></button>
                        <button onclick="playTone('boss')" class="sound-btn bg-gray-700 hover:bg-gray-600 text-white font-bold py-4 rounded-lg shadow-lg border-b-4 border-gray-900 flex flex-col items-center justify-center"><span class="text-2xl mb-1">üíÄ</span><span class="text-xs">Boss</span></button>
                    </div>
                    <h3 class="text-sm font-semibold text-gray-400 mb-2 uppercase tracking-wider border-t border-gray-700 pt-4">Creature Sounds</h3>
                    <div class="grid grid-cols-2 sm:grid-cols-5 gap-3 mb-6">
                        <button onclick="playTone('wolf')" class="sound-btn bg-gray-600 hover:bg-gray-500 text-white font-bold py-3 rounded-lg shadow-md border-b-4 border-gray-800 flex flex-col items-center justify-center"><span class="text-xl mb-1">üê∫</span><span class="text-xs">Wolf</span></button>
                        <button onclick="playTone('bear')" class="sound-btn bg-orange-800 hover:bg-orange-700 text-white font-bold py-3 rounded-lg shadow-md border-b-4 border-orange-950 flex flex-col items-center justify-center"><span class="text-xl mb-1">üêª</span><span class="text-xs">Bear</span></button>
                        <button onclick="playTone('bird')" class="sound-btn bg-sky-600 hover:bg-sky-500 text-white font-bold py-3 rounded-lg shadow-md border-b-4 border-sky-800 flex flex-col items-center justify-center"><span class="text-xl mb-1">üê¶</span><span class="text-xs">Bird</span></button>
                        <button onclick="playTone('snake')" class="sound-btn bg-green-800 hover:bg-green-700 text-white font-bold py-3 rounded-lg shadow-md border-b-4 border-green-950 flex flex-col items-center justify-center"><span class="text-xl mb-1">üêç</span><span class="text-xs">Snake</span></button>
                        <button onclick="playTone('insect')" class="sound-btn bg-yellow-700 hover:bg-yellow-600 text-white font-bold py-3 rounded-lg shadow-md border-b-4 border-yellow-900 flex flex-col items-center justify-center"><span class="text-xl mb-1">ü¶ó</span><span class="text-xs">Insect</span></button>
                    </div>
                    <h3 class="text-sm font-semibold text-gray-400 mb-2 uppercase tracking-wider border-t border-gray-700 pt-4">Ambience Loops</h3>
                    <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
                        <button onclick="toggleAmbience('village')" id="ambience-village" class="sound-btn bg-teal-800 hover:bg-teal-700 text-white font-bold py-3 rounded-lg shadow-md border border-teal-600 flex flex-col items-center justify-center"><span class="text-xl mb-1">üèòÔ∏è</span><span class="text-xs">Village</span></button>
                        <button onclick="toggleAmbience('city')" id="ambience-city" class="sound-btn bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 rounded-lg shadow-md border border-gray-500 flex flex-col items-center justify-center"><span class="text-xl mb-1">üè∞</span><span class="text-xs">City</span></button>
                        <button onclick="toggleAmbience('tavern')" id="ambience-tavern" class="sound-btn bg-yellow-900 hover:bg-yellow-800 text-white font-bold py-3 rounded-lg shadow-md border border-yellow-700 flex flex-col items-center justify-center"><span class="text-xl mb-1">üç∫</span><span class="text-xs">Tavern</span></button>
                        <button onclick="toggleAmbience('ocean')" id="ambience-ocean" class="sound-btn bg-blue-900 hover:bg-blue-800 text-white font-bold py-3 rounded-lg shadow-md border border-blue-700 flex flex-col items-center justify-center"><span class="text-xl mb-1">‚öì</span><span class="text-xs">Sea Shanty</span></button>
                        <button onclick="toggleAmbience('dungeon')" id="ambience-dungeon" class="sound-btn bg-purple-900 hover:bg-purple-800 text-white font-bold py-3 rounded-lg shadow-md border border-purple-700 flex flex-col items-center justify-center"><span class="text-xl mb-1">‚õìÔ∏è</span><span class="text-xs">Dungeon</span></button>
                        <button onclick="toggleAmbience('battle_minor')" id="ambience-battle_minor" class="sound-btn bg-red-900 hover:bg-red-800 text-white font-bold py-3 rounded-lg shadow-md border border-red-700 flex flex-col items-center justify-center"><span class="text-xl mb-1">üõ°Ô∏è</span><span class="text-xs">Minor Battle</span></button>
                        <button onclick="toggleAmbience('battle_major')" id="ambience-battle_major" class="sound-btn bg-gray-800 hover:bg-gray-700 text-white font-bold py-3 rounded-lg shadow-md border border-gray-600 flex flex-col items-center justify-center"><span class="text-xl mb-1">üî•</span><span class="text-xs">Major Battle</span></button>
                        <button onclick="toggleAmbience('sleep')" id="ambience-sleep" class="sound-btn bg-indigo-900 hover:bg-indigo-800 text-white font-bold py-3 rounded-lg shadow-md border border-indigo-700 flex flex-col items-center justify-center"><span class="text-xl mb-1">‚õ∫</span><span class="text-xs">Rest</span></button>
                    </div>
                    <div id="ambience-status" class="mt-2 text-center text-xs text-green-400 h-4"></div>
                </div>
            </div>

            <div id="notes" class="tab-content hidden h-[calc(100vh-100px)]">
    
    <div id="notes-layout-container" class="flex flex-col h-full gap-4 max-w-7xl mx-auto transition-all duration-300">

        <div id="notes-nav-classic" class="flex-shrink-0">
            <div class="flex gap-2 overflow-x-auto pb-2 border-b border-gray-700">
                <button class="sub-tab-button active px-4 py-2 bg-gray-800 hover:bg-gray-700 rounded-t-lg text-sm font-bold text-gray-400 border-b-2 border-transparent transition-all whitespace-nowrap" 
                    data-subtab="prepNotes" onclick="switchSubTab('prepNotes')">General</button>
                <button class="sub-tab-button px-4 py-2 bg-gray-800 hover:bg-gray-700 rounded-t-lg text-sm font-bold text-gray-400 border-b-2 border-transparent transition-all whitespace-nowrap" 
                    data-subtab="pcNotes" onclick="switchSubTab('pcNotes')">PCs</button>
                <button class="sub-tab-button px-4 py-2 bg-gray-800 hover:bg-gray-700 rounded-t-lg text-sm font-bold text-gray-400 border-b-2 border-transparent transition-all whitespace-nowrap" 
                    data-subtab="enemyNotes" onclick="switchSubTab('enemyNotes')">Enemies</button>
                <button class="sub-tab-button px-4 py-2 bg-gray-800 hover:bg-gray-700 rounded-t-lg text-sm font-bold text-gray-400 border-b-2 border-transparent transition-all whitespace-nowrap" 
                    data-subtab="npcNotes" onclick="switchSubTab('npcNotes')">NPCs</button>
                <button class="sub-tab-button px-4 py-2 bg-gray-800 hover:bg-gray-700 rounded-t-lg text-sm font-bold text-gray-400 border-b-2 border-transparent transition-all whitespace-nowrap" 
                    data-subtab="lootNotes" onclick="switchSubTab('lootNotes')">Loot</button>
                <button class="sub-tab-button px-4 py-2 bg-gray-800 hover:bg-gray-700 rounded-t-lg text-sm font-bold text-cyan-500 border-b-2 border-transparent transition-all whitespace-nowrap" 
                    data-subtab="timeline" onclick="switchSubTab('timeline')">Timeline</button>
            </div>
        </div>

        <div id="notes-nav-pro" class="hidden w-16 md:w-64 flex-shrink-0 flex-col gap-2 bg-gray-900/80 border border-white/5 rounded-xl p-3 shadow-xl backdrop-blur-md">
            <h3 class="hidden md:block text-xs font-black text-gray-500 uppercase tracking-widest px-3 mb-2 mt-1">Notebooks</h3>
            
            <button class="sub-tab-button active group flex items-center gap-3 p-3 rounded-lg text-sm font-semibold text-gray-400 hover:bg-gray-800 hover:text-white transition-all text-left" 
                data-subtab="prepNotes" onclick="switchSubTab('prepNotes')">
                <span class="text-xl grayscale group-hover:grayscale-0 transition">üìú</span> <span class="hidden md:block">General Prep</span>
            </button>
            <button class="sub-tab-button group flex items-center gap-3 p-3 rounded-lg text-sm font-semibold text-gray-400 hover:bg-gray-800 hover:text-white transition-all text-left" 
                data-subtab="pcNotes" onclick="switchSubTab('pcNotes')">
                <span class="text-xl grayscale group-hover:grayscale-0 transition">üõ°Ô∏è</span> <span class="hidden md:block">Player Characters</span>
            </button>
            <button class="sub-tab-button group flex items-center gap-3 p-3 rounded-lg text-sm font-semibold text-gray-400 hover:bg-gray-800 hover:text-white transition-all text-left" 
                data-subtab="enemyNotes" onclick="switchSubTab('enemyNotes')">
                <span class="text-xl grayscale group-hover:grayscale-0 transition">üíÄ</span> <span class="hidden md:block">Enemies</span>
            </button>
            <button class="sub-tab-button group flex items-center gap-3 p-3 rounded-lg text-sm font-semibold text-gray-400 hover:bg-gray-800 hover:text-white transition-all text-left" 
                data-subtab="npcNotes" onclick="switchSubTab('npcNotes')">
                <span class="text-xl grayscale group-hover:grayscale-0 transition">üë•</span> <span class="hidden md:block">NPCs</span>
            </button>
            <button class="sub-tab-button group flex items-center gap-3 p-3 rounded-lg text-sm font-semibold text-gray-400 hover:bg-gray-800 hover:text-white transition-all text-left" 
                data-subtab="lootNotes" onclick="switchSubTab('lootNotes')">
                <span class="text-xl grayscale group-hover:grayscale-0 transition">üí∞</span> <span class="hidden md:block">Loot & Items</span>
            </button>
            
            <div class="h-px bg-white/10 my-2 mx-2"></div>
            
            <button class="sub-tab-button group flex items-center gap-3 p-3 rounded-lg text-sm font-semibold text-cyan-400/70 hover:bg-cyan-900/20 hover:text-cyan-300 transition-all text-left" 
                data-subtab="timeline" onclick="switchSubTab('timeline')">
                <span class="text-xl">‚è≥</span> <span class="hidden md:block">Timeline</span>
            </button>

            <div class="mt-auto hidden md:block">
                <button onclick="window.addNewNote(window.currentSubTab)" class="w-full py-3 bg-indigo-600 hover:bg-indigo-500 text-white font-bold rounded-lg shadow-lg border border-indigo-400/50 flex items-center justify-center gap-2 transition hover:scale-[1.02]">
                    <span>+</span> New Note
                </button>
            </div>
        </div>

        <div class="flex-1 flex flex-col bg-gray-900/50 border border-white/5 rounded-xl shadow-2xl overflow-hidden relative">
            
            <div class="p-4 border-b border-white/5 flex gap-3 items-center bg-gray-900/90 backdrop-blur sticky top-0 z-20">
    
    <div class="flex flex-1 shadow-sm">
        <div class="relative flex-1 group">
            <span class="absolute left-3 top-2.5 text-gray-500 group-focus-within:text-indigo-400 transition">üîç</span>
            <input type="text" 
                   id="notes-search" 
                   placeholder="Search archives..." 
                   onkeyup="if(event.key === 'Enter') window.filterNotes()" 
                   class="w-full bg-black/40 border border-white/10 border-r-0 rounded-l-full py-2 pl-10 pr-4 text-sm text-gray-300 focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 outline-none transition-all">
        </div>
        <button onclick="window.filterNotes()" 
                class="bg-indigo-600 hover:bg-indigo-500 text-white px-5 py-2 rounded-r-full border border-indigo-600 text-sm font-bold transition shadow-[0_0_10px_rgba(79,70,229,0.3)] hover:shadow-[0_0_15px_rgba(79,70,229,0.5)] z-10">
            Search
        </button>
    </div>
    <button onclick="window.addNewNote(window.currentSubTab)" class="hidden md:flex items-center gap-2 bg-indigo-600 hover:bg-indigo-500 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-lg border border-indigo-500/50 transition hover:scale-[1.02]">
        <span>+</span> New Note
    </button>
    
    <button onclick="window.toggleNotesLayout()" title="Switch Layout (Classic/Pro)" class="p-2 text-yellow-500 bg-yellow-500/10 hover:bg-yellow-500/20 rounded-lg border border-yellow-500/30 transition">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path></svg>
    </button>

    <button onclick="window.toggleNoteDesign()" title="Toggle Grid View" class="hidden md:block p-2 text-gray-400 hover:text-white bg-white/5 hover:bg-white/10 rounded-lg border border-white/5 transition">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path></svg>
    </button>

    <button onclick="window.addNewNote(window.currentSubTab)" class="md:hidden p-2 bg-indigo-600 text-white rounded-lg font-bold shadow-lg">+</button>

    <button onclick="document.getElementById('json-import-modal').classList.remove('hidden'); document.getElementById('json-import-input').value='';" 
            class="bg-indigo-900/50 hover:bg-indigo-800 text-indigo-200 border border-indigo-700/50 px-3 py-1 rounded text-xs uppercase tracking-wider transition">
        ‚¨á Import JSON
    </button>

</div>

            <div class="flex-1 overflow-y-auto p-4 custom-scrollbar bg-gradient-to-b from-gray-900/50 to-black/50">
                <div id="prepNotes-sub-content" class="sub-tab-content h-full"><div id="prepNotes-list" class="space-y-3 pb-20"></div></div>
                <div id="pcNotes-sub-content" class="sub-tab-content hidden h-full"><div id="pcNotes-list" class="space-y-3 pb-20"></div></div>
                <div id="enemyNotes-sub-content" class="sub-tab-content hidden h-full"><div id="enemyNotes-list" class="space-y-3 pb-20"></div></div>
                <div id="npcNotes-sub-content" class="sub-tab-content hidden h-full"><div id="npcNotes-list" class="space-y-3 pb-20"></div></div>
                <div id="lootNotes-sub-content" class="sub-tab-content hidden h-full"><div id="lootNotes-list" class="space-y-3 pb-20"></div></div>
                <div id="timeline-sub-content" class="sub-tab-content hidden h-full flex flex-col">
                    <div class="bg-gray-800/80 p-4 border border-white/10 rounded-xl mb-4 flex gap-4 items-end z-10 backdrop-blur-md">
                        <div><label class="text-[10px] text-cyan-400 uppercase font-bold block mb-1">Year</label><input type="number" id="h-time-year" placeholder="Year" class="w-20 bg-black/50 border border-gray-600 rounded p-2 text-white text-sm focus:border-cyan-400 outline-none"></div>
                        <div class="flex-1"><label class="text-[10px] text-cyan-400 uppercase font-bold block mb-1">Event</label><input type="text" id="h-time-desc" placeholder="Event description..." class="w-full bg-black/50 border border-gray-600 rounded p-2 text-white text-sm focus:border-cyan-400 outline-none"></div>
                        <button onclick="window.addHorizontalEvent()" class="bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-2 px-6 rounded shadow-lg border border-cyan-400/50 transition">Add</button>
                    </div>
                    <div class="flex-1 overflow-x-auto overflow-y-hidden relative min-h-[300px] flex items-center px-10 border border-white/5 rounded-xl bg-black/20">
                        <div class="absolute left-0 right-0 top-1/2 h-0.5 bg-gray-700 w-[2000px] z-0"></div>
                        <div id="horizontal-list" class="flex relative z-10 w-full min-w-max h-full items-center gap-8 p-4"></div>
                    </div>
                </div>
            </div>
            
        </div>
    </div>
</div>

           <!-- Homebrew Tab (Items Updated to Parchment Style) -->
            <div id="homebrew" class="tab-content hidden">
                <div class="card p-4 rounded-lg shadow-xl border border-orange-500/30">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold text-orange-300">üç∫ Homebrew Workshop</h2>
                        <div class="flex bg-gray-800 rounded-lg p-1 gap-1">
                            <button class="brew-sub-tab active px-3 py-1 text-xs font-bold rounded bg-orange-600 text-white transition" onclick="switchBrewMode('monster', this)">Monster</button>
                            <button class="brew-sub-tab px-3 py-1 text-xs font-bold rounded text-gray-400 hover:text-white transition" onclick="switchBrewMode('weapon', this)">Weapon</button>
                            <button class="brew-sub-tab px-3 py-1 text-xs font-bold rounded text-gray-400 hover:text-white transition" onclick="switchBrewMode('magic', this)">Item</button>
                            <div class="w-[1px] bg-gray-600 mx-1"></div>
                            <button class="brew-sub-tab px-3 py-1 text-xs font-bold rounded text-blue-300 hover:text-white hover:bg-blue-700 transition" onclick="switchBrewMode('community', this)">üåé Community</button>
                        </div>
                    </div>

                    <div id="brew-monster-area" class="animate-fade-in">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            
                            <div class="space-y-2 bg-gray-900/50 p-3 rounded border border-gray-700">
                                <h3 class="text-gray-400 text-xs font-bold uppercase border-b border-gray-700 pb-1 mb-2">Core Stats</h3>
                                
                                <label class="block text-xs text-gray-500 uppercase">Name</label>
                                <input type="text" id="hb-mon-name" placeholder="e.g. Ancient Red Dragon" class="w-full p-2 rounded input-style text-sm font-bold mb-1">
                                
                                <label class="block text-xs text-gray-500 uppercase">Size, Type, Alignment</label>
                                <input type="text" id="hb-mon-type" placeholder="e.g. Gargantuan Dragon, Chaotic Evil" class="w-full p-2 rounded input-style text-xs">

                                <div class="grid grid-cols-3 gap-2 mt-2">
                                    <div><label class="block text-[10px] text-gray-500 uppercase">AC</label><input type="text" id="hb-mon-ac" placeholder="22 (natural armor)" class="w-full p-2 rounded input-style text-sm"></div>
                                    <div><label class="block text-[10px] text-gray-500 uppercase">HP</label><input type="text" id="hb-mon-hp" placeholder="546" class="w-full p-2 rounded input-style text-sm"></div>
                                    <div><label class="block text-[10px] text-gray-500 uppercase">Hit Dice</label><input type="text" id="hb-mon-hitdice" placeholder="(28d20 + 252)" class="w-full p-2 rounded input-style text-sm"></div>
                                </div>
                                
                                <div class="mt-2">
                                    <label class="block text-[10px] text-gray-500 uppercase">Speed</label>
                                    <input type="text" id="hb-mon-spd" placeholder="40 ft., fly 80 ft., swim 40 ft." class="w-full p-2 rounded input-style text-sm">
                                </div>

                                <label class="block text-xs text-gray-500 uppercase mt-2">Ability Scores</label>
                                <div class="grid grid-cols-6 gap-1">
                                    <div class="text-center"><span class="text-[10px] text-gray-500">STR</span><input type="number" id="hb-mon-str" placeholder="10" class="p-1 w-full rounded input-style text-xs text-center"></div>
                                    <div class="text-center"><span class="text-[10px] text-gray-500">DEX</span><input type="number" id="hb-mon-dex" placeholder="10" class="p-1 w-full rounded input-style text-xs text-center"></div>
                                    <div class="text-center"><span class="text-[10px] text-gray-500">CON</span><input type="number" id="hb-mon-con" placeholder="10" class="p-1 w-full rounded input-style text-xs text-center"></div>
                                    <div class="text-center"><span class="text-[10px] text-gray-500">INT</span><input type="number" id="hb-mon-int" placeholder="10" class="p-1 w-full rounded input-style text-xs text-center"></div>
                                    <div class="text-center"><span class="text-[10px] text-gray-500">WIS</span><input type="number" id="hb-mon-wis" placeholder="10" class="p-1 w-full rounded input-style text-xs text-center"></div>
                                    <div class="text-center"><span class="text-[10px] text-gray-500">CHA</span><input type="number" id="hb-mon-cha" placeholder="10" class="p-1 w-full rounded input-style text-xs text-center"></div>
                                </div>
                            </div>

                            <div class="space-y-2 bg-gray-900/50 p-3 rounded border border-gray-700">
                                <h3 class="text-gray-400 text-xs font-bold uppercase border-b border-gray-700 pb-1 mb-2">Proficiencies & Info</h3>
                                
                                <label class="block text-[10px] text-gray-500 uppercase">Saving Throws</label>
                                <input type="text" id="hb-mon-saves" placeholder="Dex +6, Con +13, Wis +9" class="w-full p-2 rounded input-style text-xs">
                                
                                <label class="block text-[10px] text-gray-500 uppercase">Skills</label>
                                <input type="text" id="hb-mon-skills" placeholder="Perception +16, Stealth +6" class="w-full p-2 rounded input-style text-xs">
                                
                                <label class="block text-[10px] text-gray-500 uppercase">Senses</label>
                                <input type="text" id="hb-mon-senses" placeholder="Blindsight 60 ft., Darkvision 120 ft." class="w-full p-2 rounded input-style text-xs">
                                
                                <label class="block text-[10px] text-gray-500 uppercase">Languages</label>
                                <input type="text" id="hb-mon-langs" placeholder="Common, Draconic" class="w-full p-2 rounded input-style text-xs">
                                
                                <div class="grid grid-cols-2 gap-2">
                                    <div><label class="block text-[10px] text-gray-500 uppercase">Challenge</label><input type="text" id="hb-mon-cr" placeholder="24" class="w-full p-2 rounded input-style text-xs"></div>
                                    <div><label class="block text-[10px] text-gray-500 uppercase">XP</label><input type="text" id="hb-mon-xp" placeholder="62,000 XP" class="w-full p-2 rounded input-style text-xs"></div>
                                </div>
                                
                                <div class="hidden">
                                    <input type="number" id="hb-mon-init" value="0">
                                    <input type="number" id="hb-mon-tohit" value="0">
                                    <input type="text" id="hb-mon-atkname" value="Multiattack">
                                    <input type="text" id="hb-mon-dmg" value="See Actions">
                                </div>
                            </div>
                        </div>

                        <div class="space-y-3 mb-4">
                            <div>
                                <label class="block text-xs text-gray-500 uppercase mb-1">Traits (Passive Abilities)</label>
                                <textarea id="hb-mon-traits" rows="3" class="w-full p-2 rounded input-style text-sm resize-none" placeholder="**Legendary Resistance (3/Day).** If the dragon fails a saving throw, it can choose to succeed instead."></textarea>
                            </div>
                            <div>
                                <label class="block text-xs text-gray-500 uppercase mb-1">Actions</label>
                                <textarea id="hb-mon-actions" rows="4" class="w-full p-2 rounded input-style text-sm resize-none" placeholder="**Multiattack.** The dragon makes three attacks: one with its bite and two with its claws.&#10;**Bite.** Melee Weapon Attack: +17 to hit, reach 15 ft. Hit: 21 (2d10 + 10) piercing damage."></textarea>
                            </div>
                            <div>
                                <label class="block text-xs text-gray-500 uppercase mb-1">Reactions</label>
                                <textarea id="hb-mon-reactions" rows="2" class="w-full p-2 rounded input-style text-sm resize-none" placeholder="**Tail Attack.** The dragon makes a tail attack when a creature moves within 10 ft."></textarea>
                            </div>
                        </div>

                        <button onclick="window.previewHomebrewMonster()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 rounded-lg mb-4 transition">üëÅÔ∏è Generate Statblock Preview</button>

                        <div id="hb-monster-preview" class="hidden mb-4 border border-yellow-700/50 rounded-lg overflow-hidden shadow-inner"></div>

                        <div class="flex gap-2">
                            <button onclick="window.saveHomebrewMonster()" class="flex-1 bg-orange-700 hover:bg-orange-600 text-white font-bold py-3 rounded-lg shadow-lg transition">üíæ Save to Stats</button>
                            <button onclick="window.saveHomebrewToNotes('monster')" class="flex-1 bg-gray-600 hover:bg-gray-500 text-white font-bold py-3 rounded-lg shadow-lg transition">üìú Save Note</button>
                        </div>
                    </div>

                    <div id="brew-weapon-area" class="hidden space-y-6 animate-fade-in">
                        <div class="bg-gray-900/80 p-4 rounded-xl border border-orange-500/30 space-y-4">
                            <h3 class="text-orange-300 text-xl font-bold mb-4 text-center">Forge New Weapon</h3>
                            <div>
                                <label class="block text-orange-200 text-xs uppercase mb-1">Weapon Image</label>
                                <input type="file" id="hb-wep-image-input" accept="image/*" class="w-full bg-gray-800 text-white border border-gray-700 rounded p-2 text-sm file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-orange-600 file:text-white hover:file:bg-orange-700"/>
                                <input type="hidden" id="hb-wep-image-data">
                            </div>
                            <input type="text" id="hb-wep-name" placeholder="Weapon Name (e.g., The Shadow's Edge)" class="w-full bg-gray-800 text-white border border-gray-700 rounded p-3 focus:border-orange-500 outline-none" oninput="window.updateWeaponPreview()">
                            <div class="grid grid-cols-2 gap-4">
                                 <input type="text" id="hb-wep-meta1" placeholder="Rarity (e.g., Rare, Attunement)" class="w-full bg-gray-800 text-white border border-gray-700 rounded p-2 text-sm focus:border-orange-500 outline-none" oninput="window.updateWeaponPreview()">
                                 <input type="text" id="hb-wep-meta2" placeholder="Type (e.g., +1 Sword)" class="w-full bg-gray-800 text-white border border-gray-700 rounded p-2 text-sm focus:border-orange-500 outline-none" oninput="window.updateWeaponPreview()">
                            </div>
                            <textarea id="hb-wep-desc" rows="6" placeholder="Description & Mechanics..." class="w-full bg-gray-800 text-white border border-gray-700 rounded p-3 focus:border-orange-500 outline-none resize-none font-mono text-sm" oninput="window.updateWeaponPreview()"></textarea>
                            <div class="flex gap-2">
                                <button onclick="window.saveHomebrewWeapon()" class="flex-1 bg-gradient-to-r from-orange-600 to-red-600 hover:from-orange-500 hover:to-red-500 text-white font-bold py-3 rounded-lg shadow-lg transition tracking-wider">FORGE WEAPON</button>
                                <button onclick="window.saveHomebrewToNotes('weapon')" class="flex-1 bg-gray-600 hover:bg-gray-500 text-white font-bold py-3 rounded-lg shadow-lg transition">üìú Save Note</button>
                            </div>
                        </div>
                        <div>
                            <h3 class="text-orange-300 text-sm text-center mb-2">- Live Preview -</h3>
                            <div id="hb-weapon-card-preview" class="parchment-card">
                                <div class="card-title" id="prev-wep-name">Weapon Name</div>
                                <img id="prev-wep-img" src="" class="card-image hidden">
                                <div class="card-meta-1" id="prev-wep-meta1">Rarity, Attunement</div>
                                <div class="card-meta-2" id="prev-wep-meta2">Weapon Type</div>
                                <div class="card-body" id="prev-wep-desc">Description...</div>
                            </div>
                        </div>
                    </div>

                    <div id="brew-magic-area" class="hidden space-y-6 animate-fade-in">
                        
                        <div class="bg-gray-900/80 p-4 rounded-xl border border-pink-500/30 space-y-4">
                            <h3 class="text-pink-300 text-xl font-bold mb-4 text-center">Craft Magic Item</h3>
                            
                            <div>
                                <label class="block text-pink-200 text-xs uppercase mb-1">Item Image</label>
                                <input type="file" id="hb-item-image-input" accept="image/*" class="w-full bg-gray-800 text-white border border-gray-700 rounded p-2 text-sm file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-pink-700 file:text-white hover:file:bg-pink-600"/>
                                <input type="hidden" id="hb-item-image-data">
                            </div>

                            <input type="text" id="hb-item-name" placeholder="Item Name (e.g., Ring of Jumping)" class="w-full bg-gray-800 text-white border border-gray-700 rounded p-3 focus:border-pink-500 outline-none" oninput="window.updateItemPreview()">

                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-xs text-gray-500 uppercase">Rarity</label>
                                    <select id="hb-item-rarity" class="w-full p-2 rounded input-style text-sm" onchange="window.updateItemPreview()">
                                        <option value="Common">Common</option><option value="Uncommon">Uncommon</option>
                                        <option value="Rare">Rare</option><option value="Very Rare">Very Rare</option>
                                        <option value="Legendary">Legendary</option><option value="Artifact">Artifact</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-xs text-gray-500 uppercase">Type</label>
                                    <select id="hb-item-type" class="w-full p-2 rounded input-style text-sm" onchange="window.updateItemPreview()">
                                        <option value="Wondrous Item">Wondrous</option><option value="Ring">Ring</option>
                                        <option value="Wand">Wand</option><option value="Potion">Potion</option>
                                        <option value="Scroll">Scroll</option><option value="Staff">Staff</option>
                                        <option value="Armor">Armor</option>
                                        <option value="Weapon">Weapon</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="flex items-center gap-2 pt-2">
                                <input type="checkbox" id="hb-item-attune" class="w-4 h-4 accent-pink-500" onchange="window.updateItemPreview()">
                                <label for="hb-item-attune" class="text-sm text-gray-300">Requires Attunement</label>
                            </div>

                            <textarea id="hb-item-desc" rows="6" placeholder="Description & Mechanics..." class="w-full bg-gray-800 text-white border border-gray-700 rounded p-3 focus:border-pink-500 outline-none resize-none font-mono text-sm" oninput="window.updateItemPreview()"></textarea>

                            <div class="flex gap-2">
                                <button onclick="window.saveHomebrewMagicItem()" class="flex-1 bg-gradient-to-r from-pink-700 to-purple-700 hover:from-pink-600 hover:to-purple-600 text-white font-bold py-3 rounded-lg shadow-lg transition tracking-wider">CRAFT ITEM</button>
                                <button onclick="window.saveHomebrewToNotes('item')" class="flex-1 bg-gray-600 hover:bg-gray-500 text-white font-bold py-3 rounded-lg shadow-lg transition">üìú Save Note</button>
                            </div>
                        </div>

                        <div>
                            <h3 class="text-pink-300 text-sm text-center mb-2">- Live Preview -</h3>
                            <div id="hb-item-card-preview" class="parchment-card">
                                <div class="card-title" id="prev-item-name">Item Name</div>
                                <img id="prev-item-img" src="" class="card-image hidden">
                                <div class="card-meta-1" id="prev-item-meta1">Rarity, Attunement</div>
                                <div class="card-meta-2" id="prev-item-meta2">Item Type</div>
                                <div class="card-body" id="prev-item-desc">Description...</div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="brew-community-area" class="hidden animate-fade-in">
                        <div class="flex justify-center gap-2 mb-4 sticky top-0 z-20 bg-gray-900/90 backdrop-blur p-2 rounded-lg border border-gray-700 shadow-lg">
                            <button onclick="window.filterCommunity('all')" class="com-filter-btn active text-xs font-bold px-3 py-1 rounded-full bg-indigo-600 text-white transition">All</button>
                            <button onclick="window.filterCommunity('monster')" class="com-filter-btn text-xs font-bold px-3 py-1 rounded-full text-gray-400 hover:text-white transition">üê≤ Monsters</button>
                            <button onclick="window.filterCommunity('weapon')" class="com-filter-btn text-xs font-bold px-3 py-1 rounded-full text-gray-400 hover:text-white transition">‚öîÔ∏è Weapons</button>
                            <button onclick="window.filterCommunity('item')" class="com-filter-btn text-xs font-bold px-3 py-1 rounded-full text-gray-400 hover:text-white transition">üíç Items</button>
                        </div>
                        <div id="community-list" class="columns-1 sm:columns-2 md:columns-3 gap-4 space-y-4 pb-20">
                            <p class="text-center text-gray-500 text-xs pt-10 col-span-full">Loading the gallery...</p>
                        </div>
                    </div>
                    
                    <div id="my-inventory-container">
                        <hr class="border-gray-700 my-4">
                        <h3 class="text-sm font-bold text-indigo-300 mb-2">My Inventory</h3>
                        <div id="homebrew-weapon-list" class="space-y-2 max-h-60 overflow-y-auto">
                            <p class="text-center text-gray-500 text-xs">No items saved.</p>
                        </div>
                    </div>
                </div>
            </div>

            <div id="maps" class="tab-content hidden">
    <div class="card p-4 rounded-lg shadow-xl border border-emerald-500/30">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-semibold text-emerald-300">Realm Cartographer</h2>
            <div class="flex gap-2">
                <button onclick="window.generateContinent()" class="bg-emerald-700 hover:bg-emerald-600 text-white font-bold py-1 px-3 rounded text-xs shadow">üé≤ Generate Land</button>
                <button onclick="document.getElementById('map-upload').click()" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-1 px-3 rounded text-xs shadow">üìÅ Upload Image</button>
                <input type="file" id="map-upload" class="hidden" accept="image/*" onchange="window.uploadMapImage(this)">
            </div>
        </div>

        <div class="flex gap-2 mb-4">
    <button onclick="window.openSaveModal()" class="flex-1 bg-emerald-700 hover:bg-emerald-600 text-white font-bold py-2 px-4 rounded border border-emerald-500 shadow-lg text-xs uppercase tracking-wider transition">
        üíæ Save to Folder
    </button>
    <button onclick="window.openLoadModal()" class="flex-1 bg-blue-700 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded border border-blue-500 shadow-lg text-xs uppercase tracking-wider transition">
        üìÇ Open Folder
    </button>
</div>

<div id="save-map-modal" class="hidden fixed inset-0 bg-black/80 z-50 flex items-center justify-center backdrop-blur-sm">
    <div class="bg-gray-900 border border-gray-600 p-6 rounded-lg w-96 shadow-2xl relative">
        <h3 class="text-white text-lg font-cinzel mb-4 border-b border-gray-700 pb-2">Name this Map</h3>
        <input type="text" id="save-map-name" placeholder="e.g. The Northern Realms" class="w-full bg-gray-800 text-white border border-gray-600 p-2 rounded mb-4 focus:border-emerald-500 outline-none">
        <div class="flex justify-end gap-2">
            <button onclick="document.getElementById('save-map-modal').classList.add('hidden')" class="px-4 py-2 text-gray-400 hover:text-white transition">Cancel</button>
            <button onclick="window.confirmSaveMap()" class="px-4 py-2 bg-emerald-600 hover:bg-emerald-500 text-white rounded font-bold shadow-lg transition">Save</button>
        </div>
    </div>
</div>

<div id="load-map-modal" class="hidden fixed inset-0 bg-black/80 z-50 flex items-center justify-center backdrop-blur-sm">
    <div class="bg-gray-900 border border-gray-600 p-6 rounded-lg w-[500px] max-h-[80vh] flex flex-col shadow-2xl relative">
        <div class="flex justify-between items-center mb-4 border-b border-gray-700 pb-2">
            <h3 class="text-white text-lg font-cinzel">Campaign Maps</h3>
            <button onclick="document.getElementById('load-map-modal').classList.add('hidden')" class="text-gray-400 hover:text-white">&times;</button>
        </div>
        <div id="saved-maps-list" class="flex-1 overflow-y-auto space-y-2 pr-2">
            <div class="text-gray-500 text-center text-sm italic py-4">Loading folder...</div>
        </div>
    </div>
</div>

        <div class="mb-3">
    <input type="text" id="map-title-input" placeholder="Enter Realm Name (leave empty for random)" 
           class="w-full p-2 rounded bg-gray-900 border border-gray-700 text-white text-sm focus:border-emerald-500 focus:ring-1 focus:ring-emerald-500 outline-none placeholder-gray-600 transition">
</div>

<div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4 ..."> 
   </div>

        <div class="grid grid-cols-2 md:grid-cols-6 gap-3 mb-4 bg-gray-800 p-3 rounded-lg border border-gray-700">
    <div>
        <label class="block text-[10px] uppercase font-bold text-green-400 mb-1">üå≤ Forests</label>
        <input type="range" id="param-forests" min="0" max="40" value="12" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-green-500">
    </div>
    <div>
        <label class="block text-[10px] uppercase font-bold text-gray-400 mb-1">‚õ∞Ô∏è Mountains</label>
        <input type="range" id="param-mountains" min="0" max="20" value="8" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-gray-400">
    </div>
    <div>
        <label class="block text-[10px] uppercase font-bold text-blue-400 mb-1">üíß Rivers</label>
        <input type="range" id="param-rivers" min="0" max="100" value="80" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-blue-500">
    </div>
    <div>
        <label class="block text-[10px] uppercase font-bold text-yellow-500 mb-1">üè∞ Cities</label>
        <input type="range" id="param-cities" min="0" max="15" value="6" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-yellow-500">
    </div>
    <div>
        <label class="block text-[10px] uppercase font-bold text-purple-400 mb-1">üíÄ Secrets</label>
        <input type="range" id="param-secrets" min="0" max="10" value="4" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-purple-500">
    </div>
    <div>
        <label class="block text-[10px] uppercase font-bold text-cyan-400 mb-1">üìè Scale</label>
        <input type="text" id="param-scale" value="24 Miles" class="w-full h-5 text-[10px] px-1 bg-gray-900 border border-gray-600 rounded text-cyan-100 focus:border-cyan-500 outline-none placeholder-gray-500">
    </div>
</div>

        <div id="map-wrapper" class="relative w-full aspect-video bg-blue-900/50 rounded-xl overflow-hidden border-4 border-gray-800 shadow-2xl group select-none transition-all duration-300">
    
    <img id="active-map-image" class="w-full h-full object-contain opacity-80" style="display:none;" src="" alt="Map Area">

    <div id="map-pins-layer" class="absolute inset-0 cursor-crosshair z-10" onclick="window.handleMapClick(event)"></div>

    <div id="map-placeholder" class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none">
        <span class="text-4xl opacity-20">üó∫Ô∏è</span>
        <span class="text-gray-500 text-xs mt-2 opacity-50">Generate or Upload a Map</span>
    </div>

    <button onclick="window.toggleMapFullScreen()" 
            class="absolute bottom-4 right-4 bg-black/70 hover:bg-emerald-600 text-white p-2 rounded-lg backdrop-blur-sm border border-white/20 transition shadow-lg z-40 opacity-0 group-hover:opacity-100"
            title="Toggle Full Screen">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4" />
        </svg>
    </button>
</div>

        <div class="mt-4 flex justify-between items-center bg-gray-800 p-2 rounded-lg">
            <div class="text-xs text-gray-400">
                <span class="text-emerald-400 font-bold">Tip:</span> Click anywhere on the map to add a Location Pin.
            </div>
            <button onclick="window.saveMapState()" class="bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-2 px-6 rounded-lg text-xs transition shadow-lg">
                üíæ Save Map & Pins
            </button>
        </div>
    </div>
</div>

<div id="pin-modal" class="hidden fixed inset-0 z-[200] bg-black bg-opacity-80 flex items-center justify-center p-4 backdrop-blur-sm">
    <div class="card w-full max-w-sm p-6 rounded-xl shadow-2xl border border-emerald-500/50 bg-gray-900">
        <h3 class="text-lg font-bold text-emerald-300 mb-4">Edit Location</h3>
        <input type="hidden" id="pin-id">
        <input type="hidden" id="pin-x">
        <input type="hidden" id="pin-y">
        
        <div class="space-y-3">
            <div>
                <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">Location Name</label>
                <input type="text" id="pin-title" class="w-full p-2 rounded bg-gray-800 text-white border border-gray-700 text-sm focus:border-emerald-500 outline-none">
            </div>
            <div>
                <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">Description</label>
                <textarea id="pin-desc" rows="3" class="w-full p-2 rounded bg-gray-800 text-white border border-gray-700 text-sm focus:border-emerald-500 outline-none"></textarea>
            </div>
            <div>
                <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">Type</label>
                <select id="pin-type" class="w-full p-2 rounded bg-gray-800 text-white border border-gray-700 text-sm">
                    <option value="city">üè∞ City/Castle</option>
                    <option value="village">üèòÔ∏è Village</option>
                    <option value="dungeon">üíÄ Dungeon</option>
                    <option value="ruin">üèõÔ∏è Ruins</option>
                    <option value="forest">üå≤ Forest</option>
                    <option value="landmark">üìç Landmark</option>
                </select>
            </div>
            <div class="flex gap-2 pt-2">
                <button onclick="window.deletePin()" class="bg-red-900/50 hover:bg-red-800 text-red-200 text-xs font-bold py-2 px-3 rounded transition">Delete</button>
                <div class="flex-1"></div>
                <button onclick="document.getElementById('pin-modal').classList.add('hidden')" class="bg-gray-700 hover:bg-gray-600 text-white text-xs font-bold py-2 px-4 rounded transition">Cancel</button>
                <button onclick="window.savePin()" class="bg-emerald-600 hover:bg-emerald-500 text-white text-xs font-bold py-2 px-4 rounded transition shadow-lg">Save Pin</button>
            </div>
        </div>
    </div>
</div>



<div id="gallery-tab" class="tab-content hidden max-w-6xl mx-auto">
    
    <div class="bg-gradient-to-r from-gray-900 to-indigo-900 rounded-2xl p-8 mb-10 border border-indigo-500/30 text-center relative overflow-hidden">
        <div class="relative z-10">
            <h2 class="text-3xl font-black text-white mb-2">üé® The Artist's Guild</h2>
            <p class="text-indigo-200 mb-6 max-w-2xl mx-auto">
                Are you a fantasy artist, map maker, or mini painter? 
                <strong class="text-white">Advertise your commissions and shop here.</strong>
                Connect with thousands of DMs looking for visuals.
            </p>
            
            <button onclick="document.getElementById('artist-form').classList.toggle('hidden');" 
                class="bg-pink-600 hover:bg-pink-500 text-white font-bold py-3 px-8 rounded-full shadow-lg transform transition hover:scale-105 flex items-center gap-2 mx-auto cursor-pointer">
                <span>üì¢ Submit Your Portfolio</span>
            </button>
        </div>
        <div class="absolute top-0 left-0 w-full h-full opacity-10 pointer-events-none bg-[url('https://www.transparenttextures.com/patterns/stardust.png')]"></div>
    </div>

    <div id="artist-form" class="hidden mb-10 bg-gray-800 p-6 rounded-xl border border-gray-700 animate-fade-in max-w-2xl mx-auto">
    
        <h3 class="text-xl font-bold text-white mb-4 border-b border-gray-700 pb-2">Create Your Ad</h3>

        <div class="bg-red-900/30 border border-red-500/50 rounded-lg p-3 mb-6 flex items-start gap-3">
        <div class="text-2xl">‚ö†Ô∏è</div>
        <div>
            <p class="text-red-200 text-sm font-bold">
                Strictly NO NSFW (Not Safe For Work) or AI-Generated Content.
            </p>
            <p class="text-red-300/70 text-xs">
                This is a family-friendly community. Violators will be banned and ads deleted without refund.
            </p>
        </div>
    </div>
        
        <div class="space-y-4">
            <div>
                <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Artist / Shop Name</label>
                <input type="text" id="sub-name" class="w-full bg-gray-900 border border-gray-600 rounded p-2 text-white focus:border-pink-500 outline-none">
            </div>

            <div>
                <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Link to your Shop/Socials</label>
                <input type="url" id="sub-link" class="w-full bg-gray-900 border border-gray-600 rounded p-2 text-white focus:border-pink-500 outline-none">
            </div>

            <div>
                <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Direct Image Link (Ends in .jpg or .png)</label>
                <input type="url" id="sub-img" 
                    placeholder="Paste a link ending in .jpg or .png (Use Discord or Imgur)" 
                    class="w-full bg-gray-900 border border-gray-600 rounded p-2 text-white focus:border-pink-500 outline-none">
                <p class="text-[10px] text-gray-500 mt-1 italic">
                    <strong>Tip:</strong> Upload your art to Discord, right-click it, and select "Copy Image Address".
                </p>
            </div>

            <div>
                <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Ad Text / Title</label>
                <input type="text" id="sub-desc" class="w-full bg-gray-900 border border-gray-600 rounded p-2 text-white focus:border-pink-500 outline-none">
            </div>

            <div class="mt-6 p-6 bg-gray-900 rounded-lg border border-gray-700">
                <div class="text-center space-y-4">
                    
                    <h4 class="text-white font-bold">Step 1: Pay the Ad Fee ($10/month)</h4>
                    <p class="text-xs text-gray-400">Your support keeps this tool free for everyone!</p>
                    <p class="text-xs text-gray-400">*After a month your ad will be removed*</p>

                    <div class="mb-6">
    <label class="flex items-center gap-3 cursor-pointer group">
        <input type="checkbox" id="sfw-agree" class="w-5 h-5 rounded bg-gray-900 border-gray-600 text-pink-600 focus:ring-pink-500 focus:ring-offset-gray-900">
        <span class="text-gray-300 text-sm group-hover:text-white transition-colors">
            I confirm this artwork is <strong class="text-white">100% SFW (Safe for Work)</strong>.
        </span>
    </label>
</div>
                    
                    <a href="https://ko-fi.com/aegisdmtool" target="_blank"
                       class="block w-full py-3 bg-[#29abe0] hover:bg-[#1f8ebd] text-white font-bold rounded-lg shadow-lg transform transition hover:scale-105 flex justify-center items-center gap-2">
                       <img src="https://storage.ko-fi.com/cdn/cup-border.png" class="h-5 w-5 animate-bounce">
                       Pay $10 on Ko-fi
                    </a>

                    <div class="border-t border-gray-700 my-4"></div>

                    <h4 class="text-white font-bold">Step 2: Confirm & Post</h4>
                    
                    <div>
                        <label class="block text-xs font-bold text-gray-400 uppercase mb-1 text-left">Name used on Ko-fi</label>
                        <input type="text" id="sub-kofi-name" placeholder="e.g. John Doe" 
                            class="w-full bg-gray-800 border border-gray-600 rounded p-2 text-white focus:border-pink-500 outline-none">
                    </div>

                    <button id="submit-btn" onclick="window.submitAd()" 
                        class="w-full py-3 bg-pink-600 hover:bg-pink-500 text-white font-bold rounded-lg shadow-lg mt-4 transition-colors">
                        ‚úÖ I Have Paid - Submit Ad
                    </button>

                </div>
            </div>

        </div>
    </div>

    <div id="artist-gallery-list" class="columns-1 sm:columns-2 lg:columns-3 gap-6 space-y-6">
        <div class="text-center text-gray-500 py-20 col-span-full">Loading Artist Showcase...</div>
    </div>
</div>
        
        <!-- Rules Tab -->
        
        <div id="rules" class="tab-content hidden">
                <div class="card p-4 rounded-lg shadow-xl border border-purple-500/30">
                    <h2 class="text-xl font-semibold mb-4 text-purple-300">üßô‚Äç‚ôÇÔ∏è Grand Library</h2>
                    
                    <div class="flex border-b border-gray-700 mb-4 justify-center gap-2 overflow-x-auto">
                        <button class="rule-sub-tab active border-b-2 border-purple-400 pb-2 font-bold text-purple-300 transition px-2 text-sm" onclick="switchRuleMode('spells', this)">‚ú® Spells</button>
                        <button class="rule-sub-tab text-gray-400 pb-2 font-semibold transition hover:text-gray-200 px-2 text-sm" onclick="switchRuleMode('weapons', this)">‚öîÔ∏è Weapons</button>
                        <button class="rule-sub-tab text-gray-400 pb-2 font-semibold transition hover:text-gray-200 px-2 text-sm" onclick="switchRuleMode('armor', this)">üõ°Ô∏è Armor</button>
                        <button class="rule-sub-tab text-gray-400 pb-2 font-semibold transition hover:text-gray-200 px-2 text-sm" onclick="switchRuleMode('sections', this)">üìú Rules</button>
                    </div>

                    <div class="flex gap-2 mb-4">
                        <input type="text" id="library-search" placeholder="Search..." class="flex-1 p-2 rounded-lg input-style text-sm" onkeypress="if(event.key==='Enter') window.searchLibrary()">
                        <button onclick="window.searchLibrary()" class="bg-purple-700 hover:bg-purple-600 text-white font-bold px-4 rounded-lg text-sm">Search</button>
                    </div>

                    <div id="library-results" class="scrollable-content space-y-2 max-h-[500px]">
                        <p class="text-center text-gray-500 text-xs">Select a category and search.</p>
                    </div>
                </div>
            </div>
        
        <!-- Help Tab -->
        
        <div id="help" class="tab-content hidden">
            <div class="max-w-4xl mx-auto space-y-6">
                
                <div class="text-center mb-8">
                    <h2 class="text-3xl font-black text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-indigo-400">
                        AEGIS COMMAND CENTER
                    </h2>
                    <p class="text-gray-400 text-xs uppercase tracking-widest mt-2">Operator Manual v1.0</p>
                </div>

                <div class="card p-6 rounded-xl border border-indigo-500/30 bg-gray-900 shadow-xl">
                    <h3 class="text-xl font-bold text-indigo-300 mb-4 flex items-center gap-2">
                        <span>üó∫Ô∏è</span> How to use the VTT (Battle Link)
                    </h3>
                    <div class="space-y-4 text-sm text-gray-300 leading-relaxed">
                        <div class="bg-gray-800 p-4 rounded-lg border border-gray-700">
                            <strong class="text-white block mb-1">Step 1: Broadcast</strong>
                            <p>Go to the <strong>Combat Tab</strong> and click the <span class="text-indigo-400 font-bold">"Broadcast Link"</span> button. Send this URL to your players. They can open it on their phones‚Äîno login required.</p>
                        </div>
                        <div class="bg-gray-800 p-4 rounded-lg border border-gray-700">
                            <strong class="text-white block mb-1">Step 2: Upload Map</strong>
                            <p>In the Combat Tab, click <span class="text-indigo-400 font-bold">"Upload Reveal"</span> to choose a map image. It will instantly appear on your screen and all player screens.</p>
                        </div>
                        <div class="bg-gray-800 p-4 rounded-lg border border-gray-700">
                            <strong class="text-white block mb-1">Step 3: Tokens</strong>
                            <ul class="list-disc list-inside mt-2 space-y-1 text-gray-400">
                                <li><strong>Players:</strong> Create their own tokens when they join via the link.</li>
                                <li><strong>DM:</strong> Click the <span class="text-indigo-400 font-bold">"Token"</span> button on the map to spawn monsters.</li>
                                <li><strong>Move:</strong> Drag and drop tokens to move them. Updates are live for everyone.</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="card p-6 rounded-xl border border-yellow-500/30 bg-gray-900 shadow-xl">
                    <h3 class="text-xl font-bold text-yellow-300 mb-4 flex items-center gap-2">
                        <span>‚úçÔ∏è</span> Note Editor Secrets
                    </h3>
                    <p class="text-gray-400 text-sm mb-4">The text editor supports special codes to make your notes interactive.</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="bg-gray-800 p-3 rounded border border-gray-700">
                            <div class="text-[10px] uppercase font-bold text-gray-500 mb-1">Formatting</div>
                            <code class="block bg-black/50 p-2 rounded text-yellow-500 text-xs mb-1">**Bold Text**</code>
                            <code class="block bg-black/50 p-2 rounded text-yellow-500 text-xs mb-1">*Italic Text*</code>
                            <code class="block bg-black/50 p-2 rounded text-yellow-500 text-xs mb-1"># Big Header</code>
                            <code class="block bg-black/50 p-2 rounded text-yellow-500 text-xs">- List Item</code>
                        </div>
                        <div class="bg-gray-800 p-3 rounded border border-gray-700">
                            <div class="text-[10px] uppercase font-bold text-gray-500 mb-1">Interactive Features</div>
                            <code class="block bg-black/50 p-2 rounded text-cyan-400 text-xs mb-1">[[Note Title]]</code>
                            <span class="text-[10px] text-gray-400 block mb-2">Creates a clickable link to another note.</span>
                            
                            <code class="block bg-black/50 p-2 rounded text-indigo-400 text-xs mb-1">[[2d6+4]]</code>
                            <span class="text-[10px] text-gray-400 block">Creates a button that rolls dice when clicked.</span>
                        </div>
                    </div>
                </div>

                <div class="card p-6 rounded-xl border border-emerald-500/30 bg-gray-900 shadow-xl">
                    <h3 class="text-xl font-bold text-emerald-300 mb-6 flex items-center gap-2">
                        <span>üß©</span> Module Breakdown
                    </h3>
                    
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div class="flex gap-3">
                            <div class="text-2xl">üîÆ</div>
                            <div>
                                <h4 class="font-bold text-white text-sm">Prep</h4>
                                <p class="text-xs text-gray-400">Generate names, settlements, and combat NPCs instantly using AI.</p>
                            </div>
                        </div>
                        <div class="flex gap-3">
                            <div class="text-2xl">‚öîÔ∏è</div>
                            <div>
                                <h4 class="font-bold text-white text-sm">Combat</h4>
                                <p class="text-xs text-gray-400">Manage initiative, HP, conditions, and the VTT map.</p>
                            </div>
                        </div>
                        <div class="flex gap-3">
                            <div class="text-2xl">üëπ</div>
                            <div>
                                <h4 class="font-bold text-white text-sm">Stats</h4>
                                <p class="text-xs text-gray-400">Save custom statblocks for quick access in combat.</p>
                            </div>
                        </div>
                        <div class="flex gap-3">
                            <div class="text-2xl">üê≤</div>
                            <div>
                                <h4 class="font-bold text-white text-sm">Monsters</h4>
                                <p class="text-xs text-gray-400">Search the 5e SRD or generate new monsters with AI.</p>
                            </div>
                        </div>
                        <div class="flex gap-3">
                            <div class="text-2xl">üí∞</div>
                            <div>
                                <h4 class="font-bold text-white text-sm">Loot</h4>
                                <p class="text-xs text-gray-400">Generate treasure hoards and split coin automatically.</p>
                            </div>
                        </div>
                        <div class="flex gap-3">
                            <div class="text-2xl">‚õ∫</div>
                            <div>
                                <h4 class="font-bold text-white text-sm">Journey</h4>
                                <p class="text-xs text-gray-400">Travel calculators, weather generation, and downtime.</p>
                            </div>
                        </div>
                        <div class="flex gap-3">
                            <div class="text-2xl">üîä</div>
                            <div>
                                <h4 class="font-bold text-white text-sm">Sound</h4>
                                <p class="text-xs text-gray-400">Ambient audio loops and sound effects.</p>
                            </div>
                        </div>
                        <div class="flex gap-3">
                            <div class="text-2xl">üé®</div>
                            <div>
                                <h4 class="font-bold text-white text-sm">Art Guild</h4>
                                <p class="text-xs text-gray-400">Browse character art and maps from the community.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-8">
                    <a href="https://www.reddit.com/r/AegisDMTool/" target="_blank" class="flex items-center justify-center gap-2 bg-orange-700/50 hover:bg-orange-600/50 text-orange-200 border border-orange-500/50 font-bold py-4 rounded-xl transition">
                        <span>üí¨</span> Join the Reddit Community
                    </a>
                    <a href="https://ko-fi.com/aegisdmtool" target="_blank" class="flex items-center justify-center gap-2 bg-yellow-700/50 hover:bg-yellow-600/50 text-yellow-200 border border-yellow-500/50 font-bold py-4 rounded-xl transition">
                        <span>‚òï</span> Support Development
                    </a>
                </div>

            </div>
        </div>
 <!-- Modals -->
 <div id="edit-modal" class="hidden fixed inset-0 z-50 bg-black bg-opacity-80 flex items-center justify-center p-4">
    <div class="card w-full max-w-5xl h-[85vh] p-6 rounded-lg shadow-2xl flex flex-col bg-gray-900 border border-gray-600">
        
        <h3 class="text-2xl font-bold text-indigo-300 mb-4">Edit Note</h3>
        
        <input type="hidden" id="modal-note-id">
        <input type="hidden" id="modal-tab-name">
        
        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Title</label>
        <input type="text" id="modal-title" class="w-full p-3 rounded-lg input-style mb-4 text-lg font-bold">
        
        <div class="flex justify-between items-center mb-1">
           <label class="block text-xs font-bold text-gray-500 uppercase">Content</label>
           <span class="text-[10px] text-gray-400">Supports: **bold**, *italic*, - list</span>
       </div>
       <textarea id="modal-content" class="flex-1 w-full p-4 rounded-lg input-style mb-6 resize-none text-base leading-relaxed font-mono text-sm"></textarea>

       <div id="timeline-mentions-area" class="mt-4 p-3 bg-gray-800/50 border border-gray-700 rounded-lg">
    <h4 class="text-[10px] font-bold text-cyan-400 uppercase tracking-widest mb-2 flex items-center gap-1">
        <span>‚è≥</span> Timeline Mentions
    </h4>
    <div id="timeline-backlinks-list" class="space-y-2 text-xs text-gray-400 italic">
        No timeline events mention this note.
    </div>
</div>
        
        <div class="flex justify-end space-x-3 mt-auto">
            <button onclick="closeEditModal()" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-lg">Cancel</button>
            <button onclick="saveEditedNote()" class="bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 px-6 rounded-lg shadow-lg">Save Changes</button>
        </div>
    </div>
</div>

    <div id="edit-statblock-modal" class="hidden fixed inset-0 z-50 bg-black bg-opacity-75 flex items-center justify-center p-4">
        <div class="card w-full max-w-lg p-6 rounded-lg shadow-2xl">
            <h3 class="text-xl font-bold text-indigo-300 mb-4">Edit Statblock</h3>
            <input type="hidden" id="modal-statblock-id">
            <label class="block text-sm font-medium text-gray-400 mb-1">Name</label><input type="text" id="modal-stat-name" class="w-full p-3 rounded-lg input-style mb-4">
            <div class="grid grid-cols-2 gap-4">
                <div><label class="block text-sm font-medium text-gray-400 mb-1">HP</label><input type="number" id="modal-stat-hp" class="w-full p-3 rounded-lg input-style text-center text-sm mb-4"></div>
                <div><label class="block text-sm font-medium text-gray-400 mb-1">AC</label><input type="number" id="modal-stat-ac" class="w-full p-3 rounded-lg input-style text-center text-sm mb-4"></div>
                <div><label class="block text-sm font-medium text-gray-400 mb-1">To Hit</label><input type="number" id="modal-stat-tohit" class="w-full p-3 rounded-lg input-style text-center text-sm mb-4"></div>
                <div><label class="block text-sm font-medium text-gray-400 mb-1">Init</label><input type="number" id="modal-stat-init-mod" class="w-full p-3 rounded-lg input-style text-center text-sm mb-4"></div>
            </div>
            <label class="block text-sm font-medium text-gray-400 mb-1">Damage</label><input type="text" id="modal-stat-dmg" class="w-full p-3 rounded-lg input-style mb-6">
            <div class="flex justify-end space-x-3"><button onclick="closeStatblockEditModal()" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">Cancel</button><button onclick="saveEditedStatblock()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Save</button></div>
        </div>
    </div>

    <!-- Dice Visuals Canvas -->
    <canvas id="dice-canvas" class="fixed inset-0 pointer-events-none z-50"></canvas>
    <!-- Snow Visuals Canvas -->
    <canvas id="snow-canvas"></canvas>

    <script type="module">



    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { 
    getAuth,
    setPersistence,
    browserLocalPersistence, 
    signInWithEmailAndPassword, 
    createUserWithEmailAndPassword, 
    signOut, 
    onAuthStateChanged, 
    signInAnonymously, 
    updateEmail, 
    sendEmailVerification, 
    sendPasswordResetEmail,
    updateProfile // üëà Added this so you can change usernames
} from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

import { 
    getFirestore, 
    doc, 
    setDoc, 
    deleteDoc, 
    getDoc,
    getDocs, 
    collection, 
    query, 
    onSnapshot, 
    addDoc, 
    updateDoc, 
    writeBatch, 
    limit, 
    orderBy,
    where,
    serverTimestamp
} from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";
 // üîç DEBUG SERVER CONNECTOR
window.callMyServer = async function(promptText) {
    const myServerUrl = "https://us-central1-aegisdmtoolkit.cloudfunctions.net/generateStatblock";
    
    try {
        const response = await fetch(myServerUrl, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ prompt: promptText })
        });

        if (!response.ok) {
            const errText = await response.text();
            alert(`‚ö†Ô∏è Server Error (${response.status}):\n${errText}`);
            throw new Error(`Server Error: ${response.status}`);
        }

        const data = await response.json();
        
        // üö® THIS ALERT WILL SHOW YOU THE REAL DATA
        // Once we see this, we can remove it.
        // alert("SERVER REPLY:\n" + JSON.stringify(data, null, 2));
        console.log("Server Reply:", data);

        // 1. OpenAI Format
        if (data.choices && data.choices.length > 0) {
            return data.choices[0].message.content;
        } 
        // 2. Gemini Format
        else if (data.candidates && data.candidates.length > 0) {
            return data.candidates[0].content.parts[0].text;
        }
        // 3. Direct Text (some setups do this)
        else if (data.result) {
            return data.result;
        }
        // 4. Error inside JSON
        else if (data.error) {
            throw new Error("Server Message: " + JSON.stringify(data.error));
        }
        else {
            // If we get here, the alert above will tell us why!
            throw new Error("AI returned no recognized text. Check the popup!");
        }

    } catch (e) {
        console.error(e);
        throw e;
    }
};

    // --- 1. FIREBASE SETUP ---
    const manualFirebaseConfig = {
        apiKey: "AIzaSyB6lyGYJzk70t1OJvzBn5uyJN_k2_5NKYg",
        authDomain: "aegisdmtoolkit.firebaseapp.com",
        projectId: "aegisdmtoolkit",
        storageBucket: "aegisdmtoolkit.firebasestorage.app",
        messagingSenderId: "654767294266",
        appId: "1:654767294266:web:fbee20be7d458fb7d6f203",
        
        // üü¢ 2. MEASUREMENT ID (Must be here)
        measurementId: "G-S0Y2NKNG7R"
    };
    // Initialize Firebase
const app = initializeApp(manualFirebaseConfig);
const analytics = getAnalytics(app);

// üü¢ Assign Global Variables (So HTML buttons can see them)
window.db = getFirestore(app);
window.auth = getAuth(app);


// üü¢ Auth Tools
window.signInWithEmailAndPassword = signInWithEmailAndPassword;
window.createUserWithEmailAndPassword = createUserWithEmailAndPassword;
window.signOut = signOut;
window.onAuthStateChanged = onAuthStateChanged;

window.gatekeeperLogin = async function() {
    const emailEl = document.getElementById('session-name-input');
    const passEl = document.getElementById('session-pass-input');

    // üü¢ DATA DIAGNOSTIC (Check your F12 Console for this table!)
    console.table({
        "Email Element Found": !!emailEl,
        "Password Element Found": !!passEl,
        "Email Value": emailEl ? emailEl.value : "NULL",
        "Password Value": passEl ? passEl.value : "NULL"
    });

    if (!emailEl || !passEl) {
        alert("Developer Error: The IDs session-name-input or session-pass-input do not exist in your HTML.");
        return;
    }

    const rawInput = emailEl.value.trim();
    const pass = passEl.value; 

    if (!rawInput || !pass) {
        // üö® This is the alert you are getting. 
        // If you typed something and see this, the "Email Value" in the console table will be blank.
        alert("Please enter both Username and Password.");
        return;
    }

    try {
        console.log("üîê Attempting Firebase Login...");
        let finalEmail = rawInput.includes('@') ? rawInput : rawInput + "@aegis.local";
        await window.signInWithEmailAndPassword(window.auth, finalEmail, pass);
        document.getElementById('gatekeeper-overlay').classList.add('hidden');
    } catch (error) {
        alert("Login Failed: " + error.message);
    }
};


window.onAuthStateChanged(window.auth, (user) => {
    if (user) {
        console.log("üõ°Ô∏è Session Active:", user.uid);
        
        // 1. Start listening to pins for THIS specific DM Session
        const pinRef = window.doc(window.db, 'artifacts', 'default', 'sessions', user.uid, 'singles', 'pinned_tabs');
        
        window.onSnapshot(pinRef, (docSnapshot) => {
            if (docSnapshot.exists()) {
                window.pinnedTabs = docSnapshot.data().tabs || [];
            } else {
                // If it's a brand new session with no pins, clear the screen
                window.pinnedTabs = [];
            }
            // 2. Redraw the UI immediately
            if (window.renderPinnedTabs) window.renderPinnedTabs();
        });

    } else {
        console.log("üõ°Ô∏è No Active Session. Reverting to local storage.");
        // Fallback for guest mode
        const local = localStorage.getItem('aegis_pins');
        window.pinnedTabs = local ? JSON.parse(local) : [];
        if (window.renderPinnedTabs) window.renderPinnedTabs();
    }
});

// üü¢ Account Management Tools (Settings Menu)
window.updateEmail = updateEmail;
window.sendEmailVerification = sendEmailVerification;
window.sendPasswordResetEmail = sendPasswordResetEmail;
window.updateProfile = updateProfile; // üëà CRITICAL: Don't forget this one!

// üü¢ State Trackers (Optional, but good if you use them elsewhere)
window.userId = null; 
window.isAuthReady = false;

window.setPersistence = setPersistence;
window.browserLocalPersistence = browserLocalPersistence;
   

    // Expose Functions (FIX: Added limit and orderBy here)
    window.doc = doc; window.setDoc = setDoc; window.deleteDoc = deleteDoc; window.collection = collection;
    window.query = query; window.onSnapshot = onSnapshot; window.addDoc = addDoc; window.updateDoc = updateDoc; window.writeBatch = writeBatch;
    window.limit = limit; window.orderBy = orderBy; window.getDoc = getDoc; window.getDocs = getDocs; window.storage = getStorage(app);
window.sRef = sRef; // This fixes the "sRef is not a function" error
window.uploadBytes = uploadBytes;
window.getDownloadURL = getDownloadURL;

    // üü¢ CRITICAL FIX: Make sure ALL query tools are attached here
    window.query = query; 
    window.limit = limit; 
    window.orderBy = orderBy;
    window.where = where; // üëà This was missing!

    window.serverTimestamp = serverTimestamp;
    
    window.signInWithEmailAndPassword = signInWithEmailAndPassword;
    window.createUserWithEmailAndPassword = createUserWithEmailAndPassword;
    window.signOut = signOut;

    // --- 2. GLOBAL VARIABLES ---
    // We attach these to 'window' so the HTML buttons can see them!
    window.currentTab = 'improv'; 
    window.currentTab = 'improv'; window.currentSubTab = 'prepNotes';
    let savedStatblocks = [], combatants = [], currentTurnIndex = -1;
    // ADDED: pcNotes array
    // Define it AND attach to window immediately
let structuredNotes = { prepNotes: [], pcNotes: [], enemyNotes: [], npcNotes: [], lootNotes: [] };
window.structuredNotes = structuredNotes;
    let userApiKey = localStorage.getItem('dm_toolkit_api_key') || "";
    let isChristmasMode = localStorage.getItem('aegis_theme') === 'christmas';
    let lastGeneratedNpc = null, lastGeneratedMonster = null, lastRoll = 0;

// --- 2.5 THEME & SNOW ENGINE (RESTORED) ---
    window.toggleTheme = function() {
        isChristmasMode = !isChristmasMode;
        localStorage.setItem('aegis_theme', isChristmasMode ? 'christmas' : 'default');
        applyTheme();
    };

    function applyTheme() {
        if (isChristmasMode) {
            document.body.classList.add('christmas-mode');
            startSnow();
        } else {
            document.body.classList.remove('christmas-mode');
            stopSnow();
        }
    }

    // Snow Logic
    let snowInterval;
    const snowCanvas = document.getElementById('snow-canvas');
    const snowCtx = snowCanvas ? snowCanvas.getContext('2d') : null;
    let snowflakes = [];

    function startSnow() {
        if (!snowCanvas || snowInterval) return;
        snowCanvas.width = window.innerWidth;
        snowCanvas.height = window.innerHeight;
        snowflakes = [];
        for (let i = 0; i < 100; i++) {
            snowflakes.push({
                x: Math.random() * snowCanvas.width,
                y: Math.random() * snowCanvas.height,
                r: Math.random() * 3 + 1,
                speed: Math.random() * 0.5 + 0.2
            });
        }
        snowInterval = setInterval(drawSnow, 50);
    }

    function stopSnow() {
        if (snowInterval) { clearInterval(snowInterval); snowInterval = null; }
        if (snowCtx) snowCtx.clearRect(0, 0, snowCanvas.width, snowCanvas.height);
    }

    function drawSnow() {
        if (!snowCtx) return;
        snowCtx.clearRect(0, 0, snowCanvas.width, snowCanvas.height);
        snowCtx.fillStyle = "rgba(255, 255, 255, 0.6)";
        snowCtx.beginPath();
        for (let i = 0; i < snowflakes.length; i++) {
            let f = snowflakes[i];
            snowCtx.moveTo(f.x, f.y);
            snowCtx.arc(f.x, f.y, f.r, 0, Math.PI * 2, true);
        }
        snowCtx.fill();
        moveSnow();
    }

    let angle = 0;
    function moveSnow() {
        angle += 0.005;
        for (let i = 0; i < snowflakes.length; i++) {
            let f = snowflakes[i];
            f.y += f.speed;
            f.x += Math.sin(angle + f.y/50) * 0.2;
            if (f.y > snowCanvas.height) { f.y = -10; f.x = Math.random() * snowCanvas.width; }
            if (f.x > snowCanvas.width + 5) f.x = -5;
            if (f.x < -5) f.x = snowCanvas.width + 5;
        }
    }

    // --- 3. PRIVATE SESSION HELPERS (FIXED PATHS) ---
    const getDataPath = () => {
        if (window.userId) return ['sessions', window.userId];
        return ['public', 'default']; 
    };

    // Helper for Lists (Combatants, Statblocks)
    // Path: artifacts/default/{sessions}/{userId}/{collectionName}
    const getCol = (name) => {
        const path = getDataPath();
        return window.collection(window.db, 'artifacts', 'default', path[0], path[1], name);
    };

    // Helper for Specific Items in Lists
    // Path: artifacts/default/{sessions}/{userId}/{collectionName}/{docId}
    const getDocRef = (col, id) => {
        const path = getDataPath();
        return window.doc(window.db, 'artifacts', 'default', path[0], path[1], col, id);
    };

    // Helper for Shared Single Docs (Notes, Turn State)
    // Path: artifacts/default/{sessions}/{userId}/singles/{docName}
    // We use a 'singles' collection to hold these standalone documents cleanly
    const getSharedDoc = (name) => {
        window.getSharedDoc = getSharedDoc; // üü¢ MAKES IT VISIBLE TO THE IMPORTER
        const path = getDataPath();
        return window.doc(window.db, 'artifacts', 'default', path[0], path[1], 'singles', name);
    };

    window.saveStructuredNotes = async (tab, data) => {
        if(!window.isAuthReady) return;
        const field = `structured${tab.charAt(0).toUpperCase() + tab.slice(1)}`;
        try { await window.setDoc(getSharedDoc('shared_notes'), { [field]: data }, { merge: true }); } catch(e) { console.error(e); }
    };

// ==========================================
// üîê AUTHENTICATION & LOGIN SYSTEM (COMPLETE)
// ==========================================

// 1. LISTEN FOR LOGIN STATE
onAuthStateChanged(window.auth, (user) => {
    updateLoginUI(user);
    if (user) {
        console.log("‚úÖ User Active:", user.email);
        // Load your data here if needed (e.g., loadTimeline())
    } else {
        console.log("üí§ No User Logged In");
    }
});

// 2. MODAL CONTROLS
window.openLoginModal = () => { 
    document.getElementById('login-modal').classList.remove('hidden'); 
    document.getElementById('session-name-input').focus(); 
};
window.closeLoginModal = () => { 
    document.getElementById('login-modal').classList.add('hidden'); 
};

window.handleSessionLogin = async () => {
    const emailEl = document.getElementById('gate-name');
    const passEl = document.getElementById('gate-pass');
    const status = document.getElementById('login-status');

    const email = emailEl.value.trim().replace(/[\u200B-\u200D\uFEFF]/g, '');
    const password = passEl.value;

    // 1. STRICT EMAIL VALIDATION
    if (!email.includes('@') || !email.includes('.')) {
        alert("Please enter a valid email address. (e.g. name@example.com)");
        return;
    }

    try {
        if (status) status.textContent = "Verifying...";
        
        // 2. TRY LOGIN
        await window.signInWithEmailAndPassword(window.auth, email, password);
        document.getElementById('gatekeeper-overlay').classList.add('hidden');

    } catch (error) {
        // 3. IF USER NOT FOUND -> OFFER TO SIGN UP
        if (error.code === 'auth/user-not-found' || error.code === 'auth/invalid-credential') {
            if (confirm("Account not found. Would you like to create a new account with this email and password?")) {
                try {
                    if (status) status.textContent = "Creating Account...";
                    await window.createUserWithEmailAndPassword(window.auth, email, password);
                    document.getElementById('gatekeeper-overlay').classList.add('hidden');
                } catch (createErr) {
                    alert("Signup Failed: " + createErr.message);
                }
            }
        } else {
            alert("Error: " + error.message);
        }
    }
};

// 4. LOGOUT
window.logoutUser = async () => {
    await window.signOut(window.auth);
    window.location.reload();
};

// 5. UPDATE UI (SHOWS REAL NAME)
function updateLoginUI(user) {
    const loginBtn = document.getElementById('login-btn');
    const userProfile = document.getElementById('user-profile');
    const userName = document.getElementById('user-name');
    const userAvatar = document.getElementById('user-avatar');

    if (user) {
        if(loginBtn) loginBtn.classList.add('hidden');
        if(userProfile) userProfile.classList.remove('hidden');

        // üü¢ NAME PRIORITY: DisplayName -> Email Prefix
        let displayName = user.displayName;
        if (!displayName && user.email) {
            displayName = user.email.split('@')[0].replace(/_/g, ' '); 
        }
        
        // Update Text
        if(userName) {
            userName.innerHTML = `<span class="text-indigo-300 font-bold">${displayName || "User"}</span>`;
            userName.innerHTML += `<div class="text-[10px] text-green-400">‚óè Online</div>`;
        }
        
        // Update Avatar
        if(userAvatar) {
            userAvatar.src = `https://ui-avatars.com/api/?name=${displayName || "User"}&background=6366f1&color=fff&size=128`;
        }
    } else {
        if(loginBtn) loginBtn.classList.remove('hidden');
        if(userProfile) userProfile.classList.add('hidden');
    }
}

// üü¢ GLOBAL PRO CHECKER
window.isProUser = false;

window.auth.onAuthStateChanged(async (user) => {
    if (user) {
        window.userId = user.uid;
        
        // Listen to the User Profile in real-time
        window.onSnapshot(window.doc(window.db, "users", user.uid), (doc) => {
            const data = doc.data();
            // Check for 'isPro' field OR if it's YOU (the Admin)
            window.isProUser = data?.isPro === true || user.email === "aegisdmtoolkit@gmail.com";
            
            // Update UI buttons based on status
            updateProButtons(); 
        });
    } else {
        window.userId = null;
        window.isProUser = false;
        updateProButtons();
    }
});

// üü¢ MASTER PRO INTERFACE UPDATER
window.updateProButtons = function() {
    const lockIcon = `<svg class="w-3 h-3 text-yellow-500 inline mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" /></svg>`;
    
    // 1. Lock/Unlock VTT Buttons
    document.querySelectorAll('.pro-lock-btn').forEach(btn => {
        if (window.isProUser) {
            btn.classList.remove('opacity-50', 'cursor-not-allowed', 'grayscale');
            btn.title = ""; 
            if (btn.innerHTML.includes('text-yellow-500')) {
                 btn.innerHTML = btn.innerText.replace("üîí", "").trim(); 
            }
        } else {
            if (!btn.innerHTML.includes('text-yellow-500')) {
                btn.classList.add('opacity-50', 'cursor-not-allowed', 'grayscale');
                btn.innerHTML = lockIcon + btn.innerText.replace("üîí", "").trim();
                btn.title = "Requires Pro Subscription";
            }
        }
    });

    // 2. Handle Theme Bar
    const themeBar = document.getElementById('pro-theme-bar');
    if (themeBar) {
        if (window.isProUser) {
            themeBar.classList.add('group');
            themeBar.classList.remove('grayscale', 'opacity-60');
            themeBar.title = "Customize Theme";
        } else {
            themeBar.classList.remove('group');
            themeBar.classList.add('grayscale', 'opacity-60');
            themeBar.title = "Themes are a Pro Feature";
        }
    }

    // 3. Update Sidebar Button Text
    const proBtnText = document.getElementById('pro-btn-text');
    if (proBtnText) {
        proBtnText.innerText = window.isProUser ? "Warlord Active" : "Upgrade to Pro";
    }

    // 4. Toggle Header Crown
    const crown = document.getElementById('pro-header-crown');
    if (crown) {
        if (window.isProUser) crown.classList.remove('hidden');
        else crown.classList.add('hidden');
    }

    // 5. Switch Modal Views
    const buyView = document.getElementById('pro-tier-view');
    const activeView = document.getElementById('pro-active-view');
    if (buyView && activeView) {
        if (window.isProUser) {
            buyView.classList.add('hidden');
            activeView.classList.remove('hidden');
        } else {
            buyView.classList.remove('hidden');
            activeView.classList.add('hidden');
        }
    }

    // üü¢ 6. KILL THE ADS (Corrected ID)
    const adSpotlight = document.getElementById('ad-spotlight');
    if (adSpotlight) {
        if (window.isProUser) {
            adSpotlight.classList.add('hidden');
            adSpotlight.style.display = 'none'; 
        } else {
            adSpotlight.classList.remove('hidden');
            adSpotlight.style.display = ''; 
        }
    }

    // üü¢ 7. HIDE FOG LOCK ICON (New Addition)
    const fogLock = document.getElementById('fog-lock-icon');
    if (fogLock) {
        fogLock.style.display = 'none'; 
    }
};

    // --- 5. ROBUST DATA LISTENERS ---
    window.unsubNotes = null; window.unsubCombat = null; window.unsubStats = null; window.unsubTurn = null;

    window.setupNotesListener = () => {
    if(!window.isAuthReady) return;
    
    window.onSnapshot(getSharedDoc('shared_notes'), (doc) => {
        if(doc.exists()) {
            const d = doc.data();
            
            // Update the local variable
            structuredNotes = { 
                prepNotes: d.structuredPrepNotes||[], 
                pcNotes: d.structuredPcNotes||[], 
                enemyNotes: d.structuredEnemyNotes||[], 
                npcNotes: d.structuredNpcNotes||[], 
                lootNotes: d.structuredLootNotes||[] 
            };
        } else {
            structuredNotes = { prepNotes: [], pcNotes: [], enemyNotes: [], npcNotes: [], lootNotes: [] };
        }

        // üü¢ CRITICAL FIX: Share this data globally so Combat Tab can see it
        window.structuredNotes = structuredNotes; 

        // Update Campaign List
        if (doc.exists()) {
            const d = doc.data();
            if (d.campaignList && Array.isArray(d.campaignList)) {
                window.campaignList = d.campaignList;
            }
        }

        // Refresh UI
        window.renderCampaignSelector();
        
        // Refresh Notes Tab if open
        if(window.currentTab === 'notes') {
            window.renderStructuredNotes(window.currentSubTab);
        }
        
        // Refresh Combat Tracker Tabs if open
        // This ensures if you add a note, the tracker updates instantly
        if(window.currentTab === 'combat' && (window.currentTrackerTab === 'enemies' || window.currentTrackerTab === 'npcs')) {
            window.switchTrackerTab(window.currentTrackerTab);
        }
    });
};


// üü¢ 2. LISTENER THAT HANDLES CLEARING (Fixes the "Refresh" bug)
window.setupDMMapListener = () => {
    if (!window.userId) return;
    
    const uplinkRef = window.doc(window.db, `artifacts/default/sessions/${window.userId}/singles/shared_uplink`);
    
    let lastLoadedImage = null;
    let hasLoadedFog = false;

    window.onSnapshot(uplinkRef, (doc) => {
        // 1. Safety: If painting, ignore updates to prevent interruptions
        if (window.fog && window.fog.isDrawing) return;

        const img = document.getElementById('active-battlemap');
        const placeholder = document.getElementById('map-placeholder-text');
        
        if (doc.exists()) {
            const data = doc.data();
            
            // üü¢ CASE A: Map Exists
            if (data.activeImage && img) {
                const isNewImage = (data.activeImage !== lastLoadedImage);
                
                if (isNewImage) {
                    // New Map: Load Everything
                    console.log("üó∫Ô∏è New map detected.");
                    lastLoadedImage = data.activeImage;
                    img.src = data.activeImage;
                    img.style.display = "block";
                    
                    img.onload = () => {
                        img.style.opacity = "1";
                        if (placeholder) placeholder.classList.add('hidden');
                        
                        // Load Fog & Walls
                        if (data.walls) { window.walls = data.walls; if(window.renderWalls) window.renderWalls(); }
                        if (window.fog && window.fog.loadFogData) window.fog.loadFogData(data.fogData);
                        
                        hasLoadedFog = true;
                    };
                } else {
                    // Same Map: Update Walls, Ignore Fog (unless we haven't loaded it yet)
                    if (data.walls) { window.walls = data.walls; if(window.renderWalls) window.renderWalls(); }
                    
                    if (!hasLoadedFog) {
                        if (window.fog && window.fog.loadFogData) window.fog.loadFogData(data.fogData);
                        hasLoadedFog = true;
                    }
                }

            } else {
                // üü¢ CASE B: Map Cleared (THIS FIXES YOUR ISSUE)
                console.log("üßπ Map cleared by database.");
                
                // 1. Hide Image
                if (img) { img.src = ""; img.style.display = "none"; }
                if (placeholder) placeholder.classList.remove('hidden');
                
                // 2. Clear Walls
                window.walls = [];
                if(window.renderWalls) window.renderWalls();

                // 3. Clear Fog (Manually wipe canvas to be safe)
                const canvas = document.getElementById('fow-canvas');
                if(canvas) {
                    const ctx = canvas.getContext('2d');
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                }

                // 4. Reset State
                lastLoadedImage = null;
                hasLoadedFog = false;
            }
        }
    });
};

    window.setupCombatDataListeners = () => {
        if(!window.isAuthReady) return;
        const status = document.getElementById('db-status');
        if (window.unsubCombat) window.unsubCombat();
        if (window.unsubTurn) window.unsubTurn();

        // Note: 'shared_combatants' is now a top-level collection in the session folder
        window.unsubCombat = window.onSnapshot(window.query(getCol('shared_combatants')), (snap) => {
            combatants = []; 
            snap.forEach(d => combatants.push({id: d.id, ...d.data()}));
            combatants.sort((a,b) => (b.init||0) - (a.init||0));
            renderCombatants();
            if(status) { status.textContent = "Connected"; status.className = "text-xs px-2 py-1 rounded bg-gray-700 text-green-400"; }
        });

        window.unsubTurn = window.onSnapshot(getSharedDoc('shared_combat_state'), (doc) => {
            currentTurnIndex = doc.exists() ? (doc.data().currentTurnIndex || 0) : -1;
            renderCombatants();
        });
    };

    window.setupStatblocksListener = () => {
        if(!window.isAuthReady) return;
        if (window.unsubStats) window.unsubStats();
        window.unsubStats = window.onSnapshot(window.query(getCol('dm_toolkit_statblocks')), (snap) => {
            savedStatblocks = []; 
            snap.forEach(d => savedStatblocks.push({id: d.id, ...d.data()}));
            savedStatblocks.sort((a,b) => a.name.localeCompare(b.name));
            renderStatblocks();
        });
    };



// --- 7. CORE NAVIGATION (Master Color Controller) ---
    window.switchTab = function(tabId) {
        window.currentTab = tabId;
        
        // 1. Hide all tab content areas
        document.querySelectorAll('.tab-content, .tab-section').forEach(el => el.classList.add('hidden'));
        
        // 2. Show the selected tab content
        let target = document.getElementById(tabId); 
        if (!target) target = document.getElementById('tab-' + tabId); // Finds 'tab-home'
        if(target) target.classList.remove('hidden');
        
        // --- 3. SIDEBAR HIGHLIGHT LOGIC ---
        
        // Define the color themes for each tab
        const tabThemes = {
            'improv':     { text: 'text-indigo-200', bg: 'bg-indigo-600/20' },
            'combat':     { text: 'text-red-200',    bg: 'bg-red-600/20' },
            'statblocks': { text: 'text-yellow-200', bg: 'bg-yellow-600/20' },
            'monsters':   { text: 'text-emerald-200',bg: 'bg-emerald-600/20' },
            'loot':       { text: 'text-amber-200',  bg: 'bg-amber-600/20' },
            'travel':     { text: 'text-green-200',  bg: 'bg-green-600/20' },
            'soundboard': { text: 'text-pink-200',   bg: 'bg-pink-600/20' },
            'gallery-tab':{ text: 'text-orange-200', bg: 'bg-orange-600/20' },
            'notes':      { text: 'text-cyan-200',   bg: 'bg-cyan-600/20' },
            'maps':       { text: 'text-teal-200',   bg: 'bg-teal-600/20' },
            'homebrew':   { text: 'text-blue-200',   bg: 'bg-blue-600/20' },
            'rules':      { text: 'text-purple-200', bg: 'bg-purple-600/20' },
            'help':       { text: 'text-gray-200',   bg: 'bg-gray-600/20' }
        };

        // Helper to strip all possible active colors from a button
        const removeAllColors = (btn) => {
            Object.values(tabThemes).forEach(theme => {
                btn.classList.remove(theme.text, theme.bg);
            });
            btn.classList.remove('border-l-4', 'border-cyan-500', 'bg-opacity-20');
        };

        // Iterate all drawer buttons to update their state
        document.querySelectorAll('.drawer-btn').forEach(btn => {
            // A. Clean up the button (Remove old active state)
            removeAllColors(btn);
            btn.classList.add('text-gray-400'); // Set to default inactive gray
            
            // B. Check if this is the active button
            // We look at the onclick attribute to see if it links to the current tab
            if (btn.getAttribute('onclick') && btn.getAttribute('onclick').includes(`'${tabId}'`)) { 
                
                // C. Apply the specific theme color
                const theme = tabThemes[tabId] || { text: 'text-indigo-200', bg: 'bg-indigo-600/20' }; // Default fallback
                
                btn.classList.remove('text-gray-400');
                btn.classList.add(theme.text, theme.bg, 'border-l-4', 'border-cyan-500');
            }
        });
        
        // 4. Highlight the HOME Button (Special Case)
        const homeBtn = document.getElementById('nav-home');
        if (homeBtn) {
            if (tabId === 'home') {
                homeBtn.classList.remove('border-gray-700', 'text-gray-400', 'hover:border-teal-400');
                homeBtn.classList.add('border-teal-400', 'text-white', 'bg-gray-700');
            } else {
                homeBtn.classList.add('border-gray-700', 'text-gray-400', 'hover:border-teal-400');
                homeBtn.classList.remove('border-teal-400', 'text-white', 'bg-gray-700');
            }
        }
        
        // 5. Special case: Sub-tabs and Lazy Loading
        if (tabId === 'notes') window.switchSubTab(window.currentSubTab);
        if (tabId === 'gallery-tab') setTimeout(window.loadArtistGallery, 100);
    };

window.switchSubTab = function(subTabId) {
    window.currentSubTab = subTabId;

    // 1. Clear search box (Standard behavior)
    const searchInput = document.getElementById('notes-search');
    if(searchInput) searchInput.value = "";

    // 2. Hide ALL sub-tab contents first
    document.querySelectorAll('.sub-tab-content').forEach(el => el.classList.add('hidden'));

    // 3. Show the TARGET sub-tab
    const targetId = subTabId.includes('-sub-content') ? subTabId : subTabId + '-sub-content';
    const target = document.getElementById(targetId);
    if(target) target.classList.remove('hidden');

    // 4. Update Button Styles
    document.querySelectorAll('.sub-tab-button').forEach(btn => {
        btn.classList.remove('active', 'text-indigo-400', 'border-b-2', 'border-indigo-500');
        btn.classList.add('text-gray-400');
        
        if (btn.dataset.subtab === subTabId || (btn.getAttribute('onclick') && btn.getAttribute('onclick').includes(`'${subTabId}'`))) {
            btn.classList.remove('text-gray-400');
            btn.classList.add('active', 'text-indigo-400', 'border-b-2', 'border-indigo-500');
        }
    });

    // 5. Timeline vs Notes Logic
    const globalBtn = document.getElementById('global-add-note-btn'); 
    const searchBar = document.getElementById('notes-controls');

    if (subTabId === 'timeline') {
        if(globalBtn) globalBtn.classList.add('hidden');
        if(searchBar) searchBar.classList.add('hidden');
        if(window.loadHorizontalTimeline) window.loadHorizontalTimeline();
    } else {
        if(globalBtn) globalBtn.classList.remove('hidden');
        if(searchBar) searchBar.classList.remove('hidden');
        if(window.renderStructuredNotes) window.renderStructuredNotes(window.currentSubTab);
    }
};


    
    window.addNewNote = (tab) => { structuredNotes[tab].unshift({ id: crypto.randomUUID(), title: 'New Note', content: 'Details...' }); window.saveStructuredNotes(tab, structuredNotes[tab]); };
    // --- CONFIRMATION ADDED: DELETE NOTE ---
window.deleteNote = (id, tab) => {
    
    // üü¢ CRITICAL: Add Confirmation Dialog
    const confirmed = confirm("‚ö†Ô∏è Are you sure you want to permanently delete this note? This action cannot be undone.");

    if (!confirmed) {
        // If the user clicks 'Cancel', stop the function here
        return;
    }
    
    // Proceed with deletion: filter out the note and save the new list
    // We filter the array in the specified tab
    structuredNotes[tab] = structuredNotes[tab].filter(n => n.id !== id);
    
    // Save the updated list back to the database
    window.saveStructuredNotes(tab, structuredNotes[tab]);
    
    // Re-render the notes list to reflect the change
    window.renderStructuredNotes(tab);
};
    // ==========================================
// üõ†Ô∏è FINAL EDIT FIX: Reverse-Engineer HTML to Markdown
// ==========================================
window.editNote = function(id, tab) {
    let note = null;
    let title = "Edit Note";
    let content = "";

    // 1. Try to find the raw data in memory (Preferred)
    if (window.structuredNotes && window.structuredNotes[tab]) {
        note = window.structuredNotes[tab].find(n => n.id === id);
    }

    if (note) {
        // ‚úÖ Success: We have the original symbols (e.g. **Bold**)
        title = note.title;
        content = note.content;
    } else {
        // ‚ö†Ô∏è Fallback: We have to read the HTML from the screen.
        // We must convert the HTML tags BACK into symbols.
        console.warn(`Note ID ${id} not found in memory. Reversing HTML...`);
        const card = document.getElementById('note-' + id);
        
        if (card) {
            const titleEl = card.querySelector('.collapsible-header span');
            if (titleEl) title = titleEl.innerText;

            const contentDiv = card.querySelector('.font-sans');
            if (contentDiv) {
                // Get the HTML, not just text
                let html = contentDiv.innerHTML;

                // üîÑ REVERSE PARSER: HTML -> Markdown Symbols
                content = html
                    .replace(/<strong[^>]*>(.*?)<\/strong>/gi, "**$1**") // Bold
                    .replace(/<b[^>]*>(.*?)<\/b>/gi, "**$1**")
                    .replace(/<em[^>]*>(.*?)<\/em>/gi, "*$1*") // Italic
                    .replace(/<i[^>]*>(.*?)<\/i>/gi, "*$1*")
                    .replace(/<h3[^>]*>(.*?)<\/h3>/gi, "# $1\n") // Header 1
                    .replace(/<h4[^>]*>(.*?)<\/h4>/gi, "## $1\n") // Header 2
                    .replace(/<li[^>]*>(.*?)<\/li>/gi, "- $1\n") // Lists
                    .replace(/<br\s*\/?>/gi, "\n") // Newlines
                    .replace(/&lt;/g, "<").replace(/&gt;/g, ">").replace(/&amp;/g, "&"); // Symbols

                // Clean up extra whitespace created by the conversion
                content = content.replace(/\n\s+\n/g, "\n\n").trim();
            } else {
                alert("Error: Note content missing. Please refresh.");
                return;
            }
        }
    }

    // 2. Load into Modal
    document.getElementById('modal-note-id').value = id;
    document.getElementById('modal-tab-name').value = tab;
    document.getElementById('modal-title').value = title;
    document.getElementById('modal-content').value = content;

    // üü¢ TRIGGER BACKLINKS
    window.updateTimelineBacklinks(title);

    
    // 3. Show Modal
    document.getElementById('edit-modal').classList.remove('hidden');
};
    window.saveEditedNote = () => {
        const id = document.getElementById('modal-note-id').value, tab = document.getElementById('modal-tab-name').value;
        const idx = structuredNotes[tab].findIndex(x => x.id === id);
        if(idx > -1) {
            structuredNotes[tab][idx].title = document.getElementById('modal-title').value;
            structuredNotes[tab][idx].content = document.getElementById('modal-content').value;
            window.saveStructuredNotes(tab, structuredNotes[tab]);
        }
        document.getElementById('edit-modal').classList.add('hidden');
    };
    window.closeEditModal = () => document.getElementById('edit-modal').classList.add('hidden');

    window.updateApiKey = function(val) { userApiKey = val.trim(); localStorage.setItem('dm_toolkit_api_key', userApiKey); const status = document.getElementById('api-key-status'); if(userApiKey.length > 5) { status.textContent = "Key saved!"; status.className="mt-2 text-xs text-green-400"; } else { status.textContent = "Key empty"; status.className="mt-2 text-xs text-red-400"; } };
    window.saveApiKey = function() { window.updateApiKey(document.getElementById('user-api-key').value); };

    // --- 7. COMBAT & STATBLOCKS ---
    // ==========================================
// ‚öîÔ∏è FIX: ADD COMBATANT (SUPPORTS BULK ENTRY)
// ==========================================
window.addCombatant = async () => { 
    const rawName = document.getElementById('combatant-name').value.trim(); 
    if(!rawName) return; 
    
    // üü¢ READ NEW COUNT FIELD
    const count = parseInt(document.getElementById('combatant-count').value) || 1;
    
    const initRoll = parseInt(document.getElementById('combatant-init').value) || 0; 
    const hp = parseInt(document.getElementById('combatant-hp').value) || 0; 
    const ac = parseInt(document.getElementById('combatant-ac').value) || 0; 
    
    const batch = window.writeBatch(window.db);
    const combatantsCollection = getCol('shared_combatants');

    for (let i = 1; i <= count; i++) {
        // 1. Determine Name
        // Append sequential number only if count > 1
        const combatantName = count > 1 ? `${rawName} ${i}` : rawName;
        
        // 2. Determine Initiative Roll (Randomize if base Initiative Modifier is 0)
        // If initRoll is 0 (meaning no input, maybe a random monster), roll a d20
        let finalInitRoll = initRoll;
        if (rawName === "Random Monster" || initRoll === 0) {
            // Use the D20 roller logic for a random roll if needed, but for minion bulk add, 
            // DMs usually rely on an overall static modifier/roll for minion groups.
            // For simplicity and quick entry, we will only randomize if the count is 1.
            if (count === 1) {
                // If adding a single, manually entered NPC, we assume the user provides the roll + mod.
                // If they enter 0, they should roll themselves.
            }
        }
        
        // 3. Create the document reference and add to batch
        const newDocRef = window.doc(combatantsCollection);
        batch.set(newDocRef, { 
            name: combatantName, 
            init: finalInitRoll, // We trust the user's input for the final roll + modifier
            maxHp: hp, 
            currentHp: hp, 
            ac: ac, 
            initModifier: finalInitRoll // Keep for display consistency, even if it's the rolled value
        });
    }

    // 4. Commit all operations at once
    await batch.commit();

    // 5. Clear fields only after successful commit
    document.getElementById('combatant-name').value = ''; 
    document.getElementById('combatant-count').value = '1';
};
    window.modHp = async (id, idx, mul) => { const val = parseInt(document.getElementById(`dmg-${idx}`).value); if(isNaN(val)) return; const c = combatants[idx]; const newHp = Math.max(0, Math.min(c.maxHp, c.currentHp + (val * mul))); await window.updateDoc(getDocRef('shared_combatants', id), { currentHp: newHp }); document.getElementById(`dmg-${idx}`).value = ''; };
    window.delCombatant = async (id) => await window.deleteDoc(getDocRef('shared_combatants', id));
    window.clearCombat = async () => {
    if(!confirm("‚ö†Ô∏è FACTORY RESET: Clear everything and reload?")) return;

    window.showToast("Cleaning database...", "info");

    try {
        const batch = window.writeBatch(window.db);
        
        // 1. DELETE COMBATANTS
        combatants.forEach(c => {
            const ref = window.doc(window.db, `artifacts/default/sessions/${window.userId}/shared_combatants`, c.id);
            batch.delete(ref);
        });

        // 2. DELETE STATE
        const stateRef = window.doc(window.db, `artifacts/default/sessions/${window.userId}/singles/shared_combat_state`);
        batch.delete(stateRef);

        // 3. DELETE TOKENS
        const tokenCol = window.collection(window.db, `artifacts/default/sessions/${window.userId}/vtt_tokens`);
        const tokenSnap = await window.getDocs(tokenCol);
        tokenSnap.forEach(doc => batch.delete(doc.ref));

        // 4. CLEAR SHARED MAP & FOG (Crucial before reload)
        const uplinkRef = window.doc(window.db, `artifacts/default/sessions/${window.userId}/singles/shared_uplink`);
        batch.set(uplinkRef, { 
            activeImage: null, 
            fogData: null 
        }, { merge: true });

        // 5. COMMIT CHANGES
        await batch.commit();

        // üü¢ 6. THE HARD REFRESH
        // This wipes all memory, listeners, and variables, giving you a fresh start.
        window.location.reload();

    } catch (e) {
        console.error("Clear Error:", e);
        window.showToast("Failed to clear combat", "error");
    }
};
    window.nextTurn = async () => { if(!combatants.length) return; const next = (currentTurnIndex + 1) % combatants.length; await window.setDoc(getSharedDoc('shared_combat_state'), { currentTurnIndex: next }); };
    window.sortInitiative = async () => { await window.setDoc(getSharedDoc('shared_combat_state'), { currentTurnIndex: 0 }); };
    window.saveStatblock = async () => { const name = document.getElementById('stat-name').value.trim(); if(!name) return; await window.addDoc(getCol('dm_toolkit_statblocks'), { name, hp: parseInt(document.getElementById('stat-hp').value)||0, ac: parseInt(document.getElementById('stat-ac').value)||0, toHit: parseInt(document.getElementById('stat-tohit').value)||0, initMod: parseInt(document.getElementById('stat-init-mod').value)||0, dmg: document.getElementById('stat-dmg').value, timestamp: new Date().toISOString() }); document.getElementById('stat-name').value = ''; };
    window.delStat = async (id) => await window.deleteDoc(getDocRef('dm_toolkit_statblocks', id));
    window.importStat = (n, h, i, a) => { document.getElementById('combatant-name').value = n; document.getElementById('combatant-hp').value = h; document.getElementById('combatant-init').value = i; document.getElementById('combatant-ac').value = a; window.switchTab('combat'); };
    
    // Conditions Logic
    const dndConditions = ['Blinded', 'Charmed', 'Deafened', 'Frightened', 'Grappled', 'Incapacitated', 'Invisible', 'Paralyzed', 'Petrified', 'Poisoned', 'Prone', 'Restrained', 'Stunned', 'Unconscious', 'Exhaustion', 'Concentrating'];
    window.addCondition = async (id, cond) => { if (!cond) return; const c = combatants.find(x => x.id === id); if (!c) return; const current = c.conditions || []; if (current.includes(cond)) return; const updated = [...current, cond]; await window.updateDoc(getDocRef('shared_combatants', id), { conditions: updated }); };
    window.removeCondition = async (id, cond) => { const c = combatants.find(x => x.id === id); if (!c) return; const current = c.conditions || []; const updated = current.filter(x => x !== cond); await window.updateDoc(getDocRef('shared_combatants', id), { conditions: updated }); };

    function renderCombatants() { 
        const list = document.getElementById('initiative-list'); if(!list) return; 
        list.innerHTML = combatants.length ? '' : '<p class="text-center text-gray-500 pt-8">No combatants.</p>'; 
        
        const conditionOptions = dndConditions.map(cond => `<option value="${cond}">${cond}</option>`).join('');
        
        combatants.forEach((c, idx) => { 
            const active = idx === currentTurnIndex ? 'bg-indigo-700 glow-shadow' : 'bg-gray-700'; 
            
            // 1. Format the Modifier (e.g. "+3" or "-1")
            // We use (c.initModifier || 0) to ensure it doesn't break if undefined
            const modVal = parseInt(c.initModifier) || 0;
            const modStr = (modVal >= 0 ? '+' : '') + modVal;

            // Condition Badges
            const conditionBadges = (c.conditions || []).map(cond => `<span onclick="removeCondition('${c.id}', '${cond}')" class="inline-block cursor-pointer bg-red-900/80 hover:bg-red-800 text-red-100 text-[10px] px-1.5 py-0.5 rounded border border-red-700 mr-1 mb-1 select-none">${cond} &times;</span>`).join('');
            
            const div = document.createElement('div'); div.className = `flex items-start space-x-2 p-3 rounded-lg transition ${active}`; 
            
            div.innerHTML = `
                <div class="flex flex-col items-center justify-center w-12 mr-1 pt-1">
                    <div class="text-xl font-bold text-white leading-none">${c.init}</div>
                    <div class="text-[10px] text-gray-400 font-mono mt-1" title="Dex Modifier">(${modStr})</div>
                </div>

                <div class="flex-1 min-w-0">
                    <div class="font-semibold text-sm text-white truncate">${c.name}</div>
                    <div class="text-xs text-gray-300">HP: ${c.currentHp}/${c.maxHp} | AC: ${c.ac}</div>
                    <div class="mt-2">
                        <div class="flex flex-wrap gap-1 mb-1">${conditionBadges}</div>
                        <select onchange="addCondition('${c.id}', this.value); this.value='';" class="bg-gray-800 text-[10px] text-gray-400 border border-gray-600 rounded px-1 py-0.5"><option value="">+ Condition</option>${conditionOptions}</select>
                    </div>
                </div>
                
                <div class="flex flex-col items-end gap-2">
                    <div class="flex items-center gap-1">
                        <input type="number" id="dmg-${idx}" class="w-10 p-1 text-xs rounded text-black" placeholder="Amt">
                        <button onclick="modHp('${c.id}', ${idx}, 1)" class="bg-green-600 hover:bg-green-500 px-2 py-1 rounded text-xs font-bold">Heal</button>
                        <button onclick="modHp('${c.id}', ${idx}, -1)" class="bg-red-600 hover:bg-red-500 px-2 py-1 rounded text-xs font-bold">Dmg</button>
                    </div>
                    <button onclick="delCombatant('${c.id}')" class="text-gray-400 hover:text-red-400 text-xs underline">Remove</button>
                </div>`; 
            list.appendChild(div); 
        }); 
        
        const sel = document.getElementById('combatant-selector');
        if(sel) { sel.innerHTML = '<option value="" disabled selected>Target</option>'; combatants.forEach((c,i) => sel.innerHTML += `<option value="${i}">${c.name}</option>`); }
        const btn = document.getElementById('assign-roll-button'); if(btn) btn.disabled = combatants.length === 0 || lastRoll === 0;
    }
    
    function renderStatblocks() { const list = document.getElementById('statblocks-list'); if(!list) return; list.innerHTML = savedStatblocks.length ? '' : '<p class="text-center text-gray-500">No stats.</p>'; savedStatblocks.forEach(s => { const div = document.createElement('div'); div.className = 'card p-2 mb-2 bg-gray-800'; const safeName = s.name.replace(/'/g, "\\'"); div.innerHTML = `<div class="flex justify-between font-bold text-indigo-300"><span>${s.name}</span><div class="gap-2 flex"><button onclick="editStatblock('${s.id}')" class="text-xs text-blue-400">Edit</button><button onclick="delStat('${s.id}')" class="text-xs text-red-400">Del</button></div></div><div class="text-xs text-gray-300 grid grid-cols-2 gap-1 mt-1"><span>HP: ${s.hp}</span><span>AC: ${s.ac}</span><span>Hit: ${s.toHit}</span><span>Init: ${s.initMod}</span></div><div class="text-xs text-yellow-500 mt-1 truncate">${s.dmg}</div><button onclick="importStat('${safeName}', ${s.hp}, ${s.initMod}, ${s.ac})" class="w-full bg-purple-900 text-xs rounded mt-2 py-1">Add to Tracker</button>`; list.appendChild(div); }); }

    // --- 8. STATBLOCK EDIT MODAL ---
    window.editStatblock = (id) => {
        const s = savedStatblocks.find(x => x.id === id); if (!s) return;
        document.getElementById('modal-statblock-id').value = id;
        document.getElementById('modal-stat-name').value = s.name;
        document.getElementById('modal-stat-hp').value = s.hp;
        document.getElementById('modal-stat-ac').value = s.ac;
        document.getElementById('modal-stat-tohit').value = s.toHit;
        document.getElementById('modal-stat-init-mod').value = s.initMod;
        document.getElementById('modal-stat-dmg').value = s.dmg;
        document.getElementById('edit-statblock-modal').classList.remove('hidden');
    };
    window.closeStatblockEditModal = () => document.getElementById('edit-statblock-modal').classList.add('hidden');
    window.saveEditedStatblock = async () => {
        const id = document.getElementById('modal-statblock-id').value; if (!id) return;
        try {
            await window.updateDoc(getDocRef('dm_toolkit_statblocks', id), {
                name: document.getElementById('modal-stat-name').value.trim(),
                hp: parseInt(document.getElementById('modal-stat-hp').value) || 0,
                ac: parseInt(document.getElementById('modal-stat-ac').value) || 0,
                toHit: parseInt(document.getElementById('modal-stat-tohit').value) || 0,
                initMod: parseInt(document.getElementById('modal-stat-init-mod').value) || 0,
                dmg: document.getElementById('modal-stat-dmg').value.trim(),
            });
            closeStatblockEditModal();
        } catch (error) { console.error("Error updating statblock:", error); }
    };

    // --- 9. DICE LOGIC ---
    window.rollD20 = function() { lastRoll = Math.floor(Math.random() * 20) + 1; document.getElementById('last-roll-display').textContent = lastRoll; const btn = document.getElementById('assign-roll-button'); if(btn) btn.disabled = combatants.length === 0 || lastRoll === 0; };
    window.assignInitiativeRoll = async function() { const selector = document.getElementById('combatant-selector'); const selectedIndex = parseInt(selector.value, 10); if (isNaN(selectedIndex) || selectedIndex < 0 || lastRoll === 0) return; const c = combatants[selectedIndex]; const modifier = c.initModifier || 0; const newInitiative = lastRoll + modifier; try { await window.updateDoc(getDocRef('shared_combatants', c.id), { init: newInitiative }); } catch (error) { console.error(error); } lastRoll = 0; document.getElementById('last-roll-display').textContent = '?'; selector.value = ''; document.getElementById('assign-roll-button').disabled = true; };
    window.rollSimple = function(sides) { document.getElementById('dice-num').value = 1; document.getElementById('dice-type').value = sides; document.getElementById('dice-mod').value = 0; window.rollCustomDice(); };
    window.rollCustomDice = function() {
        const numDice = parseInt(document.getElementById('dice-num').value, 10) || 1;
        const diceType = parseInt(document.getElementById('dice-type').value, 10) || 20;
        const modifier = parseInt(document.getElementById('dice-mod').value, 10) || 0;
        if (numDice <= 0) return;
        let totalRoll = 0; const rolls = [];
        for (let i = 0; i < numDice; i++) { const roll = Math.floor(Math.random() * diceType) + 1; rolls.push(roll); totalRoll += roll; }
        const finalTotal = totalRoll + modifier;
        const modString = modifier > 0 ? `+${modifier}` : (modifier < 0 ? `${modifier}` : '');
        const resultDisplay = document.getElementById('dice-roll-result');
        resultDisplay.textContent = finalTotal; resultDisplay.className = "text-2xl font-bold text-white animate-pulse"; setTimeout(() => { resultDisplay.className = "text-2xl font-bold text-white"; }, 200);
        let detailsText = `[${rolls.join(', ')}]`; if (modifier !== 0) detailsText += ` ${modString}`;
        document.getElementById('dice-roll-details').textContent = `${numDice}d${diceType}${modString}: ${detailsText}`;
        if (window.throwDiceVisuals) window.throwDiceVisuals(rolls, diceType);
    };

    // --- 10. AI & GENERATORS (Fully Restored) ---
    const API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent';
const combatSchema = { 
    type: "OBJECT", 
    properties: { 
        name: { type: "STRING" }, 
        level_or_cr: { type: "STRING" }, 
        armor_class_ac: { type: "INTEGER" }, 
        max_hit_points: { type: "INTEGER" }, 
        initiative_bonus: { type: "INTEGER" }, 
        
        // NEW FIELDS FOR FULL SHEET
        ability_scores: { type: "OBJECT", properties: { STR: { type: "INTEGER" }, DEX: { type: "INTEGER" }, CON: { type: "INTEGER" }, INT: { type: "INTEGER" }, WIS: { type: "INTEGER" }, CHA: { type: "INTEGER" } }, required: ["STR", "DEX", "CON", "INT", "WIS", "CHA"] },
        saving_throws: { type: "ARRAY", items: { type: "STRING" }, description: "e.g., ['Dex +5', 'Wis +3']" },
        skills: { type: "ARRAY", items: { type: "STRING" }, description: "e.g., ['Perception +4', 'Stealth +5']" },
        main_attack_action: { type: "STRING", description: "Full attack description for the main action." },
        key_feature: { type: "STRING", description: "One key ability or feature, e.g., Sneak Attack (3d6)" },
        
    }, 
    required: ["name", "level_or_cr", "armor_class_ac", "max_hit_points", "initiative_bonus", "ability_scores", "main_attack_action"] 
};
const monsterSchema = { type: "OBJECT", properties: { name: { type: "STRING" }, size: { type: "STRING" }, type: { type: "STRING" }, alignment: { type: "STRING" }, armor_class: { type: "INTEGER" }, ac_type: { type: "STRING" }, hit_points: { type: "INTEGER" }, hit_dice: { type: "STRING" }, speed: { type: "STRING" }, ability_scores: { type: "OBJECT", properties: { STR: { type: "INTEGER" }, DEX: { type: "INTEGER" }, CON: { type: "INTEGER" }, INT: { type: "INTEGER" }, WIS: { type: "INTEGER" }, CHA: { type: "INTEGER" } }, required: ["STR", "DEX", "CON", "INT", "WIS", "CHA"] }, saving_throws: { type: "ARRAY", items: { type: "STRING" } }, skills: { type: "ARRAY", items: { type: "STRING" } }, damage_vulnerabilities: { type: "ARRAY", items: { type: "STRING" } }, damage_resistances: { type: "ARRAY", items: { type: "STRING" } }, damage_immunities: { type: "ARRAY", items: { type: "STRING" } }, condition_immunities: { type: "ARRAY", items: { type: "STRING" } }, senses: { type: "STRING" }, languages: { type: "STRING" }, challenge_rating: { type: "STRING" }, xp: { type: "INTEGER" }, abilities: { type: "ARRAY", items: { type: "OBJECT", properties: { name: { type: "STRING" }, description: { type: "STRING" } } } }, actions: { type: "ARRAY", items: { type: "OBJECT", properties: { name: { type: "STRING" }, description: { type: "STRING" } } } }, legendary_actions: { type: "ARRAY", items: { type: "OBJECT", properties: { name: { type: "STRING" }, description: { type: "STRING" } } } } } };
    // --- UPDATED AI CALLER (With Auto-Retry) ---
    async function callAI(url, payload) {
        // 1. Get Key
        let key = userApiKey;
        if (!key || key === "") { 
            const inputEl = document.getElementById('user-api-key'); 
            if (inputEl && inputEl.value) { 
                key = inputEl.value.trim(); 
                userApiKey = key; 
                localStorage.setItem('dm_toolkit_api_key', key); 
            } 
        }
        if (!key) throw new Error("No API Key provided. Check Prep tab.");

        // 2. Retry Loop (Try 3 times before failing)
        const maxRetries = 3;
        for (let i = 0; i < maxRetries; i++) {
            try {
                const res = await fetch(`${url}?key=${key}`, { 
                    method: 'POST', 
                    headers: {'Content-Type': 'application/json'}, 
                    body: JSON.stringify(payload) 
                });

                // Success!
                if (res.ok) return await res.json();

                // If Server is Overloaded (503), wait and try again
                if (res.status === 503) {
                    console.warn(`Server overloaded (503). Retrying... (${i + 1}/${maxRetries})`);
                    // Wait 2 seconds before retrying
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    continue; 
                }

                // If other error, throw immediately
                throw new Error(await res.text());

            } catch (e) {
                // If this was the last try, throw the error to the user
                if (i === maxRetries - 1) throw e;
                
                // If network error, wait 1 second and retry
                await new Promise(resolve => setTimeout(resolve, 1000));
            }
        }
    }

    // Helper Function for Title Generation
    function generateTitleFromContent(content) {
        const htmlTitleMatch = content.match(/<div class="dnd-header">(.*?)<\/div>/);
        if (htmlTitleMatch) { return htmlTitleMatch[1].trim(); }
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = content;
        tempDiv.querySelectorAll('br').forEach(br => br.replaceWith('\n'));
        tempDiv.querySelectorAll('div, p').forEach(block => block.after('\n')); 
        const textContent = tempDiv.textContent || "";
        const headerMatch = textContent.match(/^#+\s*(.*?)$/m);
        if (headerMatch) { return headerMatch[1].trim(); }
        const firstLine = textContent.split('\n').find(line => line.trim().length > 0) || "";
        const cleanLine = firstLine.replace(/^[#*>\s]+/, '').trim(); 
        const shortTitle = cleanLine.substring(0, 50);
        return (shortTitle + (cleanLine.length > 50 ? '...' : '')) || 'Untitled Generated Note';
    }

    // ==========================================
    // ‚öîÔ∏è COMBAT NPC GENERATOR (MASTER VERSION)
    // ==========================================
    window.generateCombatNpc = async () => {
        const btn = document.getElementById('generate-combat-button');
        const spinner = document.getElementById('combat-loading-spinner');
        const outputDiv = document.getElementById('ai-output'); 
        
        const lvlEl = document.getElementById('npc-level');
        const classEl = document.getElementById('npc-spell-class');
        const txtEl = document.getElementById('npc-type');

        if (!lvlEl) return;

        let spellHtml = "";
        let weaponHtml = "";
        const lvl = parseInt(lvlEl.value) || 1;
        const spellClass = classEl ? classEl.value : "";
        let txt = txtEl ? txtEl.value : (spellClass || "Generic Enemy");

        if(btn) btn.disabled = true;
        if(spinner) spinner.classList.remove('hidden');
        if(outputDiv) {
            outputDiv.classList.remove('hidden');
            outputDiv.innerHTML = `<div class="text-green-400 animate-pulse">Forging high-level character...</div>`;
        }

        try {
            const isSW5e = (window.currentSystem === 'sw5e');
            const prompt = `Generate a ${isSW5e ? "Star Wars 5e" : "D&D 5e"} combat NPC (Level/CR ${lvl}, ${txt}). ${spellClass ? `Class: ${spellClass}` : ""} 
            CRITICAL: Return strictly valid JSON. 
            Schema: { "name": "Name", "ac": 15, "hp": 50, "ability_scores": {"STR": 10, "DEX": 10, "CON": 10, "INT": 10, "WIS": 10, "CHA": 10}, "attack": "Description", "special": "Description" }`;
            
            if (typeof window.callMyServer !== 'function') throw new Error("Server function missing.");
            const aiText = await window.callMyServer(prompt);
            const firstBracket = aiText.indexOf('{');
            const lastBracket = aiText.lastIndexOf('}');
            const cleanJson = aiText.substring(firstBracket, lastBracket + 1);
            const n = JSON.parse(cleanJson);

            // üü¢ 1. HARMONIZE NAMES (Crucial for fixing 'undefined' in Notes/UI)
            n.ac = n.ac || n.armor_class || n.armor_class_ac || 10;
            n.hp = n.hp || n.max_hit_points || n.hit_points || 10;
            n.level = lvl; // Hard-sync to input level
            n.attack = n.attack || n.main_attack_action || n.main_attack || n.action || "Standard Attack: +4 to hit, 1d8 damage.";
            n.special = n.special || n.key_feature || n.ability || n.trait || "";
            
            // üü¢ 2. MASTER CLASS DATABASE (Spells 1-9 & Weapons)
            if (spellClass) {
                const DB = {
                    wizard: { w: ["Quarterstaff", "Dagger"], s: { L1:["Shield","Magic Missile"], L2:["Misty Step","Mirror Image"], L3:["Fireball","Counterspell"], L4:["Polymorph","Banishment"], L5:["Wall of Force","Cone of Cold"], L6:["Disintegrate"], L7:["Forcecage"], L8:["Maze"], L9:["Wish"] } },
                    cleric: { w: ["Mace", "Warhammer"], s: { L1:["Bless","Guiding Bolt"], L2:["Spiritual Weapon","Hold Person"], L3:["Spirit Guardians","Revivify"], L4:["Death Ward","Guardian of Faith"], L5:["Flame Strike","Mass Cure Wounds"], L6:["Heal"], L7:["Fire Storm"], L8:["Holy Aura"], L9:["Mass Heal"] } },
                    sorcerer: { w: ["Dagger", "Light Crossbow"], s: { L1:["Shield","Chaos Bolt"], L2:["Scorching Ray","Misty Step"], L3:["Fireball","Haste"], L4:["Greater Invisibility"], L5:["Hold Monster"], L6:["Chain Lightning"], L7:["Finger of Death"], L8:["Sunburst"], L9:["Meteor Swarm"] } },
                    bard: { w: ["Rapier", "Dagger"], s: { L1:["Healing Word","Bane"], L2:["Shatter","Suggestion"], L3:["Hypnotic Pattern","Fear"], L4:["Dimension Door","Polymorph"], L5:["Synaptic Static"], L6:["Otto's Irresistible Dance"], L7:["Regenerate"], L8:["Power Word Stun"], L9:["Foresight"] } },
                    druid: { w: ["Quarterstaff", "Scimitar"], s: { L1:["Entangle","Thunderwave"], L2:["Moonbeam","Spike Growth"], L3:["Call Lightning","Sleet Storm"], L4:["Ice Storm","Polymorph"], L5:["Conjure Elemental"], L6:["Sunbeam"], L7:["Reverse Gravity"], L8:["Animal Shapes"], L9:["Shapechange"] } },
                    warlock: { w: ["Dagger", "Spear"], s: { L1:["Hex","Hellish Rebuke"], L2:["Darkness","Misty Step"], L3:["Hunger of Hadar","Fly"], L4:["Blight","Banishment"], L5:["Synaptic Static"], L6:["Circle of Death"], L7:["Finger of Death"], L8:["Power Word Stun"], L9:["Power Word Kill"] } },
                    paladin: { w: ["Longsword", "Shield"], s: { L1:["Bless","Shield of Faith"], L2:["Find Steed","Branding Smite"], L3:["Aura of Vitality"], L4:["Staggering Smite"], L5:["Destructive Wave"] } },
                    ranger: { w: ["Longbow", "Shortswords"], s: { L1:["Hunter's Mark"], L2:["Spike Growth"], L3:["Lightning Arrow"], L4:["Stoneskin"], L5:["Swift Quiver"] } },
                    artificer: { w: ["Light Crossbow", "Hammer"], s: { L1:["Faerie Fire","Cure Wounds"], L2:["Web","Heat Metal"], L3:["Haste","Revivify"], L4:["Arcane Eye"], L5:["Creation"] } },
                    fighter: { w: ["Greatsword", "Longbow", "Longsword & Shield"], s: null },
                    rogue: { w: ["Rapier", "Shortbow", "Daggers"], s: null },
                    barbarian: { w: ["Greataxe", "Javelins", "Handaxes"], s: null },
                    monk: { w: ["Unarmed Strike", "Quarterstaff", "Darts"], s: null }
                };

                const data = DB[spellClass.toLowerCase()];
                if (data) {
                    if (data.w) weaponHtml = `<div class='mt-2 text-xs border-t border-gray-600 pt-2 text-gray-300'><strong class='text-orange-400'>‚öîÔ∏è Loadout:</strong> ${data.w.join(", ")}</div>`;
                    if (data.s) {
                        // Math: Full Casters (L9 at Lv17), Half Casters (L5 at Lv17), 1/3 Casters (L4 at Lv19)
                        let maxS = 0;
                        const cName = spellClass.toLowerCase();
                        if (['wizard','sorcerer','cleric','druid','bard','warlock'].includes(cName)) maxS = Math.min(9, Math.ceil(lvl / 2));
                        else if (['paladin','ranger','artificer'].includes(cName)) maxS = Math.min(5, Math.floor((lvl + 1) / 4) + 1);
                        else maxS = Math.min(4, Math.floor((lvl + 1) / 6) + 1);

                        spellHtml += `<div class='mt-2 text-xs border-t border-gray-600 pt-2'><div class='font-bold text-indigo-300 mb-1'>‚ú® Spells (Lv${lvl} ${spellClass})</div>`;
                        for (let i = 1; i <= maxS; i++) {
                            if (data.s[`L${i}`]) {
                                spellHtml += `<div class='mb-0.5'><span class='text-blue-400'>L${i}:</span> <span class='text-gray-300'>${data.s[`L${i}`].join(", ")}</span></div>`;
                            }
                        }
                        spellHtml += `</div>`;
                    }
                }
            }

            // üü¢ 3. PRESERVE DATA FOR SAVING
            n.weaponHtml = weaponHtml;
            n.spellHtml = spellHtml;
            window.lastGeneratedNpc = n;     

            // üü¢ 4. RENDER UI
            const sc = n.ability_scores || {STR:10, DEX:10, CON:10, INT:10, WIS:10, CHA:10}; 
            const fMod = (s) => { const m = Math.floor(((parseInt(s)||10)-10)/2); return m>=0 ? `+${m}` : m; };
            
            outputDiv.innerHTML = `
                <div class="text-2xl font-bold text-green-400 mb-1">${n.name}</div>
                <div class="text-gray-400 text-xs mb-4 uppercase tracking-widest">Level ${n.level} ‚Ä¢ ${spellClass || "Combat NPC"}</div>

                <div class="grid grid-cols-3 gap-3 mb-4 text-center">
                    <div class="p-2 bg-gray-800 rounded border border-gray-700">
                        <div class="text-[10px] text-gray-500 uppercase">AC</div>
                        <div class="font-bold text-xl text-blue-300">${n.ac}</div>
                    </div>
                    <div class="p-2 bg-gray-800 rounded border border-gray-700">
                        <div class="text-[10px] text-gray-500 uppercase">HP</div>
                        <div class="font-bold text-xl text-green-300">${n.hp}</div>
                    </div>
                    <div class="p-2 bg-gray-800 rounded border border-gray-700">
                        <div class="text-[10px] text-gray-500 uppercase">Init</div>
                        <div class="font-bold text-xl text-yellow-300">${fMod(sc.DEX)}</div>
                    </div>
                </div>

                <div class="grid grid-cols-6 text-center text-[10px] font-bold text-gray-500 mb-1">
                    <div>STR</div><div>DEX</div><div>CON</div><div>INT</div><div>WIS</div><div>CHA</div>
                </div>
                <div class="grid grid-cols-6 text-center text-xs font-mono text-white mb-4 bg-gray-800 p-2 rounded">
                    <div>${sc.STR}(${fMod(sc.STR)})</div><div>${sc.DEX}(${fMod(sc.DEX)})</div><div>${sc.CON}(${fMod(sc.CON)})</div>
                    <div>${sc.INT}(${fMod(sc.INT)})</div><div>${sc.WIS}(${fMod(sc.WIS)})</div><div>${sc.CHA}(${fMod(sc.CHA)})</div>
                </div>

                <div class="bg-gray-800 p-3 rounded border border-gray-700 mb-4 text-left">
                    <p class="text-sm text-white mb-2"><strong class="text-red-400">Attack:</strong> ${n.attack}</p>
                    ${n.special ? `<p class="text-sm text-white"><strong class="text-purple-400">Special:</strong> ${n.special}</p>` : ''}
                    ${weaponHtml}
                </div>

                ${spellHtml}

                <button onclick="window.addNpcToStatblocks()" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 rounded-lg mb-2 mt-4 shadow-lg">üíæ Add to Tracker</button>
                <div class="grid grid-cols-3 gap-2 mt-2">
                     <button onclick="window.saveCombatNpcToNotes('prepNotes')" class="bg-gray-700 hover:bg-gray-600 text-white py-2 rounded text-xs font-bold border border-gray-500">Note</button>
                     <button onclick="window.saveCombatNpcToNotes('enemyNotes')" class="bg-red-900/80 hover:bg-red-800 text-white py-2 rounded text-xs font-bold border border-red-700">Enemy</button>
                     <button onclick="window.saveCombatNpcToNotes('npcNotes')" class="bg-blue-900/80 hover:bg-blue-800 text-white py-2 rounded text-xs font-bold border border-blue-700">NPC</button>
                </div>
            `;
            
        } catch(e) {    
            console.error(e);
            outputDiv.innerHTML = `<div class="text-red-400 font-bold p-2 border border-red-500 bg-red-900/20 rounded">Generation Error: ${e.message}</div>`;    
        } finally {    
            if(spinner) spinner.classList.add('hidden');    
            if(btn) btn.disabled = false;    
        }
    };

    // ==========================================
// üíæ FIX: ADD COMBAT NPC TO STATBLOCKS (ROBUST)
// ==========================================
window.addNpcToStatblocks = async function() {
    // 1. CRITICAL VALIDATION
    if (!window.userId) { 
        alert("üîí Please log in to a Session to save data."); 
        window.openLoginModal(); 
        return; 
    }
    
    // Ensure the required NPC data object exists
    const m = window.lastGeneratedNpc;
    if (!m || !m.name) { 
        alert("NPC data is missing. Please generate a Combat NPC first."); 
        return; 
    }

    const btn = event.target;
    const originalText = btn.innerText;
    btn.innerText = "Saving...";
    btn.disabled = true;

    try {
        // 2. EXTRACT & CALC STATS (Guaranteed numbers using parseInt or 0)
        
        // Initiative Modifier: Directly from the AI output (guaranteed to be integer or 0)
        const initModifier = parseInt(m.initiative_bonus) || 0;
        
        let toHit = initModifier; 
        let mainAttack = m.attack || m.main_attack || "Attack";

        // Try to parse the actual attack bonus from the attack string, if available
        const hitMatch = mainAttack.match(/(\+|\-)?\d+/);
        if (hitMatch) {
            // Extracts the leading sign and number (e.g., "+5" or "-1")
            toHit = parseInt(hitMatch[0], 10);
        }

        // 3. Create Database Object
        const statData = {
            name: m.name || "Unnamed NPC",
            hp: parseInt(m.max_hit_points) || 10,
            ac: parseInt(m.armor_class_ac) || 10,
            
            // üü¢ CORRECTED VALUES
            toHit: toHit || 0,        // Final To Hit Modifier
            initMod: initModifier,    // Final Initiative Modifier
            
            dmg: mainAttack,           // Name of the main attack
            timestamp: new Date().toISOString()
        };

        // 4. Save to Statblocks Collection
        await window.addDoc(getCol('dm_toolkit_statblocks'), statData);

        // 5. Success Feedback
        if(confirm(`‚úÖ Saved "${m.name}" to Statblocks!\n\nDo you want to go to the Stats tab now?`)) {
            window.switchTab('statblocks');
        }

    } catch (e) {
        console.error("Combat NPC Stat Save Error:", e);
        alert("Error saving combat statblock: " + e.message);
    } finally {
        btn.innerText = originalText;
        btn.disabled = false;
    }
};

    window.saveCombatNpcToNotes = async function(tab) {
    if (!window.isAuthReady) { alert("Please log in."); window.openLoginModal(); return; }
    
    const n = window.lastGeneratedNpc;
    if (!n) { alert("No NPC data found. Generate one first."); return; }

    const targetCampaign = await window.promptForCampaign();
    if (!targetCampaign) return;

    const scores = n.ability_scores || { STR:10, DEX:10, CON:10, INT:10, WIS:10, CHA:10 };
    const getMod = (s) => Math.floor(((parseInt(s)||10) - 10) / 2);
    const fmtStat = (val) => { 
        const v = parseInt(val)||10; 
        const mod = getMod(v); 
        return `${v} (${mod>=0?'+':''}${mod})`; 
    };

    // üü¢ BUILD MARKDOWN using the MASTER GENERATOR keys
    let md = `# ${n.name}\n`;
    md += `*Level ${n.level || '?'}, Combat NPC*\n`;
    md += `---\n`;
    md += `**AC:** ${n.ac} | **HP:** ${n.hp}\n`;
    
    // Calculate Init on the fly from DEX
    const initMod = getMod(scores.DEX);
    md += `**Init:** ${initMod >= 0 ? '+' + initMod : initMod}\n`;
    
    md += `---\n`;
    md += `**STR:** ${fmtStat(scores.STR)} | **DEX:** ${fmtStat(scores.DEX)} | **CON:** ${fmtStat(scores.CON)}\n`;
    md += `**INT:** ${fmtStat(scores.INT)} | **WIS:** ${fmtStat(scores.WIS)} | **CHA:** ${fmtStat(scores.CHA)}\n`;
    md += `---\n`;
    
    md += `\n## Actions\n`;
    // Use n.attack (Master key) and linkify the dice
    md += `**Attack.** ${window.linkifyDice(n.attack || "Standard Strike")}\n`;
    
    if (n.special) {
        md += `\n## Features\n`;
        md += `**Special.** ${window.linkifyDice(n.special)}\n`;
    }

    // üü¢ INJECT WEAPONS & SPELLS (Levels 1-9)
    if (n.weaponHtml) {
        // We strip the HTML tags so the list looks clean in Markdown
        md += `\n---\n### ‚öîÔ∏è Loadout\n${n.weaponHtml.replace(/<[^>]*>/g, '')}\n`;
    }
    if (n.spellHtml) {
        md += `\n---\n### ‚ú® Spellcasting\n${n.spellHtml.replace(/<[^>]*>/g, '')}\n`;
    }

    const newNote = { 
        id: crypto.randomUUID(), 
        title: `${n.name} (NPC)`, 
        content: md, 
        timestamp: new Date().toISOString() 
    };

    await window.finalizeSave(tab, newNote, targetCampaign);
};

    // ==========================================
// üêâ ROBUST MONSTER GENERATOR (SECURE SERVER VERSION)
// ==========================================
window.generateMonsterStatblock = async function() {
    const btn = document.getElementById('generate-monster-button');  
    const spinner = document.getElementById('monster-loading-spinner');
    const output = document.getElementById('monster-output');  
    const status = document.getElementById('monster-status-message');

const name = document.getElementById('monster-name').value;
const cr = document.getElementById('monster-cr').value;

window.sendEvent('generate_monster', { monster_name: name, difficulty: cr });

    // 1. Reset & UI Prep
    window.lastGeneratedMonster = null;  
    btn.disabled = true;  
    spinner.classList.remove('hidden');
    output.innerHTML = '<span class="text-gray-400 animate-pulse">Summoning creature...</span>';
    if(status) status.classList.add('hidden');

    try {
        const name = document.getElementById('monster-name').value;
        const cr = document.getElementById('monster-cr').value;
        
        // üü¢ IMPROVEMENT 1: STRICTOR PROMPT
        const prompt = `Generate a D&D 5e monster statblock for "${name}" (CR ${cr}). 
        The entire output MUST be a single, complete, valid JSON object following the schema provided. 
        Ensure all required numeric values (AC, HP, STR, DEX, CON, INT, WIS, CHA) are present as integers.`;

        // üü¢ 2. CALL SERVER (Replaces callAI)
        // We use the helper function we added to the top of the script
        const aiText = await callMyServer(prompt);
        
        // 3. Robust Parsing & Cleanup (Handles markdown block errors)
        let raw = {};
        try {
            // üü¢ IMPROVEMENT 2: POST-PROCESSING
            // Strip common markdown JSON wrappers (```json...```) before parsing.
            let cleanText = aiText.replace(/```json/g, '').replace(/```/g, '').trim();
            raw = JSON.parse(cleanText);
        } catch (e) {
            console.error("JSON Parsing Failed:", e);
            throw new Error("AI returned malformed data. Try regenerating or simplifying the creature name/CR.");
        }

        // 4. Map & Normalize Data (Ensures numeric fallback if the model misses a key)
        const m = {
            name: raw.name || name,
            size: raw.size || "Medium",
            type: raw.type || "Monster",
            align: raw.alignment || raw.align || "Unaligned",
            ac: parseInt(raw.ac || raw.armor_class) || 10,  
            hp: parseInt(raw.hp || raw.hit_points) || 10,   
            speed: raw.speed || "30 ft.",
            str: parseInt(raw.STR || raw.ability_scores?.STR) || 10,
            dex: parseInt(raw.DEX || raw.ability_scores?.DEX) || 10,
            con: parseInt(raw.CON || raw.ability_scores?.CON) || 10,
            int: parseInt(raw.INT || raw.ability_scores?.INT) || 10,
            wis: parseInt(raw.WIS || raw.ability_scores?.WIS) || 10,
            cha: parseInt(raw.CHA || raw.ability_scores?.CHA) || 10,
            cr: raw.cr || raw.challenge_rating || cr, 
            traits: raw.traits || raw.special_abilities || [],
            actions: raw.actions || [],
            legendary: raw.legendary_actions || []
        };

        // 5. CRITICAL: Store the cleaned data globally for the save buttons
        window.lastGeneratedMonster = m;

        // 6. Build and Display HTML Statblock (Reusing your existing rendering logic)
        const fmtMod = (score) => { const mod = Math.floor(((parseInt(score) || 10) - 10) / 2); return mod >= 0 ? `+${mod}` : mod; };
        const fmtText = (arr) => arr.map(t => `<div><strong class="italic">${t.name}.</strong> ${t.description||t.desc}</div>`).join('');
        
        let html = `
            <div class="dnd-statblock text-left">
                <div class="dnd-header">${m.name}</div>
                <div class="italic text-black text-sm">${m.size} ${m.type}, ${m.align}</div>
                <div class="tapered-rule"></div>
                <div class="text-sm text-red-900 leading-relaxed">
                    <p><strong>AC</strong> ${m.ac}</p>
                    <p><strong>HP</strong> ${m.hp}</p>
                    <p><strong>Speed</strong> ${m.speed}</p>
                </div>
                <div class="tapered-rule"></div>
                <div class="grid grid-cols-6 text-center text-red-900 text-xs font-bold my-2">
                    <div>STR<br>${m.str} (${fmtMod(m.str)})</div>
                    <div>DEX<br>${m.dex} (${fmtMod(m.dex)})</div>
                    <div>CON<br>${m.con} (${fmtMod(m.con)})</div>
                    <div>INT<br>${m.int} (${fmtMod(m.int)})</div>
                    <div>WIS<br>${m.wis} (${fmtMod(m.wis)})</div>
                    <div>CHA<br>${m.cha} (${fmtMod(m.cha)})</div>
                </div>
                <div class="tapered-rule"></div>
                <div class="space-y-3 mt-3 text-sm text-black">`;

        if (m.traits.length) { html += fmtText(m.traits); }
        if (m.actions.length) { html += `<div class="dnd-section-title mt-2">Actions</div>${fmtText(m.actions)}`; }
        if (m.legendary.length) { html += `<div class="dnd-section-title mt-2">Legendary Actions</div>${fmtText(m.legendary)}`; }

        html += `</div></div>`;
        output.innerHTML = html;
        
        // 7. Reveal the Save Buttons
        document.getElementById('save-options-monster').classList.remove('hidden');

    } catch(e) {  
        console.error(e);  
        output.textContent = "Error during generation: " + e.message;
        window.lastGeneratedMonster = null; 
    } finally {  
        spinner.classList.add('hidden');  
        btn.disabled = false;  
    }
};

    // ==========================================
// üíæ FIX: ADD MONSTER TO STATBLOCKS (ROBUST DATA EXTRACTION)
// ==========================================
window.addMonsterToStatblocks = async function() {
    // 1. CRITICAL VALIDATION
    if (!window.userId) { 
        alert("üîí Please log in to a Session to save data."); 
        window.openLoginModal(); 
        return; 
    }
    
    const m = window.lastGeneratedMonster;
    if (!m || !m.name) { 
        alert("Monster data is missing. Please regenerate the monster."); 
        return; 
    }

    const btn = event.target;
    const originalText = btn.innerText;
    btn.innerText = "Saving...";
    btn.disabled = true;

    try {
        // 2. CORE STAT EXTRACTION (Guaranteed Numbers)
        
        // HP/AC: Use parsed values (m.hp, m.ac) which are guaranteed to be numbers by generateMonsterStatblock fix.
        const monsterHP = parseInt(m.hp) || 10;
        const monsterAC = parseInt(m.ac) || 10;
        
        // Initiative Modifier: Calculate from DEX score. Math.floor((DEX - 10) / 2)
        const dexScore = parseInt(m.dex) || parseInt(m.DEX) || 10;
        const initModifier = Math.floor((dexScore - 10) / 2);
        
        let toHit = initModifier; // Default To Hit to DEX Mod
        let mainAttack = m.actions.length ? m.actions[0].name : "Attack";

        // 3. GET ATTACK/TO HIT MODIFIER (Best Guess from the first Action)
        if (m.actions && m.actions.length > 0 && m.actions[0].description) {
            const desc = m.actions[0].description;
            // Look for a pattern like "+5 to hit"
            const hitMatch = desc.match(/(\+|\-)?\d+\s+to\s+hit/); 
            if (hitMatch) {
                // Extracts the number part (e.g., '+10 to hit' -> 10)
                // Use .replace to strip text and ensure proper parsing
                toHit = parseInt(hitMatch[0].replace(/[^0-9\-\+]/g, ''), 10);
            }
        }
        
        // 4. Create Database Object
        const statData = {
            name: m.name,
            hp: monsterHP, 
            ac: monsterAC, 
            
            toHit: toHit || 0,         // Final To Hit Modifier (now guaranteed number)
            initMod: initModifier,     // Final Initiative Modifier
            
            dmg: mainAttack,           // Name of the main attack
            timestamp: new Date().toISOString()
        };

        // 5. Save to Statblocks Collection
        // NOTE: getCol is defined in your code to target the correct user session.
        await window.addDoc(getCol('dm_toolkit_statblocks'), statData);

        // 6. Success Feedback
        if(confirm(`‚úÖ Saved "${m.name}" to Statblocks!\n\nDo you want to go to the Stats tab now?`)) {
            window.switchTab('statblocks');
        }

    } catch (e) {
        console.error("Stat Save Error:", e);
        alert("Error saving statblock. Check console for details.");
    } finally {
        btn.innerText = originalText;
        btn.disabled = false;
    }
};

    // ==========================================
// üíæ FINAL ROBUST FIX: MONSTER SAVE TO NOTES 
// ==========================================
window.saveMonsterToNotes = async function() {
    // 1. CRITICAL VALIDATION
    if (!window.userId) { 
        alert("üîí Please log in to a Session to save data."); 
        window.openLoginModal(); 
        return; 
    }
    const m = window.lastGeneratedMonster;
    if (!m || !m.name) { 
        alert("Monster data is missing. Please regenerate the monster."); 
        return; 
    }

    const btn = event.target;
    const originalText = btn.innerText;
    btn.innerText = "Processing...";
    btn.disabled = true; // Disable button immediately

    try {
        // 2. Ask for Campaign (The critical asynchronous step)
        const targetCampaign = await window.promptForCampaign();
        if (!targetCampaign) {
            // User cancelled the modal, exit gracefully
            return; 
        }

        // 3. Create Note Object (Content is pulled from the dedicated monster output div)
        const newNote = { 
            id: crypto.randomUUID(), 
            title: `${m.name} (CR ${m.cr || 'N/A'})`, 
            // üü¢ Content MUST be pulled from the correct dedicated div:
            content: document.getElementById('monster-output').innerHTML, 
            timestamp: new Date().toISOString() 
        };

        // 4. Use the unified save and redirect helper
        await window.finalizeSave('enemyNotes', newNote, targetCampaign);
        
    } catch (e) {
        console.error("Save to Notes Error:", e);
        alert("Error saving note: " + e.message + ". Check console for details.");
    } finally {
        // Re-enable button regardless of success or failure
        btn.innerText = originalText;
        btn.disabled = false;
    }
};

   // üí∞ FIXED LOOT GENERATOR (Secure Server)
window.generateLoot = async () => {
    const btn = document.getElementById('generate-loot-button'); 
    const spinner = document.getElementById('loot-loading-spinner');
    const output = document.getElementById('loot-output');

const level = document.getElementById('loot-level').value;
const type = document.getElementById('loot-type').value;

// üü¢ ADD THIS LINE:
window.sendEvent('generate_loot', { loot_level: level, loot_type: type });
    
    // UI Prep
    if (btn) btn.disabled = true;
    if (spinner) spinner.classList.remove('hidden');
    output.innerHTML = '<span class="text-gray-400 animate-pulse">Scanning area for valuables...</span>';
    
    try {
        const level = document.getElementById('loot-level').value;
        const type = document.getElementById('loot-type').value;
        // Check system safely
        const isSW5e = (typeof window.currentSystem !== 'undefined' && window.currentSystem === 'sw5e');
        
        let prompt = "";
        if (isSW5e) {
            prompt = `Generate a list of physical rewards for a Level ${level} Star Wars 5e (SW5e) ${type}. 
            Focus on: Credits, Medpacs, Tech/Force items, and interesting junk. 
            Format as a bulleted list with bold names.`;
        } else {
            prompt = `Generate a list of D&D 5e loot for a Level ${level} ${type}. 
            Focus on: Gold (gp), Gems, Art Objects, and Magic Items appropriate for the level. 
            Format as a bulleted list with bold names.`;
        }

        // üü¢ CALL SECURE SERVER (Removes the "No API Key" error)
        const aiText = await window.callMyServer(prompt);
        
        // Render
        const accentColor = isSW5e ? 'text-cyan-400' : 'text-yellow-500';
        const formattedText = aiText
            .replace(/\n/g, '<br>')
            .replace(/\*\*(.*?)\*\*/g, `<strong class="${accentColor}">$1</strong>`) // Bold text becomes colored
            .replace(/- /g, '‚Ä¢ '); // Dashes become dots

        output.innerHTML = `<div class="p-4 text-sm font-mono text-gray-300 leading-relaxed">${formattedText}</div>`;

    } catch(e) { 
        console.error(e);
        output.innerHTML = `<div class="text-red-400 font-bold">Error: ${e.message}</div>`; 
    } finally { 
        if (spinner) spinner.classList.add('hidden'); 
        if (btn) btn.disabled = false; 
    }
};

    // üí° FIXED CREATIVE GENERATOR (Secure Server)
window.generateCreativeIdea = async () => {
    const btn = document.getElementById('generate-button'); 
    const output = document.getElementById('ai-output'); 
    const spinner = document.getElementById('creative-loading-spinner');

    btn.disabled = true;
    if(spinner) spinner.classList.remove('hidden');
    output.textContent = "Thinking...";
    
    try {
        const userPrompt = document.getElementById('improv-prompt').value;
        const prompt = `Provide a creative D&D idea for: ${userPrompt}. Keep it concise and usable at the table.`;
        
        // üü¢ CALL SECURE SERVER
        const aiText = await window.callMyServer(prompt);
        
        output.innerHTML = aiText.replace(/\n/g, '<br>');
        
        if(document.getElementById('save-options-creative')) {
            document.getElementById('save-options-creative').classList.remove('hidden');
        }
    } catch(e) { 
        output.textContent = "Error: " + e.message; 
    } finally { 
        if(spinner) spinner.classList.add('hidden'); 
        btn.disabled = false; 
    }
};
    
    // üè∞ FIXED SETTLEMENT GENERATOR (Secure Server)
window.generateSettlement = async () => {
    const btn = document.getElementById('generate-settlement-button'); 
    const spinner = document.getElementById('settlement-loading-spinner');
    const outputDiv = document.getElementById('ai-output'); 
    
    btn.disabled = true; 
    spinner.classList.remove('hidden'); 
    outputDiv.textContent = "Constructing settlement...";
    
    try {
        const type = document.getElementById('settlement-type').value;
        const vibe = document.getElementById('settlement-vibe').value;
        const prompt = `Generate a D&D ${type} with a "${vibe}" atmosphere. 
        Include: Name, Leader, 3 Key Locations, and a Current Rumor. 
        Use standard markdown.`;
        
        // üü¢ CALL SECURE SERVER
        const aiText = await window.callMyServer(prompt);
        
        outputDiv.innerHTML = aiText
            .replace(/\n/g, '<br>')
            .replace(/\*\*(.*?)\*\*/g, '<strong class="text-indigo-300">$1</strong>');
            
        if(document.getElementById('save-options-creative')) {
            document.getElementById('save-options-creative').classList.remove('hidden'); 
        }
    } catch(e) { 
        outputDiv.textContent = "Error: " + e.message; 
    } finally { 
        btn.disabled = false; 
        spinner.classList.add('hidden'); 
    }
};

    window.saveGeneratedContent = async function(destinationTab) {
        if (!window.isAuthReady) return;
        let content = document.getElementById('ai-output').innerHTML;
        if (currentTab === 'loot') content = document.getElementById('loot-output').innerText;
        
        // Generate title dynamically
        const title = generateTitleFromContent(content);
        
        structuredNotes[destinationTab].unshift({ id: crypto.randomUUID(), title: title, content: content, timestamp: new Date().toISOString() });
        await window.saveStructuredNotes(destinationTab, structuredNotes[destinationTab]);
        window.switchTab('notes'); window.switchSubTab(destinationTab);
    };

    // --- 11. STARTUP & AUTH LISTENER ---
    // ==========================================
// üêï THE WATCHDOG (Corrected)
// ==========================================
onAuthStateChanged(window.auth, async (user) => {
    // 1. Always Reset Data first (so old data doesn't linger)
    combatants = []; 
    savedStatblocks = []; 
    structuredNotes = { prepNotes: [], pcNotes: [], enemyNotes: [], npcNotes: [], lootNotes: [] };
    
    // Clear the screen immediately
    if(typeof renderCombatants === 'function') renderCombatants();
    if(typeof renderStatblocks === 'function') renderStatblocks();
    if(typeof renderStructuredNotes === 'function') renderStructuredNotes(currentSubTab);

    // Get the Gatekeeper Element
    const gate = document.getElementById('session-gatekeeper');

    // 2. CHECK LOGIN STATUS
    if (user) {
        // ‚úÖ CASE A: LOGGED IN
        console.log("‚úÖ User connected:", user.uid);
        window.userId = user.uid;
        window.isAuthReady = true;
        
        // Hide the Login Screen
        if(gate) gate.classList.add('hidden');

        // Update UI
        if(typeof updateLoginUI === 'function') updateLoginUI(user);
        
        // Load Data
        if(window.setupNotesListener) window.setupNotesListener();
        if(window.setupCombatDataListeners) window.setupCombatDataListeners();
        if(window.setupStatblocksListener) window.setupStatblocksListener();
        if(window.setupHomebrewListener) window.setupHomebrewListener();
        if(window.loadMapState) window.loadMapState();
        
        // Load Timeline (if you added that feature)
        if(window.setupTimelineListener) window.setupTimelineListener();

    } else {
        // üîí CASE B: LOGGED OUT
        // We do NOT sign in anonymously anymore.
        console.log("üîí Signed out. Showing Gatekeeper.");
        
        // SHOW the Login Screen so the user can sign in again
        if(gate) gate.classList.remove('hidden');
    }
});

    document.addEventListener('DOMContentLoaded', () => {
    // 1. Restore API Key
    if(window['userApiKey']) { 
        const keyInput = document.getElementById('user-api-key');
        if (keyInput) keyInput.value = window['userApiKey']; 
        if (typeof window['updateApiKey'] === 'function') window['updateApiKey'](window['userApiKey']); 
    }

    // 2. Start Theme & Tab
    if (typeof window['applyTheme'] === 'function') window['applyTheme']();
    if (typeof window['switchTab'] === 'function') window['switchTab']('home');

    // 3. üü¢ DICE VISUALS ENGINE
    (function() {
        const canvas = document.getElementById('dice-canvas'); 
        if(!canvas) return; 
        
        const ctx = canvas.getContext('2d'); 
        let dice = []; 
        let loopId = null;
        window['customDiceImage'] = null; 

        // Handle File Upload
        window['uploadDiceTexture'] = function(input) { 
            if (input.files && input.files[0]) { 
                const reader = new FileReader(); 
                reader.onload = function(e) { 
                    const img = new Image(); 
                    img.onload = function() { 
                        window['customDiceImage'] = img; 
                        if(window['showToast']) window['showToast']("üé≤ Dice Texture Loaded!", "success");
                    }; 
                    img.src = e.target.result; 
                }; 
                reader.readAsDataURL(input.files[0]); 
            } 
        };

        // Reset Texture
        window['resetDiceTexture'] = function() {
            window['customDiceImage'] = null;
            const input = document.getElementById('dice-texture-input');
            if(input) input.value = "";
            if(window['showToast']) window['showToast']("üé≤ Texture Reset", "info");
        };

        // Resize Handler
        function resize() { 
            canvas.width = window.innerWidth; 
            canvas.height = window.innerHeight; 
        } 
        window.addEventListener('resize', resize); 
        resize();

        // The 3D Die Class
        class VisualDie { 
            constructor(val, type) { 
                this.val = val; 
                this.type = type; 
                this.x = canvas.width/2; 
                this.y = canvas.height + 30; 
                this.vx = (Math.random()-0.5) * 20; 
                this.vy = -(Math.random() * 15 + 20); 
                this.angle = Math.random() * Math.PI; 
                this.vAngle = (Math.random() - 0.5) * 0.5; 
                
                const picker = document.getElementById('dice-color-picker'); 
                this.color = picker ? picker.value : '#6366f1'; 
            } 

            update() { 
                this.vy += 1; 
                this.x += this.vx; 
                this.y += this.vy; 
                this.angle += this.vAngle; 
                if(this.y > canvas.height - 50) { 
                    this.y = canvas.height - 50; 
                    this.vy *= -0.6; 
                    this.vx *= 0.9; 
                    if(Math.abs(this.vx) < 0.5 && Math.abs(this.vy) < 1) { this.vAngle = 0; } 
                } 
                if(this.x < 20 || this.x > canvas.width - 20) this.vx *= -0.8; 
            } 

            draw() { 
                ctx.save(); 
                ctx.translate(this.x, this.y); 
                ctx.rotate(this.angle); 
                
                ctx.shadowColor = 'rgba(0,0,0,0.5)';
                ctx.shadowBlur = 10;
                ctx.beginPath(); 
                if(this.type === 4) { ctx.moveTo(0,-20); ctx.lineTo(20,15); ctx.lineTo(-20,15); } 
                else if(this.type === 6) { ctx.rect(-15,-15,30,30); } 
                else if(this.type === 8 || this.type === 10) { ctx.moveTo(0,-25); ctx.lineTo(15,0); ctx.lineTo(0,25); ctx.lineTo(-15,0); } 
                else if(this.type === 12) { for(let i=0;i<5;i++) ctx.lineTo(22*Math.cos(i*2*Math.PI/5-Math.PI/2), 22*Math.sin(i*2*Math.PI/5-Math.PI/2)); } 
                else { for(let i=0;i<6;i++) ctx.lineTo(22*Math.cos(i*2*Math.PI/6), 22*Math.sin(i*2*Math.PI/6)); } 
                ctx.closePath(); 
                
                if (window['customDiceImage']) { 
                    ctx.save(); ctx.clip(); ctx.drawImage(window['customDiceImage'], -25, -25, 50, 50); ctx.restore(); 
                } else { 
                    ctx.fillStyle = this.color; ctx.fill(); 
                } 
                
                ctx.shadowBlur = 0;
                ctx.strokeStyle = 'white'; ctx.lineWidth = 2; ctx.stroke(); 
                ctx.fillStyle = 'white'; ctx.shadowColor = 'black'; ctx.shadowBlur = 4; 
                ctx.font = 'bold 14px Arial'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle'; 
                if(window['customDiceImage']) { ctx.lineWidth = 3; ctx.strokeStyle = 'black'; ctx.strokeText(this.val, 0, 2); }
                ctx.fillText(this.val, 0, 2); 
                ctx.restore(); 
            } 
        }

        function animate() { 
            ctx.clearRect(0,0,canvas.width,canvas.height); 
            let active = false;
            dice.forEach(d => { 
                d.update(); 
                d.draw(); 
                if(Math.abs(d.vy) > 0.1 || Math.abs(d.vx) > 0.1 || d.y < canvas.height - 50) active = true;
            }); 
            if (active || dice.length > 0) loopId = requestAnimationFrame(animate); 
        } 

        window['throwDiceVisuals'] = (rolls, type) => { 
            if(dice.length > 10) dice = [];
            const newDice = rolls.map(r => new VisualDie(r, type));
            dice.push(...newDice);
            setTimeout(() => { 
                dice = []; 
                ctx.clearRect(0, 0, canvas.width, canvas.height); 
                if(loopId) cancelAnimationFrame(loopId);
            }, 4000); 
            animate();
        };
    })();

    // 4. üü¢ MAP UPLINK (Global)
    const uplinkInput = document.getElementById('uplink-image-input');
    if (uplinkInput) {
        uplinkInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const statusEl = document.getElementById('uplink-status');
            const localUrl = URL.createObjectURL(file);
            const mapImg = document.getElementById('active-battlemap');
            const placeholder = document.getElementById('map-placeholder-text');
            
            if (mapImg) { mapImg.src = localUrl; mapImg.style.opacity = "1"; }
            if (placeholder) placeholder.classList.add('hidden');
            
            const vtt = document.getElementById('vtt-viewport');
            if (vtt && vtt.classList.contains('hidden') && typeof window['toggleVTTMode'] === 'function') {
                window['toggleVTTMode']();
            }

            const user = window.auth.currentUser;
            if (!user) { if (statusEl) statusEl.innerText = "Login required."; return; }

            if (statusEl) statusEl.innerText = "Transmitting...";

            try {
                const storageRef = window['sRef'](window.storage, `sessions/${user.uid}/current_reveal`);
                await window['uploadBytes'](storageRef, file);
                const downloadURL = await window['getDownloadURL'](storageRef);

                const uplinkRef = window.doc(window.db, 'artifacts', 'default', 'sessions', user.uid, 'singles', 'shared_uplink');
                await window.setDoc(uplinkRef, { activeImage: downloadURL, timestamp: new Date().toISOString() }, { merge: true });

                if (statusEl) statusEl.innerText = "Synced ‚úÖ";
            } catch (err) {
                console.error("Uplink Error:", err);
                if (statusEl) statusEl.innerText = "Upload Failed";
            }
        });
    }

    // 5. üü¢ SOUNDBOARD LOGIC (Global Scope)
    const ac = new (window.AudioContext||window.webkitAudioContext)();
    const masterGain = ac.createGain(); masterGain.connect(ac.destination); masterGain.gain.value = 0.5;
    let ambNodes = []; let ambType = null;
    const noiseBuf = ac.createBuffer(1, ac.sampleRate*2, ac.sampleRate);
    for(let i=0; i<noiseBuf.length; i++) noiseBuf.getChannelData(0)[i] = Math.random()*2-1;

    const volSlider = document.getElementById('master-volume');
    if(volSlider) volSlider.addEventListener('input', (e) => masterGain.gain.setTargetAtTime(parseFloat(e.target.value), ac.currentTime, 0.01));

    const unlockMobileAudio = () => {
        if (ac.state === 'suspended') ac.resume();
        const buffer = ac.createBuffer(1, 1, 22050); const source = ac.createBufferSource();
        source.buffer = buffer; source.connect(ac.destination); source.start(0);
        document.removeEventListener('touchstart', unlockMobileAudio); document.removeEventListener('click', unlockMobileAudio);
    };
    document.addEventListener('touchstart', unlockMobileAudio); document.addEventListener('click', unlockMobileAudio);

    // Sound Helper Functions
    const playNote = (freq, t, dur, type = 'sine', vol = 0.3) => {
        const o = ac.createOscillator(); const g = ac.createGain(); o.type = type; o.frequency.value = freq; 
        o.connect(g); g.connect(masterGain); 
        g.gain.setValueAtTime(vol, t); g.gain.exponentialRampToValueAtTime(0.01, t + dur); o.start(t); o.stop(t + dur);
    };
    const playDrum = (type, time) => {
        const osc = ac.createOscillator(); const gain = ac.createGain(); osc.connect(gain); gain.connect(masterGain);
        if (type === 'kick') { osc.frequency.setValueAtTime(150, time); osc.frequency.exponentialRampToValueAtTime(0.01, time+0.5); gain.gain.setValueAtTime(0.5, time); gain.gain.exponentialRampToValueAtTime(0.01, time+0.5); osc.start(time); osc.stop(time+0.5); }
        else if (type === 'snare') { const n = ac.createBufferSource(); n.buffer = noiseBuf; const f = ac.createBiquadFilter(); f.type = 'highpass'; f.frequency.value = 1000; n.connect(f); f.connect(gain); gain.gain.setValueAtTime(0.4, time); gain.gain.exponentialRampToValueAtTime(0.01, time+0.2); n.start(time); n.stop(time+0.2); }
        else if (type === 'hihat') { const n = ac.createBufferSource(); n.buffer = noiseBuf; const f = ac.createBiquadFilter(); f.type = 'highpass'; f.frequency.value = 5000; n.connect(f); f.connect(gain); gain.gain.setValueAtTime(0.3, time); gain.gain.exponentialRampToValueAtTime(0.01, time+0.05); n.start(time); n.stop(time+0.05); }
        else if (type === 'tom') { osc.frequency.setValueAtTime(100, time); osc.frequency.exponentialRampToValueAtTime(50, time+0.3); gain.gain.setValueAtTime(0.4, time); gain.gain.exponentialRampToValueAtTime(0.01, time+0.3); osc.start(time); osc.stop(time+0.3); }
    };
    const playLute = (freq, startTime, duration) => {
        const osc = ac.createOscillator(); const gain = ac.createGain(); const filter = ac.createBiquadFilter(); osc.type = 'sawtooth'; osc.frequency.setValueAtTime(freq, startTime); filter.type = 'lowpass'; filter.frequency.setValueAtTime(1000, startTime); gain.gain.setValueAtTime(0.1, startTime); gain.gain.exponentialRampToValueAtTime(0.001, startTime + duration); osc.connect(filter); filter.connect(gain); gain.connect(masterGain); osc.start(startTime); osc.stop(startTime + duration);
    };
    const playAccordion = (freq, startTime, duration, vol = 0.15) => {
         const osc = ac.createOscillator(); const gain = ac.createGain(); const filter = ac.createBiquadFilter(); osc.type = 'sawtooth'; osc.frequency.setValueAtTime(freq, startTime); filter.type = 'lowpass'; filter.frequency.value = 2500; osc.connect(filter); filter.connect(gain); gain.connect(masterGain); gain.gain.setValueAtTime(0, startTime); gain.gain.linearRampToValueAtTime(vol, startTime+0.1); gain.gain.setValueAtTime(vol, startTime + duration - 0.1); gain.gain.linearRampToValueAtTime(0, startTime+duration); osc.start(startTime); osc.stop(startTime + duration);
    };

    // Public Sound Functions
    window['playTone'] = function(type) {
        if (ac.state === 'suspended') ac.resume();
        const now = ac.currentTime;
        const osc = ac.createOscillator(); const gain = ac.createGain();
        
        switch (type) {
            case 'success': [523.25, 659.25, 783.99].forEach((freq, i) => { const o = ac.createOscillator(); const g = ac.createGain(); o.type = 'triangle'; o.frequency.value = freq; o.connect(g); g.connect(masterGain); g.gain.setValueAtTime(0, now); g.gain.linearRampToValueAtTime(0.1, now + i*0.1 + 0.05); g.gain.exponentialRampToValueAtTime(0.001, now + 1.0); o.start(now + i*0.1); o.stop(now + 1.0); }); break;
            case 'critical': [523.25, 1046.50, 1318.51].forEach((freq, i) => { const o = ac.createOscillator(); const g = ac.createGain(); o.type = 'square'; o.frequency.value = freq; o.connect(g); g.connect(masterGain); g.gain.setValueAtTime(0, now); g.gain.linearRampToValueAtTime(0.1, now + 0.05); g.gain.exponentialRampToValueAtTime(0.001, now + 1.5); o.start(now); o.stop(now + 1.5); }); break;
            case 'fail': { const o1 = ac.createOscillator(); const g1 = ac.createGain(); o1.type = 'sawtooth'; o1.frequency.setValueAtTime(196.00, now); o1.frequency.linearRampToValueAtTime(185.00, now + 0.4); o1.connect(g1); g1.connect(masterGain); g1.gain.setValueAtTime(0.2, now); g1.gain.linearRampToValueAtTime(0, now + 0.4); o1.start(now); o1.stop(now+0.4); const o2 = ac.createOscillator(); const g2 = ac.createGain(); o2.type = 'sawtooth'; o2.frequency.setValueAtTime(174.61, now + 0.45); o2.frequency.linearRampToValueAtTime(155.56, now + 1.0); o2.connect(g2); g2.connect(masterGain); g2.gain.setValueAtTime(0, now + 0.45); g2.gain.linearRampToValueAtTime(0.2, now + 0.5); g2.gain.linearRampToValueAtTime(0, now + 1.0); o2.start(now + 0.45); o2.stop(now + 1.0); } break;
            case 'combat_start': { osc.type = 'sawtooth'; osc.frequency.value = 60; const filter = ac.createBiquadFilter(); filter.type = 'lowpass'; filter.frequency.setValueAtTime(200, now); filter.frequency.linearRampToValueAtTime(1500, now + 0.1); filter.frequency.exponentialRampToValueAtTime(200, now + 2); osc.connect(filter); filter.connect(gain); gain.connect(masterGain); gain.gain.setValueAtTime(0, now); gain.gain.linearRampToValueAtTime(0.4, now + 0.1); gain.gain.exponentialRampToValueAtTime(0.001, now + 2); osc.start(now); osc.stop(now + 2); } break;
            case 'spell': { osc.type = 'sine'; osc.frequency.setValueAtTime(400, now); osc.frequency.exponentialRampToValueAtTime(2000, now + 1); gain.gain.setValueAtTime(0.2, now); gain.gain.linearRampToValueAtTime(0, now + 1); osc.connect(gain); gain.connect(masterGain); osc.start(now); osc.stop(now + 1); } break;
            case 'mystery': { const mo1 = ac.createOscillator(); const mg1 = ac.createGain(); mo1.type = 'sine'; mo1.frequency.value = 440; mo1.connect(mg1); mg1.connect(masterGain); mg1.gain.setValueAtTime(0, now); mg1.gain.linearRampToValueAtTime(0.2, now + 1); mg1.gain.linearRampToValueAtTime(0, now + 3); mo1.start(now); mo1.stop(now + 3); const mo2 = ac.createOscillator(); const mg2 = ac.createGain(); mo2.type = 'sine'; mo2.frequency.value = 455; mo2.connect(mg2); mg2.connect(masterGain); mg2.gain.setValueAtTime(0, now); mg2.gain.linearRampToValueAtTime(0.2, now + 1.5); mg2.gain.linearRampToValueAtTime(0, now + 3); mo2.start(now); mo2.stop(now + 3); } break;
            case 'rest': { [261.63, 329.63, 392.00, 523.25].forEach(f => { const o = ac.createOscillator(); const g = ac.createGain(); o.type = 'sine'; o.frequency.value = f; o.connect(g); g.connect(masterGain); g.gain.setValueAtTime(0, now); g.gain.linearRampToValueAtTime(0.05, now + 1); g.gain.linearRampToValueAtTime(0, now + 4); o.start(now); o.stop(now + 4); }); } break;
            case 'trap': { const n = ac.createBufferSource(); n.buffer = noiseBuf; const f = ac.createBiquadFilter(); f.type = 'highpass'; f.frequency.value = 1000; const ng = ac.createGain(); n.connect(f); f.connect(ng); ng.connect(masterGain); ng.gain.setValueAtTime(0.6, now); ng.gain.exponentialRampToValueAtTime(0.01, now + 0.1); n.start(now); n.stop(now + 0.1); osc.type = 'square'; osc.frequency.setValueAtTime(100, now); osc.frequency.exponentialRampToValueAtTime(40, now + 0.2); osc.connect(gain); gain.connect(masterGain); gain.gain.setValueAtTime(0.5, now); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.2); osc.start(now); osc.stop(now + 0.2); } break;
            case 'boss': { osc.type = 'sawtooth'; osc.frequency.setValueAtTime(55, now); const bf = ac.createBiquadFilter(); bf.type='lowpass'; bf.frequency.value=150; osc.connect(bf); bf.connect(gain); gain.connect(masterGain); gain.gain.setValueAtTime(0, now); gain.gain.linearRampToValueAtTime(0.5, now + 0.1); gain.gain.exponentialRampToValueAtTime(0.001, now + 3); osc.start(now); osc.stop(now + 3); } break;
            case 'wolf': { osc.type = 'triangle'; osc.frequency.setValueAtTime(400, now); osc.frequency.linearRampToValueAtTime(600, now + 0.5); osc.frequency.linearRampToValueAtTime(300, now + 2.5); gain.gain.setValueAtTime(0, now); gain.gain.linearRampToValueAtTime(0.2, now + 0.5); gain.gain.linearRampToValueAtTime(0, now + 2.5); osc.connect(gain); gain.connect(masterGain); osc.start(now); osc.stop(now + 2.5); } break;
            case 'bear': { osc.type = 'sawtooth'; osc.frequency.value = 50; const bearF = ac.createBiquadFilter(); bearF.type = 'lowpass'; bearF.frequency.setValueAtTime(100, now); bearF.frequency.linearRampToValueAtTime(600, now + 0.2); bearF.frequency.linearRampToValueAtTime(100, now + 1.0); osc.connect(bearF); bearF.connect(gain); gain.connect(masterGain); gain.gain.setValueAtTime(0, now); gain.gain.linearRampToValueAtTime(0.4, now + 0.1); gain.gain.linearRampToValueAtTime(0, now + 1.0); osc.start(now); osc.stop(now + 1.0); } break;
            case 'bird': { osc.type = 'sine'; osc.frequency.setValueAtTime(2000, now); osc.frequency.exponentialRampToValueAtTime(1000, now + 0.1); gain.gain.setValueAtTime(0, now); gain.gain.linearRampToValueAtTime(0.1, now + 0.01); gain.gain.linearRampToValueAtTime(0, now + 0.1); osc.connect(gain); gain.connect(masterGain); osc.start(now); osc.stop(now + 0.1); setTimeout(() => { const o2 = ac.createOscillator(); const g2 = ac.createGain(); o2.type = 'sine'; o2.frequency.setValueAtTime(2500, ac.currentTime); o2.frequency.exponentialRampToValueAtTime(1200, ac.currentTime + 0.1); g2.gain.setValueAtTime(0, ac.currentTime); g2.gain.linearRampToValueAtTime(0.1, ac.currentTime + 0.01); g2.gain.linearRampToValueAtTime(0, ac.currentTime + 0.1); o2.connect(g2); g2.connect(masterGain); o2.start(ac.currentTime); o2.stop(ac.currentTime + 0.1); }, 150); } break;
            case 'snake': { const n = ac.createBufferSource(); n.buffer = noiseBuf; const f = ac.createBiquadFilter(); f.type = 'highpass'; f.frequency.value = 3000; n.connect(f); f.connect(gain); gain.connect(masterGain); gain.gain.setValueAtTime(0, now); gain.gain.linearRampToValueAtTime(0.15, now + 0.5); gain.gain.linearRampToValueAtTime(0, now + 2.0); n.start(now); n.stop(now + 2.0); } break;
            case 'insect': { 
                const playPulse = (t) => { const osc = ac.createOscillator(); osc.type = 'sawtooth'; osc.frequency.value = 4500; const filter = ac.createBiquadFilter(); filter.type = 'bandpass'; filter.frequency.value = 4500; filter.Q.value = 10; const g = ac.createGain(); osc.connect(filter); filter.connect(g); g.connect(masterGain); g.gain.setValueAtTime(0, t); g.gain.linearRampToValueAtTime(0.2, t + 0.002); g.gain.exponentialRampToValueAtTime(0.001, t + 0.02); osc.start(t); osc.stop(t + 0.03); };
                const playChirp = (t) => { for(let i=0; i<4; i++) playPulse(t + (i * 0.018)); };
                playChirp(now); playChirp(now + 0.3); playChirp(now + 0.6); 
            } break;
        }
    };

    window['toggleAmbience'] = function(t) {
        if(ac.state==='suspended') ac.resume();
        ambNodes.forEach(n => { try{n.stop()}catch(e){} try{n.disconnect()}catch(e){} }); ambNodes=[];
        document.querySelectorAll('.sound-btn').forEach(b => b.classList.remove('active-loop'));
        if(ambType === t) { ambType = null; document.getElementById('ambience-status').innerText = ""; return; }
        ambType = t; 
        const btn = document.getElementById(`ambience-${t}`);
        if(btn) btn.classList.add('active-loop');
        document.getElementById('ambience-status').innerText = "Playing: " + t.toUpperCase();
        const now = ac.currentTime;
        
        if (t === 'village') {
            const noise = ac.createBufferSource(); noise.buffer = noiseBuf; noise.loop = true; const filter = ac.createBiquadFilter(); filter.type = 'lowpass'; filter.frequency.setValueAtTime(400, now); const lfo = ac.createOscillator(); lfo.type = 'sine'; lfo.frequency.value = 0.1; const lfoGain = ac.createGain(); lfoGain.gain.value = 200; lfo.connect(lfoGain); lfoGain.connect(filter.frequency); const gain = ac.createGain(); gain.gain.value = 0.05; noise.connect(filter); filter.connect(gain); gain.connect(masterGain); noise.start(now); lfo.start(now); ambNodes.push(noise, lfo, gain);
            const iv1 = setInterval(() => { if (Math.random() > 0.7) { playNote(1500 + Math.random() * 500, ac.currentTime, 0.05, 'triangle', 0.02); } }, 2000);
            const scale = [261.63, 293.66, 329.63, 392.00, 440.00, 523.25]; 
            const iv2 = setInterval(() => { const t = ac.currentTime; if (Math.random() > 0.3) { const pitch = scale[Math.floor(Math.random() * scale.length)]; playLute(pitch, t, 0.4); } }, 600);
            ambNodes.push({ stop: () => { clearInterval(iv1); clearInterval(iv2); } });
        }
        else if (t === 'city') {
            const noise = ac.createBufferSource(); noise.buffer = noiseBuf; noise.loop = true; 
            const filter = ac.createBiquadFilter(); filter.type = 'lowpass'; filter.frequency.value = 200; 
            const gain = ac.createGain(); gain.gain.value = 0.08;
            noise.connect(filter); filter.connect(gain); gain.connect(masterGain); 
            noise.start(now); ambNodes.push(noise, gain);
            const scale = [146.83, 164.81, 174.61, 196.00, 220.00, 246.94, 261.63, 293.66];
            let beat = 0;
            const musicIv = setInterval(() => {
                const t = ac.currentTime;
                if (beat % 4 === 0) playLute(scale[0], t, 0.8);
                if (beat % 4 === 2) playLute(scale[4], t, 0.6);
                if (Math.random() > 0.4) {
                    const noteIdx = Math.floor(Math.random() * scale.length);
                    const note = scale[noteIdx] * 2;
                    const timing = t + (Math.random() * 0.05);
                    playLute(note, timing, 0.3);
                }
                if (beat % 8 === 0 && Math.random() > 0.6) {
                    playLute(scale[0], t + 0.05, 0.5); playLute(scale[2], t + 0.10, 0.5); playLute(scale[4], t + 0.15, 0.5);
                }
                beat++;
            }, 350); 
            const sfxIv = setInterval(() => {
                  if (Math.random() > 0.95) {
                      const bellT = ac.currentTime;
                      playNote(523.25, bellT, 2.0, 'sine', 0.1); playNote(261.63, bellT, 2.0, 'triangle', 0.05);
                  }
            }, 2000);
            ambNodes.push({ stop: () => { clearInterval(musicIv); clearInterval(sfxIv); } });
        }
        else if (t === 'tavern') {
            const noise = ac.createBufferSource(); noise.buffer = noiseBuf; noise.loop = true; const filter = ac.createBiquadFilter(); filter.type = 'lowpass'; filter.frequency.value = 150; const gain = ac.createGain(); gain.gain.value = 0.25; noise.connect(filter); filter.connect(gain); gain.connect(masterGain); noise.start(now); ambNodes.push(noise, gain);
            const iv1 = setInterval(() => { if (Math.random() > 0.6) { playNote(1200, ac.currentTime, 0.05, 'triangle', 0.05); } }, 2500);
            const scale = [261.63, 293.66, 329.63, 392.00, 440.00, 523.25]; let beat = 0; 
            const iv2 = setInterval(() => { const t = ac.currentTime; if (beat % 4 === 0) { playLute(130.81, t, 0.8); } if (Math.random() > 0.2) { playLute(scale[Math.floor(Math.random() * scale.length)], t + 0.05, 0.4); } beat++; }, 300);
            ambNodes.push({ stop: () => { clearInterval(iv1); clearInterval(iv2); } });
        }
        else if (t === 'ocean') {
            const drone = ac.createOscillator(); drone.type = 'sawtooth'; drone.frequency.value = 73.42; const df = ac.createBiquadFilter(); df.type = 'lowpass'; df.frequency.value = 300; const dg = ac.createGain(); dg.gain.value = 0.05; drone.connect(df); df.connect(dg); dg.connect(masterGain); drone.start(now); ambNodes.push(drone, dg);
            const shanty = [293.66, 329.63, 349.23, 392.00, 440.00, 493.88, 523.25]; let beat = 0;
            const iv = setInterval(() => { const t = ac.currentTime; if (beat % 2 === 0) { playDrum('kick', t); playAccordion(146.83, t, 0.4, 0.2); } else { playDrum('snare', t); playAccordion(293.66, t, 0.2, 0.05); } if (Math.random() > 0.3) { playAccordion(shanty[Math.floor(Math.random()*shanty.length)], t, 0.4, 0.15); } beat++; }, 600);
            ambNodes.push({ stop: () => clearInterval(iv) });
        }
        else if (t === 'dungeon') {
            const d1 = ac.createOscillator(); d1.type = 'triangle'; d1.frequency.value = 55; const d2 = ac.createOscillator(); d2.type = 'sine'; d2.frequency.value = 58; const dg = ac.createGain(); dg.gain.value = 0.15; const f = ac.createBiquadFilter(); f.type = 'lowpass'; f.frequency.value = 300; d1.connect(f); d2.connect(f); f.connect(dg); dg.connect(masterGain); d1.start(now); d2.start(now); ambNodes.push(d1, d2, dg);
            const iv1 = setInterval(() => { if (Math.random() > 0.6) { const t = ac.currentTime; const o = ac.createOscillator(); o.type = 'sine'; o.frequency.setValueAtTime(2000 + Math.random() * 500, t); const g = ac.createGain(); g.gain.setValueAtTime(0, t); g.gain.linearRampToValueAtTime(0.1, t + 0.01); g.gain.exponentialRampToValueAtTime(0.001, t + 0.15); o.connect(g); g.connect(masterGain); o.start(t); o.stop(t + 0.5); } }, 3000);
            ambNodes.push({ stop: () => clearInterval(iv1) });
        }
        else if (t === 'battle_minor') {
            const bpm = 130; const stepTime = (60 / bpm) / 4; let step = 0; const bassFreqs = [73.42, 73.42, 73.42, 73.42, 87.31, 87.31, 82.41, 82.41]; 
            const iv = setInterval(() => { 
                const t = ac.currentTime; const barStep = step % 16; 
                if (step % 2 === 0) { const osc = ac.createOscillator(); osc.type = 'sawtooth'; osc.frequency.value = bassFreqs[Math.floor((step % 16) / 2) % bassFreqs.length]; const f = ac.createBiquadFilter(); f.type = 'lowpass'; f.frequency.value = 600; const g = ac.createGain(); g.gain.setValueAtTime(0.25, t); g.gain.exponentialRampToValueAtTime(0.01, t + 0.15); osc.connect(f); f.connect(g); g.connect(masterGain); osc.start(t); osc.stop(t + 0.2); }
                if (barStep === 0 || barStep === 6 || barStep === 10) { playDrum('kick', t); if(barStep === 0) playDrum('tom', t); }
                if (barStep === 4 || barStep === 12) { playDrum('snare', t); }
                if (barStep % 2 === 0) { const hOsc = ac.createOscillator(); hOsc.type = 'square'; hOsc.frequency.value = 800; const hG = ac.createGain(); hG.gain.setValueAtTime(0.03, t); hG.gain.exponentialRampToValueAtTime(0.001, t + 0.03); hOsc.connect(hG); hG.connect(masterGain); hOsc.start(t); hOsc.stop(t + 0.05); }
                step++; 
            }, stepTime * 1000);
            ambNodes.push({ stop: () => clearInterval(iv) });
        }
        else if (t === 'battle_major') {
            const osc = ac.createOscillator(); osc.type = 'sawtooth'; osc.frequency.value = 35; const f = ac.createBiquadFilter(); f.type = 'lowpass'; f.frequency.value = 200; const lfo = ac.createOscillator(); lfo.type = 'sine'; lfo.frequency.value = 0.25; const lG = ac.createGain(); lG.gain.value = 150; lfo.connect(lG); lG.connect(f.frequency); const g = ac.createGain(); g.gain.value = 0.2; osc.connect(f); f.connect(g); g.connect(masterGain); osc.start(now); lfo.start(now); ambNodes.push(osc, f, g, lfo, lG);
            let beat = 0; const iv = setInterval(() => { const t = ac.currentTime; if (beat % 4 === 0) { playDrum('kick', t); playDrum('tom', t + 0.1); } if (beat % 4 === 2) { playDrum('snare', t); playDrum('kick', t); } playDrum('hihat', t); playDrum('hihat', t + 0.21); beat++; }, 428);
            ambNodes.push({ stop: () => clearInterval(iv) });
        }
        else if (t === 'sleep') {
            const noise = ac.createBufferSource(); noise.buffer = noiseBuf; noise.loop = true; const f = ac.createBiquadFilter(); f.type = 'lowpass'; f.frequency.value = 120; const g = ac.createGain(); g.gain.value = 0.3; noise.connect(f); f.connect(g); g.connect(masterGain); noise.start(now); ambNodes.push(noise, g);
            const iv1 = setInterval(() => { if (Math.random() > 0.7) { const n = ac.createBufferSource(); n.buffer = noiseBuf; const f2 = ac.createBiquadFilter(); f2.type = 'highpass'; f2.frequency.value = 2000; const g2 = ac.createGain(); g2.gain.value = 0.1 + Math.random() * 0.1; g2.gain.exponentialRampToValueAtTime(0.01, ac.currentTime + 0.05); n.connect(f2); f2.connect(g2); g2.connect(masterGain); n.start(); n.stop(ac.currentTime + 0.05); } }, 200);
            const scale = [196.00, 220.00, 246.94, 293.66, 329.63]; 
            const iv2 = setInterval(() => { if (Math.random() > 0.4) { const t = ac.currentTime; const noteIdx = Math.floor(Math.random() * scale.length); playNote(scale[noteIdx], t, 4, 'sine', 0.1); } }, 5000);
            ambNodes.push({ stop: () => { clearInterval(iv1); clearInterval(iv2); } });
        }
    };

    // 6. üü¢ CLEAR UPLINK FUNCTION
    window['clearUplinkImage'] = async () => {
        const user = window.auth.currentUser;
        if (!user) return alert("Please log in.");
        try {
            const uplinkRef = window.doc(window.db, 'artifacts', 'default', 'sessions', user.uid, 'singles', 'shared_uplink');
            await window.setDoc(uplinkRef, { activeImage: null }, { merge: true });
            if (document.getElementById('uplink-status')) document.getElementById('uplink-status').innerText = "Uplink Terminated.";
            if (window['showToast']) window['showToast']("üì¥ Visual cleared.", "info");
        } catch (err) { console.error("Clear Error:", err); }
    };
        
        
        // --- END OF SOUNDBOARD LOGIC ---

     window.splitLoot = function() {
    const isSW5e = (window.currentSystem === 'sw5e');
    const partySize = parseInt(document.getElementById('loot-party-size').value) || 1;
    const output = document.getElementById('split-results');
    
    // Get values
    const gp = parseInt(document.getElementById('loot-gp').value) || 0;
    const totalInput = parseInt(document.getElementById('total-loot').value) || 0;

    if (isSW5e) {
        const totalCredits = totalInput > 0 ? totalInput : gp;
        const perPerson = (totalCredits / partySize).toFixed(2);
        
        output.innerHTML = `
            <div class="mt-2 p-3 bg-black border border-blue-900 rounded font-mono text-[10px] text-blue-400">
                <div class="text-center border-b border-blue-900 pb-1 mb-2 uppercase">Galactic Bank Record</div>
                <div class="flex justify-between"><span>TOTAL DEPOSIT:</span> <span>${totalCredits} CR</span></div>
                <div class="flex justify-between"><span>SHARES:</span> <span>${partySize}</span></div>
                <div class="border-t border-dashed border-blue-900 mt-2 pt-2 text-sm font-bold text-cyan-300 flex justify-between">
                    <span>PER SHARE:</span> <span>${perPerson} CR</span>
                </div>
            </div>
        `;
    } else {
        // Standard D&D math...
        const total = totalInput > 0 ? totalInput : gp;
        output.innerText = `Each player receives: ${(total / partySize).toFixed(2)} GP`;
    }
};
    });
    
// --- 12. MONSTER COMPENDIUM (Strict CR Filtering) ---

    // Helpers
    const getMod = (s) => Math.floor((s - 10) / 2);
    const fmtMod = (s) => { const m = getMod(s); return m >= 0 ? `+${m}` : m; };
    const fmtSpeed = (s) => {
        if (!s) return '30 ft.';
        if (typeof s === 'object') return Object.entries(s).map(([k, v]) => `${k} ${v} ft.`).join(', ');
        return s;
    };

    // --- NEW HELPER FUNCTIONS FOR FULL RENDER (INSERT ABOVE window.searchCompendium) ---
const fmtSrdSection = (title, items) => {
    // 1. If there's no data, don't show the section header
    if (!items || (Array.isArray(items) && items.length === 0)) return '';

    const isSW5e = (window.currentSystem === 'sw5e');
    const dataArray = Array.isArray(items) ? items : [items];

    // 2. DYNAMIC HEADERS
    const headerClass = isSW5e 
        ? "border-b border-cyan-500/50 text-cyan-400 font-bold uppercase text-[11px] tracking-widest mb-3 mt-6 pb-1" 
        : "dnd-section-title mt-4 border-b border-red-200 text-red-800 font-bold uppercase text-xs tracking-wide mb-2";

    let html = `<div class="${headerClass}">${title}</div>`;
    
    dataArray.forEach(item => {
        const name = item.name || "Ability";
        const content = item.description || item.desc || item.text || "";
        
        if (content) {
            if (isSW5e) {
                // üöÄ NEON SCI-FI LAYOUT (High Contrast)
                html += `
                    <div class="mb-4 bg-cyan-900/10 p-2 rounded border-l-2 border-cyan-500/30">
                        <div class="neon-label text-yellow-400 font-black text-xs uppercase tracking-wider mb-1">
                           <span class="opacity-50">>></span> ${name}
                        </div> 
                        <div class="neon-text text-cyan-50 font-mono text-sm leading-relaxed antialiased">
                            ${content}
                        </div>
                    </div>`;
            } else {
                // üêâ TRADITIONAL PARCHMENT LAYOUT
                html += `
                    <div class="mb-3 text-sm leading-relaxed text-black">
                        <strong class="text-red-900 font-bold italic">${name}.</strong> 
                        ${content}
                    </div>`;
            }
        }
    });

    return html;
};

const fmtList = (val) => Array.isArray(val) ? val.join(', ') : (val || '-');


// The core function to build the full, collapsable statblock card
const renderDetailedSrdMonster = (m, index) => {
    // 1. SYSTEM CHECK
    const isSW5e = (window.currentSystem === 'sw5e');
    const uniqueId = `monster-${index}`;

    // 2. NORMALIZE BASIC STATS
    const hp = m.hitPoints || m.hit_points || 10;
    const ac = m.armorClass || m.armor_class || 10;
    const cr = m.challengeRating || m.challenge_rating || "0";
    const dex = m.dexterity || 10;
    const speedRaw = m.speed || m.speed_desc || "30 ft.";
    const safeName = m.name.replace(/'/g, "\\'");

    // 3. üöÄ SW5E DEEP-DATA MAPPING (The Fix)
    // Star Wars API stores combat logic in 'behaviors' and 'actions'
    let monsterTraits = [];
    let monsterActions = [];
    let monsterReactions = [];
    let monsterLegendary = [];

    if (isSW5e) {
        // Star Wars data normalization
        monsterTraits = m.behaviors ? m.behaviors.filter(b => b.monsterBehaviorTypeEnum === 1 || b.name === "Traits") : [];
        monsterActions = m.behaviors ? m.behaviors.filter(b => b.monsterBehaviorTypeEnum === 2 || b.name === "Actions") : [];
        monsterReactions = m.behaviors ? m.behaviors.filter(b => b.monsterBehaviorTypeEnum === 3 || b.name === "Reactions") : [];
        monsterLegendary = m.behaviors ? m.behaviors.filter(b => b.monsterBehaviorTypeEnum === 4 || b.name === "Legendary Actions") : [];
    } else {
        // Standard D&D mapping
        monsterTraits = m.traits || m.special_abilities || [];
        monsterActions = m.actions || [];
        monsterReactions = m.reactions || [];
        monsterLegendary = m.legendaryActions || m.legendary_actions || [];
    }

    // 4. DYNAMIC STYLING
    const blockClass = isSW5e ? "stat-block" : "dnd-statblock"; 
    const headerColor = isSW5e ? "text-cyan-400" : "text-red-800";
    const ruleStyle = isSW5e ? "border-b border-cyan-900/50 my-3" : "tapered-rule";
    const subTextColor = isSW5e ? "text-cyan-100/80" : "text-black";

    const speedDisplay = typeof speedRaw === 'object' ? 
        Object.entries(speedRaw).map(([k, v]) => `${k} ${v}`).join(', ') : speedRaw;
    
    let saves = [];
    const sMap = { "Str": m.strengthSave, "Dex": m.dexteritySave, "Con": m.constitutionSave, "Int": m.intelligenceSave, "Wis": m.wisdomSave, "Cha": m.charismaSave };
    Object.entries(sMap).forEach(([k, v]) => { if (v != null) saves.push(`${k} ${v >= 0 ? '+' : ''}${v}`); });

    const div = document.createElement('div');
    div.className = `bg-gray-800 rounded border ${isSW5e ? 'border-cyan-500/30' : 'border-gray-700'} overflow-hidden mb-2`;
    
    div.innerHTML = `
        <div class="p-3 flex justify-between items-center cursor-pointer hover:bg-gray-700 transition" onclick="document.getElementById('${uniqueId}').classList.toggle('hidden')">
            <div>
                <div class="font-bold ${isSW5e ? 'text-cyan-300' : 'text-blue-200'} text-sm">
                    ${isSW5e ? 'üõ∞Ô∏è ' : ''}${m.name} <span class="text-[10px] text-gray-500">‚ñº</span>
                </div>
                <div class="text-[10px] text-gray-500 uppercase tracking-tighter">
                    ${isSW5e ? 'Threat' : 'CR'} ${cr} ‚Ä¢ AC ${ac} ‚Ä¢ HP ${hp}
                </div>
            </div>
            <button onclick="event.stopPropagation(); window.importCompendiumMonster('${safeName}', ${hp}, ${ac}, ${Math.floor((dex-10)/2)})" 
                    class="${isSW5e ? 'bg-cyan-950 border-cyan-500 text-cyan-300' : 'bg-green-700 border-green-500 text-white'} text-[10px] font-bold py-1 px-3 rounded border">
                ${isSW5e ? 'DATA-LINK' : '+ Add'}
            </button>
        </div>
        <button onclick="event.stopPropagation(); window.saveCompendiumToNotes(${index})" 
            class="${isSW5e ? 'bg-indigo-900 border-indigo-500 text-indigo-200' : 'bg-blue-700 border-blue-500 text-white'} text-[10px] font-bold py-1 px-3 rounded border">
        üíæ ${isSW5e ? 'ARCHIVE' : 'Save'}
    </button>
</div>
        
        <div id="${uniqueId}" class="hidden border-t ${isSW5e ? 'border-cyan-900' : 'border-gray-600'}">
            <div class="${blockClass} text-left text-sm p-4">
                <div class="${headerColor} text-xl border-b-2 ${isSW5e ? 'border-cyan-400' : 'border-red-800'} mb-1 font-bold uppercase tracking-widest">
                    ${m.name}
                </div>
                <div class="italic text-xs mb-2 ${subTextColor}">
                    ${m.size || ''} ${m.type || ''}, ${m.alignment || m.align || ''}
                </div>
                
                <div class="${ruleStyle}"></div>
                
                <div class="${isSW5e ? 'text-cyan-100' : 'text-red-900'} font-serif">
                    <p><strong>Armor Class</strong> ${ac} <span class="opacity-60 text-xs">(${m.armorDesc || m.armor_class_desc || 'natural'})</span></p>
                    <p><strong>Hit Points</strong> ${hp} <span class="opacity-60 text-xs">(${m.hitDice || m.hit_dice || ''})</span></p>
                    <p><strong>Speed</strong> ${speedDisplay}</p>
                </div>

                <div class="${ruleStyle}"></div>

                <div class="grid grid-cols-6 text-center ${isSW5e ? 'text-cyan-400' : 'text-red-900'} text-[10px] font-bold my-2">
                    <div>STR<br>${m.strength||10}</div>
                    <div>DEX<br>${m.dexterity||10}</div>
                    <div>CON<br>${m.constitution||10}</div>
                    <div>INT<br>${m.intelligence||10}</div>
                    <div>WIS<br>${m.wisdom||10}</div>
                    <div>CHA<br>${m.charisma||10}</div>
                </div>

                <div class="${ruleStyle}"></div>

                <div class="text-xs ${isSW5e ? 'text-cyan-200' : 'text-red-900'} space-y-1 mt-2">
                    <p><strong>Saving Throws:</strong> <span class="${isSW5e ? 'text-white' : 'text-black'}">${saves.join(', ') || '-'}</span></p>
                    <p><strong>Senses:</strong> <span class="${isSW5e ? 'text-white' : 'text-black'}">${m.senses || 'passive Perception 10'}</span></p>
                    <p><strong>Languages:</strong> <span class="${isSW5e ? 'text-white' : 'text-black'}">${m.languages || m.languagesKnown || '-'}</span></p>
                </div>

                <div class="mt-4 space-y-3 ${isSW5e ? 'text-cyan-50' : 'text-black'}">
                    ${fmtSrdSection(isSW5e ? "Passive Subroutines" : "Traits", monsterTraits)}
                    ${fmtSrdSection(isSW5e ? "Combat Behaviors" : "Actions", monsterActions)}
                    ${fmtSrdSection(isSW5e ? "Countermeasures" : "Reactions", monsterReactions)}
                    ${fmtSrdSection(isSW5e ? "Legendary Cycles" : "Legendary Actions", monsterLegendary)}
                </div>
            </div>
        </div>
    `;
    return div;
};


    window.searchCompendium = async () => {
    const rawQuery = document.getElementById('compendium-search').value.trim();
    const list = document.getElementById('compendium-results');
    
    if (!rawQuery) {
        list.innerHTML = '<p class="text-center text-gray-500 text-xs">Search the database...</p>';
        return;
    }
    
    list.innerHTML = '<div class="loading-spinner mx-auto mt-10"></div>';
    
    try {
        let results = [];
        const query = rawQuery.toLowerCase();

        if (window.currentSystem === 'sw5e') {
            // üöÄ STAR WARS SEARCH
            const url = `https://sw5eapi.azurewebsites.net/api/monster?search=${rawQuery}`;
            const res = await fetch(url);
            const data = await res.json();
            // Strict "Starts With" filter
            results = data.filter(m => m.name.toLowerCase().startsWith(query));
        } else {
            // üêâ D&D SEARCH (Increased limit to find "B" monsters)
            const url = `https://api.open5e.com/monsters/?limit=200&search=${rawQuery}&ordering=name`;
            const res = await fetch(url);
            const data = await res.json();
            
            // Filter to ensure results actually START with the search term
            results = data.results.filter(m => m.name.toLowerCase().startsWith(query));
            
            // Fetch full details for the filtered D&D monsters
            const detailPromises = results.map(m => fetch(`https://api.open5e.com/monsters/${m.slug}/`).then(r => r.json()));
            results = await Promise.all(detailPromises);
        }

        if (results.length === 0) {
            list.innerHTML = `<p class="text-center text-gray-500 text-xs mt-5">No records found for "${rawQuery}".</p>`;
            return;
        }

        list.innerHTML = '';
        results.forEach((m, index) => {
            // Map keys so the renderer works for both systems
            const normalizedMonster = {
                ...m,
                hp: m.hit_points || m.hitPoints || 10,
                ac: m.armor_class || m.armorClass || 10
            };
            list.appendChild(renderDetailedSrdMonster(normalizedMonster, index));
        });
            
    } catch (error) {
        console.error("Database Error:", error);
        list.innerHTML = `<p class="text-red-400 text-xs text-center font-bold">‚ö†Ô∏è Connection to the archives failed.</p>`;
    }
};
        // --- THE MISSING IMPORT FUNCTION ---
    // ==========================================
// ‚öîÔ∏è FIX: IMPORT COMPENDIUM MONSTER (PRE-POPULATES COMBAT INPUTS)
// ==========================================
window.importCompendiumMonster = async (name, hp, ac, initMod) => {
    // 1. Check if logged in (Still necessary for session data)
    if(!window.isAuthReady) { 
        alert("Please log in to a session first."); 
        window.openLoginModal(); 
        return; 
    }
    
    // 2. Populate the Combat Input Fields
    
    // Set the Name field with the SRD monster's name
    document.getElementById('combatant-name').value = name; 
    
    // Set the HP and AC fields
    document.getElementById('combatant-hp').value = hp; 
    document.getElementById('combatant-ac').value = ac; 
    
    // Set the Init field with the calculated DEX modifier
    // The user can now add the D20 roll or adjust the modifier if needed.
    document.getElementById('combatant-init').value = initMod;
    
    // Reset the Count field to 1, ready for adjustment (e.g., set to 5)
    document.getElementById('combatant-count').value = 1;

    // 3. Switch to the Combat Tab to show the populated fields
    window.switchTab('combat');

    // Optional: Add a subtle confirmation
    const statusEl = document.getElementById('db-status');
    if (statusEl) {
        statusEl.textContent = `Ready to add ${name}. Set count and press ADD.`;
        statusEl.className = "text-xs px-2 py-1 rounded bg-gray-700 text-yellow-400";
    }
};
    
    // --- 13. ENCOUNTER BALANCER ---
    let calcMonsters = [];
    
    // XP Thresholds per Character Level [Level, Easy, Med, Hard, Deadly]
    const xpThresholds = {
        1: [25, 50, 75, 100], 2: [50, 100, 150, 200], 3: [75, 150, 225, 400], 4: [125, 250, 375, 500],
        5: [250, 500, 750, 1100], 6: [300, 600, 900, 1400], 7: [350, 750, 1100, 1700], 8: [450, 900, 1400, 2100],
        9: [550, 1100, 1600, 2400], 10: [600, 1200, 1900, 2800], 11: [800, 1600, 2400, 3600], 12: [1000, 2000, 3000, 4500],
        13: [1100, 2200, 3400, 5100], 14: [1250, 2500, 3800, 5700], 15: [1400, 2800, 4300, 6400], 16: [1600, 3200, 4800, 7200],
        17: [2000, 3900, 5900, 8800], 18: [2100, 4200, 6300, 9500], 19: [2400, 4900, 7300, 10900], 20: [2800, 5700, 8500, 12700]
    };

    window.addCalcMonster = () => {
        const select = document.getElementById('calc-cr');
        const xp = parseInt(select.value);
        const count = parseInt(document.getElementById('calc-count').value) || 1;
        const label = select.options[select.selectedIndex].text;
        
        for(let i=0; i<count; i++) calcMonsters.push(xp);
        window.calcEncounter();
    };

    window.removeCalcMonster = (index) => {
        calcMonsters.splice(index, 1);
        window.calcEncounter();
    };

    window.clearCalc = () => {
        calcMonsters = [];
        window.calcEncounter();
    };

    window.calcEncounter = () => {
        const list = document.getElementById('calc-monster-list');
        const resultBox = document.getElementById('calc-result');
        const diffText = document.getElementById('calc-difficulty-text');
        const xpDetail = document.getElementById('calc-xp-details');
        
        // 1. Render List
        list.innerHTML = '';
        calcMonsters.forEach((xp, idx) => {
            const tag = document.createElement('span');
            tag.className = 'bg-gray-700 text-gray-200 text-xs px-2 py-1 rounded cursor-pointer hover:bg-red-900';
            tag.innerHTML = `${xp} XP &times;`;
            tag.onclick = () => window.removeCalcMonster(idx);
            list.appendChild(tag);
        });

        if (calcMonsters.length === 0) {
            diffText.textContent = "Add Monsters...";
            diffText.className = "text-2xl font-bold text-gray-500";
            resultBox.className = "bg-gray-900 p-4 rounded-lg text-center border border-gray-700";
            xpDetail.textContent = "";
            return;
        }

        // 2. Calculate Math
        const partySize = parseInt(document.getElementById('calc-party-size').value) || 4;
        const level = parseInt(document.getElementById('calc-party-level').value) || 1;
        
        // Total Raw XP
        const totalXP = calcMonsters.reduce((a, b) => a + b, 0);
        
        // Multiplier based on count (DMG p.82)
        let mult = 1;
        const n = calcMonsters.length;
        if (n === 2) mult = 1.5;
        else if (n >= 3 && n <= 6) mult = 2;
        else if (n >= 7 && n <= 10) mult = 2.5;
        else if (n >= 11 && n <= 14) mult = 3;
        else if (n >= 15) mult = 4;

        // Adjusted XP for Difficulty
        const adjustedXP = totalXP * mult;

        // Party Thresholds
        const thresholds = xpThresholds[level] || xpThresholds[1];
        const partyEasy = thresholds[0] * partySize;
        const partyMed = thresholds[1] * partySize;
        const partyHard = thresholds[2] * partySize;
        const partyDeadly = thresholds[3] * partySize;

        // Determine Rating
        let rating = "Trivial";
        let colorClass = "text-gray-400 border-gray-600";

        if (adjustedXP >= partyDeadly) { rating = "üíÄ Deadly"; colorClass = "text-red-500 border-red-500 shadow-[0_0_15px_rgba(239,68,68,0.4)]"; }
        else if (adjustedXP >= partyHard) { rating = "Hard"; colorClass = "text-orange-400 border-orange-400"; }
        else if (adjustedXP >= partyMed) { rating = "Medium"; colorClass = "text-yellow-300 border-yellow-300"; }
        else if (adjustedXP >= partyEasy) { rating = "Easy"; colorClass = "text-green-400 border-green-400"; }

        diffText.textContent = rating;
        resultBox.className = `bg-gray-900 p-4 rounded-lg text-center border-2 transition duration-300 ${colorClass}`;
        xpDetail.textContent = `Adjusted XP: ${adjustedXP} (Daily Budget: ${Math.round((adjustedXP / (partyDeadly*3))*100)}%)`;
    };
    
    // --- 14. RULES ENGINE (Updated with Armor) ---
    let currentRuleMode = 'spells'; 

    window.switchRuleMode = (mode, btn) => {
        currentRuleMode = mode;
        
        // 1. Update UI Styles
        document.querySelectorAll('.rule-sub-tab').forEach(b => {
            b.classList.remove('active', 'border-b-2', 'border-purple-400', 'text-purple-300');
            b.classList.add('text-gray-400');
        });
        btn.classList.add('active', 'border-b-2', 'border-purple-400', 'text-purple-300');
        btn.classList.remove('text-gray-400');
        
        // 2. Update Placeholder
        const input = document.getElementById('library-search');
        input.value = "";
        
        if(mode === 'spells') input.placeholder = "Search spells (e.g. Fireball)...";
        else if(mode === 'weapons') input.placeholder = "Search weapons (e.g. Dagger)...";
        else if(mode === 'armor') input.placeholder = "Search armor (e.g. Plate)...";
        else input.placeholder = "Search rules (e.g. Cover)...";

        // 3. Auto-load everything except Spells (list is small enough)
        window.searchLibrary();
    };

    // üü¢ UPDATED SEARCH: Sorts Armor by Weight (Light -> Heavy)
    window.searchLibrary = async () => {
        const rawQuery = document.getElementById('library-search').value.trim();
        const list = document.getElementById('library-results');
        
        // Only enforce typing for Spells (to save data/speed)
        if (!rawQuery && currentRuleMode === 'spells') {
             list.innerHTML = '<p class="text-center text-gray-500 text-xs">Type a spell name to search...</p>';
             return;
        }

        list.innerHTML = '<div class="loading-spinner mx-auto"></div>';

        try {
            // 1. Build URL
            let url = `https://api.open5e.com/${currentRuleMode}/?limit=${currentRuleMode === 'spells' ? 20 : 100}`;
            
            if (rawQuery) {
                url += `&search=${rawQuery}`;
            } else if (currentRuleMode !== 'spells') {
                url += `&ordering=name`; 
            }

            const res = await fetch(url);
            const data = await res.json();
            let results = data.results;

            if (results.length === 0) {
                list.innerHTML = '<p class="text-center text-gray-500 text-xs">No results found.</p>';
                return;
            }

            // 2. Client-Side Sorting (Smart Sort)
            if (rawQuery) {
                // Search Relevance Sorting
                const query = rawQuery.toLowerCase();
                results.sort((a, b) => {
                    const nameA = a.name.toLowerCase();
                    const nameB = b.name.toLowerCase();
                    if (nameA === query && nameB !== query) return -1;
                    if (nameB === query && nameA !== query) return 1;
                    const startA = nameA.startsWith(query);
                    const startB = nameB.startsWith(query);
                    if (startA && !startB) return -1;
                    if (!startA && startB) return 1;
                    return nameA.length - nameB.length;
                });
            } else {
                // Default Sort
                if (currentRuleMode === 'armor') {
                    // üü¢ CUSTOM ARMOR SORT: Light -> Medium -> Heavy -> Shield
                    const weightOrder = { 'Light Armor': 1, 'Medium Armor': 2, 'Heavy Armor': 3, 'Shield': 4 };
                    const getOrder = (c) => weightOrder[c] || 5; // 5 = items like Ring Mail if category is weird

                    results.sort((a, b) => {
                        const orderA = getOrder(a.category);
                        const orderB = getOrder(b.category);
                        
                        // Sort by Category First
                        if (orderA !== orderB) return orderA - orderB;
                        
                        // Then by AC (Low to High)
                        const acA = parseInt(a.ac_string) || 0;
                        const acB = parseInt(b.ac_string) || 0;
                        return acA - acB;
                    });
                } else {
                    // Default A-Z for everything else
                    results.sort((a, b) => a.name.localeCompare(b.name));
                }
            }

            list.innerHTML = '';

            // 3. RENDER CARDS
            results.forEach((item, index) => {
                const uniqueId = `lib-${index}`;
                const div = document.createElement('div');
                div.className = 'bg-gray-800 rounded border border-gray-700 overflow-hidden mb-2';

                if (currentRuleMode === 'spells') {
                    // --- SPELL CARD ---
                    div.innerHTML = `
                        <div class="p-3 flex justify-between items-center cursor-pointer hover:bg-gray-700 transition select-none" onclick="document.getElementById('${uniqueId}').classList.toggle('hidden')">
                            <div><div class="font-bold text-purple-300 text-sm">${item.name}</div><div class="text-[10px] text-gray-400">${item.level} ‚Ä¢ ${item.school}</div></div>
                            <span class="text-[10px] text-gray-500">‚ñº</span>
                        </div>
                        <div id="${uniqueId}" class="hidden bg-gray-900/50 p-3 border-t border-gray-600 text-xs text-gray-300 leading-relaxed">
                            <p class="mb-2"><strong class="text-purple-400">Range:</strong> ${item.range} | <strong class="text-purple-400">Comp:</strong> ${item.components} | <strong class="text-purple-400">Dur:</strong> ${item.duration}</p>
                            <div class="whitespace-pre-wrap">${item.desc}</div>
                        </div>`;
                } 
                else if (currentRuleMode === 'weapons') {
                    // --- WEAPON CARD ---
                    const props = item.properties ? item.properties.map(p => p.name || p).join(', ') : '-';
                    div.innerHTML = `
                        <div class="p-3 flex justify-between items-center cursor-pointer hover:bg-gray-700 transition select-none" onclick="document.getElementById('${uniqueId}').classList.toggle('hidden')">
                            <div class="flex items-center gap-3">
                                <div class="font-bold text-red-300 text-sm">${item.name}</div>
                                <div class="text-xs font-mono bg-gray-700 px-2 py-0.5 rounded text-white">${item.damage_dice || '-'} ${item.damage_type || ''}</div>
                            </div>
                            <span class="text-[10px] text-gray-500">‚ñº</span>
                        </div>
                        <div id="${uniqueId}" class="hidden bg-gray-900/50 p-3 border-t border-gray-600 text-xs text-gray-300 leading-relaxed grid grid-cols-2 gap-2">
                            <div><strong class="text-red-400">Category:</strong> ${item.category}</div>
                            <div><strong class="text-red-400">Cost:</strong> ${item.cost}</div>
                            <div><strong class="text-red-400">Weight:</strong> ${item.weight}</div>
                            <div class="col-span-2"><strong class="text-red-400">Properties:</strong> ${props}</div>
                        </div>`;
                } 
                else if (currentRuleMode === 'armor') {
                    // --- üõ°Ô∏è ARMOR CARD (With Category Badge) ---
                    const stealth = item.stealth_disadvantage ? '<span class="text-red-400">Disadvantage</span>' : '<span class="text-green-400">Normal</span>';
                    const strReq = item.strength_requirement ? item.strength_requirement : '-';
                    
                    // Color code the category badge
                    let catColor = "text-gray-400 border-gray-600";
                    if(item.category.includes('Light')) catColor = "text-blue-300 border-blue-500";
                    if(item.category.includes('Medium')) catColor = "text-green-300 border-green-500";
                    if(item.category.includes('Heavy')) catColor = "text-orange-300 border-orange-500";
                    
                    div.innerHTML = `
                        <div class="p-3 flex justify-between items-center cursor-pointer hover:bg-gray-700 transition select-none" onclick="document.getElementById('${uniqueId}').classList.toggle('hidden')">
                            <div class="flex items-center gap-3">
                                <div class="font-bold text-gray-200 text-sm">${item.name}</div>
                                <div class="text-[10px] font-bold ${catColor} bg-gray-900 px-2 py-0.5 rounded border">${item.category}</div>
                            </div>
                            <span class="text-[10px] text-gray-500">‚ñº</span>
                        </div>
                        <div id="${uniqueId}" class="hidden bg-gray-900/50 p-3 border-t border-gray-600 text-xs text-gray-300 leading-relaxed">
                            <div class="grid grid-cols-2 gap-2 mb-2">
                                <div><strong class="text-yellow-500">AC:</strong> ${item.ac_string}</div>
                                <div><strong class="text-gray-500">Cost:</strong> ${item.cost}</div>
                                <div><strong class="text-gray-500">Stealth:</strong> ${stealth}</div>
                                <div><strong class="text-gray-500">Min Str:</strong> ${strReq}</div>
                                <div><strong class="text-gray-500">Weight:</strong> ${item.weight}</div>
                                <div><strong class="text-gray-500">Don/Doff:</strong> ${item.category.includes('Heavy') ? '10 min / 5 min' : '1 min / 1 min'}</div>
                            </div>
                        </div>`;
                }
                else {
                    // --- RULES CARD ---
                    div.innerHTML = `
                        <div class="p-3 flex justify-between items-center cursor-pointer hover:bg-gray-700 transition select-none" onclick="document.getElementById('${uniqueId}').classList.toggle('hidden')">
                            <div class="font-bold text-yellow-200 text-sm">${item.name}</div>
                            <span class="text-[10px] text-gray-500">‚ñº</span>
                        </div>
                        <div id="${uniqueId}" class="hidden bg-gray-900/50 p-3 border-t border-gray-600 text-xs text-gray-300 leading-relaxed whitespace-pre-wrap">${item.desc}</div>`;
                }
                list.appendChild(div);
            });

        } catch (error) {
            console.error(error);
            list.innerHTML = '<p class="text-center text-red-400 text-xs">Error fetching data.</p>';
        }
    };

// --- 15. NAME GENERATOR (Expanded & Gendered) ---
    const nameDatabase = {
        "Human": { 
            male: ["Alaric", "Bram", "Dorian", "Garret", "Ivo", "Kael", "Niles", "Orin", "Silas", "Vane", "Alden", "Roric", "Ewan", "Gareth", "Lucian", "Torian", "Victor", "Xander", "Hollis", "Jareth"], 
            female: ["Celia", "Elara", "Fiora", "Halia", "Jessa", "Lora", "Maren", "Petra", "Ria", "Tamsin", "Veda", "Lyra", "Amara", "Brenna", "Dalia", "Elena", "Kiera", "Nora", "Ophelia", "Serena"], 
            last: ["Stormwind", "Blackwood", "Thorne", "Rivera", "Crowley", "Falconer", "Weaver", "Dunn", "Hart", "Mercer", "Ashford", "Brightwood", "Drake", "Fletcher", "Grimm", "Hawthorne", "Ironwood", "Sterling", "Vance", "Whitmore"] 
        },
        "Elf": { 
            male: ["Adran", "Carric", "Erdan", "Galin", "Himo", "Ivellios", "Mindartis", "Paelias", "Riardon", "Thamior", "Aramil", "Aust", "Enialis", "Heian", "Laucian", "Quarion", "Soveliss", "Tharivol", "Varis"], 
            female: ["Bylia", "Deara", "Faen", "Lia", "Naivara", "Quillathe", "Silaqui", "Thia", "Vadania", "Valanthe", "Adrie", "Althaea", "Anastrianna", "Andraste", "Bethrynna", "Caelynn", "Drusilia", "Ielenia", "Jelenneth", "Keyleth", "Leshanna", "Meriele", "Mialee", "Theirastra"], 
            last: ["Amakiir", "Caerdonel", "Galanodel", "Holimion", "Ilphelkiir", "Liadon", "Meliamne", "Nailo", "Siannodel", "Xiloscient", "Gemflower", "Moonwhisper", "Oakwalker", "Nightbreeze", "Starflower", "Silverfrond"] 
        },
        "Dwarf": { 
            male: ["Adrik", "Baern", "Brottor", "Dain", "Darrak", "Eberk", "Fargrim", "Gardain", "Harbek", "Kildrak", "Morgran", "Orsik", "Rangrim", "Thoradin", "Tordek", "Travok", "Ulfgar", "Veit", "Vondal"], 
            female: ["Amber", "Artin", "Audhild", "Bardryn", "Dagnal", "Diesa", "Eldeth", "Falkrunn", "Finellen", "Gunnloda", "Gurdis", "Helja", "Hlin", "Kathra", "Kristryd", "Ilde", "Liftrasa", "Mardred", "Riswynn", "Torbera", "Vistra"], 
            last: ["Battlehammer", "Brawnanvil", "Fireforge", "Frostbeard", "Gorunn", "Ironfist", "Loderr", "Strakeln", "Torunn", "Ungart", "Balderk", "Dankil", "Holderhek", "Loderr", "Lutgehr", "Rumnaheim", "Strakeln", "Torunn"] 
        },
        "Orc": { 
            male: ["Dench", "Feng", "Gell", "Henk", "Holg", "Imsh", "Keth", "Krusk", "Mhurren", "Ront", "Shump", "Thokk", "Grom", "Horgar", "Drago", "Rath", "Sark", "Varg"], 
            female: ["Baggi", "Emen", "Engong", "Kansif", "Myev", "Neega", "Ovak", "Ownka", "Shautha", "Sutha", "Vola", "Volen", "Grel", "Mog", "Nargol", "Urzoth"], 
            last: ["Ironhide", "Bonebreaker", "Doomhammer", "Skullcrusher", "Fist of Grumsh", "The Vile", "Bloodaxe", "Stormcaller", "Eye-Gouger", "Rot-Tooth", "Darkblood", "Deathblade", "Hell-Scream", "Iron-Tusk", "Red-Eye", "Steel-Jaw"] 
        },
        "Halfling": { 
            male: ["Alton", "Ander", "Cade", "Corrin", "Eldon", "Errich", "Finnan", "Garret", "Lindal", "Lyle", "Merric", "Milo", "Osborn", "Perrin", "Reed", "Roscoe", "Wellby"], 
            female: ["Andry", "Bree", "Callie", "Cora", "Euphemia", "Jillian", "Kithri", "Lavinia", "Lidda", "Merla", "Nedda", "Paela", "Portia", "Seraphina", "Shaena", "Trym", "Vani", "Verna"], 
            last: ["Brushgather", "Goodbarrel", "Greenbottle", "High-hill", "Hilltopple", "Leagallow", "Tealeaf", "Thorngage", "Tosscobble", "Underbough", "Alderleaf", "Blackberry", "Bramblefoot", "Cherrycheeks", "Elderberry", "Kettlewhistle", "Nimblefingers"] 
        },
        "Tiefling": { 
            male: ["Akmenos", "Amnon", "Barakas", "Damakos", "Ekemon", "Iados", "Kairon", "Leucis", "Melech", "Mordai", "Morthos", "Pelaios", "Skamos", "Therai"], 
            female: ["Akta", "Bryseis", "Damaia", "Ea", "Kallista", "Lerissa", "Makaria", "Nemeia", "Orianna", "Phelaia", "Rieta", "Levidia", "Mehetabel", "Nezznar", "Ophelia"], 
            last: ["Art", "Carrion", "Chant", "Creed", "Despair", "Excellence", "Fear", "Glory", "Hope", "Ideal", "Music", "Nowhere", "Open", "Poetry", "Quest", "Random", "Reverence", "Sorrow", "Temerity", "Torment", "Weary", "Zeal"] 
        },
        "Dragonborn": {
             male: ["Arjhan", "Balasar", "Bharash", "Donaar", "Ghesh", "Heskan", "Kriv", "Medrash", "Mehen", "Nadarr", "Pandjed", "Patrin", "Rhogar", "Shamash", "Shedinn", "Tarhun", "Torinn"],
             female: ["Akra", "Biri", "Daar", "Farideh", "Harann", "Havilar", "Jheri", "Kava", "Korinn", "Mishann", "Nala", "Perra", "Raiann", "Sora", "Surina", "Thava", "Uadjit"],
             last: ["Clethtinthiallor", "Daardendrian", "Delmirev", "Drachedandion", "Fenkenkabradon", "Kepeshkmolik", "Kerrhylon", "Kimbatuul", "Linxakasendalor", "Myistan", "Nemmonis", "Norixius", "Ophinshtalajiir", "Prexijandilin", "Shestendeliath", "Turnuroth", "Verthisathurgiesh", "Yarjerit"]
        },
        "Gnome": {
             male: ["Boddynock", "Dimble", "Fonkin", "Gimble", "Glim", "Gerbo", "Jebeddo", "Namfoodle", "Roondar", "Seebo", "Zook"],
             female: ["Bimpnottin", "Breena", "Caramip", "Carlin", "Donella", "Duvamil", "Ella", "Ellyjobell", "Ellywick", "Lilli", "Loopmottin", "Lorilla", "Mardnab", "Nissa", "Nyx", "Oda"],
             last: ["Beren", "Daergel", "Folkor", "Garrick", "Nackle", "Murnig", "Ningel", "Raulnor", "Scheppen", "Timbers", "Turen"]
        },
        "Goblin": {
             male: ["Griz", "Raz", "Tark", "Vig", "Zog", "Bok", "Nark", "Rik", "Snik", "Grob", "Krag", "Mok"],
             female: ["Gree", "Mee", "Vola", "Yig", "Zeka", "Bree", "Nola", "Rika", "Sola", "Tika", "Vika", "Zola"],
             last: ["Mudfoot", "Red-Eye", "Ear-Biter", "Rat-Catcher", "Toad-Licker", "Worm-Eater", "Sneak-Thief", "Back-Stabber", "Gold-Stealer", "Sharp-Tooth"]
        },
        "Tabaxi": {
             male: ["Cloud", "Rain", "Storm", "Thunder", "River", "Smoke", "Shadow", "Midnight", "Flicker", "Sprint", "Claw", "Fang"],
             female: ["Mist", "Ember", "Dawn", "Dusk", "Star", "Moon", "Sun", "Sky", "Leaf", "Flower", "Berry", "Root"],
             last: ["of the Mountains", "on the Water", "in the Wind", "under the Stars", "walking softly", "running fast", "hiding in shadows", "singing loudly", "dancing wildly", "sleeping soundly"]
        },
        "Kenku": {
             male: ["Click", "Clack", "Snap", "Pop", "Whistle", "Hoot", "Caw", "Screech", "Chirp", "Rustle", "Thump", "Crash"],
             female: ["Ring", "Chime", "Echo", "Whisper", "Murmur", "Hum", "Song", "Melody", "Harmony", "Rhythm", "Beat", "Tune"],
             last: ["Sounder", "Mimic", "Copycat", "Repeater", "Echoer", "Parrot", "Mocker", "Imitator", "Simulator", "Replicator"]
        },
        "Genasi": {
             male: ["Ignis", "Aqua", "Terra", "Aero", "Pyro", "Hydro", "Geo", "Zephyr", "Blaze", "Tide", "Stone", "Gale"],
             female: ["Ember", "River", "Gem", "Bree", "Ash", "Rain", "Jade", "Skye", "Flame", "Mist", "Crystal", "Cloud"],
             last: ["Fireborn", "Waterwalker", "Earthshaker", "Windrider", "Stormcaller", "Tidemaker", "Stoneforger", "Skywatcher", "Flamekeeper", "Wavebreaker"]
        }
    };

    window.generateNames = () => {
        const race = document.getElementById('name-race').value;
        const gender = document.getElementById('name-gender').value; // Get gender
        const data = nameDatabase[race];
        const output = document.getElementById('name-output');
        
        if (!data) return;
        
        // Select the correct list based on gender
        const firstNames = data[gender];
        const lastNames = data.last;

        let html = '';
        for (let i = 0; i < 5; i++) {
            const f = firstNames[Math.floor(Math.random() * firstNames.length)];
            const l = lastNames[Math.floor(Math.random() * lastNames.length)];
            html += `<div class="flex justify-between items-center bg-gray-800 px-2 py-1 rounded border border-gray-700">
                        <span class="text-pink-100 font-medium">${f} ${l}</span>
                        <button onclick="navigator.clipboard.writeText('${f} ${l}')" class="text-[10px] text-gray-500 hover:text-white uppercase tracking-wider">Copy</button>
                     </div>`;
        }
        output.innerHTML = html;
    };

    // --- 16. HOMEBREW ENGINE (Crash-Proof Fix) ---
    
    // 1. CONFIGURATION
    const getPublicBrewCol = () => window.collection(window.db, 'aegis_community_items');
    const ADMIN_ID = "DBFLOO3aeeZ4ySvDi2lSzUdTNzY2"; 
    const calcMod = (score) => { const m = Math.floor(((parseInt(score)||10) - 10) / 2); return m >= 0 ? `+${m}` : m; };

    // 2. UI SWITCHER
    window.unsubCommunity = null;
    window.currentCommunityFilter = 'all';

    window.switchBrewMode = (mode, btn) => {
        if (window.unsubCommunity) { window.unsubCommunity(); window.unsubCommunity = null; }
        
        document.querySelectorAll('.brew-sub-tab').forEach(b => {
            b.classList.remove('bg-orange-600', 'text-white', 'bg-blue-600'); 
            b.classList.add('text-gray-400');
        });
        btn.classList.remove('text-gray-400');
        
        document.getElementById('brew-monster-area').classList.add('hidden');
        document.getElementById('brew-weapon-area').classList.add('hidden');
        document.getElementById('brew-magic-area').classList.add('hidden');
        document.getElementById('brew-community-area').classList.add('hidden');
        document.getElementById(`brew-${mode}-area`).classList.remove('hidden');
        
        const inv = document.getElementById('my-inventory-container');
        if(mode === 'community') {
            if(inv) inv.classList.add('hidden');
            window.filterCommunity('all'); 
        } else {
            if(inv) inv.classList.remove('hidden');
        }
    };

    // 3. DATA HELPER (SAFE)
    // This function safely grabs values even if fields are empty/missing to prevent crashes
    const getSafeValue = (id) => {
        const el = document.getElementById(id);
        return el ? el.value : "";
    };

    const getMonsterData = () => {
        return {
            name: getSafeValue('hb-mon-name').trim(),
            type: getSafeValue('hb-mon-type'),
            ac: getSafeValue('hb-mon-ac'),
            hp: getSafeValue('hb-mon-hp'),
            hitDice: getSafeValue('hb-mon-hitdice'),
            spd: getSafeValue('hb-mon-spd'),
            str: getSafeValue('hb-mon-str'), dex: getSafeValue('hb-mon-dex'),
            con: getSafeValue('hb-mon-con'), int: getSafeValue('hb-mon-int'),
            wis: getSafeValue('hb-mon-wis'), cha: getSafeValue('hb-mon-cha'),
            saves: getSafeValue('hb-mon-saves'), skills: getSafeValue('hb-mon-skills'),
            senses: getSafeValue('hb-mon-senses'), langs: getSafeValue('hb-mon-langs'),
            cr: getSafeValue('hb-mon-cr'), xp: getSafeValue('hb-mon-xp'),
            traits: getSafeValue('hb-mon-traits'), actions: getSafeValue('hb-mon-actions'),
            reactions: getSafeValue('hb-mon-reactions'),
            // Combat Helper Fields
            init: getSafeValue('hb-mon-init'), tohit: getSafeValue('hb-mon-tohit'),
            atk: getSafeValue('hb-mon-atkname'), dmg: getSafeValue('hb-mon-dmg'),
            category: 'monster',
            timestamp: new Date().toISOString()
        };
    };

    // 4. HTML GENERATORS (SAFE)
    const generateMonsterHTML = (d) => {
        // Safe formatter handles undefined/null text
        const fmt = (t) => t ? t.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>') : '';
        
        return `
        <div class="dnd-statblock text-left text-sm" style="width:100%; margin-bottom:10px;">
            <div class="dnd-header">${d.name || "Unknown"}</div>
            <div class="italic text-black text-xs mb-2">${d.type || "Monster"}</div>
            <div class="tapered-rule"></div>
            <div class="text-red-900 font-serif">
                <p><strong>Armor Class</strong> ${d.ac || 10}</p>
                <p><strong>Hit Points</strong> ${d.hp || 10} ${d.hitDice ? `<span class="text-black">(${d.hitDice})</span>` : ''}</p>
                <p><strong>Speed</strong> ${d.spd || "30 ft."}</p>
            </div>
            <div class="tapered-rule"></div>
            <div class="grid grid-cols-6 text-center text-red-900 text-xs font-bold my-2">
                <div>STR<br>${d.str||10} (${calcMod(d.str)})</div>
                <div>DEX<br>${d.dex||10} (${calcMod(d.dex)})</div>
                <div>CON<br>${d.con||10} (${calcMod(d.con)})</div>
                <div>INT<br>${d.int||10} (${calcMod(d.int)})</div>
                <div>WIS<br>${d.wis||10} (${calcMod(d.wis)})</div>
                <div>CHA<br>${d.cha||10} (${calcMod(d.cha)})</div>
            </div>
            <div class="tapered-rule"></div>
            <div class="text-red-900 font-serif leading-snug text-xs mb-2">
                ${d.saves ? `<p><strong>Saving Throws</strong> <span class="text-black">${d.saves}</span></p>` : ''}
                ${d.skills ? `<p><strong>Skills</strong> <span class="text-black">${d.skills}</span></p>` : ''}
                <p><strong>Senses</strong> <span class="text-black">${d.senses || "passive Perception 10"}</span></p>
                <p><strong>Languages</strong> <span class="text-black">${d.langs || "-"}</span></p>
                <p><strong>Challenge</strong> <span class="text-black">${d.cr || 0} (${d.xp || "0 XP"})</span></p>
            </div>
            <div class="tapered-rule"></div>
            <div class="text-black mt-2 space-y-3 font-serif">
                ${d.traits ? `<div>${fmt(d.traits)}</div>` : ''}
                ${d.actions ? `<div class="dnd-section-title border-b border-red-900 text-red-900 font-bold mt-2 text-lg">Actions</div><div>${fmt(d.actions)}</div>` : ''}
                ${d.reactions ? `<div class="dnd-section-title border-b border-red-900 text-red-900 font-bold mt-2 text-lg">Reactions</div><div>${fmt(d.reactions)}</div>` : ''}
            </div>
        </div>`;
    };

    const generateWeaponHTML = (name, imgData, meta1, meta2, desc) => {
        return `<div class="parchment-card" style="margin: 10px auto; width: 100%;"><div class="card-title">${name}</div>${imgData ? `<img src="${imgData}" class="card-image">` : ''}<div class="card-meta-1">${meta1}</div><div class="card-meta-2">${meta2}</div><div class="card-body">${desc}</div></div>`;
    };

    // 5. PREVIEW FUNCTIONS
    window.previewHomebrewMonster = () => {
        const data = getMonsterData();
        const preview = document.getElementById('hb-monster-preview');
        if(preview) { 
            preview.classList.remove('hidden'); 
            preview.innerHTML = generateMonsterHTML(data); 
        }
    };

    // Image Listeners
    ['hb-wep-image-input', 'hb-item-image-input'].forEach(id => {
        const el = document.getElementById(id);
        if(el) el.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if(!file) return;
            if(file.size > 500000) { alert("Image too large! Keep under 500KB."); return; }
            const reader = new FileReader();
            reader.onload = (ev) => {
                const type = id.includes('wep') ? 'wep' : 'item';
                document.getElementById(`prev-${type}-img`).src = ev.target.result;
                document.getElementById(`prev-${type}-img`).classList.remove('hidden');
                document.getElementById(`hb-${type}-image-data`).value = ev.target.result;
            };
            reader.readAsDataURL(file);
        });
    });

    window.updateWeaponPreview = () => {
        document.getElementById('prev-wep-name').textContent = getSafeValue('hb-wep-name') || "Weapon Name";
        document.getElementById('prev-wep-meta1').textContent = getSafeValue('hb-wep-meta1') || "Rarity";
        document.getElementById('prev-wep-meta2').textContent = getSafeValue('hb-wep-meta2') || "Type";
        document.getElementById('prev-wep-desc').innerText = getSafeValue('hb-wep-desc') || "Desc...";
    };
    window.updateItemPreview = () => {
        document.getElementById('prev-item-name').textContent = getSafeValue('hb-item-name') || "Item Name";
        const attune = document.getElementById('hb-item-attune').checked ? "(Attunement)" : "";
        document.getElementById('prev-item-meta1').textContent = `${getSafeValue('hb-item-rarity')} ${attune}`;
        document.getElementById('prev-item-meta2').textContent = getSafeValue('hb-item-type');
        document.getElementById('prev-item-desc').innerText = getSafeValue('hb-item-desc') || "Desc...";
    };

    // 6. SAVING (MASTER)
    window.saveHomebrewMonster = () => window.saveHomebrewToNotes('monster', false);
    window.saveHomebrewWeapon = () => window.saveHomebrewToNotes('weapon', false);
    window.saveHomebrewMagicItem = () => window.saveHomebrewToNotes('item', false);

    window.saveHomebrewToNotes = async (type, createNote = true) => {
        if (!window.isAuthReady) { alert("Login required."); return; }
        
        try {
            let title, content, tab, id = crypto.randomUUID(), timestamp = new Date().toISOString();
            
            if (type === 'monster') {
                const mData = getMonsterData();
                if(!mData.name) return alert("Name required!");
                
                // 1. Save to Stats (Simple Combat Data)
                const fullDmg = `${mData.atk}: ${mData.dmg}`;
                await window.addDoc(getCol('dm_toolkit_statblocks'), { 
                    name: mData.name, hp: parseInt(mData.hp)||10, ac: parseInt(mData.ac)||10, 
                    toHit: parseInt(mData.tohit)||0, initMod: parseInt(mData.init)||0, dmg: fullDmg, timestamp 
                });
                
                // 2. Save to Inventory (Full Data for View)
                await window.addDoc(getCol('dm_toolkit_homebrew_items'), { ...mData, props: `CR ${mData.cr} ‚Ä¢ ${mData.type}`, dmg: `HP ${mData.hp}`, type: `AC ${mData.ac}` });
                
                title = mData.name + " (Homebrew)";
                content = generateMonsterHTML(mData);
                tab = 'enemyNotes';
                
                if(!createNote) { alert("Saved to Stats & Inventory!"); document.getElementById('hb-mon-name').value=''; return; }
            } 
            else if (type === 'weapon') {
                const name = getSafeValue('hb-wep-name'); if(!name) return alert("Name!");
                const wData = {
                    name, category: 'weapon',
                    imageData: getSafeValue('hb-wep-image-data'),
                    dmg: getSafeValue('hb-wep-meta1'), type: getSafeValue('hb-wep-meta2'),
                    props: getSafeValue('hb-wep-desc'), isParchment: true, timestamp
                };
                await window.addDoc(getCol('dm_toolkit_homebrew_items'), wData);
                title = name;
                content = generateWeaponHTML(wData.name, wData.imageData, wData.dmg, wData.type, wData.props);
                tab = 'lootNotes';
                if(!createNote) { alert("Saved to Inventory!"); return; }
            } 
            else {
                const name = getSafeValue('hb-item-name'); if(!name) return alert("Name!");
                const iData = {
                    name, category: 'item',
                    imageData: getSafeValue('hb-item-image-data'),
                    dmg: getSafeValue('hb-item-rarity'),
                    type: getSafeValue('hb-item-type'),
                    props: `${document.getElementById('hb-item-attune').checked?"(Attunement)":""} ${getSafeValue('hb-item-desc')}`,
                    isParchment: true, timestamp
                };
                await window.addDoc(getCol('dm_toolkit_homebrew_items'), iData);
                
                window.updateItemPreview(); // Ensure updated visual
                title = name;
                content = document.getElementById('hb-item-card-preview').outerHTML;
                tab = 'lootNotes';
                if(!createNote) { alert("Saved to Inventory!"); return; }
            }

            structuredNotes[tab].unshift({ id, title, content, timestamp });
            await window.saveStructuredNotes(tab, structuredNotes[tab]);
            if(confirm(`Saved to Inventory & Notes! Go to notes?`)) { window.switchTab('notes'); window.switchSubTab(tab); }
            
        } catch(e) { console.error("Save Failed:", e); alert("Error saving: " + e.message); }
    };

    // 7. COMMUNITY SHARING
    window.filterCommunity = (type) => {
        window.currentCommunityFilter = type;
        document.querySelectorAll('.com-filter-btn').forEach(btn => {
            if (btn.textContent.toLowerCase().includes(type) || (type==='all' && btn.textContent==='All')) {
                btn.classList.add('bg-indigo-600', 'text-white'); btn.classList.remove('text-gray-400');
            } else {
                btn.classList.remove('bg-indigo-600', 'text-white'); btn.classList.add('text-gray-400');
            }
        });
        window.loadCommunityItems(); 
    };

    window.shareHomebrewItem = async (id) => {
        if(!window.isAuthReady) return;
        try {
            // Robust fetch using both possible methods
            const docRef = window.doc(getCol('dm_toolkit_homebrew_items'), id);
            let snapshot = await getDoc(docRef);
            if (!snapshot.exists()) {
                 snapshot = await getDoc(window.doc(window.db, 'artifacts/default/sessions/'+window.userId+'/data/dm_toolkit_homebrew_items/'+id));
            }
            if (!snapshot.exists()) { alert("Item not found!"); return; }
            
            const item = snapshot.data();
            if(!confirm(`Publish "${item.name}"?`)) return;
            
            await window.addDoc(getPublicBrewCol(), { ...item, sharedBy: "Fellow DM", timestamp: new Date().toISOString() });
            alert("Published!");
            window.filterCommunity('all');
        } catch(e) { console.error(e); alert("Error: " + e.message); }
    };

    window.importCommunityItem = async (dataString) => {
        try {
            const item = JSON.parse(decodeURIComponent(dataString));
            await window.addDoc(getCol('dm_toolkit_homebrew_items'), item);
            
            let noteContent = "", tab = "lootNotes";
            if (item.category === 'monster') {
                tab = "enemyNotes";
                await window.addDoc(getCol('dm_toolkit_statblocks'), { name: item.name, hp: parseInt(item.hp)||10, ac: parseInt(item.ac)||10, toHit: parseInt(item.tohit)||0, initMod: parseInt(item.init)||0, dmg: `${item.atk}: ${item.dmg}`, timestamp: new Date().toISOString() });
                noteContent = generateMonsterHTML(item);
            } 
            else if (item.isParchment || item.category === 'weapon' || item.category === 'item') { 
                noteContent = generateWeaponHTML(item.name, item.imageData, item.dmg, item.type, item.props); 
            } 
            else { noteContent = `<strong>${item.name}</strong><br>${item.props}`; }
            
            structuredNotes[tab].unshift({ id: crypto.randomUUID(), title: item.name + " (Imported)", content: noteContent, timestamp: new Date().toISOString() });
            await window.saveStructuredNotes(tab, structuredNotes[tab]);
            alert(`Imported ${item.name}!`);
        } catch(e) { console.error(e); alert("Import failed."); }
    };

    window.deleteCommunityItem = async (id) => { if(!confirm("ADMIN: Delete?")) return; try { await window.deleteDoc(window.doc(window.db, 'aegis_community_items', id)); alert("Deleted."); } catch(e) { console.error(e); } };
    window.deleteHomebrewWeapon = async (id) => { if(!confirm("Delete?")) return; await window.deleteDoc(window.doc(getCol('dm_toolkit_homebrew_items'), id)); };

    window.loadCommunityItems = () => {
        const list = document.getElementById('community-list');
        const q = window.query(getPublicBrewCol(), window.limit(50));
        window.unsubCommunity = window.onSnapshot(q, (snap) => {
            if(snap.empty) { list.innerHTML = '<p class="text-center text-gray-500 text-xs col-span-full pt-10">No items found.</p>'; return; }
            let items = []; snap.forEach(d => items.push({id: d.id, ...d.data()}));

            if (window.currentCommunityFilter !== 'all') items = items.filter(i => i.category === window.currentCommunityFilter || (window.currentCommunityFilter==='item' && i.category==='magic'));
            items.sort((a, b) => (b.timestamp || "").localeCompare(a.timestamp || ""));
            list.innerHTML = '';

            items.forEach(item => {
                const itemString = encodeURIComponent(JSON.stringify(item));
                const isAdmin = (window.userId === ADMIN_ID);
                const deleteBtn = isAdmin ? `<button onclick="window.deleteCommunityItem('${item.id}')" class="absolute top-2 right-2 z-50 bg-red-600 text-white w-6 h-6 rounded-full text-xs font-bold shadow hover:bg-red-500">√ó</button>` : '';
                
                let visualHTML = "";
                if (item.category === 'monster') {
                    visualHTML = `<div class="transform scale-95 origin-top">${generateMonsterHTML(item)}</div>`;
                } else if (item.category === 'weapon' || item.category === 'item' || item.isParchment) {
                    visualHTML = generateWeaponHTML(item.name, item.imageData, item.dmg, item.type, item.props);
                } else {
                    visualHTML = `<div class="bg-gray-900 p-4 rounded text-center border border-gray-600"><div class="font-bold text-orange-300 text-lg">${item.name}</div><div class="text-xs text-gray-400 mt-1">${item.dmg || ""} ${item.type || ""}</div><div class="text-xs text-gray-500 mt-2 italic line-clamp-4">${item.props || ""}</div></div>`;
                }

                const card = document.createElement('div');
                card.className = "break-inside-avoid mb-4 bg-gray-800 rounded-xl border border-gray-700 shadow-lg overflow-hidden hover:shadow-xl transition relative group";
                card.innerHTML = `${deleteBtn}<div class="p-1">${visualHTML}</div><div class="bg-gray-900/90 p-2 flex justify-center border-t border-gray-700"><button onclick="window.importCommunityItem('${itemString}')" class="bg-indigo-600 hover:bg-indigo-500 text-white text-[10px] font-bold px-6 py-1.5 rounded-full shadow transition">Save to Collection</button></div>`;
                list.appendChild(card);
            });
        });
    };
    
    // üü¢ STANDARD LISTENER (Monsters, Weapons, Items only)
    window.setupHomebrewListener = () => {
        if(!window.isAuthReady) return;
        
        // Listen to the Homebrew Collection
        window.onSnapshot(window.query(getCol('dm_toolkit_homebrew_items')), (snap) => {
            const list = document.getElementById('homebrew-weapon-list'); 
            if(!list) return;
            
            if(snap.empty) { 
                list.innerHTML = '<p class="text-center text-gray-500 text-xs">No items saved.</p>'; 
                return; 
            }

            const items = []; 
            snap.forEach(d => items.push({id: d.id, ...d.data()}));
            items.sort((a,b) => a.name.localeCompare(b.name)); 
            
            list.innerHTML = '';
            list.className = "columns-1 md:columns-2 gap-4 space-y-4 pb-20";

            items.forEach(item => {
                let visualHTML = "";
                
                // 1. Check for Monster
                if (item.category === 'monster') {
                    visualHTML = `<div class="transform scale-90 origin-top-left">${generateMonsterHTML(item)}</div>`;
                } 
                // 2. Check for Parchment Items (Weapons/Magic Items)
                else if (item.category === 'weapon' || item.category === 'item' || item.isParchment) {
                    visualHTML = generateWeaponHTML(item.name, item.imageData, item.dmg, item.type, item.props);
                } 
                // 3. Fallback / Generic
                else {
                    visualHTML = `<div class="bg-gray-900 p-4 rounded text-center border border-gray-600"><div class="font-bold text-orange-300 text-lg">${item.name}</div><div class="text-xs text-gray-400 mt-1">${item.dmg || ""}</div></div>`;
                }
                
                const div = document.createElement('div'); 
                div.className = 'break-inside-avoid mb-4 bg-gray-900 p-1 rounded border border-gray-700 relative shadow-lg';
                div.innerHTML = `<div class="p-1">${visualHTML}</div><div class="flex justify-end gap-2 mt-2 p-2 border-t border-gray-700 bg-gray-800"><button onclick="window.shareHomebrewItem('${item.id}')" class="text-blue-400 hover:text-blue-300 text-xs font-bold uppercase" title="Share">üåç Share</button><button onclick="window.deleteHomebrewWeapon('${item.id}')" class="text-red-500 hover:text-red-400 text-xs font-bold uppercase">Delete</button></div>`;
                list.appendChild(div);
            });
        });
    };
        // --- 17. DUAL COMBAT TIMER (Stopwatch & Countdown) ---
    let timerInterval = null;
    let timerMode = null; // 'countup' or 'countdown'

    window.toggleTimer = () => {
        const btn = document.getElementById('btn-timer-toggle');
        const minInput = document.getElementById('timer-min');
        const secInput = document.getElementById('timer-sec');
        
        if (timerInterval) {
            // PAUSE
            clearInterval(timerInterval);
            timerInterval = null;
            btn.textContent = "‚ñ∂";
            btn.classList.replace('bg-red-700', 'bg-green-700');
            btn.classList.replace('hover:bg-red-600', 'hover:bg-green-600');
        } else {
            // START
            let m = parseInt(minInput.value) || 0;
            let s = parseInt(secInput.value) || 0;
            let total = m * 60 + s;

            // Determine Mode (Only if starting fresh)
            if (!timerMode) {
                if (total > 0) timerMode = 'countdown';
                else timerMode = 'countup';
            }

            timerInterval = setInterval(() => {
                if (timerMode === 'countdown') {
                    if (total <= 0) {
                        // TIME'S UP!
                        clearInterval(timerInterval);
                        timerInterval = null;
                        timerMode = null; // Reset mode
                        btn.textContent = "‚ñ∂";
                        btn.classList.replace('bg-red-700', 'bg-green-700');
                        // Play Sound if available
                        if(window.playTone) window.playTone('trap'); 
                        alert("‚è∞ Time is up!");
                        return;
                    }
                    total--;
                } else {
                    // Stopwatch
                    total++;
                }

                // Update UI
                const nm = Math.floor(total / 60).toString().padStart(2, '0');
                const ns = (total % 60).toString().padStart(2, '0');
                minInput.value = nm;
                secInput.value = ns;
            }, 1000);

            btn.textContent = "‚è∏";
            btn.classList.replace('bg-green-700', 'bg-red-700');
            btn.classList.replace('hover:bg-green-600', 'hover:bg-red-600');
        }
    };

    window.resetTimer = () => {
        if(timerInterval) {
            clearInterval(timerInterval);
            timerInterval = null;
        }
        timerMode = null; // Clear mode so next click decides fresh
        
        // UI Reset
        document.getElementById('btn-timer-toggle').textContent = "‚ñ∂";
        document.getElementById('btn-timer-toggle').classList.replace('bg-red-700', 'bg-green-700');
        document.getElementById('timer-min').value = "00";
        document.getElementById('timer-sec').value = "00";
    };

     // ==========================================
    // üü¢ CAMPAIGN MANAGER (With Legacy Support)
    // ==========================================

    // 1. Initialize Global Variables
    // We default to 'Default Campaign' so old notes have a home.
    window.campaignList = ['Default Campaign'];
    window.currentCampaign = localStorage.getItem('aegis_last_campaign') || 'Default Campaign';

    // 2. Create New Campaign
    window.createNewCampaign = async () => {
    // Safety check to ensure list exists
    if (!window.campaignList) window.campaignList = ['Default Campaign'];
    
    const name = prompt("Enter new Campaign Name:");
    if (!name) return;
    
    if (window.campaignList.includes(name)) {
        alert("That campaign already exists!");
        window.switchCampaign(name);
        return;
    }

    // 1. Update Local List
    window.campaignList.push(name);

    // 2. üü¢ WAIT FOR DATABASE SAVE (Crucial Fix)
    if (window.isAuthReady) {
        try {
            // Show a temporary loading state if you have a status element, or just wait
            document.body.style.cursor = "wait"; 
            
            await window.setDoc(getSharedDoc('shared_notes'), { 
                campaignList: window.campaignList 
            }, { merge: true });
            
        } catch(e) {
            console.error("DB Error:", e);
            alert("Failed to save campaign. Check console.");
            document.body.style.cursor = "default";
            return; // Stop here so we don't reload on a failed save
        }
    }

    // 3. NOW we switch (which triggers the reload)
    document.body.style.cursor = "default";
    alert(`Created: ${name}`);
    window.switchCampaign(name);
};

    // 3. Switch Campaign (Updated to Trigger Timeline)
    // 3. Switch Campaign (Reload Page Version)
window.switchCampaign = (val) => {
    if (!val) return;

    // 1. Save the new selection (So the browser remembers it after the reload)
    window.currentCampaign = val;
    localStorage.setItem('aegis_last_campaign', val);
    
    // 2. üü¢ FORCE RELOAD
    // The page will restart, read 'aegis_last_campaign', and load 
    // the correct Notes and Timeline automatically.
    window.location.reload();
};

    // 4. Render the Dropdown Menu
    window.renderCampaignSelector = () => {
        const sel = document.getElementById('campaign-selector');
        if (!sel) return;

        // Fallback: If current campaign isn't in list, select the first one
        if (!window.campaignList.includes(window.currentCampaign)) {
             window.currentCampaign = window.campaignList[0] || 'Default Campaign';
        }

        sel.innerHTML = window.campaignList.map(c => 
            `<option value="${c}" ${c === window.currentCampaign ? 'selected' : ''}>${c}</option>`
        ).join('');
    };

    // 5. UPDATE: Setup Listener (Loads Campaigns & Notes)
    window.setupNotesListener = () => {
        if(!window.isAuthReady) return;
        
        window.onSnapshot(getSharedDoc('shared_notes'), (doc) => {
            if(doc.exists()) {
                const d = doc.data();
                
                // Load Notes
                structuredNotes = { 
                    prepNotes: d.structuredPrepNotes||[], 
                    pcNotes: d.structuredPcNotes||[], 
                    enemyNotes: d.structuredEnemyNotes||[], 
                    npcNotes: d.structuredNpcNotes||[], 
                    lootNotes: d.structuredLootNotes||[] 
                };
                
                // Load Campaign List (or create default if missing)
                if (d.campaignList && Array.isArray(d.campaignList)) {
                    window.campaignList = d.campaignList;
                } else {
                    window.campaignList = ['Default Campaign'];
                }
            } else {
                // New User / Empty DB
                structuredNotes = { prepNotes: [], pcNotes: [], enemyNotes: [], npcNotes: [], lootNotes: [] };
                window.campaignList = ['Default Campaign'];
            }
            
            // Render UI
            window.renderCampaignSelector();
            if(window.currentTab === 'notes') window.renderStructuredNotes(window.currentSubTab);
        });
    };

    

    // 7. UPDATE: Add New Note (Tags it!)
    window.addNewNote = (tab) => { 
        const newNote = { 
            id: crypto.randomUUID(), 
            title: 'New Note', 
            content: 'Details...', 
            campaign: window.currentCampaign, // <--- TAGS THE NOTE
            timestamp: new Date().toISOString() 
        };
        
        structuredNotes[tab].unshift(newNote); 
        window.saveStructuredNotes(tab, structuredNotes[tab]);
        window.renderStructuredNotes(tab);
    };  

    // üü¢ FINAL: Save SRD Monster (Asks for Campaign)
    window.saveSrdToNotes = async function(index) {
        // 1. Get data
        const m = window.currentSrdResults ? window.currentSrdResults[index] : null;
        if (!m) { alert("Error: Could not find monster data."); return; }

        // üü¢ 2. ASK USER FOR CAMPAIGN (This opens the modal)
        const targetCampaign = await window.promptForCampaign();
        if (!targetCampaign) return; // User clicked Cancel

        // 3. Format Content
        const xpTable = { "0": 10, "1/8": 25, "1/4": 50, "1/2": 100, "1": 200, "2": 450, "3": 700, "4": 1100, "5": 1800, "6": 2300, "7": 2900, "8": 3900, "9": 5000, "10": 5900, "11": 7200, "12": 8400, "13": 10000, "14": 11500, "15": 13000, "16": 15000, "17": 18000, "18": 20000, "19": 22000, "20": 25000, "21": 33000, "22": 41000, "23": 50000, "24": 62000, "30": 155000 };
        const finalXP = m.xp || xpTable[m.challenge_rating] || 0;
        const speedStr = m.speed ? JSON.stringify(m.speed).replace(/[{"}]/g, '').replace(/,/g, ', ') : 'N/A';
        const fmtList = (val) => Array.isArray(val) ? val.join(', ') : (val || '-');
        
        let skillsStr = '-';
        if (m.skills) {
            if (typeof m.skills === 'object' && !Array.isArray(m.skills)) {
                skillsStr = Object.entries(m.skills).map(([k,v]) => `${k.charAt(0).toUpperCase() + k.slice(1)} +${v}`).join(', ');
            } else { skillsStr = m.skills; }
        }

        let saves = [];
        if(m.strength_save) saves.push(`Str +${m.strength_save}`);
        if(m.dexterity_save) saves.push(`Dex +${m.dexterity_save}`);
        if(m.constitution_save) saves.push(`Con +${m.constitution_save}`);
        if(m.intelligence_save) saves.push(`Int +${m.intelligence_save}`);
        if(m.wisdom_save) saves.push(`Wis +${m.wisdom_save}`);
        if(m.charisma_save) saves.push(`Cha +${m.charisma_save}`);
        const savesStr = saves.length > 0 ? saves.join(', ') : '-';

        let content = `
            <div class="dnd-statblock">
            <div class="dnd-header">${m.name}</div>
            <div class="italic text-xs mb-2">${m.size} ${m.type}, ${m.alignment}</div>
            <div class="tapered-rule"></div>
            <div class="text-sm text-red-900 leading-relaxed">
                <p><strong>AC:</strong> ${m.armor_class} | <strong>HP:</strong> ${m.hit_points} (${m.hit_dice})</p>
                <p><strong>Speed:</strong> ${speedStr}</p>
            </div>
            <div class="tapered-rule"></div>
            <div class="grid grid-cols-6 text-center text-xs font-bold my-2 text-red-900">
                <div>STR<br>${m.strength}</div><div>DEX<br>${m.dexterity}</div><div>CON<br>${m.constitution}</div>
                <div>INT<br>${m.intelligence}</div><div>WIS<br>${m.wisdom}</div><div>CHA<br>${m.charisma}</div>
            </div>
            <div class="tapered-rule"></div>
            <div class="text-xs leading-relaxed text-red-900 space-y-1 mt-2">
                <p><strong>Saves:</strong> <span class="text-black">${savesStr}</span></p>
                <p><strong>Skills:</strong> <span class="text-black">${skillsStr}</span></p>
                <p><strong>Senses:</strong> <span class="text-black">${m.senses || '-'}</span></p>
                <p><strong>Languages:</strong> <span class="text-black">${m.languages || '-'}</span></p>
                <p><strong>Challenge:</strong> <span class="text-black">${m.challenge_rating} (${finalXP.toLocaleString()} XP)</span></p>
                ${m.damage_vulnerabilities ? `<p><strong>Vulnerabilities:</strong> <span class="text-black">${fmtList(m.damage_vulnerabilities)}</span></p>` : ''}
                ${m.damage_resistances ? `<p><strong>Resistances:</strong> <span class="text-black">${fmtList(m.damage_resistances)}</span></p>` : ''}
                ${m.damage_immunities ? `<p><strong>Immunities:</strong> <span class="text-black">${fmtList(m.damage_immunities)}</span></p>` : ''}
                ${m.condition_immunities ? `<p><strong>Condition Immunities:</strong> <span class="text-black">${fmtList(m.condition_immunities)}</span></p>` : ''}
            </div>
            <div class="tapered-rule"></div>
        `;

        if (m.special_abilities) { content += `<div class="dnd-section-title mt-2">Traits</div>`; m.special_abilities.forEach(a => { content += `<div class="mb-2 text-sm leading-snug"><strong class="italic text-red-900">${a.name}.</strong> <span class="text-black">${a.desc}</span></div>`; }); }
        if (m.actions) { content += `<div class="dnd-section-title mt-2">Actions</div>`; m.actions.forEach(a => { content += `<div class="mb-2 text-sm leading-snug"><strong class="italic text-red-900">${a.name}.</strong> <span class="text-black">${a.desc}</span></div>`; }); }
        if (m.reactions) { content += `<div class="dnd-section-title mt-2">Reactions</div>`; m.reactions.forEach(a => { content += `<div class="mb-2 text-sm leading-snug"><strong class="italic text-red-900">${a.name}.</strong> <span class="text-black">${a.desc}</span></div>`; }); }
        if (m.legendary_actions) { content += `<div class="dnd-section-title mt-2">Legendary Actions</div><p class="text-xs mb-2 text-black">The ${m.name} can take 3 legendary actions.</p>`; m.legendary_actions.forEach(a => { content += `<div class="mb-2 text-sm leading-snug"><strong class="italic text-red-900">${a.name}.</strong> <span class="text-black">${a.desc}</span></div>`; }); }
        content += `</div>`;

        // 4. Save Logic
        if (!structuredNotes.enemyNotes) structuredNotes.enemyNotes = [];
        
        const newNote = {
            id: crypto.randomUUID(),
            title: `${m.name} (CR ${m.challenge_rating})`,
            content: content,
            campaign: targetCampaign, // üü¢ Uses the chosen campaign!
            timestamp: new Date().toISOString()
        };

        structuredNotes.enemyNotes.unshift(newNote);
        window.saveStructuredNotes('enemyNotes', structuredNotes.enemyNotes);
        
        // 5. Smart Redirect
        if (targetCampaign !== window.currentCampaign) {
            if(confirm(`Saved to "${targetCampaign}". Switch to that campaign to view it?`)) {
                window.switchCampaign(targetCampaign);
                window.switchTab('notes');
                window.switchSubTab('enemyNotes');
            }
        } else {
            // Already there, just refresh
            if(window.currentTab === 'notes' && window.currentSubTab === 'enemyNotes') {
                window.renderStructuredNotes('enemyNotes');
            }
            alert(`‚úÖ Saved to ${targetCampaign}!`);
        }
    };

        // üü¢ CAMPAIGN PICKER LOGIC
    let saveResolve = null;

    window.promptForCampaign = () => {
        return new Promise((resolve) => {
            saveResolve = resolve;
            
            const modal = document.getElementById('save-campaign-modal');
            const select = document.getElementById('save-campaign-select');
            
            // Populate list
            select.innerHTML = window.campaignList.map(c => 
                `<option value="${c}" ${c === window.currentCampaign ? 'selected' : ''}>${c}</option>`
            ).join('');
            
            modal.classList.remove('hidden');
        });
    };

    window.confirmSaveCampaign = () => {
        const select = document.getElementById('save-campaign-select');
        const modal = document.getElementById('save-campaign-modal');
        modal.classList.add('hidden');
        if (saveResolve) saveResolve(select.value);
    };

    window.resolveSavePromise = (val) => {
        const modal = document.getElementById('save-campaign-modal');
        modal.classList.add('hidden');
        if (saveResolve) saveResolve(val);
    };

        // ==========================================
    // üü¢ UNIFIED CAMPAIGN SAVE SYSTEM (ALL TOOLS)
    // ==========================================

    // Helper: Smart Save & Redirect Logic
    // This reduces repetitive code for all the functions below
    window.finalizeSave = async (tab, noteObj, targetCampaign) => {
        // 1. Add Campaign Tag
        noteObj.campaign = targetCampaign;
        
        // 2. Add to Local List
        if (!structuredNotes[tab]) structuredNotes[tab] = [];
        structuredNotes[tab].unshift(noteObj);
        
        // 3. Save to Firebase
        await window.saveStructuredNotes(tab, structuredNotes[tab]);

        // 4. Smart Redirect (Ask if switching campaigns)
        if (targetCampaign !== window.currentCampaign) {
            if(confirm(`‚úÖ Saved to "${targetCampaign}".\n\nSwitch to that campaign to view it?`)) {
                window.switchCampaign(targetCampaign);
                window.switchTab('notes');
                window.switchSubTab(tab);
            }
        } else {
            // If already on the right campaign, just refresh
            if(window.currentTab === 'notes' && window.currentSubTab === tab) {
                window.renderStructuredNotes(tab);
            }
            alert(`‚úÖ Saved to ${targetCampaign}!`);
        }
    };

    // 1. GENERIC AI CONTENT (Lore, Settlements, Loot)
    window.saveGeneratedContent = async function(destinationTab) {
        if (!window.isAuthReady) { alert("Please log in first."); return; }

        // Ask for Campaign
        const targetCampaign = await window.promptForCampaign();
        if (!targetCampaign) return;

        // Get Content
        let content = document.getElementById('ai-output').innerHTML;
        if (window.currentTab === 'loot') content = document.getElementById('loot-output').innerText;
        
        // Generate Note
        const newNote = { 
            id: crypto.randomUUID(), 
            title: generateTitleFromContent(content), 
            content: content, 
            timestamp: new Date().toISOString() 
        };

        await window.finalizeSave(destinationTab, newNote, targetCampaign);
    };
    

    // ==========================================
// üíæ DIAGNOSTIC FIX: MONSTER SAVE TO NOTES (TRACING CONTENT)
// ==========================================
window.saveMonsterToNotes = async function() {
    let btn, originalText;
    try {
        // 1. CRITICAL VALIDATION
        if (!window.userId) { 
            alert("üîí Please log in to a Session to save data."); 
            window.openLoginModal(); 
            return; 
        }
        const m = window.lastGeneratedMonster;
        if (!m || !m.name) { 
            alert("Monster data is missing. Please regenerate the monster."); 
            return; 
        }

        // 2. UI Prep (Ensure the button is correctly grabbed before the await call)
        btn = event.target;
        originalText = btn.innerText;
        btn.innerText = "Processing...";
        btn.disabled = true;

        // 3. Ask for Campaign (The asynchronous step)
        const targetCampaign = await window.promptForCampaign();
        if (!targetCampaign) return; // User cancelled

        // 4. Content Retrieval with Fallback
        const monsterOutputElement = document.getElementById('monster-output');
        let noteContent = monsterOutputElement ? monsterOutputElement.innerHTML : "Error: Monster output element not found.";
        
        // Final sanity check before passing the object
        const noteTitle = `${m.name} (CR ${m.cr || 'N/A'})`;
        
        // 5. Create Note Object
        const newNote = { 
            id: crypto.randomUUID(), 
            title: noteTitle, 
            content: noteContent, 
            timestamp: new Date().toISOString() 
        };
        
        // 6. Finalize Save
        await window.finalizeSave('enemyNotes', newNote, targetCampaign);
        
    } catch (e) {
        console.error("FINAL SAVE TO NOTES CRASHED:", e);
        alert("CRITICAL ERROR: Save failed. Check console for the full error message.");
    } finally {
        // Re-enable button
        if (btn) {
            btn.innerText = originalText;
            btn.disabled = false;
        }
    }
};

    // 4. HOMEBREW (Weapons, Items, Monsters)
    window.saveHomebrewToNotes = async (type, createNote = true) => {
        if (!window.isAuthReady) { alert("Login required."); return; }
        
        try {
            let title, content, tab, id = crypto.randomUUID(), timestamp = new Date().toISOString();
            
            // --- DATA GATHERING ---
            if (type === 'monster') {
                const mData = getMonsterData();
                if(!mData.name) return alert("Name required!");
                
                // Save to Stats DB (Global)
                const fullDmg = `${mData.atk}: ${mData.dmg}`;
                await window.addDoc(getCol('dm_toolkit_statblocks'), { 
                    name: mData.name, hp: parseInt(mData.hp)||10, ac: parseInt(mData.ac)||10, 
                    toHit: parseInt(mData.tohit)||0, initMod: parseInt(mData.init)||0, dmg: fullDmg, timestamp 
                });
                
                // Save to Inventory DB (Global)
                await window.addDoc(getCol('dm_toolkit_homebrew_items'), { ...mData, props: `CR ${mData.cr} ‚Ä¢ ${mData.type}`, dmg: `HP ${mData.hp}`, type: `AC ${mData.ac}` });
                
                title = mData.name + " (Homebrew)";
                content = generateMonsterHTML(mData);
                tab = 'enemyNotes';
                
                if(!createNote) { alert("Saved to Stats & Inventory!"); document.getElementById('hb-mon-name').value=''; return; }
            } 
            else if (type === 'weapon') {
                const name = getSafeValue('hb-wep-name'); if(!name) return alert("Name required!");
                const wData = {
                    name, category: 'weapon',
                    imageData: getSafeValue('hb-wep-image-data'),
                    dmg: getSafeValue('hb-wep-meta1'), type: getSafeValue('hb-wep-meta2'),
                    props: getSafeValue('hb-wep-desc'), isParchment: true, timestamp
                };
                await window.addDoc(getCol('dm_toolkit_homebrew_items'), wData);
                title = name;
                content = generateWeaponHTML(wData.name, wData.imageData, wData.dmg, wData.type, wData.props);
                tab = 'lootNotes';
                if(!createNote) { alert("Saved to Inventory!"); return; }
            } 
            else {
                const name = getSafeValue('hb-item-name'); if(!name) return alert("Name required!");
                const iData = {
                    name, category: 'item',
                    imageData: getSafeValue('hb-item-image-data'),
                    dmg: getSafeValue('hb-item-rarity'), type: getSafeValue('hb-item-type'),
                    props: `${document.getElementById('hb-item-attune').checked?"(Attunement)":""} ${getSafeValue('hb-item-desc')}`,
                    isParchment: true, timestamp
                };
                await window.addDoc(getCol('dm_toolkit_homebrew_items'), iData);
                window.updateItemPreview(); 
                title = name;
                content = document.getElementById('hb-item-card-preview').outerHTML;
                tab = 'lootNotes';
                if(!createNote) { alert("Saved to Inventory!"); return; }
            }

            // --- NOTE SAVING (With Campaign Picker) ---
            
            // Ask for Campaign
            const targetCampaign = await window.promptForCampaign();
            if (!targetCampaign) return;

            const newNote = { id, title, content, timestamp };
            
            // Use our helper to save and redirect
            await window.finalizeSave(tab, newNote, targetCampaign);
            
        } catch(e) { console.error("Save Failed:", e); alert("Error saving: " + e.message); }
    };

     // üü¢ DELETE CAMPAIGN FUNCTION
    window.deleteCurrentCampaign = async () => {
        const target = window.currentCampaign;

        // 1. Safety Checks
        if (target === 'Default Campaign') { 
            alert("‚ùå You cannot delete the Default Campaign."); 
            return; 
        }
        
        // 2. Confirmation
        const confirmed = confirm(`‚ö†Ô∏è DANGER ZONE ‚ö†Ô∏è\n\nAre you sure you want to delete "${target}"?\n\nThis will permanently delete ALL notes associated with this campaign.`);
        if (!confirmed) return;

        // 3. Update Local List (Remove the name)
        window.campaignList = window.campaignList.filter(c => c !== target);

        // 4. Update Notes (Filter out notes belonging to this campaign)
        // We loop through every tab (prep, pc, enemy, etc.) and remove matching notes
        const tabs = ['prepNotes', 'pcNotes', 'enemyNotes', 'npcNotes', 'lootNotes'];
        tabs.forEach(tab => {
            if (structuredNotes[tab]) {
                structuredNotes[tab] = structuredNotes[tab].filter(n => n.campaign !== target);
            }
        });

        // 5. Save EVERYTHING to Database
        if (window.isAuthReady) {
            try {
                // We must update the list AND all note arrays to reflect the deletion
                await window.setDoc(getSharedDoc('shared_notes'), { 
                    campaignList: window.campaignList,
                    structuredPrepNotes: structuredNotes.prepNotes,
                    structuredPcNotes: structuredNotes.pcNotes,
                    structuredEnemyNotes: structuredNotes.enemyNotes,
                    structuredNpcNotes: structuredNotes.npcNotes,
                    structuredLootNotes: structuredNotes.lootNotes
                }, { merge: true });
            } catch(e) { 
                console.error(e); 
                alert("Error deleting from database (check console).");
            }
        }

        // 6. Switch back to safety
        alert(`üóëÔ∏è Deleted "${target}".`);
        window.switchCampaign('Default Campaign');
    };  

      // --- 19. TRAVEL & DOWNTIME ENGINE ---

    // A. Travel Calculator
    window.calcTravel = () => {
        const miles = parseFloat(document.getElementById('travel-dist').value) || 0;
        const pace = document.getElementById('travel-pace').value;
        const party = parseInt(document.getElementById('travel-party').value) || 1;
        
        let rate = 24; // Normal
        let note = "Normal travel. No modifiers.";
        
        if(pace === 'fast') { 
            rate = 30; 
            note = "<span class='text-red-400'>-5 penalty to passive Perception.</span>"; 
        } else if(pace === 'slow') { 
            rate = 18; 
            note = "<span class='text-green-400'>Able to use Stealth.</span>"; 
        }

        const days = (miles / rate).toFixed(1);
        const rations = Math.ceil(days * party); // 1 ration per person per day
        const resultDiv = document.getElementById('travel-result');
        
        resultDiv.innerHTML = `
            <div class="grid grid-cols-2 gap-4 text-center mb-2">
                <div><div class="text-2xl font-bold text-white">${days}</div><div class="text-xs text-gray-500 uppercase">Days</div></div>
                <div><div class="text-2xl font-bold text-yellow-500">${rations}</div><div class="text-xs text-gray-500 uppercase">Rations Consumed</div></div>
            </div>
            <div class="text-center border-t border-gray-700 pt-2 text-gray-300 italic">${note}</div>
        `;
        resultDiv.classList.remove('hidden');
    };

    // B. Weather Generator
    const weatherTables = {
        temperate: ["Sunny and mild", "Overcast and breezy", "Light rain", "Heavy rainstorm", "Foggy morning", "Unseasonably hot"],
        desert:    ["Scorching heat", "Dry windstorm", "Clear skies", "Heat haze", "Cold night", "Sandstorm (Obscured)"],
        arctic:    ["Light snow", "Bitter cold wind", "Blizzard (Heavy obscurement)", "Clear and freezing", "Hail", "Whiteout"],
        swamp:     ["Humid and sticky", "Heavy mist", "Light rain", "Tropical storm", "Stagnant heat", "Swarm of insects"],
        underdark: ["Stale air", "Sulfuric smell", "Cold drafts", "Dripping water echo", "Phosphorescent spore cloud", "Pitch black silence"],
        coast:     ["Strong sea breeze", "Morning fog", "Heavy storm", "Clear sunny day", "Light drizzle", "Hurricane winds"]
    };

    window.genWeather = () => {
        const biome = document.getElementById('weather-biome').value;
        const list = weatherTables[biome];
        const result = list[Math.floor(Math.random() * list.length)];
        const out = document.getElementById('weather-output');
        out.textContent = result;
        out.className = "text-center text-xl font-bold text-blue-200 animate-pulse";
        setTimeout(() => out.className = "text-center text-lg text-white transition duration-500", 500);
    };

    // C. Downtime Rules (Simplified XGE)
    const downtimeRules = {
        crafting: "<strong>Crafting:</strong> Need proficiency in tools. Progress: <strong>50gp per week</strong> (or 25gp/week for magic items). <br><em>Cost:</em> Half item price in materials. <br><em>Complication:</em> 10% chance per workweek.",
        training: "<strong>Training:</strong> Learn a language or tool. <br><em>Time:</em> 10 weeks minus Int mod. <br><em>Cost:</em> 25gp per week.",
        research: "<strong>Research:</strong> Spend 50gp+ on books/bribes. Roll <strong>Int (Investigation)</strong>. <br><em>Result:</em> +1 piece of lore per 50gp spent (max +6) on success.",
        carousing: "<strong>Carousing:</strong> Lower Class (10gp) or Upper Class (50gp). Roll <strong>Cha (Persuasion)</strong>. <br><em>Success:</em> Gain contacts. <br><em>Fail:</em> 10% chance of complication (jail, enemies).",
        crime: "<strong>Crime:</strong> Set DC (10-25). Roll <strong>Dex (Stealth)</strong> + Thieves' Tools + Investigation. <br><em>Payout:</em> 50gp to 1000gp based on DC. <br><em>Fail:</em> Jail time or fine.",
        work: "<strong>Work:</strong> Roll skill check. <br><em>9 or lower:</em> Poor lifestyle. <br><em>10-14:</em> Modest (10gp). <br><em>15-20:</em> Comfortable (20gp). <br><em>21+:</em> Wealthy (50gp).",
        gambling: "<strong>Gambling:</strong> Bet 10gp-1000gp. Roll <strong>Wis (Insight)</strong>, <strong>Cha (Deception)</strong>, and <strong>Cha (Intimidation)</strong> vs DC. <br><em>0 hits:</em> Lose bet x2. <br><em>1 hit:</em> Lose half. <br><em>2 hits:</em> Win bet +50%. <br><em>3 hits:</em> Win bet x2."
    };

    window.resolveDowntime = () => {
        const type = document.getElementById('downtime-activity').value;
        const resDiv = document.getElementById('downtime-result');
        resDiv.innerHTML = downtimeRules[type];
        resDiv.classList.remove('hidden');
    };

    // D. Campfire Prompts
    const campPrompts = [
        "Who taught you how to fight (or cast magic)?",
        "What is your character most afraid of right now?",
        "What is the best meal your character has ever had?",
        "Do you have any regrets from before you joined the party?",
        "What would you do if you retired from adventuring today?",
        "Who do you miss the most?",
        "What do you think of [Another PC's Name]?",
        "What is your character's proudest moment?",
        "Do you trust the person on watch tonight?",
        "What is a secret you haven't told the party yet?"
    ];

    window.genCampfirePrompt = () => {
        const p = campPrompts[Math.floor(Math.random() * campPrompts.length)];
        const el = document.getElementById('campfire-prompt');
        el.style.opacity = 0;
        setTimeout(() => {
            el.textContent = `"${p}"`;
            el.style.opacity = 1;
        }, 300);
    };

      // üé≤ FIXED RANDOM ENCOUNTER GENERATOR (Secure Server)
window.genEncounter = async () => {
    const btn = document.getElementById('btn-gen-encounter');
    const out = document.getElementById('encounter-output');
    const saveBtn = document.getElementById('btn-save-encounter');
    
    // 1. Get Inputs
    const terrain = document.getElementById('encounter-terrain').value;
    const danger = document.getElementById('encounter-danger').value;

    // 2. UI Prep
    btn.disabled = true;
    if (saveBtn) saveBtn.classList.add('hidden');
    out.classList.remove('hidden');
    out.innerHTML = '<span class="animate-pulse text-red-400">Rolling initiative...</span>';

    try {
        // 3. System Check (D&D vs Star Wars)
        const isSW5e = (typeof window.currentSystem !== 'undefined' && window.currentSystem === 'sw5e');
        const systemName = isSW5e ? "Star Wars 5e (SW5e)" : "D&D 5e";
        
        // 4. Build Prompt
        const prompt = `
        Generate a creative ${systemName} random encounter for a party in a ${terrain} environment.
        Danger Level: ${danger}.
        
        Format the output clearly with these sections:
        **Title**: [Catchy Name]
        **The Scene**: [What they see/hear]
        **The Threat**: [Monsters or NPCs involved]
        **The Twist**: [Hidden loot, environmental hazard, or social complication]
        
        Keep it concise and ready to run at the table.
        `;

        // üü¢ 5. CALL SECURE SERVER
        const aiText = await window.callMyServer(prompt);

        // 6. Format Output (Markdown -> HTML)
        const formatted = aiText
            .replace(/\n/g, '<br>')
            .replace(/\*\*(.*?)\*\*/g, '<strong class="text-yellow-400">$1</strong>') // Bold text becomes yellow
            .replace(/Title:/g, '<span class="text-xl font-bold text-indigo-400">') // Make Title Big
            .replace(/The Scene:/g, '</span><br><br><strong class="text-gray-400 uppercase text-xs">The Scene</strong>')
            .replace(/The Threat:/g, '<br><br><strong class="text-red-400 uppercase text-xs">The Threat</strong>')
            .replace(/The Twist:/g, '<br><br><strong class="text-green-400 uppercase text-xs">The Twist</strong>');

        out.innerHTML = `<div class="text-sm text-gray-300 leading-relaxed p-2 bg-gray-900/50 rounded border border-gray-700">${formatted}</div>`;

        if (saveBtn) saveBtn.classList.remove('hidden');

    } catch(e) {
        console.error(e);
        out.innerHTML = `<span class="text-red-400 font-bold">Error: ${e.message}</span>`;
    } finally {
        btn.disabled = false;
    }
};

    // Save Encounter (Uses your Campaign Manager!)
    window.saveEncounterToNotes = async () => {
        if (!window.isAuthReady) { alert("Please log in first."); return; }

        // 1. Get Content
        const content = document.getElementById('encounter-output').innerHTML;
        if (!content) return;

        // 2. Ask for Campaign
        const targetCampaign = await window.promptForCampaign();
        if (!targetCampaign) return;

        // 3. Generate Note Object
        const newNote = { 
            id: crypto.randomUUID(), 
            title: `Encounter: ${generateTitleFromContent(content)}`, // Auto-extract title
            content: content, 
            timestamp: new Date().toISOString() 
        };

        // 4. Save using your Unified System
        await window.finalizeSave('prepNotes', newNote, targetCampaign);
    }; 

    // ==========================================
    // üì° BROADCAST / SHARE LINK (Free Version)
    // ==========================================

    window.shareCombatLink = function() {
        // 1. Check Login (Required to identify your session)
        if (!window.userId) {
            alert("Please log in to a session first (Click 'Connect' at the top).");
            window.openLoginModal();
            return;
        }

        // 2. Construct URL
        // Takes the current website address, removes 'index.html', and adds 'player.html'
        let baseUrl = window.location.href;
        
        if (baseUrl.endsWith('index.html')) {
            baseUrl = baseUrl.substring(0, baseUrl.lastIndexOf('/'));
        }
        if (baseUrl.endsWith('/')) {
            baseUrl = baseUrl.substring(0, baseUrl.length - 1);
        }
        
        const playerLink = `${baseUrl}/player.html?dm=${window.userId}`;

        // 3. Copy to Clipboard
        navigator.clipboard.writeText(playerLink).then(() => {
            alert("‚úÖ Player Link Copied!\n\nSend this to your players:\n" + playerLink);
        }).catch(err => {
            // Fallback for some browsers
            prompt("Copy this link manually:", playerLink);
        });
    }; 

    // ==========================================
// üöÄ MARKDOWN FIX & INSTANT UPDATE PATCH
// ==========================================

// 1. The Parser: Converts symbols to HTML
window.parseMarkdown = (text) => {
    if (!text) return "";
    return text
        .replace(/</g, "&lt;") // Security: Sanitize HTML tags
        .replace(/>/g, "&gt;")
        .replace(/^# (.*$)/gim, '<h3 class="text-xl font-bold text-indigo-300 mt-3 border-b border-gray-600 pb-1">$1</h3>') // H1
        .replace(/^## (.*$)/gim, '<h4 class="text-lg font-bold text-indigo-200 mt-2">$1</h4>') // H2
        .replace(/\*\*(.*?)\*\*/g, '<strong class="text-white bg-indigo-900/50 px-1 rounded">$1</strong>') // Bold
        .replace(/\*(.*?)\*/g, '<em class="text-yellow-300">$1</em>') // Italic
        .replace(/^- (.*$)/gim, '<li class="ml-4 list-disc text-gray-300">$1</li>') // List
        .replace(/\n/g, '<br>'); // Newlines
};



// 3. The Save Action: Forces a refresh immediately
window.saveEditedNote = () => {
    const id = document.getElementById('modal-note-id').value;
    const tab = document.getElementById('modal-tab-name').value;
    const idx = structuredNotes[tab].findIndex(x => x.id === id);
    
    if(idx > -1) {
        structuredNotes[tab][idx].title = document.getElementById('modal-title').value;
        structuredNotes[tab][idx].content = document.getElementById('modal-content').value; // Save raw text
        
        // Save to DB
        window.saveStructuredNotes(tab, structuredNotes[tab]);
        
        // üü¢ Force Instant Refresh (So you don't have to wait)
        window.renderStructuredNotes(tab);
        
        // Auto-expand the note you just edited so you can see the result
        setTimeout(() => {
            const contentEl = document.getElementById(`content-${id}`);
            if(contentEl) {
                contentEl.classList.add('expanded');
                contentEl.style.maxHeight = contentEl.scrollHeight + "px";
            }
        }, 100);
    }
    document.getElementById('edit-modal').classList.add('hidden');
};

// ==========================================
// üîó OBSIDIAN-STYLE LINKING UPDATE
// ==========================================

// 1. UPDATED PARSER: Handles [[Wiki Links]] + Markdown
window.parseMarkdown = (text) => {
    if (!text) return "";
    return text
        .replace(/</g, "&lt;").replace(/>/g, "&gt;") // Sanitize
        .replace(/^# (.*$)/gim, '<h3 class="text-xl font-bold text-indigo-300 mt-3 border-b border-gray-600 pb-1">$1</h3>')
        .replace(/^## (.*$)/gim, '<h4 class="text-lg font-bold text-indigo-200 mt-2">$1</h4>')
        .replace(/\*\*(.*?)\*\*/g, '<strong class="text-white bg-indigo-900/50 px-1 rounded">$1</strong>')
        .replace(/\*(.*?)\*/g, '<em class="text-yellow-300">$1</em>')
        .replace(/^- (.*$)/gim, '<li class="ml-4 list-disc text-gray-300">$1</li>')
        .replace(/\n/g, '<br>')
        // üü¢ NEW: Wiki Links [[Note Title]]
        // Creates a clickable cyan link that calls our new function
        .replace(/\[\[(.*?)\]\]/g, '<span class="note-link text-cyan-400 font-bold cursor-pointer hover:underline hover:text-cyan-300 transition" onclick="event.stopPropagation(); window.openLinkedNote(\'$1\')">üîó $1</span>');
};

// 2. NEW FUNCTION: Find and Open the Note
window.openLinkedNote = (targetTitle) => {
    // Search across ALL sub-tabs (Prep, PCs, Enemies, NPCs, Loot)
    const tabs = ['prepNotes', 'pcNotes', 'enemyNotes', 'npcNotes', 'lootNotes'];
    let foundId = null;
    let foundTab = null;

    // Normalize target for comparison (ignore case)
    const target = targetTitle.toLowerCase().trim();

    for (const tab of tabs) {
        if (structuredNotes[tab]) {
            // Find a note where the title matches
            const note = structuredNotes[tab].find(n => n.title.toLowerCase().trim() === target);
            if (note) {
                foundId = note.id;
                foundTab = tab;
                break; // Stop searching once found
            }
        }
    }

    if (foundId) {
        // 1. Clear Search bar (so the note isn't hidden by a filter)
        const searchInput = document.getElementById('notes-search');
        if(searchInput) searchInput.value = "";

        // 2. Switch to the correct tab automatically
        window.switchSubTab(foundTab);

        // üü¢ TRIGGER BACKLINKS FOR THE NEW NOTE
        // This ensures the mentions area is updated for the note you just linked to.
        window.updateTimelineBacklinks(targetTitle, foundId);

        // 3. Highlight & Expand the note
        setTimeout(() => {
            const el = document.getElementById(`note-${foundId}`);
            if (el) {
                el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                
                // Flash effect so you see which one it is
                el.classList.add('ring-2', 'ring-cyan-400', 'shadow-[0_0_15px_rgba(34,211,238,0.5)]');
                setTimeout(() => el.classList.remove('ring-2', 'ring-cyan-400', 'shadow-[0_0_15px_rgba(34,211,238,0.5)]'), 1500);
                
                // Expand if it's closed
                const content = document.getElementById(`content-${foundId}`);
                if (content && !content.classList.contains('expanded')) {
                    window.toggleCollapse(foundId);
                }
            }
        }, 100); // Small delay to allow the tab to render first
    } else {
        alert(`‚ùå Note "${targetTitle}" not found in this campaign.\nCheck your spelling or create a note with that title.`);
    }
};

// 3. UPDATED EDIT FIX: Preserves Links on Edit
window.editNote = function(id, tab) {
    let note = null;
    let title = "Edit Note";
    let content = "";

    // Try memory first (Best)
    if (window.structuredNotes && window.structuredNotes[tab]) {
        note = window.structuredNotes[tab].find(n => n.id === id);
    }

    if (note) {
        title = note.title;
        content = note.content;
    } else {
        // Fallback: Reverse Engineer from HTML (If memory fails)
        console.warn(`Note ID ${id} not found in memory. Reversing HTML...`);
        const card = document.getElementById('note-' + id);
        
        if (card) {
            const titleEl = card.querySelector('.collapsible-header span');
            if (titleEl) title = titleEl.innerText;

            const contentDiv = card.querySelector('.font-sans');
            if (contentDiv) {
                let html = contentDiv.innerHTML;
                
                content = html
                    // üü¢ NEW: Turn HTML link back into [[Title]]
                    .replace(/<span[^>]*class="note-link[^>]*>üîó (.*?)<\/span>/gi, "[[$1]]")
                    // Standard Markdown Reversal
                    .replace(/<strong[^>]*>(.*?)<\/strong>/gi, "**$1**")
                    .replace(/<b[^>]*>(.*?)<\/b>/gi, "**$1**")
                    .replace(/<em[^>]*>(.*?)<\/em>/gi, "*$1*")
                    .replace(/<i[^>]*>(.*?)<\/i>/gi, "*$1*")
                    .replace(/<h3[^>]*>(.*?)<\/h3>/gi, "# $1\n")
                    .replace(/<h4[^>]*>(.*?)<\/h4>/gi, "## $1\n")
                    .replace(/<li[^>]*>(.*?)<\/li>/gi, "- $1\n")
                    .replace(/<br\s*\/?>/gi, "\n")
                    .replace(/&lt;/g, "<").replace(/&gt;/g, ">").replace(/&amp;/g, "&");

                content = content.replace(/\n\s+\n/g, "\n\n").trim();
            } else {
                alert("Error: Note content missing.");
                return;
            }
        }
    }

    document.getElementById('modal-note-id').value = id;
    document.getElementById('modal-tab-name').value = tab;
    document.getElementById('modal-title').value = title;
    document.getElementById('modal-content').value = content;
    document.getElementById('edit-modal').classList.remove('hidden');
};

// ==========================================
// üé≤ ACTIVE NOTES & TOAST SYSTEM
// ==========================================

// 1. TOAST NOTIFICATION SYSTEM (Replaces alerts)
window.showToast = (message, type = 'info') => {
    const container = document.getElementById('toast-container');
    if (!container) return;

    // Create Element
    const el = document.createElement('div');
    
    // Colors based on type
    let bgClass = "bg-gray-800 border-gray-600";
    if (type === 'success') bgClass = "bg-green-900/90 border-green-500 text-green-100";
    if (type === 'roll') bgClass = "bg-indigo-900/90 border-indigo-500 text-indigo-100";
    if (type === 'error') bgClass = "bg-red-900/90 border-red-500 text-red-100";

    el.className = `${bgClass} border px-6 py-3 rounded-full shadow-2xl text-sm font-bold opacity-0 transform translate-y-4 transition-all duration-300 pointer-events-auto flex items-center gap-2`;
    el.innerHTML = message;

    container.appendChild(el);

    // Animate In
    requestAnimationFrame(() => {
        el.classList.remove('opacity-0', 'translate-y-4');
    });

    // Remove after 3 seconds
    setTimeout(() => {
        el.classList.add('opacity-0', 'translate-y-4');
        setTimeout(() => el.remove(), 300);
    }, 3000);
};

// 2. INLINE DICE ROLLER
window.rollInline = (formula) => {
    // Parse Formula (e.g. "2d6+4")
    const match = formula.toLowerCase().match(/^(\d+)d(\d+)([+\-]\d+)?$/);
    if (!match) return;

    const count = parseInt(match[1]);
    const sides = parseInt(match[2]);
    const modStr = match[3] || "+0";
    const mod = parseInt(modStr);

    let total = 0;
    let rolls = [];
    
    for(let i=0; i<count; i++) {
        const r = Math.floor(Math.random() * sides) + 1;
        rolls.push(r);
        total += r;
    }
    
    const finalResult = total + mod;
    
    // Trigger 3D Dice Visuals (if existing system allows)
    if(window.throwDiceVisuals) window.throwDiceVisuals(rolls, sides);

    // Play Sound
    if(window.playTone) window.playTone(finalResult === 20 ? 'critical' : finalResult === 1 ? 'fail' : 'success');

    // Show Toast
    const icon = finalResult >= 20 ? "üî•" : "üé≤";
    const detail = count > 1 ? `[${rolls.join('+')}]${modStr}` : `(d${sides}${modStr})`;
    
    window.showToast(`${icon} Rolled <strong>${finalResult}</strong> <span class='text-xs opacity-75 ml-1'>${detail}</span>`, 'roll');
};

// 3. UPDATED MARKDOWN PARSER (With Dice Detection)
window.parseMarkdown = (text) => {
    if (!text) return "";
    return text
        .replace(/</g, "&lt;").replace(/>/g, "&gt;") // Sanitize
        
        // üü¢ NEW: Detect Dice [[2d6+3]]
        // Must come BEFORE standard links to avoid conflict
        .replace(/\[\[(\d+d\d+(?:[+\-]\d+)?)\]\]/gi, 
            '<button onclick="event.stopPropagation(); window.rollInline(\'$1\')" class="inline-flex items-center gap-1 bg-indigo-900/50 hover:bg-indigo-700 border border-indigo-500/50 text-indigo-200 px-1.5 rounded text-xs font-mono font-bold cursor-pointer transition select-none transform active:scale-95 mx-1">üé≤ $1</button>')
        
        // Standard Links [[Note Title]]
        .replace(/\[\[(.*?)\]\]/g, 
            '<span class="note-link text-cyan-400 font-bold cursor-pointer hover:underline hover:text-cyan-300 transition" onclick="event.stopPropagation(); window.openLinkedNote(\'$1\')">üîó $1</span>')
        
        // Standard Markdown
        .replace(/^# (.*$)/gim, '<h3 class="text-xl font-bold text-indigo-300 mt-3 border-b border-gray-600 pb-1">$1</h3>')
        .replace(/^## (.*$)/gim, '<h4 class="text-lg font-bold text-indigo-200 mt-2">$1</h4>')
        .replace(/\*\*(.*?)\*\*/g, '<strong class="text-white bg-indigo-900/50 px-1 rounded">$1</strong>')
        .replace(/\*(.*?)\*/g, '<em class="text-yellow-300">$1</em>')
        .replace(/^- (.*$)/gim, '<li class="ml-4 list-disc text-gray-300">$1</li>')
        .replace(/\n/g, '<br>');
};

// üü¢ FIXED: EDIT NOTE (Handles Grid & List Modes)
window.editNote = function(id, tab) {
    console.log(`üìù Attempting to open note: ${id} in tab: ${tab}`);

    // 1. Try to find the note data in memory (Best Method)
    let note = null;
    let title = "";
    let content = "";

    if (window.structuredNotes && window.structuredNotes[tab]) {
        note = window.structuredNotes[tab].find(n => n.id === id);
    }

    if (note) {
        // ‚úÖ Found in memory
        title = note.title;
        content = note.content;
    } else {
        // ‚ö†Ô∏è Memory Miss: Attempt Recovery
        console.warn("‚ö†Ô∏è Note not found in memory. Attempting HTML recovery...");
        const card = document.getElementById('note-' + id);
        
        if (!card) {
            alert("Error: Note element not found. Please refresh.");
            return;
        }

        // CHECK: Are we in Grid Mode or List Mode?
        // Grid cards use <h4> for titles, List items use .collapsible-header
        const isGrid = card.querySelector('h4') !== null;

        if (isGrid) {
            // üõë GRID MODE ERROR
            // We cannot recover the full text from a Grid Card because it is truncated!
            alert("‚ö†Ô∏è Could not load full note content. Please refresh the page to sync data.");
            return;
        } else {
            // üìú LIST MODE RECOVERY (Your old logic)
            const titleEl = card.querySelector('.collapsible-header span');
            if (titleEl) title = titleEl.innerText;

            const contentDiv = card.querySelector('.font-sans');
            if (contentDiv) {
                // Reverse-Engineer HTML to Markdown
                let html = contentDiv.innerHTML;
                content = html
                    .replace(/<strong[^>]*>(.*?)<\/strong>/gi, "**$1**")
                    .replace(/<b[^>]*>(.*?)<\/b>/gi, "**$1**")
                    .replace(/<em[^>]*>(.*?)<\/em>/gi, "*$1*")
                    .replace(/<h3[^>]*>(.*?)<\/h3>/gi, "# $1\n")
                    .replace(/<li[^>]*>(.*?)<\/li>/gi, "- $1\n")
                    .replace(/<br\s*\/?>/gi, "\n")
                    .replace(/&lt;/g, "<").replace(/&gt;/g, ">");
            }
        }
    }

    // 2. Populate the Modal
    const idField = document.getElementById('modal-note-id');
    const tabField = document.getElementById('modal-tab-name');
    const titleField = document.getElementById('modal-title');
    const contentField = document.getElementById('modal-content');
    const modal = document.getElementById('edit-modal');

    if (idField) idField.value = id;
    if (tabField) tabField.value = tab;
    if (titleField) titleField.value = title || "Untitled";
    if (contentField) contentField.value = content || "";

    // 3. Trigger Timeline Backlinks (if function exists)
    if (window.updateTimelineBacklinks) window.updateTimelineBacklinks(title);

    // 4. Open Modal
    if (modal) {
        modal.classList.remove('hidden');
    } else {
        console.error("‚ùå Error: 'edit-modal' div missing from HTML.");
    }
};

    
// ==========================================
// üõ°Ô∏è STATBLOCK FIX: Save as Clean Markdown
// ==========================================

// Helper: Auto-link dice formulas like "(2d6 + 3)" -> "([[2d6 + 3]])"
const linkifyDice = (text) => {
    if (!text) return "";
    // Looks for patterns like "1d6", "2d8 + 3", "3d6+2"
    return text.replace(/(\d+d\d+(?:\s?[\+\-]\s?\d+)?)/gi, "[[$1]]");
};

// 1. SAVE SRD MONSTER (Clean Markdown)
window.saveSrdToNotes = async function(index) {
    const m = window.currentSrdResults ? window.currentSrdResults[index] : null;
    if (!m) { alert("Error: Monster data not found."); return; }

    const targetCampaign = await window.promptForCampaign();
    if (!targetCampaign) return;

    // Formatting Helpers
    const xpTable = { "0": 10, "1/8": 25, "1/4": 50, "1/2": 100, "1": 200, "2": 450, "3": 700, "4": 1100, "5": 1800, "6": 2300, "7": 2900, "8": 3900, "9": 5000, "10": 5900, "11": 7200, "12": 8400, "13": 10000, "14": 11500, "15": 13000, "16": 15000, "17": 18000, "18": 20000, "19": 22000, "20": 25000, "21": 33000, "22": 41000, "23": 50000, "24": 62000, "30": 155000 };
    const xp = m.xp || xpTable[m.challenge_rating] || 0;
    const speed = m.speed ? JSON.stringify(m.speed).replace(/[{"}]/g, '').replace(/,/g, ', ') : '30 ft.';
    const fmtList = (val) => Array.isArray(val) ? val.join(', ') : (val || '-');
    
    // Ability Scores formatted in a line
    const getMod = (s) => Math.floor((s - 10) / 2);
    const fmtStat = (val) => { const v = val||10; const mod = getMod(v); return `${v} (${mod>=0?'+':''}${mod})`; };
    const statsLine = `**STR:** ${fmtStat(m.strength)} | **DEX:** ${fmtStat(m.dexterity)} | **CON:** ${fmtStat(m.constitution)}\n**INT:** ${fmtStat(m.intelligence)} | **WIS:** ${fmtStat(m.wisdom)} | **CHA:** ${fmtStat(m.charisma)}`;

    // Build the Markdown String
    let md = `# ${m.name}\n`;
    md += `*${m.size} ${m.type}, ${m.alignment}*\n`;
    md += `---\n`;
    md += `**AC:** ${m.armor_class} (${m.armor_desc || 'natural'})\n`;
    md += `**HP:** ${linkifyDice(m.hit_points + " (" + m.hit_dice + ")")}\n`;
    md += `**Speed:** ${speed}\n`;
    md += `---\n`;
    md += `${statsLine}\n`;
    md += `---\n`;
    md += `**Saves:** ${m.strength_save ? 'Str +'+m.strength_save : ''} ${m.dexterity_save ? 'Dex +'+m.dexterity_save : ''} ${m.constitution_save ? 'Con +'+m.constitution_save : ''} ${m.intelligence_save ? 'Int +'+m.intelligence_save : ''} ${m.wisdom_save ? 'Wis +'+m.wisdom_save : ''} ${m.charisma_save ? 'Cha +'+m.charisma_save : ''}\n`;
    md += `**Skills:** ${JSON.stringify(m.skills || '-').replace(/[{"}]/g, '').replace(/,/g, ', ')}\n`;
    md += `**Senses:** ${m.senses || '-'}\n`;
    md += `**CR:** ${m.challenge_rating} (${xp} XP)\n`;
    md += `---\n`;

    // Traits
    if (m.special_abilities) {
        md += `## Traits\n`;
        m.special_abilities.forEach(t => md += `**${t.name}.** ${linkifyDice(t.desc)}\n\n`);
    }

    // Actions
    if (m.actions) {
        md += `## Actions\n`;
        m.actions.forEach(a => md += `**${a.name}.** ${linkifyDice(a.desc)}\n\n`);
    }

    // Legendary
    if (m.legendary_actions) {
        md += `## Legendary Actions\n`;
        m.legendary_actions.forEach(a => md += `**${a.name}.** ${linkifyDice(a.desc)}\n\n`);
    }

    // Save
    const newNote = { 
        id: crypto.randomUUID(), 
        title: `${m.name} (Statblock)`, 
        content: md, 
        timestamp: new Date().toISOString() 
    };
    
    await window.finalizeSave('enemyNotes', newNote, targetCampaign);
};

// 2. SAVE AI GENERATED MONSTER (Clean Markdown)
window.saveMonsterToNotes = async function() {
    if (!window.userId) { alert("Please log in."); window.openLoginModal(); return; }
    const m = window.lastGeneratedMonster;
    if (!m) { alert("No monster generated."); return; }

    const targetCampaign = await window.promptForCampaign();
    if (!targetCampaign) return;

    // Build Markdown from the AI Object
    const getMod = (s) => Math.floor(((parseInt(s)||10) - 10) / 2);
    const fmtStat = (val) => { const v = parseInt(val)||10; const mod = getMod(v); return `${v} (${mod>=0?'+':''}${mod})`; };
    
    let md = `# ${m.name}\n*${m.size} ${m.type}, ${m.align}*\n---\n`;
    md += `**AC:** ${m.ac}\n**HP:** ${linkifyDice(m.hp.toString())}\n**Speed:** ${m.speed}\n---\n`;
    md += `**STR:** ${fmtStat(m.str)} | **DEX:** ${fmtStat(m.dex)} | **CON:** ${fmtStat(m.con)}\n`;
    md += `**INT:** ${fmtStat(m.int)} | **WIS:** ${fmtStat(m.wis)} | **CHA:** ${fmtStat(m.cha)}\n---\n`;
    md += `**CR:** ${m.cr || 'Unknown'}\n---\n`;

    if (m.traits && m.traits.length) {
        md += `## Traits\n`;
        m.traits.forEach(t => md += `**${t.name}.** ${linkifyDice(t.description || t.desc)}\n\n`);
    }
    
    if (m.actions && m.actions.length) {
        md += `## Actions\n`;
        m.actions.forEach(a => md += `**${a.name}.** ${linkifyDice(a.description || t.desc)}\n\n`);
    }

    const newNote = { 
        id: crypto.randomUUID(), 
        title: `${m.name} (AI Generated)`, 
        content: md, 
        timestamp: new Date().toISOString() 
    };

    await window.finalizeSave('enemyNotes', newNote, targetCampaign);
};

// üü¢ FIXED: Smooth Accordion Toggle (Restores Old Logic)
window.toggleCollapse = function(id) {
    const content = document.getElementById('content-' + id);
    const arrow = document.querySelector('#note-' + id + ' .arrow-icon'); 
    
    if (content) {
        // 1. Toggle the logic class
        content.classList.toggle('expanded');
        
        // 2. Calculate Height dynamically (Your Old Logic)
        if (content.classList.contains('expanded')) {
            // OPEN: Set max-height to the actual scroll height of the content
            content.style.maxHeight = content.scrollHeight + "px";
            content.classList.remove('opacity-0'); // Fade in
            if(arrow) arrow.style.transform = 'rotate(180deg)'; 
        } else {
            // CLOSE: valid null clears the inline style, falling back to CSS (0px)
            content.style.maxHeight = "0px";
            content.classList.add('opacity-0'); // Fade out
            if(arrow) arrow.style.transform = 'rotate(0deg)';
        }
    }
};


// ==========================================
// üõ°Ô∏è HYBRID RENDERER (Protects Old Notes)
// ==========================================

// üü¢ MASTER RENDERER (Grid Delete + List Header Edit + Preview)
window.renderStructuredNotes = function(tab) {
    const list = document.getElementById(`${tab}-list`);
    if(!list) return;

    // 1. Setup
    const searchInput = document.getElementById('notes-search');
    const query = searchInput ? searchInput.value.toLowerCase().trim() : "";
    const allNotes = structuredNotes[tab] || [];
    const isGrid = localStorage.getItem('aegis_note_layout') === 'grid' && window.isProUser;

    // 2. Container CSS
    if (isGrid) {
        list.className = "grid grid-cols-2 md:grid-cols-3 gap-4 pb-20"; 
    } else {
        list.className = "space-y-3 pb-20"; 
    }

    // 3. Filter
    const filteredNotes = allNotes.filter(n => {
        const matchesCampaign = (n.campaign || 'Default Campaign') === window.currentCampaign;
        const matchesSearch = n.title.toLowerCase().includes(query) || n.content.toLowerCase().includes(query);
        return matchesCampaign && matchesSearch;
    });

    list.innerHTML = filteredNotes.length ? '' : `<div class="col-span-full text-center text-gray-500 pt-8 text-xs italic">No notes found.</div>`;

    // 4. Render Loop
    filteredNotes.forEach(n => {
        const div = document.createElement('div');
        div.id = `note-${n.id}`;

        // Content Prep
        let rawContent = n.content || ""; 
        let displayContent = "";
        
        const isLegacyHTML = rawContent.trim().match(/^<(div|p|table|h\d|ul|ol)/i);
        if (isLegacyHTML) {
            displayContent = rawContent.replace(/\[\[(\d+d\d+(?:[+\-]\d+)?)\]\]/gi, 'üé≤ $1');
        } else {
            if (window.parseMarkdown) {
                displayContent = window.parseMarkdown(rawContent);
            } else {
                displayContent = rawContent.replace(/\n/g, "<br>");
            }
        }

        // üü¢ A. GRID MODE (Pro)
        if (isGrid) {
            div.className = "group relative bg-gray-800 border border-gray-700 rounded-xl p-4 hover:border-indigo-500 hover:shadow-lg transition-all cursor-pointer flex flex-col h-48 overflow-hidden animate-fade-in";
            
            // Main Click: Open Preview
            div.onclick = function() { window.openNotePreview(n, tab); }; 
            
            let cleanPreview = rawContent.replace(/<[^>]+>/g, '').replace(/[*#\[\]]/g, '').substring(0, 150) + "...";
            const dateStr = n.timestamp ? new Date(n.timestamp).toLocaleDateString() : "";

            div.innerHTML = `
                <div class="flex justify-between items-start mb-2 gap-2">
                    <h4 class="font-bold text-indigo-300 text-sm line-clamp-1 group-hover:text-white transition flex-1">${n.title}</h4>
                    
                    <button onclick="event.stopPropagation(); window.deleteNote('${n.id}', '${tab}')" class="text-gray-600 hover:text-red-500 p-1 rounded hover:bg-white/5 transition z-10" title="Delete Note">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                    </button>
                </div>
                
                <p class="text-[11px] text-gray-400 leading-relaxed line-clamp-4 flex-1 break-words">${cleanPreview}</p>
                
                <div class="mt-auto pt-3 border-t border-gray-700/50 flex justify-between items-center text-[10px] text-gray-500">
                    <span>${dateStr}</span>
                    <span class="opacity-0 group-hover:opacity-100 transition text-indigo-400 font-bold uppercase tracking-wider">Read üëÅÔ∏è</span>
                </div>
            `;
        } 
        // üü¢ B. LIST MODE (Classic)
        else {
            div.className = 'note-item card p-0 rounded-lg shadow-md mb-2 bg-gray-800 border border-gray-700 overflow-hidden'; 
            const dateStr = n.timestamp ? new Date(n.timestamp).toLocaleDateString() : "";

            div.innerHTML = `
            <div class="collapsible-header hover:bg-gray-700/50 transition p-3 cursor-pointer flex justify-between items-center select-none z-10 relative bg-gray-800">
                <div class="flex items-center gap-3 overflow-hidden">
                    <span class="text-gray-600 text-xs">üìÑ</span>
                    <span class="font-bold text-indigo-200 truncate text-sm">${n.title}</span>
                </div>
                
                <div class="flex items-center gap-3">
                    <button id="header-edit-${n.id}" class="text-[10px] font-bold text-gray-500 hover:text-white uppercase tracking-wider bg-gray-700/50 hover:bg-gray-600 px-2 py-1 rounded transition-colors border border-transparent hover:border-gray-500">
                        Edit
                    </button>

                    <span class="text-gray-500 text-[10px] transition-transform duration-300 arrow-icon">‚ñº</span>
                </div>
            </div>
            
            <div class="collapsible-content max-h-0 overflow-hidden transition-all duration-500 ease-in-out opacity-0 bg-gray-900/50 border-t border-gray-700" id="content-${n.id}">
                <div class="flex justify-between items-center p-2 border-b border-gray-700 bg-black/20">
                    <span class="text-[10px] text-gray-500">${dateStr}</span>
                    <div class="flex gap-2">
                        <button onclick="deleteNote('${n.id}', '${tab}')" class="text-xs text-red-500 hover:text-red-400 font-semibold px-2 uppercase">Delete</button>
                    </div>
                </div>
                <div class="p-4 text-sm text-white leading-relaxed font-sans">
                    ${displayContent}
                </div>
            </div>`;

            // Attach Listeners
            const header = div.querySelector('.collapsible-header');
            if(header) {
                header.onclick = function() { window.toggleCollapse(n.id); };
            }

            const editBtn = div.querySelector(`#header-edit-${n.id}`);
            if(editBtn) {
                editBtn.onclick = function(e) {
                    e.stopPropagation(); // Don't open accordion
                    window.openNoteDirectly(n, tab);
                };
            }
        }
        
        list.appendChild(div);
    });
};

// ==========================================
// üõ†Ô∏è CRITICAL FIX: Safe Dice Linking & Saving
// ==========================================

// 1. GLOBAL LINKIFY FUNCTION (Safe Override)
window.linkifyDice = function(text) {
    if (!text) return "";
    // Regex matches dice (2d6) and optional modifier (+ 4) with spaces
    return text.replace(/(\d+d\d+)(?:\s?([+\-])\s?(\d+))?/gi, (match, dice, sign, mod) => {
        if (sign && mod) {
            // Remove spaces: "2d6 + 4" becomes "[[2d6+4]]"
            return `[[${dice}${sign}${mod}]]`; 
        }
        return `[[${dice}]]`;
    });
};

// 2. ROBUST ROLLER (Ignores spaces inside the button)
window.rollInline = function(formula) {
    // Sanitize: "2d6 + 4" -> "2d6+4"
    const cleanFormula = formula.replace(/\s/g, '').toLowerCase();

    const match = cleanFormula.match(/^(\d+)d(\d+)([+\-]\d+)?$/);
    
    if (!match) {
        if(window.showToast) window.showToast(`‚ùå Invalid Dice: ${formula}`, 'error');
        return;
    }

    const count = parseInt(match[1]);
    const sides = parseInt(match[2]);
    const modStr = match[3] || "+0";
    const mod = parseInt(modStr);

    let total = 0;
    let rolls = [];
    
    for(let i=0; i<count; i++) {
        const r = Math.floor(Math.random() * sides) + 1;
        rolls.push(r);
        total += r;
    }
    
    const finalResult = total + mod;
    
    // Fire Visuals & Sound
    if(window.throwDiceVisuals) window.throwDiceVisuals(rolls, sides);
    if(window.playTone) window.playTone(finalResult === 20 ? 'critical' : finalResult === 1 ? 'fail' : 'success');

    // Show Toast
    const icon = finalResult >= 20 ? "üî•" : "üé≤";
    const detail = count > 1 ? `[${rolls.join('+')}]${modStr}` : `(d${sides}${modStr})`;
    
    if(window.showToast) window.showToast(`${icon} Rolled <strong>${finalResult}</strong> <span class='text-xs opacity-75 ml-1'>${detail}</span>`, 'roll');
};

// 3. OVERWRITE SAVE: SRD MONSTER
window.saveSrdToNotes = async function(index) {
    const m = window.currentSrdResults ? window.currentSrdResults[index] : null;
    if (!m) { alert("Error: Monster data not found."); return; }

    const targetCampaign = await window.promptForCampaign();
    if (!targetCampaign) return;

    // Formatting Helpers
    const xpTable = { "0": 10, "1/8": 25, "1/4": 50, "1/2": 100, "1": 200, "2": 450, "3": 700, "4": 1100, "5": 1800, "6": 2300, "7": 2900, "8": 3900, "9": 5000, "10": 5900, "11": 7200, "12": 8400, "13": 10000, "14": 11500, "15": 13000, "16": 15000, "17": 18000, "18": 20000, "19": 22000, "20": 25000, "21": 33000, "22": 41000, "23": 50000, "24": 62000, "30": 155000 };
    const xp = m.xp || xpTable[m.challenge_rating] || 0;
    const speed = m.speed ? JSON.stringify(m.speed).replace(/[{"}]/g, '').replace(/,/g, ', ') : '30 ft.';
    
    const getMod = (s) => Math.floor(((parseInt(s)||10) - 10) / 2);
    const fmtStat = (val) => { const v = parseInt(val)||10; const mod = getMod(v); return `${v} (${mod>=0?'+':''}${mod})`; };
    const statsLine = `**STR:** ${fmtStat(m.strength)} | **DEX:** ${fmtStat(m.dexterity)} | **CON:** ${fmtStat(m.constitution)}\n**INT:** ${fmtStat(m.intelligence)} | **WIS:** ${fmtStat(m.wisdom)} | **CHA:** ${fmtStat(m.charisma)}`;

    // Build Clean Markdown
    let md = `# ${m.name}\n`;
    md += `*${m.size} ${m.type}, ${m.alignment}*\n`;
    md += `---\n`;
    md += `**AC:** ${m.armor_class} (${m.armor_desc || 'natural'})\n`;
    // üü¢ Uses window.linkifyDice
    md += `**HP:** ${window.linkifyDice(m.hit_points + " (" + m.hit_dice + ")")}\n`;
    md += `**Speed:** ${speed}\n`;
    md += `---\n`;
    md += `${statsLine}\n`;
    md += `---\n`;
    md += `**Saves:** ${m.strength_save ? 'Str +'+m.strength_save : ''} ${m.dexterity_save ? 'Dex +'+m.dexterity_save : ''} ${m.constitution_save ? 'Con +'+m.constitution_save : ''} ${m.intelligence_save ? 'Int +'+m.intelligence_save : ''} ${m.wisdom_save ? 'Wis +'+m.wisdom_save : ''} ${m.charisma_save ? 'Cha +'+m.charisma_save : ''}\n`;
    md += `**Skills:** ${JSON.stringify(m.skills || '-').replace(/[{"}]/g, '').replace(/,/g, ', ')}\n`;
    md += `**Senses:** ${m.senses || '-'}\n`;
    md += `**CR:** ${m.challenge_rating} (${xp} XP)\n`;
    md += `---\n`;

    if (m.special_abilities) {
        md += `## Traits\n`;
        m.special_abilities.forEach(t => md += `**${t.name}.** ${window.linkifyDice(t.desc)}\n\n`);
    }

    if (m.actions) {
        md += `## Actions\n`;
        m.actions.forEach(a => md += `**${a.name}.** ${window.linkifyDice(a.desc)}\n\n`);
    }

    if (m.legendary_actions) {
        md += `## Legendary Actions\n`;
        m.legendary_actions.forEach(a => md += `**${a.name}.** ${window.linkifyDice(a.desc)}\n\n`);
    }

    const newNote = { 
        id: crypto.randomUUID(), 
        title: `${m.name} (Statblock)`, 
        content: md, 
        timestamp: new Date().toISOString() 
    };
    
    await window.finalizeSave('enemyNotes', newNote, targetCampaign);
};

// 4. OVERWRITE SAVE: AI MONSTER
window.saveMonsterToNotes = async function() {
    if (!window.userId) { alert("Please log in."); window.openLoginModal(); return; }
    const m = window.lastGeneratedMonster;
    if (!m) { alert("No monster generated."); return; }

    const targetCampaign = await window.promptForCampaign();
    if (!targetCampaign) return;

    const getMod = (s) => Math.floor(((parseInt(s)||10) - 10) / 2);
    const fmtStat = (val) => { const v = parseInt(val)||10; const mod = getMod(v); return `${v} (${mod>=0?'+':''}${mod})`; };
    
    let md = `# ${m.name}\n*${m.size} ${m.type}, ${m.align}*\n---\n`;
    md += `**AC:** ${m.ac}\n**HP:** ${window.linkifyDice(m.hp.toString())}\n**Speed:** ${m.speed}\n---\n`;
    md += `**STR:** ${fmtStat(m.str)} | **DEX:** ${fmtStat(m.dex)} | **CON:** ${fmtStat(m.con)}\n`;
    md += `**INT:** ${fmtStat(m.int)} | **WIS:** ${fmtStat(m.wis)} | **CHA:** ${fmtStat(m.cha)}\n---\n`;
    md += `**CR:** ${m.cr || 'Unknown'}\n---\n`;

    if (m.traits && m.traits.length) {
        md += `## Traits\n`;
        m.traits.forEach(t => md += `**${t.name}.** ${window.linkifyDice(t.description || t.desc)}\n\n`);
    }
    
    if (m.actions && m.actions.length) {
        md += `## Actions\n`;
        m.actions.forEach(a => md += `**${a.name}.** ${window.linkifyDice(a.description || t.desc)}\n\n`);
    }

    const newNote = { 
        id: crypto.randomUUID(), 
        title: `${m.name} (AI Generated)`, 
        content: md, 
        timestamp: new Date().toISOString() 
    };

    await window.finalizeSave('enemyNotes', newNote, targetCampaign);
};


 // ==========================================
// üêâ MONSTER GENERATOR (Auto-Link Dice [[2d6]])
// ==========================================

// üü¢ UNIVERSAL SERVER CONNECTOR (Unwraps Firebase "result" envelope)
window.callMyServer = async function(promptText) {
    const myServerUrl = "https://us-central1-aegisdmtoolkit.cloudfunctions.net/generateStatblock";
    
    console.log("üì° Calling Server...");
    
    // Standard fetch to your Cloud Function
    const response = await fetch(myServerUrl, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ prompt: promptText })
    });

    if (!response.ok) {
        throw new Error(`Server Error: ${response.status} ${response.statusText}`);
    }

    const rawData = await response.json();
    console.log("üì• Raw Server Response:", rawData); 

    // 1. UNWRAP FIREBASE ENVELOPE (The Fix!)
    // If the data is inside { "result": ... }, grab it. Otherwise use rawData.
    const data = rawData.result || rawData; 

    // 2. FIND THE TEXT
    // A. Check for OpenAI format
    if (data.choices && data.choices.length > 0) {
        return data.choices[0].message.content;
    } 
    // B. Check for Gemini format
    else if (data.candidates && data.candidates.length > 0) {
        return data.candidates[0].content.parts[0].text;
    }
    // C. Check for direct text
    else if (typeof data === 'string') {
        return data;
    }
    else {
        // If we get here, check your Console (F12) to see what the server actually sent!
        console.error("Unknown Data Structure:", data);
        throw new Error("AI returned a response, but we couldn't find the text. Check Console (F12) for details.");
    }
};

// 2. GENERATOR FUNCTION
// üêâ FIXED MONSTER GENERATOR (Secure Server + Dice Linking)
window.generateMonsterStatblock = async function() {
¬† ¬† const btn = document.getElementById('generate-monster-button'); ¬† 
¬† ¬† const spinner = document.getElementById('monster-loading-spinner');
¬† ¬† const output = document.getElementById('monster-output'); ¬† 
¬† ¬† const status = document.getElementById('monster-status-message');

¬† ¬† // 1. Reset & UI Prep
¬† ¬† window.lastGeneratedMonster = null; ¬† 
¬† ¬† btn.disabled = true; ¬† 
¬† ¬† spinner.classList.remove('hidden');
¬† ¬† output.innerHTML = '<span class="text-gray-400 animate-pulse">Summoning creature...</span>';
¬† ¬† if(status) status.classList.add('hidden');

¬† ¬† try {
¬† ¬† ¬† ¬† const name = document.getElementById('monster-name').value;
¬† ¬† ¬† ¬† const cr = document.getElementById('monster-cr').value;

¬† ¬† ¬† ¬† // üü¢ 2. PROMPT (Strict JSON rules for the Server)
¬† ¬† ¬† ¬† const prompt = `
¬† ¬† ¬† ¬† Create a D&D 5e statblock for "${name}" (CR ${cr}). 
¬† ¬† ¬† ¬† 
¬† ¬† ¬† ¬† CRITICAL RULES:
¬† ¬† ¬† ¬† 1. Return ONLY valid JSON. No markdown formatting.
¬† ¬† ¬† ¬† 2. The JSON must strictly match this structure:
¬† ¬† ¬† ¬† ¬† ¬†{
¬† ¬† ¬† ¬† ¬† ¬† ¬†"name": "String", "size": "String", "type": "String", "alignment": "String",
¬† ¬† ¬† ¬† ¬† ¬† ¬†"ac": Integer, "hp": Integer, "hit_dice": "String", "speed": "String",
¬† ¬† ¬† ¬† ¬† ¬† ¬†"str": Integer, "dex": Integer, "con": Integer, "int": Integer, "wis": Integer, "cha": Integer,
¬† ¬† ¬† ¬† ¬† ¬† ¬†"saves": "String", "skills": "String", "senses": "String", "languages": "String",
¬† ¬† ¬† ¬† ¬† ¬† ¬†"cr": "String", "xp": Integer,
¬† ¬† ¬† ¬† ¬† ¬† ¬†"traits": [{"name": "String", "desc": "String"}],
¬† ¬† ¬† ¬† ¬† ¬† ¬†"actions": [{"name": "String", "desc": "String"}],
¬† ¬† ¬† ¬† ¬† ¬† ¬†"legendary": [{"name": "String", "desc": "String"}]
¬† ¬† ¬† ¬† ¬† ¬†}
¬† ¬† ¬† ¬† 3. Action descriptions must be FINAL, IN-GAME text.
¬† ¬† ¬† ¬† 4. Use standard attack format: "Melee Weapon Attack: +X to hit, reach 5 ft., one target. Hit: Y (dZ + W) type damage."
¬† ¬† ¬† ¬† `;

¬† ¬† ¬† ¬† // üü¢ 3. CALL SERVER (The Fix)
¬† ¬† ¬† ¬† const aiText = await window.callMyServer(prompt);
¬† ¬† ¬† ¬† 
¬† ¬† ¬† ¬† // Cleanup & Parse
¬† ¬† ¬† ¬† const cleanText = aiText.replace(/```json/g, '').replace(/```/g, '').trim();
¬† ¬† ¬† ¬† const raw = JSON.parse(cleanText);

¬† ¬† ¬† ¬† // üü¢ 4. Map Data
¬† ¬† ¬† ¬† const m = {
¬† ¬† ¬† ¬† ¬† ¬† name: raw.name || name, size: raw.size || "Medium", type: raw.type || "Monster", align: raw.alignment || "Unaligned",
¬† ¬† ¬† ¬† ¬† ¬† ac: parseInt(raw.ac)||10, hp: parseInt(raw.hp)||10, hitDice: raw.hit_dice||"1d8", speed: raw.speed||"30 ft.",
¬† ¬† ¬† ¬† ¬† ¬† str: parseInt(raw.str)||10, dex: parseInt(raw.dex)||10, con: parseInt(raw.con)||10, int: parseInt(raw.int)||10, wis: parseInt(raw.wis)||10, cha: parseInt(raw.cha)||10,
¬† ¬† ¬† ¬† ¬† ¬† saves: raw.saves||"-", skills: raw.skills||"-", senses: raw.senses||"-", langs: raw.languages||"-",
¬† ¬† ¬† ¬† ¬† ¬† cr: raw.cr||cr, xp: raw.xp||0, traits: raw.traits||[], actions: raw.actions||[], legendary: raw.legendary||[]
¬† ¬† ¬† ¬† };

¬† ¬† ¬† ¬† window.lastGeneratedMonster = m;

¬† ¬† ¬† ¬† // üü¢ 5. RENDER HELPERS (With Dice Linker Preserved!)
¬† ¬† ¬† ¬† const getMod = (s) => Math.floor(((parseInt(s)||10)-10)/2);
¬† ¬† ¬† ¬† const fmtMod = (s) => { const m = getMod(s); return m>=0?`+${m}`:m; };
¬† ¬† ¬† ¬† 
¬† ¬† ¬† ¬† // The Dice Linker: Swaps (2d6 + 3) -> [[2d6+3]]
¬† ¬† ¬† ¬† const formatDice = (text) => {
¬† ¬† ¬† ¬† ¬† ¬† if (!text) return "";
¬† ¬† ¬† ¬† ¬† ¬† let clean = text.replace(/Let's simplify.*?[\.\-]/gi, "").trim();
¬† ¬† ¬† ¬† ¬† ¬† clean = clean.replace(/\(\s*(\d+d\d+)(?:\s*([+\-])\s*(\d+))?\s*\)/gi, (match, d, s, m) => `[[${d}${s||''}${m||''}]]`);
¬† ¬† ¬† ¬† ¬† ¬† clean = clean.replace(/(?<!\[\[)\b(\d+d\d+)(?:\s*([+\-])\s*(\d+))?\b(?!\]\])/gi, (match, d, s, m) => `[[${d}${s||''}${m||''}]]`);
¬† ¬† ¬† ¬† ¬† ¬† return clean;
¬† ¬† ¬† ¬† };

¬† ¬† ¬† ¬† const fmtText = (arr) => arr.map(t => {
¬† ¬† ¬† ¬† ¬† ¬† const n = t.name || "Ability";
¬† ¬† ¬† ¬† ¬† ¬† let d = t.desc || t.description || ""; 
¬† ¬† ¬† ¬† ¬† ¬† d = formatDice(d); // Apply the dice formatter
¬† ¬† ¬† ¬† ¬† ¬† return `<div class="mb-3 text-sm text-gray-300"><strong class="text-white">${n}.</strong> ${d}</div>`;
¬† ¬† ¬† ¬† }).join('');
¬† ¬† ¬† ¬† 
¬† ¬† ¬† ¬† // 6. Build HTML
¬† ¬† ¬† ¬† let html = `
¬† ¬† ¬† ¬† ¬† ¬† <div class="text-left font-sans text-sm text-gray-300">
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† <h3 class="text-xl font-bold text-indigo-300 border-b border-gray-600 pb-1 mb-1">${m.name}</h3>
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† <div class="text-xs text-yellow-500 italic mb-3">${m.size} ${m.type}, ${m.align}</div>

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† <div class="grid grid-cols-3 gap-4 bg-gray-800 p-3 rounded border border-gray-700 mb-4 text-center">
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† <div><div class="text-xs text-gray-500 uppercase">AC</div><div class="text-xl font-bold text-blue-300">${m.ac}</div></div>
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† <div><div class="text-xs text-gray-500 uppercase">HP</div><div class="text-xl font-bold text-green-300">${m.hp}</div><div class="text-[10px] text-gray-500">${m.hitDice}</div></div>
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† <div><div class="text-xs text-gray-500 uppercase">Speed</div><div class="text-sm font-bold text-white mt-1">${m.speed}</div></div>
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† </div>

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† <div class="grid grid-cols-6 text-center text-[10px] font-mono text-gray-400 mb-3 bg-gray-800 rounded p-1 border border-gray-700">
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† <div>STR<br><span class="text-white text-xs">${m.str}</span><br>${fmtMod(m.str)}</div>
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† <div>DEX<br><span class="text-white text-xs">${m.dex}</span><br>${fmtMod(m.dex)}</div>
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† <div>CON<br><span class="text-white text-xs">${m.con}</span><br>${fmtMod(m.con)}</div>
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† <div>INT<br><span class="text-white text-xs">${m.int}</span><br>${fmtMod(m.int)}</div>
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† <div>WIS<br><span class="text-white text-xs">${m.wis}</span><br>${fmtMod(m.wis)}</div>
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† <div>CHA<br><span class="text-white text-xs">${m.cha}</span><br>${fmtMod(m.cha)}</div>
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† </div>

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† <div class="text-xs space-y-0.5 mb-3 border-b border-gray-600 pb-2">
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† <p><strong class="text-gray-500">Saves:</strong> ${m.saves}</p>
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† <p><strong class="text-gray-500">Skills:</strong> ${m.skills}</p>
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† <p><strong class="text-gray-500">Senses:</strong> ${m.senses}</p>
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† <p><strong class="text-gray-500">CR:</strong> <span class="text-white">${m.cr}</span> (${m.xp} XP)</p>
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† </div>

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† <div class="space-y-3">
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ${fmtText(m.traits)}
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ${m.actions.length ? `<div class="font-bold text-indigo-400 border-b border-gray-700 mt-3 mb-1">Actions</div>` : ''}
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ${fmtText(m.actions)}
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ${m.legendary.length ? `<div class="font-bold text-indigo-400 border-b border-gray-700 mt-3 mb-1">Legendary Actions</div>` : ''}
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ${fmtText(m.legendary)}
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† </div>
¬† ¬† ¬† ¬† ¬† ¬† </div>`;

¬† ¬† ¬† ¬† output.innerHTML = html;
¬† ¬† ¬† ¬† document.getElementById('save-options-monster').classList.remove('hidden');

¬† ¬† } catch(e) { ¬† 
¬† ¬† ¬† ¬† console.error(e);
¬† ¬† ¬† ¬† output.innerHTML = `<div class="p-3 bg-red-900/50 rounded border border-red-500 text-red-200 text-xs"><strong>Generation Failed:</strong> ${e.message}</div>`;
¬† ¬† ¬† ¬† window.lastGeneratedMonster = null; 
¬† ¬† } finally { ¬† 
¬† ¬† ¬† ¬† spinner.classList.add('hidden'); ¬† 
¬† ¬† ¬† ¬† btn.disabled = false; ¬† 
¬† ¬† }
};


// ==========================================
// üíæ FORCE FIX: SAVE MONSTER TO ENEMIES TAB
// ==========================================

window.saveMonsterToNotes = async function() {
    // 1. Validation
    if (!window.userId) { 
        alert("üîí Please log in to save data."); 
        window.openLoginModal(); 
        return; 
    }

    const m = window.lastGeneratedMonster;
    if (!m) { 
        alert("‚ö†Ô∏è No monster data found. Please generate a monster first."); 
        return; 
    }

    // 2. Visual Feedback
    const btn = event.target || document.querySelector('#save-options-monster button:nth-child(2)');
    if(btn) btn.innerText = "Saving...";

    try {
        // 3. Select Campaign
        const targetCampaign = await window.promptForCampaign();
        if (!targetCampaign) {
            if(btn) btn.innerText = "Save to Notes";
            return;
        }

        // 4. Capture Content (The dark card we just generated)
        const outputEl = document.getElementById('monster-output');
        const content = outputEl ? outputEl.innerHTML : "Error: No content";

        // 5. Create Note Object
        const newNote = { 
            id: crypto.randomUUID(), 
            title: `${m.name} (CR ${m.cr || '?'})`, 
            content: content, 
            campaign: targetCampaign,
            timestamp: new Date().toISOString() 
        };

        // 6. FORCE SAVE to 'enemyNotes' Array
        // Ensure the array exists
        if (!window.structuredNotes) window.structuredNotes = {};
        if (!window.structuredNotes.enemyNotes) window.structuredNotes.enemyNotes = [];

        // Add to local memory
        window.structuredNotes.enemyNotes.unshift(newNote);

        // Save to Database
        await window.saveStructuredNotes('enemyNotes', window.structuredNotes.enemyNotes);

        // 7. SUCCESS & REDIRECT
        if(btn) btn.innerText = "Saved!";
        
        // Force switch to the Enemies tab so you see it immediately
        window.switchTab('notes'); 
        window.switchSubTab('enemyNotes');
        
        // Highlight the new note
        setTimeout(() => {
            const noteEl = document.getElementById(`note-${newNote.id}`);
            if (noteEl) {
                noteEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                noteEl.classList.add('ring-2', 'ring-green-400');
            }
        }, 300);

    } catch (e) {
        console.error(e);
        alert("Save Failed: " + e.message);
        if(btn) btn.innerText = "Save to Notes";
    }
};
        
// ==========================================
// üé≤ LINKING FIX: Auto-Link Dice on Save
// ==========================================

// 1. IMPROVED LINKIFY HELPER (Finds dice, strips spaces, adds brackets)
window.linkifyDice = (text) => {
    if (!text) return "";
    // Regex finds: "1d6", "2d8 + 3", "1d20 - 1" (Case insensitive)
    return text.replace(/\b(\d+d\d+)(?:\s?([+\-])\s?(\d+))?\b/gi, (match, dice, sign, mod) => {
        // Construct clean string: "2d6+3"
        const modStr = (sign && mod) ? `${sign}${mod}` : '';
        return `[[${dice}${modStr}]]`; 
    });
};

// 2. SAVE MONSTER TO NOTES (With Dice Links)
window.saveMonsterToNotes = async function() {
    // A. Validation
    if (!window.userId) { alert("üîí Please log in."); window.openLoginModal(); return; }
    const m = window.lastGeneratedMonster;
    if (!m) { alert("‚ö†Ô∏è No monster generated."); return; }

    // B. Campaign Select
    const targetCampaign = await window.promptForCampaign();
    if (!targetCampaign) return;

    // C. Helper for modifiers
    const getMod = (s) => Math.floor(((parseInt(s)||10) - 10) / 2);
    const fmtStat = (val) => { const v = parseInt(val)||10; const mod = getMod(v); return `${v} (${mod>=0?'+':''}${mod})`; };

    // D. BUILD MARKDOWN (Applying Dice Links)
    let md = `# ${m.name}\n`;
    md += `*${m.size} ${m.type}, ${m.align}*\n`;
    md += `---\n`;
    md += `**AC:** ${m.ac}\n`;
    // Linkify HP (e.g. "[[10d8+20]]")
    md += `**HP:** ${m.hp} (${window.linkifyDice(m.hitDice)})\n`;
    md += `**Speed:** ${m.speed}\n`;
    md += `---\n`;
    md += `**STR:** ${fmtStat(m.str)} | **DEX:** ${fmtStat(m.dex)} | **CON:** ${fmtStat(m.con)}\n`;
    md += `**INT:** ${fmtStat(m.int)} | **WIS:** ${fmtStat(m.wis)} | **CHA:** ${fmtStat(m.cha)}\n`;
    md += `---\n`;
    md += `**Saves:** ${m.saves}\n`;
    md += `**Skills:** ${m.skills}\n`;
    md += `**Senses:** ${m.senses}\n`;
    md += `**CR:** ${m.cr} (${m.xp} XP)\n`;
    md += `---\n`;

    // Traits
    if (m.traits && m.traits.length) {
        md += `### Traits\n`;
        m.traits.forEach(t => {
            // Linkify content inside traits
            md += `**${t.name}.** ${window.linkifyDice(t.desc || t.description)}\n\n`;
        });
    }

    // Actions (The important part for rolling)
    if (m.actions && m.actions.length) {
        md += `### Actions\n`;
        m.actions.forEach(a => {
            // Linkify content inside actions
            md += `**${a.name}.** ${window.linkifyDice(a.desc || a.description)}\n\n`;
        });
    }

    // Legendary Actions
    if (m.legendary && m.legendary.length) {
        md += `### Legendary Actions\n`;
        m.legendary.forEach(l => {
            md += `**${l.name}.** ${window.linkifyDice(l.desc || l.description)}\n\n`;
        });
    }

    // E. SAVE NOTE
    const newNote = { 
        id: crypto.randomUUID(), 
        title: `${m.name} (CR ${m.cr})`, 
        content: md, 
        campaign: targetCampaign,
        timestamp: new Date().toISOString() 
    };

    await window.finalizeSave('enemyNotes', newNote, targetCampaign);
};


// ==========================================
// ‚öîÔ∏è COMBAT TRACKER TABS LOGIC
// ==========================================

// Track which view is active
window.currentTrackerTab = 'initiative';

// 1. Switch Tabs (Initiative vs Enemies vs NPCs)
window.switchTrackerTab = function(tabName) {
    window.currentTrackerTab = tabName;

    // A. Update Buttons (Visual State)
    document.querySelectorAll('.tracker-tab-btn').forEach(btn => {
        // Reset styles
        btn.classList.remove('text-indigo-400', 'border-b-2', 'border-indigo-500', 'bg-gray-700/50');
        btn.classList.add('text-gray-500');
        
        // Highlight active button (Matches text like "Tracker", "Enemies", "NPCs")
        const btnText = btn.innerText.toLowerCase();
        const match = tabName === 'initiative' ? 'tracker' : tabName; 
        
        if(btnText.includes(match)) {
            btn.classList.add('text-indigo-400', 'border-b-2', 'border-indigo-500', 'bg-gray-700/50');
            btn.classList.remove('text-gray-500');
        }
    });

    // B. Hide/Show Content Areas
    ['view-initiative', 'view-enemies', 'view-npcs'].forEach(id => {
        const el = document.getElementById(id);
        if(el) el.classList.add('hidden');
    });
    
    // Show the selected view
    const activeView = document.getElementById(`view-${tabName}`);
    if(activeView) activeView.classList.remove('hidden');

    // C. Load Data if switching to a Note view
    if (tabName === 'enemies') {
        window.renderNotesInTracker('enemyNotes', 'enemies-list-container');
    } else if (tabName === 'npcs') {
        window.renderNotesInTracker('npcNotes', 'npcs-list-container');
    }
};

// 2. Render List of Notes into Sidebar
window.renderNotesInTracker = function(category, containerId) {
    const container = document.getElementById(containerId);
    if (!container) return;
    
    container.innerHTML = '';

    // 1. Get Notes (Direct variable access)
    const allNotes = structuredNotes[category] || [];

    // 2. Filter by Current Campaign
    const notes = allNotes.filter(n => {
        const noteCampaign = n.campaign || 'Default Campaign';
        return noteCampaign === window.currentCampaign;
    });

    if (notes.length === 0) {
        container.innerHTML = `<p class="text-gray-500 text-center text-xs mt-4">No ${category === 'enemyNotes' ? 'Enemies' : 'NPCs'} found.</p>`;
        return;
    }

    // 3. Render Collapsible Cards
    notes.forEach(note => {
        const div = document.createElement('div');
        div.className = 'bg-gray-800 rounded border border-gray-700 mb-2 overflow-hidden shadow-sm transition hover:border-indigo-500/50';
        
        const safeTitle = note.title.replace(/'/g, "\\'");
        
        // Use your Markdown parser so bold/italics/headers look right
        // We handle the case where parseMarkdown might not be ready yet
        const contentHtml = window.parseMarkdown ? window.parseMarkdown(note.content) : note.content.replace(/\n/g, '<br>');

        div.innerHTML = `
            <div class="p-3 flex justify-between items-center cursor-pointer select-none bg-gray-800 hover:bg-gray-700/50 transition" onclick="window.toggleTrackerNote('${note.id}')">
                <div class="font-bold text-sm text-indigo-200 truncate flex-1">${note.title}</div>
                <span id="icon-${note.id}" class="text-[10px] text-gray-500 transform transition-transform duration-200">‚ñº</span>
            </div>
            
            <div id="tracker-content-${note.id}" class="hidden bg-gray-900/80 border-t border-gray-700 p-3 text-xs text-gray-300 leading-relaxed font-sans shadow-inner">
                <div class="mb-4 prose prose-invert max-w-none">
                    ${contentHtml}
                </div>
                
                <button onclick="window.addNoteToInitiative('${safeTitle}')" class="w-full bg-green-700 hover:bg-green-600 text-white font-bold py-2 rounded text-xs transition flex items-center justify-center gap-2 shadow-lg">
                    ‚öîÔ∏è Add to Initiative
                </button>
            </div>
        `;
        container.appendChild(div);
    });
};

// Helper to toggle the visibility (Unique to the tracker side)
window.toggleTrackerNote = function(id) {
    const el = document.getElementById(`tracker-content-${id}`);
    const icon = document.getElementById(`icon-${id}`);
    
    if (el) {
        if (el.classList.contains('hidden')) {
            el.classList.remove('hidden');
            if(icon) icon.style.transform = 'rotate(180deg)'; // Flip arrow up
        } else {
            el.classList.add('hidden');
            if(icon) icon.style.transform = 'rotate(0deg)'; // Flip arrow down
        }
    }
};

// 3. Search Filter for Side Panel
window.filterTrackerNotes = function(query, viewId) {
    const containerId = viewId === 'view-enemies' ? 'enemies-list-container' : 'npcs-list-container';
    const container = document.getElementById(containerId);
    if(!container) return;

    const items = container.children;
    const lowerQuery = query.toLowerCase();

    Array.from(items).forEach(div => {
        const text = div.innerText.toLowerCase();
        if (text.includes(lowerQuery)) {
            div.classList.remove('hidden');
        } else {
            div.classList.add('hidden');
        }
    });
};

// 4. "Add" Button Logic - Moves Note Title to Inputs
window.addNoteToInitiative = function(name) {
    // Switch back to the main Tracker inputs
    window.switchTrackerTab('initiative');
    
    // Pre-fill the input
    const input = document.getElementById('combatant-name');
    if(input) {
        input.value = name;
        input.focus();
        
        // Flash the "Add" button green to guide the user
        const btn = document.getElementById('add-combatant-btn');
        if(btn) {
            btn.classList.add('ring-2', 'ring-green-400');
            setTimeout(() => btn.classList.remove('ring-2', 'ring-green-400'), 500);
        }
    }
};


// ==========================================
// üó∫Ô∏è ATLAS MAP GENERATOR (Stable Load Fix)
// ==========================================

window.mapState = {
    imageSrc: null, 
    pins: [],
    gridEnabled: true
};

// --- CONFIGURATION ---
const PALETTE = {
    ocean: "#d4e0ee", land: "#f3eedd", ink: "#2c241b",
    mountains: "#786d61", river: "#4a6fa5", grid: "rgba(44, 36, 27, 0.15)",
    tree_pine: "#2f4f4f", tree_oak: "#556b2f", tree_jungle: "#228b22" 
};

// 1. GENERATE WORLD
window.generateContinent = function() {
    const canvas = document.createElement('canvas');
    canvas.width = 1600; canvas.height = 900;
    const ctx = canvas.getContext('2d');
    const CX = canvas.width / 2; const CY = canvas.height / 2;

    const valForests = document.getElementById('param-forests') ? parseInt(document.getElementById('param-forests').value) : 12;
    const valMountains = document.getElementById('param-mountains') ? parseInt(document.getElementById('param-mountains').value) : 8;
    const valRivers = document.getElementById('param-rivers') ? parseInt(document.getElementById('param-rivers').value) : 80;
    const valCities = document.getElementById('param-cities') ? parseInt(document.getElementById('param-cities').value) : 6;
    const valSecrets = document.getElementById('param-secrets') ? parseInt(document.getElementById('param-secrets').value) : 4;

    ctx.fillStyle = PALETTE.ocean; ctx.fillRect(0, 0, canvas.width, canvas.height);
    const vig = ctx.createRadialGradient(CX, CY, 400, CX, CY, 900);
    vig.addColorStop(0, "rgba(0,0,0,0)"); vig.addColorStop(1, "rgba(20,15,10,0.2)");
    ctx.fillStyle = vig; ctx.fillRect(0, 0, canvas.width, canvas.height);
    addNoise(ctx, 0.03); 

    const landPath = new Path2D();
    const steps = 800; const baseR = 260; const seed = Math.random() * 1000;
    const mainPoints = [];
    for (let i = 0; i <= steps; i++) {
        const a = (i / steps) * Math.PI * 2;
        let r = baseR + Math.sin(a * 2 + seed) * 90 + Math.sin(a * 7 + seed*2) * 40 + Math.cos(a * 15 + seed) * 15 + Math.sin(a * 50 + seed) * 5; 
        mainPoints.push({x: CX + Math.cos(a)*r, y: CY + Math.sin(a)*(r*0.65)+40});
    }
    mainPoints.forEach((p, i) => { if(i===0) landPath.moveTo(p.x, p.y); else landPath.lineTo(p.x, p.y); });
    landPath.closePath();

    const numIslands = 8 + Math.floor(Math.random() * 8); 
    for(let k=0; k<numIslands; k++) {
        const islandAngle = Math.random() * Math.PI * 2;
        const dist = baseR + 60 + (Math.random() * 180); 
        const ix = CX + Math.cos(islandAngle) * dist; const iy = CY + Math.sin(islandAngle) * (dist * 0.7) + 40;
        const iSize = 20 + Math.random() * 30; const iPoints = [];
        for(let j=0; j<=20; j++) { const a = (j/20) * Math.PI * 2; const r = iSize + (Math.random()-0.5)*15; iPoints.push({x: ix + Math.cos(a)*r, y: iy + Math.sin(a)*(r*0.7)}); }
        iPoints.forEach((p, i) => { if(i===0) landPath.moveTo(p.x, p.y); else landPath.lineTo(p.x, p.y); });
        landPath.closePath();
    }

    ctx.lineJoin = 'round'; ctx.lineCap = 'round';
    for(let i=1; i<=4; i++) { ctx.strokeStyle = `rgba(60, 70, 80, ${0.12 - (i*0.025)})`; ctx.lineWidth = 8 + (i * 10); ctx.stroke(landPath); }
    ctx.fillStyle = PALETTE.land; ctx.fill(landPath);

    ctx.save(); ctx.clip(landPath); ctx.globalCompositeOperation = 'multiply';
    for (let i = 0; i < 300; i++) {
        const x = Math.random() * canvas.width; const y = Math.random() * canvas.height;
        if (ctx.isPointInPath(landPath, x, y)) {
            const temp = y + (Math.sin(x * 0.005 + seed)*100); const size = 80 + Math.random() * 150; let color = null;
            if (temp < 250) color = "rgba(220, 235, 240, 0.4)"; else if (temp > 680) color = "rgba(210, 180, 140, 0.3)"; else if (Math.random() > 0.6) color = "rgba(160, 180, 150, 0.25)"; 
            if (color) { const grd = ctx.createRadialGradient(x, y, 0, x, y, size); grd.addColorStop(0, color); grd.addColorStop(1, "rgba(0,0,0,0)"); ctx.fillStyle = grd; ctx.beginPath(); ctx.arc(x, y, size, 0, Math.PI*2); ctx.fill(); }
        }
    }
    ctx.restore();
    ctx.strokeStyle = PALETTE.ink; ctx.lineWidth = 1.5; ctx.stroke(landPath);

    drawHexGrid(ctx, canvas.width, canvas.height, 60);
    const valScale = document.getElementById('param-scale') ? document.getElementById('param-scale').value : "24 Miles";
    drawScaleLegend(ctx, valScale); 

    const riverSources = []; const mountainPixels = []; const mountainPathsToDraw = []; 
    let mountainsPlaced = 0; let attemptsM = 0;
    while(mountainsPlaced < valMountains && attemptsM < 1000) {
        attemptsM++; const mx = Math.random() * canvas.width; const my = Math.random() * canvas.height;
        if(ctx.isPointInPath(landPath, mx, my)) {
            const path = []; const len = 10 + Math.random() * 15; let validRange = true;
            for(let j=0; j<len; j++) { const px = mx + (j*12); const py = my + Math.sin(j + seed)*10; if (ctx.isPointInPath(landPath, px, py)) path.push({x: px, y: py}); else { validRange = false; break; } }
            if (validRange && path.length > 5) { path.forEach(p => mountainPixels.push({x: p.x, y: p.y, r: 15})); riverSources.push(path[Math.floor(path.length/2)]); mountainPathsToDraw.push(path); mountainsPlaced++; }
        }
    }

    ctx.strokeStyle = PALETTE.river; ctx.lineWidth = 2;
    riverSources.forEach(start => {
        if((Math.random() * 100) < valRivers) { 
            ctx.beginPath(); ctx.moveTo(start.x, start.y + 10);
            let dir = Math.atan2(start.y - CY, start.x - CX); let cx = start.x; let cy = start.y + 10; let onLand = true; let steps = 0;
            while(onLand && steps < 300) { dir += (Math.random() - 0.5) * 0.5; cx += Math.cos(dir) * 5; cy += Math.sin(dir) * 5; ctx.lineTo(cx, cy); if (!ctx.isPointInPath(landPath, cx, cy)) onLand = false; steps++; }
            ctx.stroke();
        }
    });

    let forestsPlaced = 0; let attemptsF = 0; const forestPixels = []; 
    while(forestsPlaced < valForests && attemptsF < 1000) {
        attemptsF++; const hx = Math.random() * canvas.width; const hy = Math.random() * canvas.height;
        if(ctx.isPointInPath(landPath, hx, hy)) {
            forestsPlaced++; const treeCount = 80 + Math.random() * 100; const forestRadius = 70 + Math.random() * 50;
            let type = 'oak'; if(hy < 300) type = 'pine'; else if (hy > 600) type = 'jungle'; 
            for(let k=0; k<treeCount; k++) {
                const angle = Math.random() * Math.PI * 2; const dist = (Math.random() * 0.3 + Math.random() * 0.7) * forestRadius; 
                const tx = hx + Math.cos(angle) * dist; const ty = hy + Math.sin(angle) * dist;
                if(!ctx.isPointInPath(landPath, tx, ty)) continue;
                let hitMountainBase = false; for(let m of mountainPixels) { if(Math.abs(tx - m.x) < m.r && Math.abs(ty - m.y) < m.r) { hitMountainBase = true; break; } } if(hitMountainBase) continue;
                drawTree(ctx, tx, ty, type); forestPixels.push({x: tx, y: ty}); 
            }
        }
    }

    mountainPathsToDraw.forEach(path => { drawInkMountains(ctx, path); });

    drawCompass(ctx, 1450, 750, 60);
    const nameInput = document.getElementById('map-title-input');
    let continentName = (nameInput && nameInput.value.trim() !== "") ? nameInput.value.trim() : generateFantasyName(true);
    drawMapLabel(ctx, continentName, CX, 90, 50, true); 

    const newPins = []; const placedPixels = []; const minDistance = 150;
    let citiesPlaced = 0; let attemptsC = 0;
    while(citiesPlaced < valCities && attemptsC < 1000) {
        attemptsC++; const cx = Math.random() * canvas.width; const cy = Math.random() * canvas.height;
        if (ctx.isPointInPath(landPath, cx, cy) && ctx.isPointInPath(landPath, cx+20, cy) && ctx.isPointInPath(landPath, cx-20, cy)) {
            let tooClose = false; for (let p of placedPixels) { if (Math.sqrt((p.x - cx)**2 + (p.y - cy)**2) < minDistance) { tooClose = true; break; } }
            if (!tooClose) { placedPixels.push({x: cx, y: cy}); newPins.push({id: crypto.randomUUID(), x: (cx / canvas.width) * 100, y: (cy / canvas.height) * 100, title: generateFantasyName(), desc: "Settlement", type: Math.random() > 0.6 ? 'city' : 'village'}); citiesPlaced++; }
        }
    }
    const secretCount = valSecrets;
    for(let i=0; i<secretCount; i++) {
        const roll = Math.random(); let type = 'landmark'; let sx, sy; let valid = false;
        if (roll < 0.4 && mountainPixels.length > 0) { type = 'dungeon'; const mp = mountainPixels[Math.floor(Math.random() * mountainPixels.length)]; sx = mp.x; sy = mp.y; valid = true; } 
        else if (roll < 0.7 && forestPixels.length > 0) { type = 'ruin'; const fp = forestPixels[Math.floor(Math.random() * forestPixels.length)]; sx = fp.x; sy = fp.y; valid = true; } 
        else { let attempts = 0; while(!valid && attempts < 50) { sx = Math.random() * canvas.width; sy = Math.random() * canvas.height; if(ctx.isPointInPath(landPath, sx, sy)) valid = true; attempts++; } }
        if(valid) { newPins.push({id: crypto.randomUUID(), x: (sx / canvas.width) * 100, y: (sy / canvas.height) * 100, title: "Unknown " + (type.charAt(0).toUpperCase() + type.slice(1)), desc: "Location", type: type}); }
    }

    const dataUrl = canvas.toDataURL('image/jpeg', 0.6);
    window.setMapImage(dataUrl);
    window.mapState.pins = newPins;
    window.renderPins();
};

// 2. FULL SCREEN LOGIC
window.toggleMapFullScreen = function() {
    const wrapper = document.getElementById('map-wrapper');
    if (!wrapper) return;
    const isFull = wrapper.classList.contains('fixed');
    
    if (!isFull) {
        wrapper.classList.add('fixed', 'top-0', 'left-0', 'z-[9999]', 'bg-gray-900', 'flex', 'items-center', 'justify-center');
        wrapper.classList.remove('relative', 'aspect-video', 'rounded-lg', 'shadow-2xl', 'border', 'border-gray-700');
        wrapper.style.width = '100vw'; wrapper.style.height = '100vh'; wrapper.style.margin = '0'; wrapper.style.borderRadius = '0';
        document.addEventListener('keydown', window.escToExitMap);
    } else {
        window.exitMapFullScreen();
    }
};
window.exitMapFullScreen = function() {
    const wrapper = document.getElementById('map-wrapper');
    if (!wrapper) return;
    wrapper.classList.remove('fixed', 'top-0', 'left-0', 'z-[9999]', 'bg-gray-900', 'flex', 'items-center', 'justify-center');
    wrapper.classList.add('relative', 'aspect-video', 'rounded-lg', 'shadow-2xl', 'border', 'border-gray-700');
    wrapper.style.width = ''; wrapper.style.height = ''; wrapper.style.margin = ''; wrapper.style.borderRadius = '';
    document.removeEventListener('keydown', window.escToExitMap);
};
window.escToExitMap = function(e) { if (e.key === 'Escape') window.exitMapFullScreen(); };

// 3. UPLOAD & DISPLAY
window.uploadMapImage = function(input) {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const img = new Image();
            img.onload = function() {
                const canvas = document.createElement('canvas');
                canvas.width = 1600; canvas.height = 900;
                const ctx = canvas.getContext('2d');
                ctx.fillStyle = "#d4e0ee"; ctx.fillRect(0, 0, canvas.width, canvas.height);
                const scale = Math.min(canvas.width / img.width, canvas.height / img.height);
                const x = (canvas.width / 2) - (img.width / 2) * scale;
                const y = (canvas.height / 2) - (img.height / 2) * scale;
                ctx.drawImage(img, x, y, img.width * scale, img.height * scale);
                window.setMapImage(canvas.toDataURL());
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(input.files[0]);
    }
};
window.setMapImage = function(src) {
    if (!src) return;
    window.mapState.imageSrc = src;
    const img = document.getElementById('active-map-image');
    if(img) {
        img.src = src; 
        img.style.display = 'block';
        document.getElementById('map-placeholder').style.display = 'none';
    }
};

// 4. PIN INTERACTION & RENDER
window.handleMapClick = function(e) {
    if (e.target.classList.contains('map-pin-icon')) return;
    const rect = e.currentTarget.getBoundingClientRect();
    const xPercent = ((e.clientX - rect.left) / rect.width) * 100;
    const yPercent = ((e.clientY - rect.top) / rect.height) * 100;
    window.openPinModal(null, xPercent, yPercent);
};
window.openPinModal = function(id, x, y) {
    const modal = document.getElementById('pin-modal');
    document.getElementById('pin-id').value = id || '';
    document.getElementById('pin-x').value = x || 0;
    document.getElementById('pin-y').value = y || 0;
    if (id) {
        const pin = window.mapState.pins.find(p => p.id === id);
        if(pin) {
            document.getElementById('pin-title').value = pin.title;
            document.getElementById('pin-desc').value = pin.desc;
            document.getElementById('pin-type').value = pin.type;
        }
    } else {
        document.getElementById('pin-title').value = '';
        document.getElementById('pin-desc').value = '';
        document.getElementById('pin-type').value = 'village';
    }
    modal.classList.remove('hidden');
};
window.savePin = function() {
    const id = document.getElementById('pin-id').value;
    const title = document.getElementById('pin-title').value || "Location";
    const desc = document.getElementById('pin-desc').value;
    const type = document.getElementById('pin-type').value;
    const x = parseFloat(document.getElementById('pin-x').value);
    const y = parseFloat(document.getElementById('pin-y').value);
    if (id) {
        const idx = window.mapState.pins.findIndex(p => p.id === id);
        if (idx !== -1) window.mapState.pins[idx] = { ...window.mapState.pins[idx], title, desc, type };
    } else {
        window.mapState.pins.push({ id: crypto.randomUUID(), x, y, title, desc, type });
    }
    document.getElementById('pin-modal').classList.add('hidden');
    window.renderPins();
};
window.deletePin = function() {
    const id = document.getElementById('pin-id').value;
    if (id) { window.mapState.pins = window.mapState.pins.filter(p => p.id !== id); window.renderPins(); }
    document.getElementById('pin-modal').classList.add('hidden');
};

window.renderPins = function() {
    const container = document.getElementById('map-pins-layer');
    if(!container) return;
    container.innerHTML = '';

    window.mapState.pins.forEach(pin => {
        const el = document.createElement('div');
        el.className = 'absolute transform -translate-x-1/2 -translate-y-full z-10 pointer-events-none';
        el.style.left = pin.x + '%'; el.style.top = pin.y + '%';

        const icons = { city: 'üè∞', village: 'üèòÔ∏è', dungeon: 'üíÄ', ruin: 'üèõÔ∏è', forest: 'üå≤', landmark: 'üìç', default: 'üìç' };
        const icon = icons[pin.type] || icons.default;

        el.innerHTML = `
            <div class="map-pin-icon text-2xl drop-shadow-md hover:scale-125 transition transform duration-200 pointer-events-auto cursor-pointer peer" 
                 onclick="window.openPinModal('${pin.id}')">
                 ${icon}
            </div>
            <div class="opacity-0 peer-hover:opacity-100 transition-opacity duration-200 absolute bottom-full mb-1 left-1/2 transform -translate-x-1/2 whitespace-nowrap z-20 pointer-events-none">
                <div class="bg-black/80 text-white text-[8px] font-bold px-1.5 py-0.5 rounded shadow-lg border border-emerald-500/50 backdrop-blur-sm tracking-wide uppercase">
                    ${pin.title}
                </div>
                <div class="w-0 h-0 border-l-[4px] border-l-transparent border-r-[4px] border-r-transparent border-t-[4px] border-t-emerald-500/50 mx-auto"></div>
            </div>
        `;
        container.appendChild(el);
    });
};

// 5. DATABASE SYNC (FIXED LOAD & DELETE)
window.activeMapListener = null;

// ID Generators
window.getGlobalIndexID = function() { return 'global_map_directory'; };
window.getCampaignIndexID = function() { const camp = window.currentCampaign ? window.currentCampaign : 'lobby'; return 'map_index_' + camp.replace(/\s+/g, '_').toLowerCase(); };
window.getActiveMapID = function() { const camp = window.currentCampaign ? window.currentCampaign : 'lobby'; return 'map_' + camp.replace(/\s+/g, '_').toLowerCase(); };

// A. SAVE LIVE STATE
window.saveMapState = async function() {
    if(!window.isAuthReady) { alert("Please log in."); return; }
    try {
        const docId = window.getActiveMapID();
        await setDoc(getSharedDoc(docId), {
            campaign: window.currentCampaign || 'Lobby',
            imageSrc: window.mapState.imageSrc,
            pins: window.mapState.pins
        }, { merge: true });
        if(window.showToast) window.showToast("‚úÖ Auto-Saved Map", "success");
    } catch(e) { console.error(e); }
};

// B. FOLDER SAVE (Global)
window.openSaveModal = function() { document.getElementById('save-map-modal').classList.remove('hidden'); };
window.confirmSaveMap = async function() {
    const name = document.getElementById('save-map-name').value || "Untitled Map";
    const uniqueID = Date.now().toString();
    const storageID = 'map_archive_' + uniqueID;
    
    await setDoc(getSharedDoc(storageID), {
        name: name,
        date: new Date().toISOString(),
        campaignTag: window.currentCampaign || "General",
        imageSrc: window.mapState.imageSrc,
        pins: window.mapState.pins
    });

    const indexID = window.getGlobalIndexID();
    const indexRef = getSharedDoc(indexID);
    const indexSnap = await getDoc(indexRef);
    let list = [];
    if(indexSnap.exists()) list = indexSnap.data().list || [];
    
    list.push({ id: uniqueID, name: name, date: new Date().toLocaleDateString(), campaign: window.currentCampaign || "General" });
    
    await setDoc(indexRef, { list: list }, { merge: true });
    
    document.getElementById('save-map-modal').classList.add('hidden');
    if(window.showToast) window.showToast("‚úÖ Saved to Global Folder", "success");
};

// C. SMART LOAD & MIGRATE
window.openLoadModal = async function() {
    const modal = document.getElementById('load-map-modal');
    const listContainer = document.getElementById('saved-maps-list');
    modal.classList.remove('hidden');
    listContainer.innerHTML = '<div class="text-gray-500 text-center italic">Scanning folders...</div>';

    const globalRef = getSharedDoc(window.getGlobalIndexID());
    const globalSnap = await getDoc(globalRef);
    let globalList = globalSnap.exists() ? (globalSnap.data().list || []) : [];

    // Check for Legacy Migration
    const legacyRef = getSharedDoc(window.getCampaignIndexID());
    const legacySnap = await getDoc(legacyRef);
    let needsUpdate = false;
    
    if(legacySnap.exists() && legacySnap.data().list && legacySnap.data().list.length > 0) {
        const legacyList = legacySnap.data().list;
        legacyList.forEach(legacyMap => {
            const exists = globalList.some(g => g.id === legacyMap.id);
            if (!exists) {
                const campTag = legacyMap.campaign || window.currentCampaign || "Archived";
                globalList.push({ id: legacyMap.id, name: legacyMap.name, date: legacyMap.date || new Date().toLocaleDateString(), campaign: campTag });
                needsUpdate = true;
            }
        });
    }

    if (needsUpdate) {
        await setDoc(globalRef, { list: globalList }, { merge: true });
    }

    // Render List
    listContainer.innerHTML = '';
    if(globalList.length === 0) {
        listContainer.innerHTML = '<div class="text-gray-500 text-center">No saved maps found.</div>';
        return;
    }

    globalList.sort((a, b) => (new Date(b.date) - new Date(a.date)));
    globalList.forEach(item => {
        const div = document.createElement('div');
        div.className = "flex justify-between items-center bg-gray-800 p-3 rounded hover:bg-gray-700 transition border border-gray-700";
        div.innerHTML = `
            <div>
                <div class="text-white font-bold text-sm">${item.name}</div>
                <div class="text-gray-500 text-[10px]">${item.campaign || 'General'} ‚Ä¢ ${item.date}</div>
            </div>
            <div class="flex gap-2">
                <button onclick="window.restoreMap('${item.id}')" class="bg-blue-600 hover:bg-blue-500 text-white text-xs px-3 py-1 rounded shadow">Load</button>
                <button onclick="window.deleteMap('${item.id}')" class="text-red-400 hover:text-red-300 text-sm px-2 py-1 transition" title="Delete Map">üóëÔ∏è</button>
            </div>
        `;
        listContainer.appendChild(div);
    });
};

// *** FIXED RESTORE FUNCTION (Pauses Listener to Prevent Conflict) ***
window.restoreMap = async function(id) {
    if(window.showToast) window.showToast("‚è≥ Loading Map...", "info");
    
    // 1. Pause active listener so it doesn't try to overwrite what we are loading
    if(window.activeMapListener) {
        window.activeMapListener();
        window.activeMapListener = null;
    }

    try {
        const storageID = 'map_archive_' + id;
        const snap = await getDoc(getSharedDoc(storageID));
        
        if(snap.exists()) {
            const d = snap.data();
            
            // 2. Update Local State immediately
            if(d.imageSrc) window.setMapImage(d.imageSrc);
            window.mapState.pins = d.pins || [];
            window.renderPins();
            
            // 3. Force Save to Active Doc (So it persists)
            const docId = window.getActiveMapID();
            await setDoc(getSharedDoc(docId), {
                campaign: window.currentCampaign || 'Lobby',
                imageSrc: window.mapState.imageSrc,
                pins: window.mapState.pins
            }, { merge: true });

            document.getElementById('load-map-modal').classList.add('hidden');
            if(window.showToast) window.showToast("‚úÖ Map Loaded: " + d.name, "success");
        } else {
            alert("Could not find map data.");
        }
    } catch(e) {
        console.error("Load failed:", e);
        alert("Load failed: " + e.message);
    }

    // 4. Restart Listener
    window.loadMapState();
};

window.deleteMap = async function(id) {
    if(!confirm("Are you sure? This deletes the map for ALL campaigns.")) return;

    if(window.showToast) window.showToast("‚è≥ Deleting...", "info");

    try { await deleteDoc(getSharedDoc('map_archive_' + id)); } catch(e) {}

    const globalRef = getSharedDoc(window.getGlobalIndexID());
    const globalSnap = await getDoc(globalRef);
    if(globalSnap.exists()) {
        const list = globalSnap.data().list || [];
        const newList = list.filter(m => m.id !== id);
        await setDoc(globalRef, { list: newList }, { merge: true });
    }

    const legacyRef = getSharedDoc(window.getCampaignIndexID());
    const legacySnap = await getDoc(legacyRef);
    if(legacySnap.exists()) {
        const list = legacySnap.data().list || [];
        const newList = list.filter(m => m.id !== id);
        await setDoc(legacyRef, { list: newList }, { merge: true });
    }

    window.openLoadModal(); 
    if(window.showToast) window.showToast("üóëÔ∏è Map Deleted", "success");
};

// D. INITIAL LOAD
window.loadMapState = function() {
    if(!window.isAuthReady) return;
    if(window.activeMapListener) { window.activeMapListener(); window.activeMapListener = null; }

    const docId = window.getActiveMapID();
    window.activeMapListener = onSnapshot(getSharedDoc(docId), (doc) => {
        if(doc.exists()) {
            const d = doc.data();
            if (d.imageSrc) window.setMapImage(d.imageSrc);
            window.mapState.pins = d.pins || [];
            window.renderPins();
        } else {
            getDoc(getSharedDoc('shared_map_data')).then((legacyDoc) => {
                if(legacyDoc.exists()) {
                    const ld = legacyDoc.data();
                    if (ld.imageSrc) window.setMapImage(ld.imageSrc);
                    window.mapState.pins = ld.pins || [];
                    window.renderPins();
                } else {
                    window.mapState.pins = [];
                    window.renderPins();
                }
            });
        }
    });
};

// --- HELPERS (Draw) ---
function drawHexGrid(ctx, w, h, size) {
    if(!window.mapState.gridEnabled) return;
    ctx.strokeStyle = PALETTE.grid; ctx.lineWidth = 1;
    const dx = size * 1.5; const dy = size * Math.sqrt(3);
    for(let y = -size; y < h + size; y += dy) { for(let x = -size; x < w + size; x += dx) { const offset = (Math.floor(x / dx) % 2) * (dy / 2); drawHex(ctx, x, y + offset, size); } }
}
function drawHex(ctx, x, y, r) {
    ctx.beginPath(); for (let i = 0; i < 6; i++) { const angle = (Math.PI / 3) * i; const px = x + r * Math.cos(angle); const py = y + r * Math.sin(angle); if (i === 0) ctx.moveTo(px, py); else ctx.lineTo(px, py); } ctx.closePath(); ctx.stroke();
}
function drawScaleLegend(ctx, text) {
    const x = 50; const y = 850; const r = 60; 
    ctx.strokeStyle = PALETTE.ink; ctx.lineWidth = 2; ctx.fillStyle = "rgba(243, 238, 221, 0.9)";
    ctx.beginPath(); for (let i = 0; i < 6; i++) { const angle = (Math.PI / 3) * i; const px = x + r * Math.cos(angle); const py = y + r * Math.sin(angle); if (i === 0) ctx.moveTo(px, py); else ctx.lineTo(px, py); } ctx.closePath(); ctx.fill(); ctx.stroke();
    ctx.fillStyle = PALETTE.ink; ctx.font = "bold 24px 'Cinzel Decorative', serif"; ctx.textAlign = "left"; ctx.fillText("= " + text, x + 70, y + 10);
}
function drawCompass(ctx, x, y, r) {
    ctx.save(); ctx.translate(x, y); ctx.strokeStyle = PALETTE.ink; ctx.fillStyle = PALETTE.land; ctx.lineWidth = 2;
    ctx.beginPath(); ctx.arc(0,0,r,0,Math.PI*2); ctx.stroke(); ctx.beginPath(); ctx.arc(0,0,r*0.8,0,Math.PI*2); ctx.stroke(); ctx.fillStyle = "#2c241b";
    ctx.beginPath(); ctx.moveTo(0, -r*1.4); ctx.lineTo(10, -20); ctx.lineTo(0,0); ctx.lineTo(-10, -20); ctx.fill();
    ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(r,0); ctx.stroke(); ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(-r,0); ctx.stroke(); ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(0,r); ctx.stroke();
    ctx.font = "bold 20px serif"; ctx.textAlign = "center"; ctx.fillText("N", 0, -r*1.5); ctx.restore();
}
function addNoise(ctx, amount) {
    const w = ctx.canvas.width, h = ctx.canvas.height; const idata = ctx.getImageData(0,0,w,h); const data = idata.data;
    for(let i=0; i<data.length; i+=4) { const grain = (Math.random() - 0.5) * (amount * 255); data[i] += grain; data[i+1] += grain; data[i+2] += grain; }
    ctx.putImageData(idata, 0, 0);
}
function drawInkMountains(ctx, points) {
    ctx.fillStyle = PALETTE.mountains; ctx.strokeStyle = PALETTE.ink; ctx.lineWidth = 1.5;
    points.forEach(p => {
        const w = 12 + Math.random() * 8; const h = 18 + Math.random() * 10;
        ctx.beginPath(); ctx.moveTo(p.x - w, p.y); ctx.lineTo(p.x, p.y - h - (Math.random()*5)); ctx.lineTo(p.x + w, p.y); ctx.fill(); ctx.stroke();
        ctx.beginPath(); ctx.moveTo(p.x, p.y - h); ctx.lineTo(p.x + w*0.6, p.y); ctx.lineWidth = 0.5; ctx.stroke(); ctx.lineWidth = 1.5;
    });
}
function drawTree(ctx, x, y, type) {
    ctx.beginPath();
    if(type === 'pine') { ctx.fillStyle = PALETTE.tree_pine; ctx.moveTo(x, y-12); ctx.lineTo(x+4, y); ctx.lineTo(x-4, y); } 
    else if (type === 'jungle') { ctx.fillStyle = PALETTE.tree_jungle; ctx.arc(x, y-5, 5, 0, Math.PI*2); ctx.rect(x-1, y-2, 2, 4); } 
    else { ctx.fillStyle = PALETTE.tree_oak; ctx.arc(x, y-6, 4, 0, Math.PI*2); ctx.arc(x-3, y-3, 3, 0, Math.PI*2); ctx.arc(x+3, y-3, 3, 0, Math.PI*2); }
    ctx.fill();
}
function drawMapLabel(ctx, text, x, y, size, isTitle = false) {
    ctx.font = `bold ${size}px 'Cinzel Decorative', serif`; ctx.fillStyle = "rgba(44, 36, 27, 0.9)"; ctx.textAlign = "center";
    ctx.save(); ctx.translate(x, y);
    if (isTitle) { ctx.shadowColor = "rgba(243, 238, 221, 1)"; ctx.shadowBlur = 10; ctx.strokeStyle = "rgba(44, 36, 27, 0.5)"; ctx.lineWidth=2; ctx.beginPath(); ctx.moveTo(-150, 10); ctx.lineTo(150, 10); ctx.stroke(); } else { ctx.rotate(-0.05); }
    ctx.fillText(text.toUpperCase(), 0, 0); ctx.restore();
}
function generateFantasyName(isMajor = false) {
    const sylA = ["Ael", "Cor", "Fael", "Gae", "Ith", "Oth", "Syl", "Tor", "Val", "Xar", "Zor", "Dun", "Kil", "Ros", "Bel"];
    const sylB = ["dor", "gard", "ia", "lund", "mar", "thos", "vorn", "wick", "grad", "helm", "keep", "mont", "more", "field"];
    return (isMajor ? "The Realm of " : "") + sylA[Math.floor(Math.random()*sylA.length)] + sylB[Math.floor(Math.random()*sylB.length)];
}

if(window.loadMapState && window.userId) window.loadMapState();
        
// ==========================================
// üëã WELCOME POP-UP LOGIC
// ==========================================

document.addEventListener('DOMContentLoaded', () => {
    // Check if user has seen the welcome message
    const hasSeenWelcome = localStorage.getItem('aegis_welcome_seen');
    
    if (!hasSeenWelcome) {
        // Show the modal
        document.getElementById('welcome-modal').classList.remove('hidden');
    }
});

window.closeWelcome = function() {
    // Hide the modal
    document.getElementById('welcome-modal').classList.add('hidden');
    
    // Play a sound effect (optional, feels magical)
    if(window.playTone) window.playTone('success');
    
    // Save to memory so it doesn't pop up again
    localStorage.setItem('aegis_welcome_seen', 'true');
};

// DEV TOOL: Run this in console to see the pop-up again:
// localStorage.removeItem('aegis_welcome_seen');




        window.toggleGearSidebar = () => {
    const sidebar = document.getElementById('gear-sidebar');
    const arrow = document.getElementById('gear-arrow');
    
    // Check if it's currently hidden (translated by 180px)
    if (sidebar.classList.contains('translate-x-[180px]')) {
        // OPEN
        sidebar.classList.remove('translate-x-[180px]');
        sidebar.classList.add('translate-x-0');
        arrow.style.transform = 'rotate(180deg)';
    } else {
        // CLOSE
        sidebar.classList.remove('translate-x-0');
        sidebar.classList.add('translate-x-[180px]');
        arrow.style.transform = 'rotate(0deg)';
    }
};

    const associateItems = [
    { 
        name: "Metal Cheese Dice Set", 
        link: "https://amzn.to/49s6Gkj", 
        img: "https://m.media-amazon.com/images/I/81HTlPcs28L._AC_SL1500_.jpg" 
    },
    { 
        name: "Dice Set", 
        link: "https://amzn.to/4q0cJCQ", 
        img: "https://m.media-amazon.com/images/I/71895dN-NxL._AC_SL1500_.jpg" 
    },
    { 
        name: "2024 Player's Handbook", 
        link: "https://amzn.to/4jfgKRh", 
        img: "https://m.media-amazon.com/images/I/71uMMLxNz2L._AC_SX679_.jpg" 
    },
    { 
        name: "150+ Dice Storage Bag", 
        link: "https://amzn.to/3Li2NFt", 
        img: "https://m.media-amazon.com/images/I/91sNE4RqA8L._AC_SX679_.jpg" 
    },
    { 
        name: "Player Character Sheets", 
        link: "https://amzn.to/48Vy0aI", 
        img: "https://m.media-amazon.com/images/I/81TXcxWeHgL._AC_SL1500_.jpg" 
    },
    { 
        name: "Dungeon Master's Guide", 
        link: "https://amzn.to/4qn2lVl", 
        img: "https://m.media-amazon.com/images/I/71e5LFV8g0L._AC_SY300_SX300_QL70_FMwebp_.jpg" 
    },
    { 
        name: "Monster Manual", 
        link: "https://amzn.to/4arU261", 
        img: "https://m.media-amazon.com/images/I/71dFrIDNTKL._AC_SL1500_.jpg" 
    },
    { 
        name: "Mimic Dice Storage Chest", 
        link: "https://amzn.to/497kbVn", 
        img: "https://m.media-amazon.com/images/I/81AZDwrSO3L._AC_SY300_SX300_QL70_FMwebp_.jpg" 
    },
    { 
        name: "Dice Tower", 
        link: "https://amzn.to/4asxrpS", 
        img: "https://m.media-amazon.com/images/I/71r11PeukLL._AC_SL1500_.jpg" 
    },
    { 
        name: "Ultimate Battle Map Set", 
        link: "https://amzn.to/49oqCoe", 
        img: "https://m.media-amazon.com/images/I/81952NAmaTL._AC_SL1500_.jpg" 
    },
    { 
        name: "Condition Rings", 
        link: "https://amzn.to/4bhvyg0", 
        img: "https://m.media-amazon.com/images/I/81U8Akhm16L._AC_SL1500_.jpg" 
    }
];

function cycleAds() {
    const el = document.getElementById('ad-spotlight');
    const nameEl = document.getElementById('ad-name');
    const imgEl = document.getElementById('ad-img');
    const linkEl = document.getElementById('ad-link');

    // Safety check: stop if elements are missing
    if (!el || !nameEl || !imgEl || !linkEl) return;

    // Pick a random item
    const item = associateItems[Math.floor(Math.random() * associateItems.length)];

    // 1. Update content
    nameEl.innerText = item.name;
    imgEl.src = item.img;
    linkEl.href = item.link;

    // 2. Reset position (Force it to hidden state)
    el.style.transition = 'none';
    el.style.opacity = '0';
    el.style.transform = 'translateY(150px) scale(0.9)';
    el.style.pointerEvents = 'none';

    // 3. Force Browser Reflow
    void el.offsetWidth; 

    // 4. Animate In
    el.style.transition = 'all 0.7s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
    el.style.opacity = '1';
    el.style.transform = 'translateY(0) scale(1)';
    el.style.pointerEvents = 'auto';

    // 5. Hide after 12 seconds
    setTimeout(() => {
        el.style.transition = 'all 0.7s ease-in';
        el.style.opacity = '0';
        el.style.transform = 'translateY(150px) scale(0.9)';
        el.style.pointerEvents = 'none';
    }, 12000);
}

// Ensure the cycle starts
setInterval(cycleAds, 45000); // Shows every 45 seconds
setTimeout(cycleAds, 3000);   // First show after 3 seconds

window.currentSystem = 'dnd5e';

// --- GLOBAL STATE ---
window.currentSystem = 'dnd5e';
window.mapState = { pins: [] };

// --- HELPERS ---
const updateLabelText = (id, text) => {
    const el = document.getElementById(id);
    if (el) el.innerText = text;
};

// --- 1. THE MASTER SYSTEM TOGGLE (FULL & UNCUT) ---
window.toggleSystem = () => {
    const body = document.body;
    const btn = document.getElementById('system-toggle');
    const siteTitle = document.getElementById('site-title'); // Targeted for Lightsaber effect
    const searchInput = document.getElementById('compendium-search');
    const settlementVibe = document.getElementById('settlement-vibe');
    const travelIcon = document.getElementById('travel-header-icon');
    const coinHeaders = document.getElementById('coin-headers');
    const coinInputs = document.getElementById('coin-inputs');
    const splitterCurrency = document.getElementById('splitter-currency');
    const mapWrapper = document.getElementById('map-wrapper');
    const npcType = document.getElementById('npc-type');
    const npcLevel = document.getElementById('npc-level');

    window.currentSystem = (window.currentSystem === 'dnd5e') ? 'sw5e' : 'dnd5e';

    if (window.currentSystem === 'sw5e') {
        // --- üöÄ START SW5E MODE ---
        body.classList.add('sw5e-mode');
        btn.innerHTML = "üöÄ Mode: SW5e";

        // ‚öîÔ∏è LIGHTSABER HEADER IGNITION
        if (siteTitle) {
            siteTitle.innerText = "AEGIS"; 
        }

        // TAB NAVIGATION SWAPS
        updateLabelText('tab-prep', 'üìÇ Mission Brief');
        updateLabelText('tab-maps', 'üåå Star Chart');
        updateLabelText('tab-loot', 'üì¶ Cargo Bay');
        updateLabelText('tab-travel', 'üöÄ Astrogation');
        updateLabelText('tab-sounds', 'üìü Comms Link');

        // PREP TAB SWAPS
        updateLabelText('prep-npc-title', 'üë§ Personnel Dossiers');
        updateLabelText('prep-lore-title', 'üíæ Datacron Archives');
        updateLabelText('prep-settlement-title', 'ü™ê Planetary Data');
        updateLabelText('name-gen-title', 'Xeno-Name Generator');
        if (npcType) npcType.value = "Trandoshan Bounty Hunter";
        if (npcLevel) npcLevel.value = "CR 5";

        // LOOT UI & CREDITS
        updateLabelText('loot-gen-title', '‚öôÔ∏è Equipment Fabricator');
        updateLabelText('splitter-title', 'üí≥ Credit Chip Splitter');
        updateLabelText('quick-split-label', 'Credit Distribution');
        if (splitterCurrency) {
            splitterCurrency.innerText = "CREDITS";
            splitterCurrency.style.color = "#60a5fa"; 
        }
        if (coinHeaders) {
            coinHeaders.innerHTML = '<div></div><div></div><div style="color:#60a5fa">CREDITS</div><div></div><div></div>';
        }
        if (coinInputs) {
            const inputs = coinInputs.querySelectorAll('input');
            if (inputs.length >= 5) {
                inputs[0].style.display = 'none'; inputs[2].style.display = 'none';
                inputs[3].style.display = 'none'; inputs[4].style.display = 'none';
                inputs[1].style.display = 'block'; inputs[1].placeholder = "CREDITS";
            }
        }

        // TRAVEL / ASTROGATION
        updateLabelText('travel-title', 'üåå Hyperspace Navigator');
        if (travelIcon) travelIcon.innerText = 'üåå';
        updateLabelText('dist-label', 'Distance (Parsecs)');
        updateLabelText('pace-label', 'Hyperdrive Class');
        updateLabelText('travel-calc-btn', 'Plot Course');

        // MAPS / STAR CHART
        updateLabelText('map-main-title', 'üåå Galactic Star Chart');
        updateLabelText('map-gen-btn', 'üé≤ Scan Sector');
        updateLabelText('label-forests', 'ü™ê Planets'); 
        updateLabelText('label-mountains', 'üõ∞Ô∏è Stations');
        updateLabelText('label-rivers', '‚òÑÔ∏è Asteroids');
        updateLabelText('label-cities', 'üé∑ Cantinas');
        updateLabelText('label-secrets', 'üëπ Sith Lore');
        if (mapWrapper) {
            mapWrapper.style.aspectRatio = "16 / 9";
            mapWrapper.style.boxShadow = "0 0 25px rgba(0, 255, 255, 0.2)";
        }
        if (searchInput) searchInput.placeholder = "Search the Holocron...";

    } else {
        // --- üêâ RESET TO D&D 5E ---
        body.classList.remove('sw5e-mode');
        btn.innerHTML = "üêâ Mode: D&D 5e";

        // ‚öîÔ∏è RESET HEADER TO FANTASY
        if (siteTitle) {
            siteTitle.innerText = "AEGIS"; 
        }

        // RESET TAB NAVIGATION
        updateLabelText('tab-prep', 'üìú Prep');
        updateLabelText('tab-maps', 'üó∫Ô∏è Maps');
        updateLabelText('tab-loot', 'üí∞ Loot');
        updateLabelText('tab-travel', '‚õ∫ Travel');
        updateLabelText('tab-sounds', 'üîä Sounds');

        // RESET PREP TAB
        updateLabelText('prep-npc-title', 'üë§ NPC Generator');
        updateLabelText('prep-lore-title', 'üìú Lore & History');
        updateLabelText('prep-settlement-title', 'üèòÔ∏è Settlements');
        updateLabelText('name-gen-title', 'Name Generator');
        if (npcType) npcType.value = "Shadow Rogue";
        if (npcLevel) npcLevel.value = "3";

        // RESET LOOT & CURRENCY
        updateLabelText('loot-gen-title', 'Loot Generator');
        updateLabelText('splitter-title', 'üí∞ Loot Splitter');
        updateLabelText('quick-split-label', 'Quick Total Splitter');
        if (splitterCurrency) {
            splitterCurrency.innerText = "GP";
            splitterCurrency.style.color = "#eab308"; 
        }
        if (coinHeaders) {
            coinHeaders.innerHTML = '<div>PP</div><div>GP</div><div>EP</div><div>SP</div><div>CP</div>';
        }
        if (coinInputs) {
            const inputs = coinInputs.querySelectorAll('input');
            inputs.forEach(input => { 
                input.style.display = 'block'; 
                input.placeholder = "0"; 
            });
        }

        // RESET TRAVEL
        updateLabelText('travel-title', 'Travel Calculator');
        if (travelIcon) travelIcon.innerText = '‚õ∫';
        updateLabelText('dist-label', 'Distance (Miles)');
        updateLabelText('pace-label', 'Travel Pace');
        updateLabelText('travel-calc-btn', 'Calculate Travel');

        // RESET MAPS
        updateLabelText('map-main-title', 'Realm Cartographer');
        updateLabelText('map-gen-btn', 'üé≤ Generate Land');
        updateLabelText('label-forests', 'üå≤ Forests'); 
        updateLabelText('label-mountains', '‚õ∞Ô∏è Mountains');
        updateLabelText('label-rivers', 'üíß Rivers');
        updateLabelText('label-cities', 'üè∞ Cities');
        updateLabelText('label-secrets', 'üíÄ Secrets');
        if (mapWrapper) {
            mapWrapper.style.boxShadow = "";
        }
        if (searchInput) searchInput.placeholder = "Search SRD Monsters...";
    }
};

window.renderStatblock = function(data) {
    const isSW5e = (window.currentSystem === 'sw5e');
    const container = document.getElementById('compendium-result');
    if (!data) return;

    // Encode data to safely pass through the button
    const encodedData = btoa(JSON.stringify(data));

    container.innerHTML = `
        <div class="stat-block relative mt-4 overflow-hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold ${isSW5e ? 'text-cyan-400' : 'text-red-900'}">${data.name}</h2>
                <button onclick="window.saveToEnemies('${encodedData}')" 
                        class="px-4 py-2 rounded font-bold text-xs border transition-all 
                        ${isSW5e ? 'border-cyan-500 text-cyan-400 hover:bg-cyan-900' : 'border-red-800 text-red-800 hover:bg-red-100'}">
                    ${isSW5e ? '‚ûï MARK AS HOSTILE' : '‚ûï ADD TO ENEMIES'}
                </button>
            </div>
            <div class="text-sm italic opacity-70">${data.size} ${data.type}</div>
        </div>
    `;
};

window.saveToEnemies = function(encodedData) {
    const monster = JSON.parse(atob(encodedData));
    let enemies = JSON.parse(localStorage.getItem('enemyNotes') || '[]');

    // Check if monster is already in the list
    if (!enemies.find(e => e.name === monster.name)) {
        enemies.push({
            name: monster.name,
            cr: monster.challenge_rating,
            hp: monster.hit_points,
            data: monster // Store full data to re-open it later
        });
        localStorage.setItem('enemyNotes', JSON.stringify(enemies));
        alert(window.currentSystem === 'sw5e' ? "Target locked in Personnel Dossier." : "Enemy added to notes.");
        window.renderEnemyNotes();
    } else {
        alert("Target is already being tracked.");
    }
};

window.renderEnemyNotes = function() {
    const container = document.getElementById('enemy-notes-list');
    if (!container) return;

    const enemies = JSON.parse(localStorage.getItem('enemyNotes') || '[]');
    const isSW5e = (window.currentSystem === 'sw5e');

    if (enemies.length === 0) {
        container.innerHTML = `<div class="p-4 text-center opacity-40 italic">No hostile targets acquired.</div>`;
        return;
    }

    container.innerHTML = enemies.map((enemy, index) => `
        <div class="flex justify-between items-center p-3 mb-2 bg-black/30 border-l-4 ${isSW5e ? 'border-cyan-500' : 'border-red-800'} rounded">
            <div class="cursor-pointer flex-1" onclick='window.renderStatblock(${JSON.stringify(enemy.data)})'>
                <div class="font-bold text-lg">${enemy.name}</div>
                <div class="text-xs opacity-60">HP: ${enemy.hp} | ${isSW5e ? 'Threat' : 'CR'}: ${enemy.cr}</div>
            </div>
            <button onclick="window.removeEnemy(${index})" class="text-red-500 font-bold hover:scale-110 px-2">‚úï</button>
        </div>
    `).join('');
};

window.removeEnemy = function(index) {
    let enemies = JSON.parse(localStorage.getItem('enemyNotes') || '[]');
    enemies.splice(index, 1);
    localStorage.setItem('enemyNotes', JSON.stringify(enemies));
    window.renderEnemyNotes();
};

// Initial load
document.addEventListener('DOMContentLoaded', window.renderEnemyNotes);

const sw5eLootTables = {
    standard: ["Medpac", "Stimpac", "Adrenal", "Repair Kit", "Power Cell (High Capacity)", "Thermal Detonator"],
    premium: ["Fine Vibroweapon (+1)", "Enhanced Blaster Scope", "Combat Suit (Reinforced)", "Kyber Crystal (Blue/Green)", "Targeting Computer Mk I"],
    prototype: ["Prototype Lightsaber", "Heavy Exoskeleton", "Shield Generator Mk II", "Advanced Medpac", "Wrist-Mounted Grappling Hook"],
    advanced: ["Vibro-Greatsword (Advanced)", "Personal Cloaking Device", "Armor Modification (Absorptive)", "Holocron (Minor)"],
    legendary: ["Legendary Kyber Crystal (Red/Purple)", "Sith/Jedi Robes of the Force", "Masterwork Starship Part", "Prototype Jetpack"]
};

window.generateSW5eLoot = function() {
    const level = parseInt(document.getElementById('npc-level')?.value.replace(/\D/g, '')) || 1;
    let rarity = "standard";

    // Determine Rarity based on Level
    if (level >= 17) rarity = "legendary";
    else if (level >= 13) rarity = "advanced";
    else if (level >= 9) rarity = "prototype";
    else if (level >= 5) rarity = "premium";

    const items = sw5eLootTables[rarity];
    const rolledItem = items[Math.floor(Math.random() * items.length)];
    const credits = Math.floor(Math.random() * (level * 200)) + 50;

    return { item: rolledItem, credits: credits, rarity: rarity.toUpperCase() };
};

window.saveCompendiumToNotes = async function(index) {
    // 1. Check if logged in
    if (!window.userId) { 
        alert("üîí Please log in to a Session to save data."); 
        window.openLoginModal(); 
        return; 
    }

    // 2. Locate the monster data from the current results
    // We assume your search results are stored in a variable or we grab the specific HTML element
    const uniqueId = `monster-${index}`;
    const cardElement = document.getElementById(uniqueId);
    
    if (!cardElement) {
        alert("Error: Could not find the statblock content.");
        return;
    }

    // 3. Ask for Campaign (Using your existing prompt system)
    const targetCampaign = await window.promptForCampaign();
    if (!targetCampaign) return;

    // 4. Extract Name (from the header inside the card)
    const nameEl = cardElement.querySelector('.dnd-header, .text-xl');
    const monsterName = nameEl ? nameEl.innerText.trim() : "Unknown Creature";

    // 5. Build Note Content
    // We clone the inner HTML so we get all the styling (Parchment or Neon)
    const content = cardElement.innerHTML;

    const newNote = {
        id: crypto.randomUUID(),
        title: `${monsterName} (Imported)`,
        content: content,
        campaign: targetCampaign,
        timestamp: new Date().toISOString()
    };

    // 6. Push to Notes
    if (!window.structuredNotes.enemyNotes) window.structuredNotes.enemyNotes = [];
    window.structuredNotes.enemyNotes.unshift(newNote);

    // 7. Sync to Firebase
    await window.saveStructuredNotes('enemyNotes', window.structuredNotes.enemyNotes);

    // 8. Feedback
    if(confirm(`‚úÖ ${monsterName} saved to Enemies in "${targetCampaign}".\n\nGo to Notes now?`)) {
        window.switchTab('notes');
        window.switchSubTab('enemyNotes');
    }
};

// ==========================================
// üé® KO-FI ARTIST SYSTEM (Updated)
// ==========================================

// ==========================================
// üìß EMAIL-ONLY SUBMISSION SYSTEM
// ==========================================

window.submitAd = () => {
    // 1. Get values
    const name = document.getElementById('sub-name').value.trim();
    const link = document.getElementById('sub-link').value.trim();
    const imgUrl = document.getElementById('sub-img').value.trim();
    const desc = document.getElementById('sub-desc').value.trim();
    const kofiName = document.getElementById('sub-kofi-name').value.trim();
    const btn = document.getElementById('submit-btn');
    const isSFW = document.getElementById('sfw-agree').checked;

    if (!isSFW) {
        alert("‚ö†Ô∏è You must confirm your art is SFW (Safe for Work) before submitting.");
        return; // Stop here
    }

    if (!name || !link || !imgUrl || !kofiName) {
        alert("Please fill out all fields.");
        return;
    }

    // 2. Validation
    if (!name || !link || !imgUrl || !kofiName) {
        alert("Please fill out all fields.");
        return;
    }

    // 3. UI Feedback
    const originalText = btn.innerText;
    btn.innerText = "üìß Sending to Admin...";
    btn.disabled = true;

    // 4. Send Email via EmailJS
    // REPLACE WITH YOUR IDs from Step 1
    const serviceID = "service_0rzs3sw"; 
    const templateID = "template_me66wos";

    const params = {
        from_name: name,
        kofi_name: kofiName,
        shop_link: link,
        image_url: imgUrl,
        message: desc
    };

    emailjs.send(serviceID, templateID, params)
        .then(() => {
            // Success
            alert("Submission Sent! The Admin will review your payment and post the ad shortly.");
            document.getElementById('artist-form').classList.add('hidden');
            
            // Clear inputs
            document.getElementById('sub-name').value = "";
            document.getElementById('sub-link').value = "";
            document.getElementById('sub-img').value = "";
            document.getElementById('sub-desc').value = "";
            document.getElementById('sub-kofi-name').value = "";
        })
        .catch((err) => {
            // Error
            console.error("Email Error:", err);
            alert("Failed to send email. Please try again later.");
        })
        .finally(() => {
            btn.innerText = originalText;
            btn.disabled = false;
        });
};

// 2. üñºÔ∏è LOAD THE GALLERY (With "No Stretch" Fix)
// 2. üñºÔ∏è LOAD THE GALLERY (With Admin Delete Button)
window.loadArtistGallery = () => {
    const list = document.getElementById('artist-gallery-list');
    if (!list) return;

    // üîí GET CURRENT USER ID
    const user = window.auth.currentUser;
    const adminID = "ZyZtBy2oNuYiQ4vw4mZNlHLGttG3"; // Your Admin ID
    const isAdmin = user && user.uid === adminID;

    const col = window.collection(window.db, 'community_art');
    
    // Sort by Newest
    let q;
    try {
        q = window.query(col, window.orderBy('timestamp', 'desc'), window.limit(50));
    } catch(e) {
        q = window.query(col, window.limit(50));
    }

    window.onSnapshot(q, (snap) => {
        if (snap.empty) {
            list.innerHTML = `<div class="text-center text-gray-500 w-full py-10 col-span-full">No artists have posted yet. Be the first!</div>`;
            return;
        }

        list.innerHTML = ''; 

        snap.forEach(doc => {
            const item = doc.data();
            const docId = doc.id; // We need this ID to delete it
            
            // Create the Card HTML
            const card = document.createElement('div');
            card.className = "break-inside-avoid mb-6 bg-gray-900 rounded-xl border border-gray-700 shadow-xl overflow-hidden group hover:border-pink-500 transition-all duration-300 flex flex-col relative";
            
            // üî¥ ADMIN BUTTON HTML (Only added if isAdmin is true)
            const deleteButton = isAdmin ? `
                <button onclick="window.deleteAd('${docId}')" 
                    class="absolute top-2 right-2 z-50 bg-red-600 hover:bg-red-700 text-white p-2 rounded-full shadow-lg border border-red-400" 
                    title="Admin Delete">
                    üóëÔ∏è
                </button>
            ` : '';

            card.innerHTML = `
                ${deleteButton} <div class="relative overflow-hidden cursor-pointer bg-gray-900 flex justify-center w-full" onclick="window.open('${item.socialLink}', '_blank')">
                    
                    <img src="${item.imageUrl}" alt="${item.title}" 
                         class="max-w-full w-auto mx-auto h-auto object-contain transition-transform duration-700 group-hover:scale-105"
                         onerror="this.parentElement.innerHTML='<div class=\'p-8 text-center text-gray-600 bg-gray-800 text-xs\'>Image Link Broken</div>'">
                    
                    <div class="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
                        <span class="bg-pink-600 text-white font-bold py-2 px-4 rounded-full shadow-lg transform scale-90 group-hover:scale-100 transition-transform">
                            Visit Shop ‚ûú
                        </span>
                    </div>
                </div>

                <div class="p-4 bg-gray-800 w-full">
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <h4 class="text-white font-bold text-sm hover:text-pink-400 cursor-pointer" onclick="window.open('${item.socialLink}', '_blank')">
                                ${item.artistName}
                            </h4>
                            <p class="text-[10px] text-gray-400 uppercase tracking-wider">Verified Artist</p>
                        </div>
                        <span class="text-[10px] bg-gray-700 text-gray-300 px-2 py-1 rounded">AD</span>
                    </div>
                    <p class="text-gray-300 text-xs mb-4 line-clamp-2">${item.title}</p>
                    <a href="${item.socialLink}" target="_blank" 
                       class="block w-full text-center bg-gray-700 hover:bg-gray-600 text-white text-xs font-bold py-2 rounded transition-colors border border-gray-600 hover:border-gray-500">
                        View Portfolio
                    </a>
                </div>
            `;
            list.appendChild(card);
        });
    });
};

// 3. üîÑ TAB SWITCHER HOOK (Ensures Gallery Loads)
const originalSwitch = window.switchTab;
window.switchTab = function(tabId) {
    if (originalSwitch) originalSwitch(tabId);
    
    // If the user clicks the "Gallery" or "Art" tab
    if (tabId === 'gallery' || tabId === 'gallery-tab' || tabId === 'art') {
        setTimeout(window.loadArtistGallery, 100);
    }
};

// üóëÔ∏è ADMIN DELETE FUNCTION
window.deleteAd = async (docId) => {
    // 1. Confirm before deleting
    if(!confirm("Are you sure you want to permanently DELETE this ad?")) return;

    try {
        // 2. Delete from Firebase
        await window.deleteDoc(window.doc(window.db, "community_art", docId));
        
        // 3. Refresh the Gallery
        alert("Ad deleted.");
        window.loadArtistGallery();
        
    } catch (e) {
        console.error("Delete Error:", e);
        alert("Error: You probably don't have permission (Are you logged in as Admin?)");
    }
};

// ==========================================
// üîµ HORIZONTAL TIMELINE (CAMPAIGN AWARE)
// ==========================================

// Global variable to track if we are editing
window.editingTimelineId = null; 

// 1. ADD OR UPDATE EVENT
window.addHorizontalEvent = async () => {
    const yearInput = document.getElementById('h-time-year');
    const descInput = document.getElementById('h-time-desc');
    const btn = document.getElementById('h-add-btn');
    
    const year = yearInput.value;
    const desc = descInput.value.trim();
    const user = window.auth.currentUser;

    // üü¢ Safety Checks
    if (!user) return alert("Please log in.");
    if (!window.currentCampaign) return alert("No Campaign Selected!");
    if (!year || !desc) return alert("Please enter a Year and Description");

    // üü¢ PATH: Use the standard artifacts folder
    const collectionPath = `artifacts/default/sessions/${user.uid}/timeline_events`;

    try {
        if (window.editingTimelineId) {
            // üîÑ MODE A: UPDATE EXISTING
            const docRef = window.doc(window.db, collectionPath, window.editingTimelineId);
            
            await window.updateDoc(docRef, {
                year: parseInt(year),
                desc: desc,
                campaignId: window.currentCampaign // Ensure it stays in this campaign
            });
            
            // Reset UI back to "Add" mode
            window.editingTimelineId = null;
            btn.innerText = "Add";
            btn.classList.remove('bg-green-600', 'hover:bg-green-500'); 
            btn.classList.add('bg-cyan-600', 'hover:bg-cyan-500');      

        } else {
            // ‚ûï MODE B: CREATE NEW
            await window.addDoc(window.collection(window.db, collectionPath), {
                year: parseInt(year),
                desc: desc,
                campaignId: window.currentCampaign, // üü¢ TAG IT
                timestamp: new Date()
            });
        }

        // Clear Inputs
        yearInput.value = "";
        descInput.value = "";

    } catch (e) {
        console.error("Error saving:", e);
        alert("Error saving: " + e.message);
    }
};

// 2. TRIGGER EDIT MODE
window.startEditTimeline = (id, currentYear, currentDesc) => {
    // Fill inputs
    document.getElementById('h-time-year').value = currentYear;
    document.getElementById('h-time-desc').value = currentDesc;
    
    // Set global ID
    window.editingTimelineId = id;

    // Change Button to Green "Update"
    const btn = document.getElementById('h-add-btn');
    btn.innerText = "Update";
    btn.classList.remove('bg-cyan-600', 'hover:bg-cyan-500');
    btn.classList.add('bg-green-600', 'hover:bg-green-500');
};

// 3. DELETE EVENT (Fixed Path)
window.deleteTimeline = async (docId) => {
    if(!confirm("Permanently delete this event?")) return;
    
    const user = window.auth.currentUser;
    if (!user) return alert("You are not logged in.");

    console.log(`üóëÔ∏è Attempting to delete doc: ${docId}`);

    try {
        // üü¢ CORRECT PATH: Must match the "Add" function exactly
        const docRef = window.doc(
            window.db, 
            `artifacts/default/sessions/${user.uid}/timeline_events`, 
            docId
        );

        await window.deleteDoc(docRef);
        console.log("‚úÖ Delete Successful");

    } catch (e) {
        console.error("Delete Error:", e);
        alert("Could not delete: " + e.message);
    }
};

// 4. LOAD & DISPLAY ITEMS
window.timelineUnsubscribe = null; 

window.loadHorizontalTimeline = () => {
    // 1. üßü KILL ZOMBIES: Stop old listener
    if (window.timelineUnsubscribe) {
        window.timelineUnsubscribe();
        window.timelineUnsubscribe = null;
    }

    const list = document.getElementById('horizontal-list');
    const user = window.auth.currentUser;
    
    // üü¢ Stop if no user OR no campaign
    if (!list || !user || !window.currentCampaign) {
        if(list) list.innerHTML = `<div class="text-gray-500 p-4">Select a campaign to view timeline.</div>`;
        return;
    }

    const collectionRef = window.collection(window.db, `artifacts/default/sessions/${user.uid}/timeline_events`);

    // üü¢ QUERY: Filter by Campaign + Sort by Year
    const q = window.query(
        collectionRef, 
        window.where("campaignId", "==", window.currentCampaign),
        window.orderBy('year', 'asc')
    );

    // 2. Start the NEW listener
    window.timelineUnsubscribe = window.onSnapshot(q, (snap) => {
        list.innerHTML = ""; 
        let index = 0;
        
        if (snap.empty) {
            list.innerHTML = `<div class="text-gray-500 italic p-10">No events yet for <b>${window.currentCampaign}</b></div>`;
            return;
        }

        snap.forEach(doc => {
    const item = doc.data();
    const id = doc.id;
    
    // üü¢ APPLY THE PARSER HERE
    // This turns "The [[Great War]] begins" into a clickable link
    const displayDescription = window.parseMarkdown(item.desc || "");
    
    const isTop = index % 2 === 0;
    const safeDesc = item.desc ? item.desc.replace(/'/g, "\\'") : ""; 

            const card = document.createElement('div');
            card.className = "relative w-64 mx-4 shrink-0 flex flex-col justify-center h-full group";

            card.innerHTML = `
                <div class="absolute top-1/2 left-0 -mt-2 w-4 h-4 rounded-full bg-cyan-400 border-2 border-white z-20 shadow-[0_0_10px_rgba(34,211,238,0.8)]"></div>

                <div class="absolute w-60 pl-4 border-l-2 border-cyan-500/30 ${isTop ? 'bottom-1/2 pb-8' : 'top-1/2 pt-8'}">
                    <div class="absolute left-[-2px] w-[2px] bg-cyan-400 ${isTop ? 'bottom-0 h-8' : 'top-0 h-8'}"></div>

                    <span class="text-[10px] uppercase tracking-widest text-cyan-600 font-bold block mb-0.5">Year</span>

                    <h3 class="text-2xl font-bold text-cyan-400 mb-1">${item.year}</h3>
                    <p class="text-gray-300 text-sm leading-relaxed border-l-2 border-gray-700 pl-3 hover:border-cyan-400 transition-colors">
    ${window.parseMarkdown(item.desc)}
</p>

                    <div class="absolute right-0 top-0 opacity-0 group-hover:opacity-100 transition-opacity flex gap-1 bg-gray-900/80 rounded">
                        <button onclick="window.startEditTimeline('${id}', '${item.year}', '${safeDesc}')" class="text-gray-400 hover:text-white p-1">‚úèÔ∏è</button>
                        <button onclick="window.deleteTimeline('${id}')" class="text-gray-400 hover:text-red-500 p-1">üóëÔ∏è</button>
                    </div>
                </div>
            `;
            list.appendChild(card);
            index++;
        });
    }, (error) => {
        if (error.message.includes("indexes")) {
            console.warn("‚ö†Ô∏è INDEX MISSING: Open the link in console to fix query.");
        }
        console.error("Timeline Load Error:", error);
    });
};

// 3. DELETE EVENT (Debug Version)
window.deleteTimeline = async (docId) => {
    console.log("‚ùå Delete Button Clicked!");
    console.log("üëâ ID Received:", docId);

    // 1. Safety Check: Did we actually get an ID?
    if (!docId || docId === "undefined" || docId === "null") {
        alert("Error: The Delete Button didn't send a valid ID. Refresh the page and try again.");
        return;
    }

    if (!confirm("Permanently delete this event?")) return;

    const user = window.auth.currentUser;
    if (!user) return alert("Error: Not logged in.");

    try {
        // 2. Construct the FULL path manually (Fail-safe method)
        // We type out the full string to avoid any folder confusion
        const fullPath = `artifacts/default/sessions/${user.uid}/timeline_events/${docId}`;
        
        console.log("üî• Attempting to delete at path:", fullPath);

        // 3. Delete it
        const docRef = window.doc(window.db, fullPath);
        await window.deleteDoc(docRef);

        console.log("‚úÖ Delete Successful!");
        // (Optional: You don't need an alert here if it works, the item will just vanish)
        
    } catch (e) {
        console.error("Delete Failed:", e);
        alert("üî• Delete Error: " + e.message);
    }
};

// ==========================================
// üìß ACCOUNT SECURITY (Link Real Email)
// ==========================================

// 1. Open the Modal & Show Current Fake Email
window.openEmailModal = () => {
    const user = window.auth.currentUser;
    if (!user) return alert("You must be logged in.");
    
    document.getElementById('current-user-email').innerText = user.email;
    document.getElementById('email-modal').classList.remove('hidden');
    document.getElementById('email-status').innerText = ""; // Clear errors
};

// 2. The Link Function
window.linkRealEmail = async () => {
    // üü¢ UPDATED: Points to the new ID in the Settings Modal
    const newEmail = document.getElementById('settings-email-input').value.trim();
    const status = document.getElementById('settings-email-status'); 
    const user = window.auth.currentUser;

    // 1. Validation
    if (!newEmail.includes('@') || !newEmail.includes('.')) {
        status.innerText = "‚ö†Ô∏è Please enter a valid email.";
        status.className = "text-xs mt-2 text-red-400";
        return;
    }

    try {
        status.innerText = "‚è≥ Saving contact info...";
        
        // 2. üü¢ CHANGE: Save to Database instead of Auth
        // We use 'setDoc' with { merge: true } so we don't erase other data
        const userRef = window.doc(window.db, "users", user.uid);
        
        await window.setDoc(userRef, {
            contactEmail: newEmail,
            lastUpdated: window.serverTimestamp()
        }, { merge: true });

        // 3. Success Message
        status.innerText = "‚úÖ Saved! (Your login Username remains unchanged)";
        status.className = "text-xs mt-2 text-green-400";
        
        // Optional: Update the input box to show it saved
        document.getElementById('settings-email-input').value = newEmail;

    } catch (error) {
        console.error("Link Error:", error);
        status.innerText = "Error: " + error.message;
        status.className = "text-xs mt-2 text-red-400";
    }
};


// ==========================================
// ‚öôÔ∏è SETTINGS & PROFILE (Final Verified Bundle)
// ==========================================

// 1. OPEN SETTINGS (Loads Data Correctly)
window.openSettings = async () => {
    const user = window.auth.currentUser;
    if (!user) return;

    document.getElementById('settings-modal').classList.remove('hidden');

    // A. Fill Display Name
    const nameInput = document.getElementById('settings-name-input');
    if(nameInput) nameInput.value = user.displayName || "";

    // B. Fill Login Username (Smart Display)
    const usernameInput = document.getElementById('settings-username-input');
    if (usernameInput && user.email) {
        // If "Steve@aegis.local", show "Steve". If "steve@gmail.com", show that.
        const shortName = user.email.includes("@aegis.local") 
            ? user.email.split('@')[0] 
            : user.email;
        
        usernameInput.placeholder = shortName; 
        usernameInput.value = ""; // Start empty
    }

    // C. Fill Contact Email (From Database)
    const emailInput = document.getElementById('settings-email-input');
    const status = document.getElementById('settings-email-status');

    if (emailInput) {
        emailInput.value = "Loading...";
        try {
            const docRef = window.doc(window.db, "users", user.uid);
            const docSnap = await window.getDoc(docRef);

            if (docSnap.exists() && docSnap.data().contactEmail) {
                emailInput.value = docSnap.data().contactEmail;
                if(status) {
                    status.innerText = "‚úÖ Contact email saved.";
                    status.className = "text-xs mt-2 text-green-500";
                }
            } else {
                emailInput.value = "";
                if(status) {
                    status.innerText = "Add an email for recovery/contact.";
                    status.className = "text-xs mt-2 text-gray-500";
                }
            }
        } catch (e) {
            console.error(e);
            emailInput.value = "";
        }
    }
};

// 2. CHANGE LOGIN ID (Handles Usernames AND Real Emails)
window.changeLoginUsername = async () => {
    const userInput = document.getElementById('settings-username-input');
    const status = document.getElementById('settings-username-status');
    const user = window.auth.currentUser;
    const INTERNAL_DOMAIN = "@aegis.local"; 

    if (!user || !userInput) return;
    const inputVal = userInput.value.trim();

    // Validation
    if (inputVal.length < 3) return alert("‚ö†Ô∏è Username must be at least 3 characters.");

    // LOGIC: Is it a Real Email or a Username?
    let finalEmail;
    let isUpgrade = false;

    if (inputVal.includes('@')) {
        // Real Email -> Upgrade Account
        if (!inputVal.includes('.')) return alert("‚ö†Ô∏è Invalid email format.");
        finalEmail = inputVal;
        isUpgrade = true;
    } else {
        // Username -> Add Fake Domain
        if (inputVal.includes(" ")) return alert("‚ö†Ô∏è Usernames cannot contain spaces.");
        finalEmail = inputVal + INTERNAL_DOMAIN;
    }

    if (!confirm(`Are you sure you want to change your login to: "${inputVal}"?`)) return;

    try {
        if(status) status.innerText = "‚è≥ Updating Login...";
        
        await window.updateEmail(user, finalEmail);

        // If Real Email: Verify & Save to DB
        if (isUpgrade) {
            await window.sendEmailVerification(user);
            const userRef = window.doc(window.db, "users", user.uid);
            await window.setDoc(userRef, { 
                contactEmail: finalEmail,
                lastUpdated: window.serverTimestamp()
            }, { merge: true });
        }

        alert(`‚úÖ SUCCESS!\n\nYour login is now: "${inputVal}"`);
        userInput.value = "";
        if(status) {
            status.innerText = "‚úÖ Login Updated.";
            status.className = "text-xs mt-2 text-green-500";
        }

    } catch (error) {
        console.error(error);
        if (error.code === 'auth/requires-recent-login') {
            alert("‚ö†Ô∏è SECURITY: You must Log Out and Log In again to change your username.");
        } else if (error.code === 'auth/email-already-in-use') {
            alert("‚ö†Ô∏è That username/email is already taken.");
        } else {
            alert("Error: " + error.message);
        }
    }
};

// 3. SAVE CONTACT EMAIL (Offers to Upgrade Login too)
window.linkRealEmail = async () => {
    const input = document.getElementById('settings-email-input');
    const status = document.getElementById('settings-email-status');
    const user = window.auth.currentUser;
    
    if (!input || !user) return;
    const newEmail = input.value.trim();

    if (!newEmail.includes('@') || !newEmail.includes('.')) {
        return alert("‚ö†Ô∏è Please enter a valid email.");
    }

    try {
        if(status) status.innerText = "‚è≥ Saving...";
        
        // Save to Database
        const userRef = window.doc(window.db, "users", user.uid);
        await window.setDoc(userRef, {
            contactEmail: newEmail,
            lastUpdated: window.serverTimestamp()
        }, { merge: true });

        if(status) {
            status.innerText = "‚úÖ Saved!";
            status.className = "text-xs mt-2 text-green-500";
        }
        
        // Smart Prompt: If still using fake login, offer upgrade
        if (user.email.includes("@aegis.local")) {
            if(confirm(`Saved! Do you want to use "${newEmail}" as your LOGIN username too?\n(This secures your account)`)) {
                // Auto-fill the other box and trigger the update
                document.getElementById('settings-username-input').value = newEmail;
                window.changeLoginUsername();
            }
        }

    } catch (e) {
        alert(e.message);
    }
};

// 4. RESET PASSWORD (Checks for Fake Email first)
window.triggerPasswordReset = async () => {
    const user = window.auth.currentUser;
    if (!user) return;

    // Block Fake Emails
    if (user.email.includes("@aegis.local")) {
        alert(
            "‚ö†Ô∏è PASSWORD RESET UNAVAILABLE\n\n" +
            "You are using a Guest/Username login.\n" +
            "Please use the 'Update ID' box above to switch to a Real Email first."
        );
        // Highlight the box they need to use
        document.getElementById('settings-username-input').focus();
        document.getElementById('settings-username-input').classList.add('border-red-500');
        return;
    }

    if(confirm(`Send password reset link to ${user.email}?`)) {
        try {
            await window.sendPasswordResetEmail(window.auth, user.email);
            alert("‚úÖ Reset link sent! Check your inbox.");
        } catch (e) {
            alert("Error: " + e.message);
        }
    }
};

// ==========================================
// üêï THE WATCHDOG (Checks Login on Load)
// ==========================================
window.onAuthStateChanged(window.auth, (user) => {
    const loginOverlay = document.getElementById('gatekeeper-overlay');
    const adminBtn = document.getElementById('admin-export-btn');

    if (user) {
        console.log("üë§ User detected:", user.email);
        window.userId = user.uid; // ‚úÖ Set global ID
        window.isAuthReady = true;

        window.checkProStatus(user);

        // =========================================================
        // 1. üü¢ NEW VTT LISTENERS (Map & Tokens)
        // =========================================================
        // We use brackets ['name'] to stop VS Code from complaining
        if (typeof window['setupDMMapListener'] === 'function') window['setupDMMapListener']();
        if (typeof window['setupTokenListener'] === 'function') window['setupTokenListener']();

        // =========================================================
        // 2. üü¢ CORE APP LISTENERS
        // =========================================================
        if (typeof window['setupNotesListener'] === 'function') window['setupNotesListener']();
        if (typeof window['setupCombatDataListeners'] === 'function') window['setupCombatDataListeners']();

        // =========================================================
        // 3. üü¢ UI LOADERS (Wrapped in Try/Catch for Safety)
        // =========================================================
        try {
            if (typeof window['loadHorizontalTimeline'] === 'function') window['loadHorizontalTimeline']();
            if (typeof window['renderStructuredNotes'] === 'function') window['renderStructuredNotes']();
        } catch (err) {
            console.warn("‚ö†Ô∏è Timeline/Notes loader skipped:", err);
        }

        // =========================================================
        // 4. üõ°Ô∏è ADMIN CHECK
        // =========================================================
        const adminUID = "ZyZtBy2oNuYiQ4vw4mZNlHLGttG3"; 
        if (user.uid === adminUID) {
            console.log("Welcome, Arch-Mage. Admin tools enabled.");
            if (adminBtn) adminBtn.classList.remove('hidden');
        } else {
            if (adminBtn) adminBtn.classList.add('hidden');
        }

        if (loginOverlay) loginOverlay.classList.add('hidden');

        // =========================================================
        // 5. üîÑ NEWSLETTER & SETTINGS
        // =========================================================
        const userDocRef = window.doc(window.db, "users", user.uid);
        window.getDoc(userDocRef).then((docSnap) => {
            const toggle = document.getElementById('settings-newsletter-toggle');
            const statusText = document.getElementById('newsletter-status-text');
            
            if (docSnap.exists()) {
                const data = docSnap.data();
                const isSubbed = data.settings?.newsletter || false;
                if (toggle) toggle.checked = isSubbed;
                if (statusText) statusText.innerText = isSubbed ? "Subscribed" : "Not Subscribed";
            } else {
                if (statusText) statusText.innerText = "Not Subscribed";
            }
        }).catch(err => console.error("Newsletter sync failed:", err));

        // =========================================================
        // 6. üü¢ PINS & UTILS
        // =========================================================
        if (typeof window['syncPinsFromCloud'] === 'function') window['syncPinsFromCloud'](user);

        // Newsletter Unsubscribe Logic
        const params = new URLSearchParams(window.location.search);
        if (params.get('action') === 'unsubscribe') {
            window.setDoc(userDocRef, { 
                settings: { newsletter: false } 
            }, { merge: true }).then(() => {
                if(window['showToast']) window['showToast']("üìú Raven scroll service cancelled.", "success");
                
                const toggle = document.getElementById('settings-newsletter-toggle');
                const statusText = document.getElementById('newsletter-status-text');
                if (toggle) toggle.checked = false;
                if (statusText) statusText.innerText = "Not Subscribed";

                window.history.replaceState({}, document.title, window.location.pathname);
            });
        }
        
    } else {
        // üí§ LOGGED OUT STATE
        if (loginOverlay) loginOverlay.classList.remove('hidden');
        if (adminBtn) adminBtn.classList.add('hidden');
        window.userId = null;
        
        // Guest Pins
        const localPins = localStorage.getItem('aegis_pins');
        window.pinnedTabs = localPins ? JSON.parse(localPins) : [];
        if (typeof window['renderPinnedTabs'] === 'function') window['renderPinnedTabs']();
    }
});

window.handleGatekeeperReset = async () => {
    // 1. Ask for the email address
    const email = prompt("Enter your email address to receive a reset link:");
    
    if (!email) return; // User cancelled

    // 2. Security Check: Block guest accounts
    if (!email.includes('@') || email.includes('@aegis.local')) {
        alert("‚ö†Ô∏è Password reset is only available for accounts linked to a real email address.");
        return;
    }

    try {
        // 3. Send the Firebase Reset Email
        await window.sendPasswordResetEmail(window.auth, email.trim());
        alert("‚úÖ Reset link sent! Please check your inbox (and spam folder).");
    } catch (error) {
        console.error("Reset Error:", error);
        if (error.code === 'auth/user-not-found') {
            alert("‚ùå No account found with that email address.");
        } else {
            alert("Error: " + error.message);
        }
    }
};

let isSignUpMode = false;

// 1. TOGGLE BETWEEN LOGIN & SIGNUP
window.toggleAuthMode = () => {
    isSignUpMode = !isSignUpMode;
    
    const btn = document.getElementById('auth-submit-btn');
    const toggle = document.getElementById('auth-toggle-btn');
    const subtitle = document.getElementById('gate-subtitle');
    const label = document.getElementById('gate-label');
    const instruction = document.getElementById('signup-instruction'); // üü¢ Grab the box
    const newsletter = document.getElementById('newsletter-container');
    
    if (isSignUpMode) {
        btn.innerText = "CREATE SECURE ACCOUNT";
        toggle.innerText = "Already have an account? Login";
        subtitle.innerText = "Register New Session";
        
        // üü¢ Show the instruction and change label
        label.innerText = "Email Address (Required)";
        if (instruction) instruction.classList.remove('hidden');
        if (newsletter) newsletter.classList.remove('hidden');
        
        subtitle.classList.replace('text-indigo-400', 'text-cyan-400');
    } else {
        btn.innerText = "ENTER SESSION";
        toggle.innerText = "Need an Account? Sign Up";
        subtitle.innerText = "Welcome Back";
        
        // üî¥ Hide the instruction and revert label
        label.innerText = "Email or Session Name";
        if (instruction) instruction.classList.add('hidden'); 
        if (newsletter) newsletter.classList.add('hidden');
        
        subtitle.classList.replace('text-cyan-400', 'text-indigo-400');
    }
};

// 2. THE MAIN AUTH ACTION
window.handleAuthAction = async () => {
    const emailEl = document.getElementById('gate-email');
    const passEl = document.getElementById('gate-pass');
    const status = document.getElementById('gate-status'); 
    
    const rawInput = emailEl.value.trim();
    const pass = passEl.value;

    if (!rawInput || !pass) {
        status.innerText = "‚ö†Ô∏è Enter both Email and Password.";
        return;
    }

    let finalEmail = rawInput;
    const isEmailFormat = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(rawInput);

    if (!rawInput.includes('@')) {
        finalEmail = `${rawInput.replace(/\s+/g, '_')}@aegis.local`;
        if (isSignUpMode) {
            status.innerText = "‚ö†Ô∏è Use a real email to sign up.";
            return;
        }
    } else if (isSignUpMode && !isEmailFormat) {
        status.innerText = "‚ö†Ô∏è Please enter a valid email address.";
        return;
    }

    try {
        status.innerText = isSignUpMode ? "Creating Account..." : "Verifying...";
        status.classList.replace('text-red-400', 'text-indigo-400');

        if (isSignUpMode) {
    const wantsNewsletter = document.getElementById('signup-newsletter')?.checked;

    // 1. Create the account
    await window.createUserWithEmailAndPassword(window.auth, finalEmail, pass);
    const user = window.auth.currentUser;

    if (user) {
                // üü¢ 2. Save using your existing Firestore 'setDoc' and 'doc' functions
                const userDocRef = window.doc(window.db, "users", user.uid);
                await window.setDoc(userDocRef, {
                    email: finalEmail, // ‚ú® ADD THIS LINE HERE ‚ú®
                    uid: user.uid,     // (Optional but helpful)
                    settings: {
                        newsletter: wantsNewsletter || false,
                        signupDate: new Date().toISOString()
                    }
                }, { merge: true });
            }

   


    // 4. Dispatch Email
    emailjs.send("service_0rzs3sw", "template_w6vsziy", {
        user_email: finalEmail,
        user_name: rawInput.split('@')[0], 
        message: "Welcome to the Aegis Archives!"
    }).then(() => {
        console.log("‚úÖ Email dispatched via EmailJS");
    }).catch((err) => {
        console.error("‚ùå EmailJS Failed:", err);
    });


            // üî¥ REMOVED: window.sendEmailVerification
            // This allows the user to start using the app immediately
            alert("Account created! Check your email for your welcome message.");
            
        } else {
            await window.signInWithEmailAndPassword(window.auth, finalEmail, pass);
        }

        document.getElementById('session-gatekeeper').classList.add('hidden');

    } catch (error) {
        console.error("Auth Error:", error.code);
        status.classList.replace('text-indigo-400', 'text-red-400');
        
        if (error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
            status.innerText = "‚ùå Incorrect password.";
        } else if (error.code === 'auth/user-not-found') {
            status.innerText = "‚ùå Account not found.";
        } else if (error.code === 'auth/email-already-in-use') {
            status.innerText = "‚ùå Email already registered.";
        } else {
            status.innerText = "Error: " + error.message;
        }
    }
};



window.updateTimelineBacklinks = async (noteTitle, noteId = null) => {
    // 1. Identify which container to fill (Card vs Modal)
    const listContainer = noteId 
        ? document.getElementById(`inline-backlinks-list-${noteId}`)
        : document.getElementById('timeline-backlinks-list');
    
    const wrapper = noteId ? document.getElementById(`inline-mentions-${noteId}`) : null;
    
    if (!listContainer) return;

    const user = window.auth.currentUser;
    if (!user || !window.currentCampaign) return;

    try {
        const collectionPath = `artifacts/default/sessions/${user.uid}/timeline_events`;
        const q = window.query(
            window.collection(window.db, collectionPath),
            window.where("campaignId", "==", window.currentCampaign),
            window.orderBy('year', 'asc')
        );

        const snap = await window.getDocs(q);
        const mentions = [];
        const bracketedTitle = `[[${noteTitle.toLowerCase()}]]`;
        
        snap.forEach(doc => {
            const event = doc.data();
            if (event.desc && event.desc.toLowerCase().includes(bracketedTitle)) {
                mentions.push({ id: doc.id, ...event });
            }
        });

        // 2. Display logic
        if (mentions.length === 0) {
            if (wrapper) wrapper.classList.add('hidden'); // Hide area if no matches
            listContainer.innerHTML = "No timeline events mention this note.";
            return;
        }

        if (wrapper) wrapper.classList.remove('hidden'); // Show area

        listContainer.innerHTML = mentions.map(m => `
            <div class="p-2 bg-black/40 rounded border border-gray-700 hover:border-cyan-500 cursor-pointer transition mb-1" 
                 onclick="event.stopPropagation(); window.jumpToTimelineEvent('${m.id}')">
                <span class="text-cyan-400 font-bold uppercase text-[9px]">Year ${m.year}:</span>
                <span class="text-gray-300 text-[10px] ml-1">${m.desc.replace(/\[\[.*?\]\]/g, '').substring(0, 50)}...</span>
            </div>
        `).join('');

    } catch (e) {
        console.error("Backlink Scan Error:", e);
    }
};

// üü¢ Drawer Open/Close Engine
window.toggleDrawer = () => {
    const drawer = document.getElementById('side-drawer');
    const overlay = document.getElementById('drawer-overlay');
    const isOpen = drawer.classList.contains('translate-x-0');

    if (isOpen) {
        drawer.classList.replace('translate-x-0', '-translate-x-full');
        overlay.classList.add('hidden');
        overlay.classList.remove('opacity-100');
    } else {
        drawer.classList.replace('-translate-x-full', 'translate-x-0');
        overlay.classList.remove('hidden');
        setTimeout(() => overlay.classList.add('opacity-100'), 10);
    }
};

// üü¢ NAVIGATION HELPER (Updated: Always closes sidebar)
    window.navTo = (tabId, displayName) => {
        // 1. Switch the view
        window.switchTab(tabId);
        
        // 2. Update the header text
        const indicator = document.getElementById('active-tab-indicator');
        if(indicator) indicator.innerText = displayName;

        // 3. ALWAYS close the drawer if it's open
        const drawer = document.getElementById('side-drawer');
        if (drawer && drawer.classList.contains('translate-x-0')) {
            window.toggleDrawer();
        }
    };

document.addEventListener('DOMContentLoaded', () => {
        // Check if they've already seen this specific update
        const hasSeenNavUpdate = localStorage.getItem('aegis_nav_moved_seen');
        
        if (!hasSeenNavUpdate) {
            // We wait 3 seconds so it doesn't clash with other loading alerts
            setTimeout(() => {
                if (window.showToast) {
                    window.showToast(
                        "üöÄ <strong>Navigation Update:</strong> Tabs have moved to the sidebar! Click the menu icon in the top-left.", 
                        "info"
                    );
                }
                // Save to local storage so it only shows once per device
                localStorage.setItem('aegis_nav_moved_seen', 'true');
            }, 1000); 
        }
    });

    // Inside window.handleAuthAction (approx. line 3410)
if (isSignUpMode) {
    // 1. Create the Firebase Account
    await window.createUserWithEmailAndPassword(window.auth, finalEmail, pass);
    
    // üü¢ 2. SEND WELCOME EMAIL VIA EMAILJS
    // This triggers right after signup succeeds
    emailjs.send("service_0rzs3sw", "template_w6vsziy", {
        user_email: finalEmail,
        user_name: rawInput.split('@')[0], // Uses the part before the @ as a temporary name
        message: "The gates to the Aegis Archives have opened for you."
    }).then(() => {
        console.log("Welcome email sent successfully!");
    }).catch((err) => {
        console.error("Failed to send welcome email:", err);
    });

    // 3. Send Verification & Notify User
    await window.sendEmailVerification(window.auth.currentUser);
    alert("Account created! Check your email to verify and for your welcome message.");
}

// üü¢ UPDATED: SESSION-SPECIFIC PINNED TABS ENGINE
window.pinnedTabs = [];

window.togglePin = async (tabId, displayName) => {
    const index = window.pinnedTabs.findIndex(p => p.id === tabId);
    
    if (index > -1) {
        window.pinnedTabs.splice(index, 1);
        if(window.showToast) window.showToast(`üìå Removed ${displayName}`, 'info');
    } else {
        if (window.pinnedTabs.length >= 6) return alert("Maximum 6 pins allowed!");
        window.pinnedTabs.push({ id: tabId, name: displayName });
        if(window.showToast) window.showToast(`üìå Pinned ${displayName}!`, 'success');
    }

    window.renderPinnedTabs();

    const user = window.auth.currentUser;
    if (user) {
        // üü¢ FIX: Save to the specific SESSION path, not the global USER path
        const pinRef = window.doc(window.db, 'artifacts', 'default', 'sessions', user.uid, 'singles', 'pinned_tabs');
        await window.setDoc(pinRef, { tabs: window.pinnedTabs }, { merge: true });
    } else {
        localStorage.setItem('aegis_pins', JSON.stringify(window.pinnedTabs));
    }
};

// üìå Save Pinned Tabs to the Database
window.savePinnedTabs = async () => {
    const user = window.auth.currentUser;
    if (!user) {
        // Fallback: If not logged in, save to the browser only
        localStorage.setItem('aegis_pins', JSON.stringify(window.pinnedTabs));
        return;
    }

    try {
        // üü¢ PATH: artifacts/default/sessions/USER_ID/singles/pinned_tabs
        const pinRef = window.doc(window.db, 'artifacts', 'default', 'sessions', user.uid, 'singles', 'pinned_tabs');
        
        await window.setDoc(pinRef, { 
            tabs: window.pinnedTabs || [],
            lastUpdated: new Date().toISOString()
        }, { merge: true });

        console.log("Pins synced to session.");
    } catch (e) {
        console.error("Error saving pinned tabs:", e);
    }
};

window.syncPinsFromCloud = async (user) => {
    if (!user) return;
    
    // üü¢ Use your existing 'doc' helper instead of 'ref'
    const userDocRef = window.doc(window.db, "users", user.uid);
    const docSnap = await window.getDoc(userDocRef);
    
    if (docSnap.exists()) {
        const data = docSnap.data();
        if (data.settings && data.settings.pins) {
            window.pinnedTabs = data.settings.pins;
        }
    } else {
        // Migration: Move local pins to cloud on first login
        const local = localStorage.getItem('aegis_pins');
        if (local) {
            window.pinnedTabs = JSON.parse(local);
            await window.setDoc(userDocRef, { 
                settings: { pins: window.pinnedTabs } 
            }, { merge: true });
        }
    }
    window.renderPinnedTabs();
};

window.renderPinnedTabs = () => {
    const bar = document.getElementById('pinned-tabs-bar');
    const container = document.getElementById('pinned-container');
    if (!container || !bar) return;

    if (window.pinnedTabs.length === 0) {
        bar.classList.add('hidden');
        container.innerHTML = '';
        return;
    }

    bar.classList.remove('hidden');
    container.innerHTML = window.pinnedTabs.map(pin => `
        <div class="relative group">
            <button onclick="window.switchTab('${pin.id}')" 
                    class="px-3 py-1 bg-gray-800/50 border border-gray-700 hover:border-cyan-500 rounded-md text-[10px] font-bold text-gray-300 hover:text-cyan-400 transition-all flex items-center gap-1 shadow-md">
                ${pin.name}
            </button>
            <button onclick="window.togglePin('${pin.id}', '${pin.name}')" 
                    class="absolute -top-1 -right-1 bg-red-600 text-white text-[8px] w-4 h-4 rounded-full opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center shadow-lg">
                √ó
            </button>
        </div>
    `).join('');
};

window.clearAllPins = async () => {
    if(!confirm("Clear all your favorite pins for this session?")) return;
    
    window.pinnedTabs = [];
    const user = window.auth.currentUser;

    if (user) {
        try {
            // üü¢ Target the session-specific document
            const pinRef = window.doc(window.db, 'artifacts', 'default', 'sessions', user.uid, 'singles', 'pinned_tabs');
            // Overwrite with an empty array to clear it
            await window.setDoc(pinRef, { tabs: [] }, { merge: true });
            
            if(window.showToast) window.showToast("Session pins cleared.", "info");
        } catch (e) {
            console.error("Error clearing pins:", e);
        }
    }
    
    localStorage.removeItem('aegis_pins');
    window.renderPinnedTabs();
};

// Start it up for guests
    document.addEventListener('DOMContentLoaded', () => {
        // üü¢ Force the Home Tab to open on startup
        if (typeof window.switchTab === 'function') {
            window.switchTab('home');
        }

        if (!window.auth.currentUser) {
            window.pinnedTabs = JSON.parse(localStorage.getItem('aegis_pins')) || [];
            window.renderPinnedTabs();
        }
    });

window.loadPinnedTabs = () => {
    const user = window.auth.currentUser;
    if (!user) {
        const local = localStorage.getItem('aegis_pins');
        window.pinnedTabs = local ? JSON.parse(local) : [];
        window.renderPinnedTabs();
        return;
    }

    // üü¢ Listen to the SESSION-SPECIFIC document
    const pinRef = window.doc(window.db, 'artifacts', 'default', 'sessions', user.uid, 'singles', 'pinned_tabs');
    
    window.onSnapshot(pinRef, (docSnapshot) => {
        if (docSnapshot.exists()) {
            window.pinnedTabs = docSnapshot.data().tabs || [];
        } else {
            // Start with a clean slate for brand new sessions
            window.pinnedTabs = [];
        }
        window.renderPinnedTabs();
    });
};

window.sendNewsletter = async (updateTitle, messageBody) => {
    // 1. Fetch all users from Firebase
    const usersRef = window.ref(window.db, 'users');
    const snapshot = await window.get(usersRef);
    
    if (!snapshot.exists()) return console.log("No users found.");

    const allUsers = snapshot.val();
    let sentCount = 0;

    // 2. Loop through users and check for 'newsletter: true'
    for (let uid in allUsers) {
        const user = allUsers[uid];
        const settings = user.settings || {};

        if (settings.newsletter === true && user.email) {
            // 3. Trigger EmailJS for each subscriber
            const templateParams = {
                update_title: updateTitle,
                message_content: messageBody,
                user_email: user.email,
                user_uid: uid // for the unsubscribe link
            };

            try {
                await emailjs.send('service_0rzs3sw', 'template_fnjonxr', templateParams);
                sentCount++;
                console.log(`‚úÖ Raven sent to: ${user.email}`);
            } catch (err) {
                console.error(`‚ùå Failed to send to ${user.email}:`, err);
            }
        }
    }

    alert(`Successfully dispatched ${sentCount} Raven Scrolls!`);
};

window.toggleNewsletter = async (status) => {
    const user = window.auth.currentUser;
    if (!user) return alert("Please log in to change settings.");
    
    // üü¢ FIRESTORE LOGIC (Correct for your app)
    const userDocRef = window.doc(window.db, "users", user.uid);
    
    try {
        await window.setDoc(userDocRef, {
            email: user.email, // üìß Saves the email so your CSV export works!
            settings: {
                newsletter: status
            }
        }, { merge: true });

        // Update the text next to the toggle if it exists
        const statusText = document.getElementById('newsletter-status-text');
        if (statusText) statusText.innerText = status ? "Subscribed" : "Not Subscribed";

        const msg = status ? "Subscribed to Raven Scrolls!" : "Unsubscribed from Raven Scrolls.";
        if(window.showToast) window.showToast(`üìú ${msg}`, "success");
    } catch (e) {
        console.error("Newsletter Update Error:", e);
        alert("Failed to update preferences. Check console.");
    }
};

window.exportNewsletterList = async () => {
    try {
        const usersRef = window.collection(window.db, "users");
        const snapshot = await window.getDocs(usersRef);
        
        let csvContent = "Email,SignupDate\n";
        let count = 0;

        snapshot.forEach(doc => {
            const data = doc.data();
            // Check if they opted in
            if (data.settings && data.settings.newsletter === true) {
                // Use data.email or the document ID if the ID is the email
                const email = data.email || doc.id; 
                const date = data.settings.signupDate || "Unknown";
                csvContent += `${email},${date}\n`;
                count++;
            }
        });

        if (count === 0) return alert("No subscribers found yet!");

        // Create the download link
        const blob = new Blob([csvContent], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.setAttribute('hidden', '');
        a.setAttribute('href', url);
        a.setAttribute('download', `raven_scrolls_${new Date().toISOString().split('T')[0]}.csv`);
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);

        if(window.showToast) window.showToast(`üìú Exported ${count} ravens!`, "success");
    } catch (e) {
        console.error(e);
        alert("Failed to export list. Check console.");
    }
};


// üü¢ UNIFIED MAP UPLOADER (Preview + Fog Resize + Sync)
window.handleMapUpload = async (input) => {
    if (input.files && input.files[0]) {
        const file = input.files[0];

        // 1. LOCAL PREVIEW (Instant Feedback & Fog Setup)
        const reader = new FileReader();
        reader.onload = function(e) {
            const img = document.getElementById('active-battlemap');
            const placeholder = document.getElementById('map-placeholder-text');
            
            // Set source immediately for preview
            img.src = e.target.result;
            img.style.display = 'block';
            
            // Wait for dimensions to load so we can resize Fog
            img.onload = function() {
                img.style.opacity = "1";
                if(placeholder) placeholder.style.display = 'none'; 
                
                // üü¢ RESIZE FOG ENGINE (FIXED)
                if(window.fog) {
                    window.fog.setupForImage(img);
                    
                    // üõë REMOVED: window.fog.fillFog(); 
                    // üü¢ ADDED: Start Transparent
                    if(window.fog.clearFog) window.fog.clearFog(); 
                    
                    window.fog.broadcast(); // Sync the clear view to players
                }
            };
        };
        reader.readAsDataURL(file);

        // 2. FIREBASE UPLOAD (Sync to Players)
        if (!window.auth.currentUser) return;
        
        try {
            const status = document.getElementById('uplink-status');
            if(status) status.innerText = "Syncing...";
            
            // A. Upload Image to Storage
            // Using a unique name prevents caching issues
            const storageRef = window.sRef(window.storage, `sessions/${window.auth.currentUser.uid}/vtt_map_${Date.now()}`);
            await window.uploadBytes(storageRef, file);
            const publicUrl = await window.getDownloadURL(storageRef);
            
            // B. Update Firestore (Players will see this link)
            const sessionRef = window.doc(window.db, 'artifacts', 'default', 'sessions', window.auth.currentUser.uid, 'singles', 'shared_uplink');
            
            // üü¢ CRITICAL: Send new Image AND Reset Fog Data
            // We set 'fogData' to null so the old map's fog doesn't ghost over the new one
            await window.setDoc(sessionRef, { 
                activeImage: publicUrl,
                fogData: null 
            }, { merge: true });
            
            if(status) status.innerText = "Synced ‚úÖ";
            
        } catch (e) {
            console.error("Map Upload Error:", e);
            if(window.showToast) window.showToast("Sync Failed: " + e.message, "error");
        }
    }
};

// üü¢ 2. VTT TOGGLE (Layout Logic)
// üü¢ 2. VTT TOGGLE (Fixed Animation)
    window.toggleVTTMode = () => {
        const vtt = document.getElementById('vtt-viewport');
        const panel = document.getElementById('tracker-panel');
        const btn = document.getElementById('vtt-toggle-btn');

        // Check if closed by looking for width-0 class
        const isClosed = vtt.classList.contains('w-0');

        if (isClosed) {
            // OPEN MAP (Slide Right)
            vtt.classList.remove('w-0', 'border-none'); // Remove 0 width constraint
            vtt.classList.add('flex-grow', 'border-r', 'border-gray-700'); // Allow growth
            
            panel.classList.remove('w-full');
            panel.classList.add('w-[360px]', 'shrink-0'); // Shrink tracker to side
            
            if(btn) {
                btn.innerText = "Hide Map";
                btn.classList.add('bg-gray-600');
                btn.classList.remove('bg-indigo-600');
            }
        } else {
            // CLOSE MAP (Slide Left)
            vtt.classList.remove('flex-grow', 'border-r', 'border-gray-700');
            vtt.classList.add('w-0', 'border-none'); // Force collapse
            
            panel.classList.remove('w-[360px]', 'shrink-0');
            panel.classList.add('w-full'); // Expand tracker
            
            if(btn) {
                btn.innerText = "Open Map";
                btn.classList.remove('bg-gray-600');
                btn.classList.add('bg-indigo-600');
            }
        }
        
        // Trigger resize event so the canvas/map knows the size changed
        setTimeout(() => window.dispatchEvent(new Event('resize')), 310);
    };

// ==========================================
// ‚ôüÔ∏è ADVANCED TOKEN SYSTEM (IMAGES + NAMES)
// ==========================================

// 1. OPEN/CLOSE MODAL
window.openTokenModal = () => {
    document.getElementById('token-modal').classList.remove('hidden');
    document.getElementById('new-token-name').focus();
};

window.closeTokenModal = () => {
    document.getElementById('token-modal').classList.add('hidden');
    document.getElementById('new-token-name').value = "";
    document.getElementById('new-token-file').value = "";
};

window.confirmCreateToken = async () => {
    const nameInput = document.getElementById('new-token-name');
    const fileInput = document.getElementById('new-token-file');
    const sizeInput = document.getElementById('new-token-size');
    const visionInput = document.getElementById('new-token-vision'); // üü¢ GET CHECKBOX
    
    const sizeMultiplier = parseFloat(sizeInput ? sizeInput.value : 1) || 1;
    const btn = document.getElementById('btn-create-token');
    const name = nameInput.value.trim() || "Unit";
    const file = fileInput.files[0];

    if (!window.auth.currentUser) return alert("You must be logged in.");

    const originalText = btn.innerText;
    btn.innerText = "Forging...";
    btn.disabled = true;

    try {
        let imageUrl = null;
        let color = 'blue';

        if (file) {
            const storageRef = window.sRef(window.storage, `sessions/${window.auth.currentUser.uid}/tokens/${Date.now()}_${file.name}`);
            await window.uploadBytes(storageRef, file);
            imageUrl = await window.getDownloadURL(storageRef);
        } else {
            const colors = ['red', 'blue', 'green', 'purple', 'orange'];
            color = colors[Math.floor(Math.random() * colors.length)];
        }

        const tokenId = crypto.randomUUID();
        await window.setDoc(window.doc(window.db, `artifacts/default/sessions/${window.userId}/vtt_tokens`, tokenId), {
            id: tokenId,
            label: name,
            shortLabel: name.substring(0, 2).toUpperCase(),
            image: imageUrl,
            color: color,
            x: 50,
            y: 50,
            size: sizeMultiplier,
            // üü¢ SAVE VISION STATUS (Defaults to false if unchecked)
            hasSight: visionInput ? visionInput.checked : false 
        });

        window.closeTokenModal();
    } catch (error) {
        console.error("Token creation failed:", error);
        alert("Error creating token: " + error.message);
    } finally {
        btn.innerText = originalText;
        btn.disabled = false;
    }
};


window.setupTokenListener = () => {
    if (!window.userId) return;
    const tokenLayer = document.getElementById('vtt-token-layer');
    
    window.onSnapshot(window.collection(window.db, `artifacts/default/sessions/${window.userId}/vtt_tokens`), (snapshot) => {
        tokenLayer.innerHTML = ''; 

        snapshot.forEach((docSnapshot) => {
            const t = docSnapshot.data();
            const el = document.createElement('div');
            
            // üü¢ 1. ATTACH SIGHT DATA (Critical for the fog check)
            el.dataset.hasSight = t.hasSight || false; 
            el.dataset.size = t.size || 1;
            
            // üü¢ 2. CLASSES: Added 'pointer-events-auto' so you can grab it
            el.className = `token absolute border-[3px] rounded-full shadow-md flex items-center justify-center cursor-move select-none transition-transform duration-100 hover:z-50 active:z-50 group pointer-events-auto`;
            el.id = `token-${docSnapshot.id}`;
            
            // Size & Position logic
            const fixedBaseSize = 50; 
            const finalSize = fixedBaseSize * (t.size || 1);
            el.style.width = `${finalSize}px`;
            el.style.height = `${finalSize}px`;
            el.style.left = `${t.x}%`;
            el.style.top = `${t.y}%`;
            el.style.transform = "translate(-50%, -50%)"; // Center anchor
            
            // Color / Image Logic
            const colorMap = { red: 'border-red-500 bg-red-900', blue: 'border-blue-500 bg-blue-900', green: 'border-green-500 bg-green-900', purple: 'border-purple-500 bg-purple-900', orange: 'border-orange-500 bg-orange-900' };
            const colorClass = colorMap[t.color] || colorMap['blue'];

            if (t.image) {
                el.classList.add(colorClass.split(' ')[0]); // Border only
                el.style.backgroundColor = '#000';
                el.style.backgroundImage = `url('${t.image}')`;
                el.style.backgroundSize = 'cover';
            } else {
                el.className += ` ${colorClass}`;
                el.innerText = t.shortLabel;
                el.style.color = "white";
                el.style.fontWeight = "bold";
                el.style.fontSize = `${10 * (t.size||1)}px`;
            }

            // üü¢ 3. ATTACH EVENTS (Fixes the "Can't Drag" issue)
            el.onmousedown = (e) => window.startTokenDrag(e, docSnapshot.id);
            el.ontouchstart = (e) => window.startTokenDrag(e, docSnapshot.id);
            el.oncontextmenu = (e) => window.handleTokenContextMenu(e, docSnapshot.id);

            tokenLayer.appendChild(el);
        });

        // Update Fog immediately
        setTimeout(window.revealTokenVision, 100);
    });
};

// ==========================================
// üü¢ TOKEN DRAG ENGINE (MISSING CODE)
// ==========================================
window.draggedTokenId = null;
window.dragOffsetX = 0;
window.dragOffsetY = 0;

window.startDragToken = (e, tokenId) => {
    if (window.vttSettings.isMeasuring) return; // Don't drag if measuring
    if (window.isDrawingWall) return; // Don't drag if drawing walls
    
    // Prevent default browser dragging of images
    e.preventDefault(); 
    e.stopPropagation();

    window.draggedTokenId = tokenId;
    const token = document.getElementById(`token-${tokenId}`);
    const rect = token.getBoundingClientRect();

    // Calculate offset so token doesn't "snap" to center of mouse
    // We handle both Mouse and Touch events
    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
    const clientY = e.touches ? e.touches[0].clientY : e.clientY;

    window.dragOffsetX = clientX - rect.left;
    window.dragOffsetY = clientY - rect.top;

    // Attach global listeners to document (so you can drag fast outside the token)
    document.addEventListener('mousemove', window.dragToken);
    document.addEventListener('mouseup', window.stopDragToken);
    document.addEventListener('touchmove', window.dragToken, { passive: false });
    document.addEventListener('touchend', window.stopDragToken);
};

window.dragToken = (e) => {
    if (!window.draggedTokenId) return;
    e.preventDefault(); // Stop scrolling on mobile

    const container = document.getElementById('dm-map-container');
    const containerRect = container.getBoundingClientRect();
    
    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
    const clientY = e.touches ? e.touches[0].clientY : e.clientY;

    // 1. Calculate raw position relative to map container
    let x = clientX - containerRect.left - window.dragOffsetX;
    let y = clientY - containerRect.top - window.dragOffsetY;

    // 2. Adjust for token center (since CSS uses center anchor)
    // We want the mouse to hold the part of the token we clicked, 
    // but the math below assumes we are setting the Top-Left.
    // However, your CSS uses `transform: translate(-50%, -50%)`, so left/top are the CENTER.
    
    // Let's reverse the offset logic slightly for centered tokens:
    // We want to calculate the new CENTER percentage.
    
    const tokenEl = document.getElementById(`token-${window.draggedTokenId}`);
    const width = tokenEl.offsetWidth;
    const height = tokenEl.offsetHeight;

    // Add half-width to get the center point from the top-left coordinate
    let centerX = x + (width / 2);
    let centerY = y + (height / 2);

    // 3. Snap to Grid (If Enabled)
    if (window.vttSettings && window.vttSettings.snapEnabled) {
        const snapped = window.snapToGrid(centerX, centerY);
        centerX = snapped.x;
        centerY = snapped.y;
    }

    // 4. Convert to Percentages (for responsive resizing)
    const xPercent = (centerX / containerRect.width) * 100;
    const yPercent = (centerY / containerRect.height) * 100;

    // 5. Update Visuals Instantly
    tokenEl.style.left = `${xPercent}%`;
    tokenEl.style.top = `${yPercent}%`;
};

window.stopDragToken = async () => {
    if (!window.draggedTokenId) return;

    const tokenId = window.draggedTokenId;
    const tokenEl = document.getElementById(`token-${tokenId}`);

    // Clean up listeners
    document.removeEventListener('mousemove', window.dragToken);
    document.removeEventListener('mouseup', window.stopDragToken);
    document.removeEventListener('touchmove', window.dragToken);
    document.removeEventListener('touchend', window.stopDragToken);

    window.draggedTokenId = null;

    // 6. SAVE TO DATABASE
    // Read the final style values we set during drag
    const finalX = parseFloat(tokenEl.style.left);
    const finalY = parseFloat(tokenEl.style.top);

    if (!window.userId) return;

    try {
        await window.updateDoc(window.doc(window.db, `artifacts/default/sessions/${window.userId}/vtt_tokens`, tokenId), {
            x: finalX,
            y: finalY
        });
        
        // Update Vision if needed
        if (tokenEl.dataset.hasSight === "true") {
            window.revealTokenVision();
        }
    } catch (err) {
        console.error("Token Save Error:", err);
    }
};

// Dragging Logic
// ==========================================
    // ‚ôüÔ∏è VTT LOGIC (Fixed for Sync)
    // ==========================================
    
    let draggedId = null;
    let mapScale = 1;

    // 1. ZOOM CONTROLS
    window.zoomMap = (factor) => {
        mapScale *= factor;
        mapScale = Math.max(0.2, Math.min(5, mapScale)); // Clamp zoom
        const el = document.getElementById('dm-map-container');
        if(el) el.style.transform = `scale(${mapScale})`;
    };

    window.resetMap = () => {
        mapScale = 1;
        const el = document.getElementById('dm-map-container');
        if(el) el.style.transform = `scale(1)`;
    };

    // ==========================================
// üü¢ UNIFIED DRAG & DROP SYSTEM
// ==========================================

window.draggedId = null; // Global variable to track active token

// 1. START DRAG
window.startTokenDrag = (e, dbId) => {
    e.preventDefault();
    e.stopPropagation();
    
    // Set the global ID
    window.draggedId = dbId;
    
    const token = document.getElementById(`token-${dbId}`);
    if (!token) return;

    // Disable transition for instant movement
    token.style.transition = 'none';
    token.style.zIndex = '100'; // Bring to front

    // Attach listeners
    document.addEventListener('mousemove', window.onTokenMove);
    document.addEventListener('mouseup', window.onTokenDrop);
};

// 2. MOVE TOKEN (Includes Grid Snapping)
window.onTokenMove = (e) => {
    // üü¢ CHECK: Ensure we are using the global variable
    if (!window.draggedId) return;

    const container = document.getElementById('dm-map-container');
    const token = document.getElementById(`token-${window.draggedId}`);
    if (!container || !token) return;

    const rect = container.getBoundingClientRect();

    // Calculate Mouse Position relative to Map
    let finalX = e.clientX - rect.left;
    let finalY = e.clientY - rect.top;

    // üü¢ SNAP LOGIC
    if (window.vttSettings && window.vttSettings.snapEnabled) {
        // If snap is ON, ignore mouse precision and find grid center
        const snapped = window.snapToGrid(finalX, finalY);
        finalX = snapped.x;
        finalY = snapped.y;
    }

    // Convert to Percentage for Responsiveness
    let xPercent = (finalX / rect.width) * 100;
    let yPercent = (finalY / rect.height) * 100;

    // Clamp to Map Edges (0% to 100%)
    xPercent = Math.max(0, Math.min(100, xPercent));
    yPercent = Math.max(0, Math.min(100, yPercent));

    // Apply Position
    token.style.left = `${xPercent}%`;
    token.style.top = `${yPercent}%`;
    
    // Keep Centered
    token.style.transform = "translate(-50%, -50%)";
};

// 3. DROP TOKEN (Saves to Database)
window.onTokenDrop = async (e) => {
    if (!window.draggedId) return;

    // Remove listeners immediately
    document.removeEventListener('mousemove', window.onTokenMove);
    document.removeEventListener('mouseup', window.onTokenDrop);

    const token = document.getElementById(`token-${window.draggedId}`);
    const currentId = window.draggedId; // Capture ID before clearing
    window.draggedId = null; // Clear global flag

    if (!token) return;

    // Restore smooth transitions
    token.style.transition = 'all 0.3s ease';
    token.style.zIndex = '40'; 

    // Get Final Coordinates
    const newX = parseFloat(token.style.left);
    const newY = parseFloat(token.style.top);

    // üü¢ SAVE TO FIREBASE
    if (window.auth.currentUser) {
        try {
            await window.updateDoc(window.doc(window.db, `artifacts/default/sessions/${window.auth.currentUser.uid}/vtt_tokens`, currentId), {
                x: newX,
                y: newY
            });
            // console.log("Saved position for", currentId);
        } catch (err) {
            console.error("Error saving token:", err);
            window.showToast("Failed to save position", "error");
        }
    }

    if (window.revealTokenVision) window.revealTokenVision();
};

// Map Zoom
let zoom = 1;
window.zoomMap = (f) => { zoom *= f; if(zoom<0.2) zoom=0.2; if(zoom>5) zoom=5; document.getElementById('vtt-map-container').style.transform = `scale(${zoom})`; };
window.resetMap = () => { zoom = 1; document.getElementById('vtt-map-container').style.transform = `scale(1)`; };

// Init
window.addEventListener('load', () => {
    // Wait for auth then setup listeners
    setTimeout(() => { if(window.setupTokenListener) window.setupTokenListener(); }, 2000);
});

// üëë PRO MODE SYSTEM
    window.isProUser = false; // Default state
    let proListener = null;   // To store the live connection

    // 1. HELPER: Updates the Button Text & Colors
    const updateProUI = (isPro) => {
        const planLabel = document.getElementById('plan-label');
        const freeBtn = document.getElementById('free-tier-btn');
        const proBtn = document.getElementById('pro-tier-btn'); 

        if (isPro) {
            // --- USER IS PRO ---
            if (planLabel) {
                planLabel.innerText = "Warlord (Pro)";
                planLabel.classList.add('text-yellow-400');
            }
            // Free Button -> "Included"
            if (freeBtn) {
                freeBtn.innerText = "Included";
                freeBtn.classList.remove('border-gray-700', 'text-gray-400');
                freeBtn.classList.add('border-gray-600', 'text-gray-500');
            }
            // Pro Button -> "‚úÖ Current Plan" (Disabled)
            if (proBtn) {
                proBtn.disabled = true;
                proBtn.innerHTML = "<span>‚úÖ</span> Current Plan";
                proBtn.classList.remove('bg-gradient-to-r', 'from-yellow-600', 'to-amber-500', 'text-black', 'shadow-lg');
                proBtn.classList.add('bg-gray-700', 'text-white', 'cursor-default');
            }

        } else {
            // --- USER IS FREE ---
            if (planLabel) {
                planLabel.innerText = "Free";
                planLabel.classList.remove('text-yellow-400');
            }
            // Free Button -> "Current Plan"
            if (freeBtn) {
                freeBtn.innerText = "Current Plan";
                freeBtn.classList.add('border-gray-700', 'text-gray-400');
            }
            // Pro Button -> "Upgrade" (Active)
            if (proBtn) {
                proBtn.disabled = false;
                proBtn.innerHTML = "<span>üí≥</span> Upgrade Instantly ($5)";
                proBtn.classList.add('bg-gradient-to-r', 'from-yellow-600', 'to-amber-500', 'text-black', 'shadow-lg');
                proBtn.classList.remove('bg-gray-700', 'text-white', 'cursor-default');
            }
        }
    };

    // 2. CHECK STATUS (Real-Time Listener)
    window.checkProStatus = (user) => {
        if (!user) return;
        
        // Stop listening to previous user if any
        if (proListener) proListener();

        // Start listening to CURRENT user
        const userRef = window.doc(window.db, 'users', user.uid);
        
        proListener = window.onSnapshot(userRef, (doc) => {
            const data = doc.data();
            const isNowPro = data?.isPro || false;
            
            // Check for NEW upgrade (Celebration)
            if (isNowPro && !window.isProUser) {
                console.log("üöÄ UPGRADE DETECTED!");
                const successModal = document.getElementById('pro-success-modal');
                if(successModal) successModal.classList.remove('hidden');
                new Audio('https://assets.mixkit.co/sfx/preview/mixkit-winning-chimes-2015.mp3').play().catch(()=>{});
            }

            // Update Global State
            window.isProUser = isNowPro;
            if (isNowPro) {
                console.log("üëë User is PRO");
                document.body.classList.add('pro-active'); 
            } else {
                window.isProUser = false;
                document.body.classList.remove('pro-active');
            }

            // üü¢ UPDATE THE UI BUTTONS
            updateProUI(isNowPro);
        });
    };

    // 3. THE GATE (Protects Premium Features)
    window.requirePro = () => {
        if (window.isProUser) return true;
        
        // If not pro, show the modal
        const modal = document.getElementById('pro-modal');
        if (modal) modal.classList.remove('hidden');
        new Audio('https://assets.mixkit.co/sfx/preview/mixkit-wrong-answer-fail-notification-940.mp3').play().catch(()=>{});
        return false;
    };

    // 4. STRIPE REDIRECT (Opens in New Tab)
    window.redirectToStripe = () => {
        if (!window.auth.currentUser) return alert("Please sign in first!");
        
        const userId = window.auth.currentUser.uid;
        
        // üü¢ YOUR SAVED LINK
        const stripeUrl = "https://buy.stripe.com/fZu9AVepQ5B48MQg3pcs800"; 

        const finalUrl = stripeUrl + "?client_reference_id=" + userId;
        window.open(finalUrl, '_blank');
    };

    // ==========================================
    // üîÆ SPELL GENERATOR ENGINE (Paste this at the bottom of your script)
    // ==========================================
    const SPELL_DB = {
        wizard: {
            CANT: ["Fire Bolt", "Mage Hand", "Prestidigitation", "Ray of Frost", "Shocking Grasp", "Light", "Minor Illusion"],
            L1: ["Magic Missile", "Shield", "Mage Armor", "Burning Hands", "Sleep", "Thunderwave", "Detect Magic"],
            L2: ["Misty Step", "Scorching Ray", "Invisibility", "Web", "Mirror Image", "Hold Person"],
            L3: ["Fireball", "Counterspell", "Fly", "Lightning Bolt", "Haste", "Dispel Magic"],
            L4: ["Polymorph", "Greater Invisibility", "Dimension Door", "Wall of Fire", "Banishment"],
            L5: ["Cone of Cold", "Wall of Force", "Hold Monster", "Cloudkill", "Telekinesis"]
        },
        sorcerer: {
            CANT: ["Fire Bolt", "Ray of Frost", "Shocking Grasp", "Light", "Minor Illusion", "Acid Splash"],
            L1: ["Shield", "Magic Missile", "Burning Hands", "Chaos Bolt", "Sleep", "Thunderwave"],
            L2: ["Scorching Ray", "Misty Step", "Invisibility", "Hold Person", "Mirror Image"],
            L3: ["Fireball", "Counterspell", "Fly", "Lightning Bolt", "Haste"],
            L4: ["Greater Invisibility", "Dimension Door", "Polymorph", "Banishment"],
            L5: ["Cone of Cold", "Cloudkill", "Hold Monster"]
        },
        warlock: {
            CANT: ["Eldritch Blast", "Mage Hand", "Minor Illusion", "Prestidigitation", "Chill Touch"],
            L1: ["Hex", "Hellish Rebuke", "Armor of Agathys", "Charm Person", "Protection from Evil"],
            L2: ["Misty Step", "Invisibility", "Hold Person", "Darkness", "Shatter"],
            L3: ["Counterspell", "Fly", "Dispel Magic", "Fear", "Hunger of Hadar"],
            L4: ["Banishment", "Dimension Door", "Blight"],
            L5: ["Hold Monster", "Synaptic Static", "Dream"]
        },
        druid: {
            CANT: ["Druidcraft", "Shillelagh", "Thorn Whip", "Produce Flame", "Guidance"],
            L1: ["Entangle", "Cure Wounds", "Faerie Fire", "Thunderwave", "Goodberry", "Healing Word"],
            L2: ["Barkskin", "Moonbeam", "Spike Growth", "Pass Without Trace", "Heat Metal"],
            L3: ["Call Lightning", "Dispel Magic", "Sleet Storm", "Conjure Animals"],
            L4: ["Polymorph", "Ice Storm", "Wall of Fire", "Stoneskin"],
            L5: ["Conjure Elemental", "Mass Cure Wounds", "Wall of Stone"]
        },
        cleric: {
            CANT: ["Sacred Flame", "Guidance", "Thaumaturgy", "Toll the Dead", "Light"],
            L1: ["Bless", "Cure Wounds", "Healing Word", "Guiding Bolt", "Shield of Faith", "Inflict Wounds"],
            L2: ["Spiritual Weapon", "Hold Person", "Lesser Restoration", "Silence", "Aid"],
            L3: ["Spirit Guardians", "Revivify", "Dispel Magic", "Mass Healing Word"],
            L4: ["Banishment", "Death Ward", "Guardian of Faith"],
            L5: ["Mass Cure Wounds", "Flame Strike", "Greater Restoration"]
        },
        bard: {
            CANT: ["Vicious Mockery", "Minor Illusion", "Mage Hand", "Message"],
            L1: ["Healing Word", "Thunderwave", "Sleep", "Charm Person", "Faerie Fire", "Dissonant Whispers"],
            L2: ["Invisibility", "Shatter", "Hold Person", "Suggestion", "Heat Metal"],
            L3: ["Hypnotic Pattern", "Dispel Magic", "Leomund's Tiny Hut", "Fear"],
            L4: ["Polymorph", "Greater Invisibility", "Dimension Door"],
            L5: ["Hold Monster", "Mass Cure Wounds", "Synaptic Static"]
        },
        paladin: { 
            CANT: [],
            L1: ["Divine Favor", "Shield of Faith", "Cure Wounds", "Bless", "Command"],
            L2: ["Aid", "Branding Smite", "Find Steed", "Lesser Restoration"],
            L3: ["Revivify", "Blinding Smite", "Aura of Vitality"],
            L4: ["Banishment", "Death Ward", "Staggering Smite"],
            L5: ["Destructive Wave", "Circle of Power"]
        },
        ranger: {
            CANT: [],
            L1: ["Hunter's Mark", "Cure Wounds", "Ensnaring Strike", "Fog Cloud"],
            L2: ["Pass Without Trace", "Spike Growth", "Silence"],
            L3: ["Conjure Animals", "Lightning Arrow"],
            L4: ["Freedom of Movement", "Stoneskin"],
            L5: ["Swift Quiver", "Steel Wind Strike"]
        }
    };

    // Helper: Determine Slot Count
    window.getSpellSlots = (cls, lvl) => {
        cls = cls.toLowerCase();
        lvl = parseInt(lvl);
        if (isNaN(lvl)) return null;

        const isFull = ["wizard", "sorcerer", "druid", "cleric", "bard"].includes(cls);
        const isHalf = ["paladin", "ranger"].includes(cls);
        const isWarlock = cls === "warlock";

        if (isWarlock) {
            let slotLevel = Math.min(5, Math.ceil(lvl / 2));
            let slotCount = lvl >= 17 ? 4 : (lvl >= 11 ? 3 : (lvl >= 2 ? 2 : 1));
            return { type: "warlock", count: slotCount, level: slotLevel, arcanum: lvl >= 11 };
        }

        let effectiveLvl = isFull ? lvl : (isHalf ? Math.ceil(lvl / 2) : 0);
        if (effectiveLvl === 0) return null;

        return {
            type: "standard",
            L1: effectiveLvl >= 1 ? 4 : 0,
            L2: effectiveLvl >= 3 ? 3 : (effectiveLvl == 2 ? 2 : 0),
            L3: effectiveLvl >= 5 ? 3 : (effectiveLvl == 4 ? 2 : 0),
            L4: effectiveLvl >= 7 ? 3 : (effectiveLvl == 6 ? 2 : 0),
            L5: effectiveLvl >= 9 ? 3 : (effectiveLvl == 8 ? 2 : 0)
        };
    };

    // Helper: Generate the formatted HTML string
    window.generateSpellList = (cls, lvl) => {
        if(!cls) return "";
        cls = cls.toLowerCase();
        const slots = window.getSpellSlots(cls, lvl);
        const spells = SPELL_DB[cls];

        if (!slots || !spells) return ""; 

        let html = `<div class='mt-3 text-xs border-t border-gray-600 pt-2'>`;
        html += `<div class='font-bold text-indigo-300 mb-1'>‚ú® Prepared Spells (${cls.charAt(0).toUpperCase() + cls.slice(1)} Lv${lvl})</div>`;

        if (spells.CANT && spells.CANT.length > 0) {
            html += `<div class='mb-1'><span class='text-gray-400'>Cantrips:</span> <span class='text-gray-200'>${spells.CANT.slice(0, 3 + Math.floor(lvl/4)).join(", ")}</span></div>`;
        }

        if (slots.type === "warlock") {
            let known = spells[`L${slots.level}`] || [];
            if (slots.level > 1) known = known.concat(spells[`L${slots.level-1}`] || []);
            
            html += `<div class='mb-1'><span class='text-purple-400'>Pact Slots (${slots.count} x Lv${slots.level}):</span> <span class='text-gray-200'>${known.slice(0, lvl + 1).join(", ")}</span></div>`;
        } else {
            for (let i = 1; i <= 5; i++) {
                let count = slots[`L${i}`];
                let list = spells[`L${i}`];
                if (count > 0 && list) {
                    let picks = list.sort(() => 0.5 - Math.random()).slice(0, Math.max(2, count + 1));
                    html += `<div class='mb-0.5'><span class='text-blue-400'>Lv${i} (${count}):</span> <span class='text-gray-300'>${picks.join(", ")}</span></div>`;
                }
            }
        }
        html += `</div>`;
        return html;
    };

 // 1. Unified Theme Engine
// üü¢ MASTER THEME ENGINE (Anti-White Screen Fix)
window.applyTheme = (bg, card, accent) => {
    // Use provided values OR original dark defaults if arguments are missing
    const finalBg = bg || '#030712';
    const finalCard = card || '#111827';
    const finalAccent = accent || '#4f46e5';

    // 1. Set CSS Variables
    document.documentElement.style.setProperty('--pro-bg', finalBg);
    document.documentElement.style.setProperty('--pro-card', finalCard);
    document.documentElement.style.setProperty('--pro-accent', finalAccent);
    
    // 2. FORCE FIX: Directly paint the root and body
    document.documentElement.style.backgroundColor = finalBg;
    document.body.style.backgroundColor = finalBg;

    // 3. Save Preference
    localStorage.setItem('pro-ui-settings', JSON.stringify({bg: finalBg, card: finalCard, accent: finalAccent}));
};

// üü¢ UNIFIED INITIALIZATION
document.addEventListener('DOMContentLoaded', () => {
    const saved = JSON.parse(localStorage.getItem('pro-ui-settings'));
    if (saved) {
        window.applyTheme(saved.bg, saved.card, saved.accent);
    } else {
        // DEFAULT TO ORIGINAL DARK ON FIRST LOAD
        window.applyTheme('#030712', '#111827', '#4f46e5'); 
    }
});

// üü¢ 3. Modern Notes Design Toggle (Corrected)
window.toggleNoteDesign = function() {
    // 1. Pro Guard
    if (!window.isProUser) {
        window.showToast("üîí Grid View is a Pro Feature", "error");
        return;
    }

    // 2. Toggle the State (Grid vs List)
    const currentMode = localStorage.getItem('aegis_note_layout');
    const newMode = currentMode === 'grid' ? 'list' : 'grid';
    localStorage.setItem('aegis_note_layout', newMode);

    // 3. Redraw the CURRENT tab immediately
    // This calls the master renderer to swap the HTML structure
    if (window.renderStructuredNotes && window.currentSubTab) {
        window.renderStructuredNotes(window.currentSubTab);
    }

    // 4. User Feedback
    window.showToast(newMode === 'grid' ? "Switched to Grid View" : "Switched to List View", "success");
};

// üíæ SAVE SCENE (Includes Walls)
window.saveCurrentScene = async (sceneName) => {
    if (!window.isProUser) {
        if (window.event && window.event.type === 'click') window.openProMenu();
        return; 
    }
    
    if (!window.userId) return window.showToast("Log in to save.", "error");
    if (!sceneName) sceneName = prompt("Name this tactical scene:");
    if (!sceneName) return;

    const mapEl = document.getElementById('active-battlemap');
    const fogState = window.fog ? window.fog.getFogData() : null; // Compressed Fog

    const tokenElements = document.querySelectorAll('[id^="token-"]');
    const tokens = [];

    tokenElements.forEach(t => {
        const styleBg = t.style.backgroundImage;
        let finalImage = null;
        if (styleBg && styleBg !== 'none') {
            finalImage = styleBg.replace(/^url\(["']?/, '').replace(/["']?\)$/, '');
        }
        const tooltip = t.querySelector('.group-hover\\:opacity-100');
        const fullLabel = tooltip ? tooltip.innerText : "Unit";
        const shortLabel = t.innerText.replace(fullLabel, '').trim().substring(0, 2);
        
        let color = 'blue';
        if (t.style.backgroundColor) {
            if (t.style.backgroundColor.includes('239')) color = 'red';
            else if (t.style.backgroundColor.includes('34')) color = 'green';
            else if (t.style.backgroundColor.includes('168')) color = 'purple';
            else if (t.style.backgroundColor.includes('249')) color = 'orange';
        }
        
        tokens.push({ 
            image: finalImage, label: fullLabel, shortLabel: shortLabel, 
            color: color, 
            x: parseFloat(t.style.left)||50, 
            y: parseFloat(t.style.top)||50,
            size: parseFloat(t.dataset.size)||1 
        });
    });

    try {
        await window.setDoc(window.doc(window.db, `users/${window.userId}/vtt_scenes`, sceneName), { 
            mapUrl: mapEl?.src || '', 
            tokens: tokens, 
            fogData: fogState,
            walls: window.walls || [], // üü¢ SAVE WALLS HERE
            timestamp: new Date().toISOString() 
        });
        window.showToast(`Saved scene "${sceneName}"`, "success");
    } catch (e) { 
        console.error(e); 
        window.showToast("Save failed", "error"); 
    }
};

// üü¢ PRO SCENE SELECTOR
window.openSceneSelector = async () => {

    if (!window.isProUser) {
        window.showToast("üîí This feature is for Pro users only.", "error");
        return;
    }

    if (!window.userId) return window.showToast("Login required", "error");

    const modal = document.getElementById('scene-modal');
    const grid = document.getElementById('scene-gallery-grid');
    
    modal.classList.remove('hidden');
    grid.innerHTML = `<div class="col-span-full text-center py-20 text-gray-500">Accessing secure archive...</div>`;

    try {
        const colRef = window.collection(window.db, "users", window.userId, "vtt_scenes");
        const querySnapshot = await window.getDocs(colRef);

        if (querySnapshot.empty) {
            grid.innerHTML = `<div class="col-span-full text-center py-20 text-gray-500">No saved scenes found.</div>`;
            return;
        }

        grid.innerHTML = ''; 

        querySnapshot.forEach((doc) => {
            const data = doc.data();
            const sceneName = doc.id;
            
            const card = document.createElement('div');
            // Added 'group' class to handle hover effects
            card.className = "group relative bg-gray-800 rounded-xl overflow-hidden border border-white/5 hover:border-indigo-500 cursor-pointer transition-all h-40 shadow-lg";
            
            // Clicking the main card loads the scene
            card.onclick = () => {
                window.loadScene(sceneName);
                modal.classList.add('hidden');
            };

            const previewImg = data.mapUrl || 'https://placehold.co/400x225/111/444?text=No+Map+Data';

            card.innerHTML = `
                <button onclick="event.stopPropagation(); window.deleteScene('${sceneName}')" 
                        title="Delete Scene"
                        class="absolute top-2 right-2 z-20 w-6 h-6 bg-red-600 hover:bg-red-500 text-white rounded-full flex items-center justify-center font-bold shadow-md opacity-0 group-hover:opacity-100 transition-all transform hover:scale-110">
                    &times;
                </button>

                <div class="h-28 bg-black relative">
                    <img src="${previewImg}" class="w-full h-full object-cover opacity-50 group-hover:opacity-100 transition duration-500">
                    <div class="absolute inset-0 bg-gradient-to-t from-gray-900 via-transparent to-transparent"></div>
                    
                    <div class="absolute bottom-2 left-2">
                        <div class="text-[9px] text-indigo-400 font-bold uppercase tracking-widest mb-0.5">Tactical Scene</div>
                        <div class="text-sm font-bold text-white truncate w-32 shadow-black drop-shadow-md">${sceneName}</div>
                    </div>
                </div>

                <div class="p-2 flex justify-between items-center bg-gray-900 border-t border-white/5">
                    <span class="text-[9px] text-gray-400 uppercase tracking-wider flex items-center gap-1">
                        <span class="w-1.5 h-1.5 rounded-full bg-green-500"></span>
                        ${data.tokens?.length || 0} Entities
                    </span>
                    <span class="text-indigo-400 text-[9px] font-bold group-hover:translate-x-1 transition-transform">LOAD &rarr;</span>
                </div>
            `;
            grid.appendChild(card);
        });

    } catch (e) {
        console.error(e);
        grid.innerHTML = `<div class="col-span-full text-center py-20 text-red-500 text-xs">Error: ${e.message}</div>`;
    }
};


// üìÇ LOAD SCENE (Handles Expired/Broken Maps)
window.loadScene = async (sceneName) => {
    // üîí Silent Lock
    if (!window.isProUser && window.userId !== "aegisdmtoolkit@gmail.com") {
        if (window.event && window.event.type === 'click') window.openProMenu();
        return; 
    }
    
    if (!window.userId) return;
    if (!sceneName) sceneName = prompt("Load which scene?");
    if (!sceneName) return;

    window.showToast("‚è≥ Loading Scene...", "info");

    try {
        const sceneRef = window.doc(window.db, `users/${window.userId}/vtt_scenes`, sceneName);
        const snap = await window.getDoc(sceneRef);
        if (!snap.exists()) return window.showToast("Scene not found", "error");

        const data = snap.data();

        // üü¢ STEP 0: WIPE PLAYER VIEW
        const uplinkRef = window.doc(window.db, `artifacts/default/sessions/${window.userId}/singles/shared_uplink`);
        window.setDoc(uplinkRef, { activeImage: '', fogData: null }, { merge: true });

        // üõë STEP 1: CLEAN LOCAL SLATE
        window.walls = [];
        if(window.renderWalls) window.renderWalls(); 
        if(window.fog) window.fog.clearFog();
        
        const mapImg = document.getElementById('active-battlemap');
        if(mapImg) {
            mapImg.style.opacity = '0'; 
            mapImg.src = ''; 
        }

        // üü¢ STEP 2: PARALLEL LOADING
        
        // TASK A: Load Map Image (With Dead Link Detection)
        const loadMapPromise = new Promise((resolve) => {
            if (data.mapUrl && data.mapUrl.length > 5) {
                
                // ‚ö†Ô∏è CHECK FOR EXPIRED BLOB
                if (data.mapUrl.startsWith('blob:')) {
                    console.warn("‚ö†Ô∏è Scene uses an expired Blob URL.");
                    alert(`‚ö†Ô∏è Map Missing for "${sceneName}"\n\nThis scene was saved with a temporary image file that has expired.\n\nPlease drag the map image onto the screen again to restore it.`);
                    resolve(); // Stop trying to load the broken link
                    return;
                }

                if (mapImg) {
                    mapImg.onload = () => {
                        mapImg.style.display = "block";
                        mapImg.style.opacity = "1"; 
                        if(window.fog) {
                            window.fog.setupForImage(mapImg);
                            if (data.fogData) window.fog.loadFogData(data.fogData);
                        }
                        resolve(); 
                    };
                    mapImg.onerror = () => {
                        console.error("‚ùå Map image failed to load (URL broken).");
                        resolve(); // Resolve anyway so the rest of the scene loads
                    };
                    
                    mapImg.src = data.mapUrl;
                    
                    // Sync to Players
                    window.setDoc(uplinkRef, { activeImage: data.mapUrl, fogData: data.fogData || null }, { merge: true });
                } else { resolve(); }
            } else { 
                resolve(); // No URL, just finish
            }
        });

        // TASK B: Restore Data (Tokens & Walls)
        const loadDataPromise = (async () => {
            if (data.walls) window.walls = data.walls;

            // üü¢ 1. Reference the Token Collection
            const tokenCol = window.collection(window.db, `artifacts/default/sessions/${window.userId}/vtt_tokens`);

            // üü¢ 2. FETCH EXISTING TOKENS (We must find them to delete them)
            const existingTokens = await window.getDocs(tokenCol);

            // üü¢ 3. START BATCH (We will do deletions and additions in one go)
            const batch = window.writeBatch(window.db);

            // üü¢ 4. DELETE OLD TOKENS
            existingTokens.forEach(doc => {
                batch.delete(doc.ref);
            });

            // üü¢ 5. ADD NEW TOKENS (From your saved file)
            if (data.tokens) {
                data.tokens.forEach(t => {
                    const newDoc = window.doc(tokenCol); // Create fresh ID
                    batch.set(newDoc, { 
                        image: t.image||null, 
                        label: t.label||"Unit", 
                        shortLabel: t.shortLabel||"U", 
                        color: t.color||"blue", 
                        x: Number(t.x)||50, 
                        y: Number(t.y)||50, 
                        size: t.size||1 
                    });
                });
            }

            // üü¢ 6. COMMIT (This executes the clear and the add simultaneously)
            await batch.commit();
        })();

        // ‚è≥ WAIT FOR BOTH
        await Promise.all([loadMapPromise, loadDataPromise]);

        // üü¢ STEP 3: FINAL RENDER
        // Only render walls/vision if map actually loaded
        if (mapImg && mapImg.naturalWidth > 0) {
            if (window.renderWalls) window.renderWalls();
            if (window.fog && window.fog.broadcast) window.fog.broadcast();
            
            // Safety Redraw (Fixes invisible wall bug)
            setTimeout(() => {
                if (window.renderWalls) window.renderWalls();
                if (window.revealTokenVision) window.revealTokenVision();
            }, 200);
        }

        window.showToast(`Scene Loaded: ${sceneName}`, "success");

    } catch (e) {
        console.error(e);
        window.showToast("Load Error: " + e.message, "error");
    }
};

// üóëÔ∏è DELETE SCENE LOGIC
window.deleteScene = async (sceneName) => {
    if (!confirm(`Are you sure you want to permanently delete "${sceneName}"?`)) return;

    try {
        // Delete from Firestore
        await window.deleteDoc(window.doc(window.db, `users/${window.userId}/vtt_scenes`, sceneName));
        window.showToast(`Deleted "${sceneName}"`, "success");
        
        // Refresh the gallery instantly so it disappears
        window.openSceneSelector();
    } catch (e) {
        console.error("Delete Error:", e);
        window.showToast("Failed to delete scene.", "error");
    }
};

// üü¢ SMART PRO MENU: Decides which modal to show
window.openProMenu = function() {
    if (window.isProUser) {
        // Already Pro? Show the Success/Status Screen
        document.getElementById('pro-success-modal').classList.remove('hidden');
        document.getElementById('pro-modal').classList.add('hidden');
    } else {
        // Free User? Show the Upgrade/Buy Screen
        document.getElementById('pro-modal').classList.remove('hidden');
        document.getElementById('pro-success-modal').classList.add('hidden');
    }
};

// üü¢ TOGGLE CLASSIC / PRO LAYOUT
window.toggleNotesLayout = function() {
    // 1. Check Pro Status
    if (!window.isProUser) {
        window.showToast("üîí Layout Switching is a Pro Feature", "error");
        return;
    }

    const container = document.getElementById('notes-layout-container');
    const classicNav = document.getElementById('notes-nav-classic');
    const proNav = document.getElementById('notes-nav-pro');
    
    // 2. Check current state (is Pro active?)
    const isProActive = !proNav.classList.contains('hidden');
    
    if (isProActive) {
        // Switch to CLASSIC
        proNav.classList.add('hidden');
        classicNav.classList.remove('hidden');
        
        container.classList.remove('flex-row');
        container.classList.add('flex-col');
        
        localStorage.setItem('aegis_notes_mode', 'classic');
        window.showToast("Switched to Classic View", "neutral");
    } else {
        // Switch to PRO
        classicNav.classList.add('hidden');
        proNav.classList.remove('hidden');
        proNav.classList.add('flex'); // Ensure flex display is active
        
        container.classList.remove('flex-col');
        container.classList.add('flex-row');
        
        localStorage.setItem('aegis_notes_mode', 'pro');
        window.showToast("Switched to Pro Dashboard", "success");
    }
};

// üü¢ DIRECT EDITOR (Bypasses ID lookup issues)
window.openNoteDirectly = function(note, tab) {
    console.log("üìÇ Opening note directly:", note.title);

    // 1. Populate Modal Fields
    const idField = document.getElementById('modal-note-id');
    const tabField = document.getElementById('modal-tab-name');
    const titleField = document.getElementById('modal-title');
    const contentField = document.getElementById('modal-content');
    const modal = document.getElementById('edit-modal');

    if (idField) idField.value = note.id || "";
    if (tabField) tabField.value = tab || "general";
    if (titleField) titleField.value = note.title || "Untitled";
    
    // Handle Markdown vs HTML content
    // We want the RAW content for editing
    if (contentField) contentField.value = note.content || "";

    // 2. Trigger Timeline Backlinks (Optional)
    if (window.updateTimelineBacklinks && note.title) {
        window.updateTimelineBacklinks(note.title);
    }

    // 3. Open the Modal
    if (modal) {
        modal.classList.remove('hidden');
    } else {
        alert("‚ùå Error: Edit Modal HTML is missing!");
    }
};

// üü¢ OPEN READING MODE (The Preview Modal)
window.openNotePreview = function(note, tab) {
    const modal = document.getElementById('note-preview-modal');
    const titleEl = document.getElementById('preview-title');
    const contentEl = document.getElementById('preview-content-area');
    const dateEl = document.getElementById('preview-date');
    const editBtn = document.getElementById('preview-edit-btn');

    if (!modal) return;

    // 1. Set Basic Info
    titleEl.innerText = note.title || "Untitled Note";
    dateEl.innerText = note.timestamp ? "Last updated: " + new Date(note.timestamp).toLocaleString() : "";

    // 2. Render Content (Logic borrowed from renderer)
    let rawContent = note.content || "";
    let displayContent = "";
    
    // Check for Legacy HTML vs Markdown
    const isLegacyHTML = rawContent.trim().match(/^<(div|p|table|h\d|ul|ol)/i);
    
    if (isLegacyHTML) {
        displayContent = rawContent.replace(/\[\[(\d+d\d+(?:[+\-]\d+)?)\]\]/gi, 
            '<button class="inline-flex items-center gap-1 bg-indigo-900/50 border border-indigo-500/50 text-indigo-200 px-1.5 rounded text-xs font-mono font-bold mx-1">üé≤ $1</button>');
    } else {
        if (window.parseMarkdown) {
            displayContent = window.parseMarkdown(rawContent);
        } else {
            displayContent = rawContent.replace(/\n/g, "<br>");
        }
    }
    
    // Fallback for empty notes
    if (!displayContent || displayContent.trim() === "") {
        displayContent = "<em class='text-gray-600'>This note is empty. Click 'Edit' to add content.</em>";
    }

    contentEl.innerHTML = displayContent;

    // 3. Setup the "Edit" Button inside the preview
    // When clicked, it closes this preview and opens the editor
    editBtn.onclick = function() {
        modal.classList.add('hidden'); // Close preview
        window.openNoteDirectly(note, tab); // Open Editor
    };

    // 4. Show Modal
    modal.classList.remove('hidden');
};

window.redirectToPortal = async () => {
    if (!window.userId) return;
    
    // UI Feedback
    window.showToast("Opening Billing Portal...", "info");

    try {
        // Call your Cloud Function
        const response = await fetch("https://us-central1-aegisdmtoolkit.cloudfunctions.net/createPortalSession", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ userId: window.userId })
        });

        if (!response.ok) throw new Error("Portal creation failed");

        const data = await response.json();
        
        // Redirect the user
        if (data.url) {
            window.location.href = data.url;
        } else {
            alert("Could not generate billing link.");
        }

    } catch (e) {
        console.error(e);
        alert("Error accessing billing portal. Are you subscribed?");
    }
};

// üü¢ SMART BILLING HANDLER
// Connects the "Manage Subscription" button to the correct destination
window.handleBilling = function() {
    if (window.isProUser) {
        // ‚úÖ USER IS PRO: Open the Stripe Customer Portal
        window.redirectToPortal();
    } else {
        // ‚ùå USER IS FREE: Open the Sales/Upgrade Screen
        // (Assuming you have a function to open your sales modal)
        if(window.openProModal) {
            window.openProModal(); 
        } else {
            // Fallback: Send straight to checkout if no modal exists
            window.redirectToStripe(); 
        }
    }
};

// üü¢ PORTAL REDIRECTOR (Requires Cloud Function)
window.redirectToPortal = async () => {
    if (!window.userId) return;
    
    window.showToast("Contacting Stripe...", "info");

    try {
        // Call your Backend Cloud Function
        const response = await fetch("https://us-central1-aegisdmtoolkit.cloudfunctions.net/createPortalSession", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ userId: window.userId })
        });

        if (!response.ok) throw new Error("Portal creation failed");

        const data = await response.json();
        
        // Go to Stripe
        if (data.url) {
            window.location.href = data.url;
        } else {
            alert("Could not generate billing link. Please try again.");
        }

    } catch (e) {
        console.error(e);
        window.showToast("Error accessing billing portal.", "error");
    }
};

// üü¢ FIXED FOG ENGINE (Prevents Self-Destruction)
window.fog = {
    enabled: false,
    canvas: null,
    ctx: null,
    isDrawing: false, // This flag now actually works
    mode: 'reveal',
    brushSize: 60,

    init: function() {
        this.canvas = document.getElementById('fow-canvas');
        if(!this.canvas) return false;
        this.ctx = this.canvas.getContext('2d');
        const slider = document.getElementById('fog-brush-slider');
        const label = document.getElementById('brush-size-label');
        if(slider) {
            slider.value = this.brushSize;
            slider.oninput = (e) => {
                this.brushSize = parseInt(e.target.value);
                if(label) label.innerText = this.brushSize + "px";
            };
        }
        this.attachListeners();
        return true;
    },

    toggleControls: function() {
        if (!this.ctx) this.init();
        const toolbar = document.getElementById('fog-toolbar');
        const canvas = document.getElementById('fow-canvas');
        toolbar.classList.toggle('hidden');
        if (!toolbar.classList.contains('hidden')) {
            if(canvas) {
                canvas.classList.remove('pointer-events-none');
                canvas.classList.add('cursor-crosshair');
            }
            this.enabled = true;
        } else {
            if(canvas) {
                canvas.classList.add('pointer-events-none');
                canvas.classList.remove('cursor-crosshair');
            }
            this.enabled = false;
        }
    },

    fillFog: function() {
        if (!this.canvas) this.init();
        if (!this.canvas) return;
        this.ctx.globalCompositeOperation = 'source-over';
        this.ctx.fillStyle = '#000000';
        this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
        this.broadcast();
        if(window.showToast) window.showToast("Map Shrouded", "success");
    },

    clearFog: function() {
        if (!this.canvas) this.init();
        if (!this.canvas) return;
        this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
        this.broadcast();
        if(window.showToast) window.showToast("Map Revealed", "success");
    },

    setMode: function(m) {
        this.mode = m;
        const btnReveal = document.getElementById('btn-fog-reveal');
        const btnShroud = document.getElementById('btn-fog-shroud');
        if(btnReveal && btnShroud) {
            btnReveal.classList.toggle('bg-indigo-600', m === 'reveal');
            btnReveal.classList.toggle('bg-gray-700', m !== 'reveal');
            btnShroud.classList.toggle('bg-indigo-600', m === 'shroud');
            btnShroud.classList.toggle('bg-gray-700', m !== 'shroud');
        }
    },

    getFogData: function() {
        if (!this.canvas) return null;
        const tempCanvas = document.createElement('canvas');
        const MAX_SIZE = 900;
        let w = this.canvas.width;
        let h = this.canvas.height;
        if (w > h) { if (w > MAX_SIZE) { h *= MAX_SIZE / w; w = MAX_SIZE; } } 
        else { if (h > MAX_SIZE) { w *= MAX_SIZE / h; h = MAX_SIZE; } }
        
        tempCanvas.width = w;
        tempCanvas.height = h;
        const tCtx = tempCanvas.getContext('2d');
        tCtx.drawImage(this.canvas, 0, 0, w, h);
        return tempCanvas.toDataURL('image/png', 0.7);
    },

    loadFogData: function(dataUrl) {
        if (!this.ctx) this.init();
        if (!dataUrl) return;
        
        // üü¢ SAFETY: If we are currently painting, DO NOT overwrite the canvas
        if (this.isDrawing) return;

        const img = new Image();
        img.onload = () => {
            this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
            this.ctx.drawImage(img, 0, 0, this.canvas.width, this.canvas.height);
        };
        img.src = dataUrl;
    },

    broadcast: function() {
        if (!this.canvas) return;
        
        // üü¢ FIX: Do NOT capture data here. Wait for the timeout.
        
        if (window.auth && window.auth.currentUser && window.db) {
            const ref = window.doc(window.db, 'artifacts', 'default', 'sessions', window.auth.currentUser.uid, 'singles', 'shared_uplink');
            
            if (this.broadcastTimer) clearTimeout(this.broadcastTimer);

            this.broadcastTimer = setTimeout(() => {
                // üü¢ Capture data ONLY when safe (1 second after mouse stops)
                const data = this.getFogData();
                
                // üü¢ SAFETY: Don't save empty/broken data
                if (!data || data.length < 500) return;

                window.setDoc(ref, { fogData: data }, { merge: true })
                    .catch(e => console.error(e));
            }, 1000); 
        }
    },

    setupForImage: function(img) {
        if (!this.canvas) this.init();
        if (this.canvas && img) {
            if (this.canvas.width !== img.naturalWidth || this.canvas.height !== img.naturalHeight) {
                this.canvas.width = img.naturalWidth;
                this.canvas.height = img.naturalHeight;
            }
        }
    },

    attachListeners: function() {
        const paint = (e) => {
            if (!this.isDrawing || !this.canvas) return;
            const rect = this.canvas.getBoundingClientRect();
            if (rect.width === 0) return;
            const scaleX = this.canvas.width / rect.width;
            const scaleY = this.canvas.height / rect.height;
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            const x = (clientX - rect.left) * scaleX;
            const y = (clientY - rect.top) * scaleY;
            
            this.ctx.lineCap = 'round';
            this.ctx.lineJoin = 'round';
            this.ctx.lineWidth = this.brushSize * scaleX;
            
            if (this.mode === 'reveal') {
                this.ctx.globalCompositeOperation = 'destination-out';
                this.ctx.strokeStyle = 'rgba(0,0,0,1)';
            } else {
                this.ctx.globalCompositeOperation = 'source-over';
                this.ctx.strokeStyle = '#000000';
            }
            this.ctx.lineTo(x, y);
            this.ctx.stroke();
            this.ctx.beginPath();
            this.ctx.moveTo(x, y);
        };

        this.canvas.addEventListener('mousedown', (e) => {
            if(e.button !== 0) return;
            this.isDrawing = true; // üü¢ Set Global Flag
            this.ctx.beginPath();
            paint(e);
        });
        
        this.canvas.addEventListener('touchstart', (e) => { 
            e.preventDefault(); 
            this.isDrawing = true; 
            this.ctx.beginPath(); 
            paint(e); 
        }, {passive: false});

        window.addEventListener('mousemove', paint);
        window.addEventListener('touchmove', paint, {passive: false});

        const stopPainting = () => {
            if (this.isDrawing) {
                this.isDrawing = false; // üü¢ Clear Global Flag
                this.ctx.beginPath();
                this.broadcast();
            }
        };

        window.addEventListener('mouseup', stopPainting);
        window.addEventListener('touchend', stopPainting);
    }
};




// ‚ö° INTEGRATION: Hook into your existing image upload function
// When you load a map, we need to tell the Fog Engine to resize



// üü¢ 1. IMPORT LOGIC (Trigger)
window.submitJsonImport = async () => {
    const inputEl = document.getElementById('json-import-input');
    const categoryEl = document.getElementById('json-import-category');
    
    if(!inputEl || !categoryEl) return;
    
    const input = inputEl.value.trim();
    const targetTab = categoryEl.value; // e.g. "enemyNotes"

    if (!input) return alert("Please paste the JSON first.");

    const btn = document.querySelector('#json-import-modal button.bg-indigo-600');
    const originalText = btn.innerText;
    btn.innerText = "Processing...";
    btn.disabled = true;
    
    try {
        const data = JSON.parse(input);
        const items = Array.isArray(data) ? data : [data];

        for (const item of items) {
            await createNoteFrom5eJSON(item, targetTab);
        }

        // Cleanup
        inputEl.value = "";
        document.getElementById('json-import-modal').classList.add('hidden');
        
        // üü¢ FORCE REFRESH: Switch to the tab to ensure it renders
        if(window.switchSubTab) {
            window.switchSubTab(targetTab);
        } else if(window.renderStructuredNotes) {
            window.renderStructuredNotes(targetTab);
        }
        
        window.showToast(`Imported ${items.length} note(s)!`, "success");

    } catch (e) {
        console.error(e);
        alert("Import Error: " + e.message);
    } finally {
        btn.innerText = originalText;
        btn.disabled = false;
    }
};

// üü¢ PARSER WITH FULL SPELLCASTING SUPPORT
async function createNoteFrom5eJSON(item, targetTab) {
    const title = item.name || "Imported Note";
    
    // 1. Clean Text Helper
    const clean = (str) => {
        if (!str) return "";
        return str.replace(/{@(spell|item|creature|condition|sense|skill|action|background|race|class) ([^}|]+)\|?[^}]*}/gi, '$2')
                  .replace(/{@(dice|damage) ([^}|]+)\|?[^}]*}/gi, '$2')
                  .replace(/{@(hit|d20) ([^}]+)}/gi, '+$2')
                  .replace(/{@dc ([^}]+)}/gi, 'DC $1')
                  .replace(/{@atkr ([^}]+)}/gi, '($1)')
                  .replace(/{@h}/gi, 'Hit:')
                  .replace(/{@recharge ([^}]+)}/gi, '(Recharge $1)');
    };

    let body = "";

    // 2. Build Body (Standard 5e Statblock)
    if (item.source && (item.ac || item.hp)) {
        const type = typeof item.type === 'string' ? item.type : (item.type?.type || "Monster");
        const ac = Array.isArray(item.ac) ? item.ac.map(x=>(x.ac||x)).join(', ') : (item.ac?.ac || item.ac || "?");
        const hp = item.hp?.average ? `${item.hp.average} (${item.hp.formula})` : (item.hp || "?");
        const speed = item.speed ? (typeof item.speed==='string'?item.speed : Object.entries(item.speed).map(([k,v])=>`${k} ${v}ft`).join(', ')) : "30 ft.";

        body = `**${type}**\n**AC:** ${ac} | **HP:** ${hp} | **Speed:** ${speed}\n\n`;
        body += `STR:${item.str} DEX:${item.dex} CON:${item.con} INT:${item.int} WIS:${item.wis} CHA:${item.cha}\n\n`;

        // Skills & Saves (Optional Polish)
        const skills = item.skill ? "**Skills:** " + Object.entries(item.skill).map(([k,v]) => `${k} ${v}`).join(', ') : "";
        const saves = item.save ? "**Saves:** " + Object.entries(item.save).map(([k,v]) => `${k} ${v}`).join(', ') : "";
        if(skills || saves) body += `${skills} ${saves}\n\n`;

        const parseEntries = (entries) => {
            if(!entries) return "";
            return entries.map(e => {
                if(typeof e === 'string') return clean(e);
                if(e.name && e.entries) return `**${e.name}.** ${clean(Array.isArray(e.entries) ? e.entries.join(' ') : e.entries)}`;
                return "";
            }).join('\n\n');
        };

        if(item.trait) body += `${parseEntries(item.trait)}\n\n`;
        if(item.action) body += `### Actions\n${parseEntries(item.action)}\n\n`;
        if(item.reaction) body += `### Reactions\n${parseEntries(item.reaction)}\n\n`;

        // üü¢ FULL SPELLCASTING LOGIC
        if(item.spellcasting) {
            body += `### Spellcasting\n`;
            item.spellcasting.forEach(sc => {
                if (sc.name) body += `**${sc.name}**\n`;
                if (sc.headerEntries) body += `${clean(sc.headerEntries.join(' '))}\n`;

                if (sc.will) body += `- **At will:** ${clean(sc.will.join(', '))}\n`;
                
                if (sc.daily) {
                    Object.entries(sc.daily).forEach(([k, v]) => {
                        const count = k.replace('e', ''); // Handle "1e" (1 each)
                        body += `- **${count}/day:** ${clean(v.join(', '))}\n`;
                    });
                }
                
                if (sc.spells) {
                    Object.entries(sc.spells).forEach(([level, obj]) => {
                        const label = level === "0" ? "Cantrips" : `Level ${level}`;
                        const slots = obj.slots ? ` (${obj.slots} slots)` : "";
                        body += `- **${label}${slots}:** ${clean(obj.spells.join(', '))}\n`;
                    });
                }
                body += `\n`;
            });
        }

    } else {
        const parseSimple = (entries) => {
             if (!entries) return "";
             if (typeof entries === 'string') return clean(entries);
             if (Array.isArray(entries)) return entries.map(e => typeof e === 'string' ? clean(e) : parseSimple(e.entries)).join('\n\n');
             return "";
        }
        body = parseSimple(item.entries || item.text || item.desc);
    }

    // 3. PREPARE NOTE
    const newNote = {
        id: crypto.randomUUID(),
        title: title,
        content: body,
        campaign: window.currentCampaign || 'Default Campaign',
        timestamp: new Date().toISOString()
    };

    // 4. DATABASE SAVE (Matches 'setupNotesListener' logic)
    const dbFieldMap = {
        'prepNotes': 'structuredPrepNotes',
        'pcNotes': 'structuredPcNotes',
        'enemyNotes': 'structuredEnemyNotes',
        'npcNotes': 'structuredNpcNotes',
        'lootNotes': 'structuredLootNotes'
    };

    const dbFieldName = dbFieldMap[targetTab];
    if (!dbFieldName) return alert(`Error: Could not map tab "${targetTab}" to a database field.`);

    try {
        // Use Global Helper or Fallback
        const docRef = window.getSharedDoc ? window.getSharedDoc('shared_notes') : window.doc(window.db, 'users', window.userId, 'data', 'shared_notes');
        
        const docSnap = await window.getDoc(docRef);
        let currentList = [];
        
        if (docSnap.exists()) {
            const data = docSnap.data();
            currentList = data[dbFieldName] || [];
        }

        currentList.unshift(newNote);

        await window.setDoc(docRef, {
            [dbFieldName]: currentList
        }, { merge: true });

        // Update UI Local State
        if (window.structuredNotes) {
            window.structuredNotes[targetTab] = currentList;
        }

    } catch(err) {
        console.error("Save Error:", err);
        throw new Error("Database Write Failed: " + err.message);
    }
}

// ==========================================
// üü¢ VTT UPGRADE: Grid, Measure, & Lighting
// ==========================================

window.vttSettings = {
    snapEnabled: false,
    gridSize: 50, // Pixels per 5ft square
    isMeasuring: false
};

// ==========================================
// üü¢ SEPARATE GRID LOGIC
// ==========================================

// 1. SNAP TOGGLE (Physics only)
window.toggleGridSnap = () => {
    
    window.vttSettings.snapEnabled = !window.vttSettings.snapEnabled;
    const btn = document.getElementById('btn-snap');
    
    if(window.vttSettings.snapEnabled) {
        btn.classList.add('text-indigo-400', 'bg-white/10');
        btn.classList.remove('text-gray-400');
        window.showToast("Snap: ON", "success");
    } else {
        btn.classList.remove('text-indigo-400', 'bg-white/10');
        btn.classList.add('text-gray-400');
        window.showToast("Snap: OFF");
    }
};

// 2. VISIBILITY TOGGLE (Visuals only)
window.isGridVisible = false;

window.toggleGridVisibility = () => {
    
    window.isGridVisible = !window.isGridVisible;
    const btn = document.getElementById('btn-grid-vis');
    
    if (window.isGridVisible) {
        btn.classList.add('text-cyan-400', 'bg-white/10');
        btn.classList.remove('text-gray-400');
        window.renderGrid(); // Draw immediately
    } else {
        btn.classList.remove('text-cyan-400', 'bg-white/10');
        btn.classList.add('text-gray-400');
        document.getElementById('grid-layer').innerHTML = ''; // Clear lines
    }
};

// üü¢ UPDATED: Snap to CENTER of Grid Square
window.snapToGrid = (x, y) => {
    
    // 1. Check if snapping is actually enabled
    if (!window.vttSettings.snapEnabled) return { x, y };

    // 2. Get the current Grid Size from the input
    // This ensures it ALWAYS matches the visual grid lines
    const input = document.getElementById('grid-size-input');
    const size = parseInt(input.value) || 50;
    
    // 3. Calculate "Cell" coordinates
    // Math.floor finds which "box" we are in (Row/Column)
    const col = Math.floor(x / size);
    const row = Math.floor(y / size);

    // 4. Calculate Center of that Cell
    // (Column * Size) = Top-Left corner of box
    // + (size / 2) = Move to middle
    const centerX = (col * size) + (size / 2);
    const centerY = (row * size) + (size / 2);

    return { x: centerX, y: centerY };
};


// 2. MEASURE TOOL (RULER)
window.activateRuler = () => {
    
    window.vttSettings.isMeasuring = !window.vttSettings.isMeasuring;
    const btn = document.getElementById('btn-ruler');
    const viewport = document.getElementById('vtt-token-layer'); // Use token layer for clicks
    
    if (window.vttSettings.isMeasuring) {
        btn.classList.add('text-yellow-400', 'bg-white/10');
        btn.classList.remove('text-gray-400');
        viewport.style.cursor = 'crosshair';
        
        // Disable token dragging while measuring
        viewport.classList.add('pointer-events-auto'); 
        viewport.addEventListener('mousedown', startMeasure);
    } else {
        btn.classList.remove('text-yellow-400', 'bg-white/10');
        btn.classList.add('text-gray-400');
        viewport.style.cursor = 'default';
        viewport.removeEventListener('mousedown', startMeasure);
        document.getElementById('ruler-layer').innerHTML = ''; 
    }
};

let measureStart = null;

function startMeasure(e) {
    if(!window.vttSettings.isMeasuring) return;
    
    // Get coordinates relative to the map container
    const container = document.getElementById('dm-map-container');
    const rect = container.getBoundingClientRect();
    
    measureStart = { 
        x: e.clientX - rect.left, 
        y: e.clientY - rect.top 
    };
    
    document.addEventListener('mousemove', updateMeasure);
    document.addEventListener('mouseup', endMeasure);
}

function updateMeasure(e) {
    if (!measureStart) return;
    
    const container = document.getElementById('dm-map-container');
    const rect = container.getBoundingClientRect();
    
    const currentX = e.clientX - rect.left;
    const currentY = e.clientY - rect.top;

    // Calculate Distance
    const dx = currentX - measureStart.x;
    const dy = currentY - measureStart.y;
    const distPx = Math.sqrt(dx*dx + dy*dy);
    
    // Convert to Feet
    const gridSize = parseInt(document.getElementById('grid-size-input').value) || 50;
    const feet = Math.round((distPx / gridSize) * 5);

    // Draw Line (SVG)
    const svg = document.getElementById('ruler-layer');
    svg.innerHTML = `
        <line x1="${measureStart.x}" y1="${measureStart.y}" x2="${currentX}" y2="${currentY}" 
              stroke="#facc15" stroke-width="3" stroke-dasharray="8,4" />
        <circle cx="${measureStart.x}" cy="${measureStart.y}" r="4" fill="#facc15" />
        <circle cx="${currentX}" cy="${currentY}" r="4" fill="#facc15" />
        
        <rect x="${currentX + 10}" y="${currentY + 10}" width="60" height="24" rx="4" fill="rgba(0,0,0,0.8)" stroke="#facc15" stroke-width="1" />
        
        <text x="${currentX + 40}" y="${currentY + 26}" fill="white" font-size="12" text-anchor="middle" font-weight="bold" font-family="sans-serif">
            ${feet} ft
        </text>
    `;
}

function endMeasure() {
    measureStart = null;
    document.removeEventListener('mousemove', updateMeasure);
    document.removeEventListener('mouseup', endMeasure);
    // document.getElementById('ruler-layer').innerHTML = ''; // Keep line visible until next click?
}


// üü¢ UPDATED: Checks 'hasSight' before revealing
window.revealTokenVision = async () => {
    const canvas = document.getElementById('fow-canvas');
    if(!canvas) return;
    const ctx = canvas.getContext('2d');

    const tokens = document.querySelectorAll('#vtt-token-layer > div');
    if(tokens.length === 0) return;

    // 1. Get Screen Dimensions
    const rect = canvas.getBoundingClientRect();
    if (rect.width === 0 || rect.height === 0) return;

    // 2. Clear Fog (Cut Holes)
    ctx.globalCompositeOperation = 'destination-out';

    tokens.forEach(token => {
        // Check Toggle
        if (token.dataset.hasSight !== "true") return;

        const tokenRect = token.getBoundingClientRect();
        
        // 3. Calculate Center in Canvas Coordinates
        // We map the "Screen Pixel" center to "Canvas Pixel" center
        const screenX = tokenRect.left - rect.left + (tokenRect.width / 2);
        const screenY = tokenRect.top - rect.top + (tokenRect.height / 2);
        
        const canvasX = screenX * (canvas.width / rect.width);
        const canvasY = screenY * (canvas.height / rect.height);

        // 4. Calculate Radii to ensure perfect Screen Circle
        // We want a vision radius of ~3 grid squares (approx 150 screen pixels)
        // You can adjust 'targetScreenRadius' to make the circle bigger/smaller
        const gridSizeInput = document.getElementById('grid-size-input');
        const gridVal = parseInt(gridSizeInput ? gridSizeInput.value : 50) || 50;
        
        const targetScreenRadius = gridVal * 3; // e.g. 150px on screen

        // Convert that single screen distance into X and Y canvas distances
        const radiusX = targetScreenRadius * (canvas.width / rect.width);
        const radiusY = targetScreenRadius * (canvas.height / rect.height);

        if (!Number.isFinite(canvasX) || !Number.isFinite(canvasY)) return;

        // 5. Draw Ellipse (To appear as Circle on Screen)
        // We use a transform so the radial gradient stretches with the oval
        ctx.save();
        ctx.translate(canvasX, canvasY);
        ctx.scale(1, radiusY / radiusX); // Squash/Stretch the context

        // Draw the "Circle" in this distorted space
        // Note: We use radiusX for both because the Y-scale handles the shape
        const gradient = ctx.createRadialGradient(0, 0, radiusX * 0.4, 0, 0, radiusX);
        gradient.addColorStop(0, 'rgba(0,0,0,1)'); 
        gradient.addColorStop(1, 'rgba(0,0,0,0)'); 

        ctx.fillStyle = gradient;
        ctx.beginPath();
        ctx.arc(0, 0, radiusX, 0, Math.PI * 2);
        ctx.fill();
        
        ctx.restore(); 
    });

    ctx.globalCompositeOperation = 'source-over';

    if(window.fog && window.fog.broadcast) {
        window.fog.broadcast();
    }
};

// ==========================================
// üü¢ ADVANCED VISION SYSTEM (Walls & Raycasting)
// ==========================================

window.walls = window.walls || []; // Stores {x1, y1, x2, y2}
window.isDrawingWall = false;

// 1. WALL DRAWING TOOL
window.toggleWallTool = () => {
    
    window.isDrawingWall = !window.isDrawingWall;
    const btn = document.getElementById('btn-wall');
    const container = document.getElementById('dm-map-container');
    
    if (window.isDrawingWall) {
        if(btn) btn.classList.add('text-red-500', 'bg-white/10');
        container.classList.add('cursor-crosshair');
        // Disable token dragging while drawing
        if(document.getElementById('vtt-token-layer'))
            document.getElementById('vtt-token-layer').style.pointerEvents = 'none'; 
        container.addEventListener('mousedown', startWall);
    } else {
        if(btn) btn.classList.remove('text-red-500', 'bg-white/10');
        container.classList.remove('cursor-crosshair');
        if(document.getElementById('vtt-token-layer'))
            document.getElementById('vtt-token-layer').style.pointerEvents = 'auto';
        container.removeEventListener('mousedown', startWall);
    }
};

let wallStart = null;

function startWall(e) {
    if(!window.isDrawingWall) return;
    const rect = document.getElementById('dm-map-container').getBoundingClientRect();
    wallStart = { x: e.clientX - rect.left, y: e.clientY - rect.top };
    
    document.addEventListener('mousemove', previewWall);
    document.addEventListener('mouseup', endWall);
}

function previewWall(e) {
    if(!wallStart) return;
    const rect = document.getElementById('dm-map-container').getBoundingClientRect();
    const current = { x: e.clientX - rect.left, y: e.clientY - rect.top };
    renderWalls(current); 
}

function endWall(e) {
    if(!wallStart) return;
    const rect = document.getElementById('dm-map-container').getBoundingClientRect();
    const end = { x: e.clientX - rect.left, y: e.clientY - rect.top };
    
    // Save Wall
    window.walls.push({ x1: wallStart.x, y1: wallStart.y, x2: end.x, y2: end.y });
    
    wallStart = null;
    document.removeEventListener('mousemove', previewWall);
    document.removeEventListener('mouseup', endWall);
    renderWalls(); // Final redraw
    window.saveActiveWalls();
}

function renderWalls(previewEnd = null) {
    const svg = document.getElementById('wall-layer');
    if(!svg) return;
    let html = '';
    
    // Draw existing walls
    window.walls.forEach(w => {
        html += `<line x1="${w.x1}" y1="${w.y1}" x2="${w.x2}" y2="${w.y2}" stroke="red" stroke-width="3" opacity="0.7" />`;
        html += `<circle cx="${w.x1}" cy="${w.y1}" r="3" fill="red" />`;
        html += `<circle cx="${w.x2}" cy="${w.y2}" r="3" fill="red" />`;
    });

    // Draw preview line
    if (wallStart && previewEnd) {
        html += `<line x1="${wallStart.x}" y1="${wallStart.y}" x2="${previewEnd.x}" y2="${previewEnd.y}" stroke="yellow" stroke-width="3" stroke-dasharray="5,5" />`;
    }

    svg.innerHTML = html;
}

// üü¢ 1. ADD THIS NEW FUNCTION (This saves the walls to the database)
window.saveActiveWalls = async () => {
    if (!window.userId) return; // Safety check

    // Save to the 'shared_uplink' document
    const ref = window.doc(window.db, `artifacts/default/sessions/${window.userId}/singles/shared_uplink`);
    
    // We use { merge: true } to avoid deleting the map image
    await window.setDoc(ref, { 
        walls: window.walls || [] 
    }, { merge: true });
    
    console.log("Saved walls to database");
};

// üü¢ 2. REPLACE YOUR EXISTING clearWalls WITH THIS (Now it actually saves the deletion)
window.clearWalls = () => {
    

    if(confirm("Delete all walls?")) {
        window.walls = []; // Clear the array
        renderWalls();     // Clear the screen
        window.saveActiveWalls(); // <--- THIS WAS MISSING. Now it saves the empty state!
    }
};


// 2. RAYCASTING MATH (The "Vision" Engine)
function getIntersection(ray, segment) {
    // Standard Line-Line Intersection Formula
    const r_px = ray.x; const r_py = ray.y;
    const r_dx = ray.dx; const r_dy = ray.dy;

    const s_px = segment.x1; const s_py = segment.y1;
    const s_dx = segment.x2 - segment.x1;
    const s_dy = segment.y2 - segment.y1;

    const r_mag = Math.sqrt(r_dx*r_dx + r_dy*r_dy);
    const s_mag = Math.sqrt(s_dx*s_dx + s_dy*s_dy);

    if(r_dx/r_mag == s_dx/s_mag && r_dy/r_mag == s_dy/s_mag) return null; // Parallel

    const T2 = (r_dx*(s_py-r_py) + r_dy*(r_px-s_px))/(s_dx*r_dy - s_dy*r_dx);
    const T1 = (s_px+s_dx*T2-r_px)/r_dx;

    if(T1 < 0) return null; // Behind ray
    if(T2 < 0 || T2 > 1) return null; // Not on segment

    return {
        x: r_px + r_dx*T1,
        y: r_py + r_dy*T1,
        param: T1
    };
}


window.revealTokenVision = async () => {
    const canvas = document.getElementById('fow-canvas');
    if(!canvas) return;
    const ctx = canvas.getContext('2d');

    const tokens = document.querySelectorAll('#vtt-token-layer > div');
    if(tokens.length === 0) return;

    // Scaling Calculation
    const rect = canvas.getBoundingClientRect();
    if (rect.width === 0 || rect.height === 0) return;
    const scaleX = canvas.width / rect.width;
    const scaleY = canvas.height / rect.height;

    // Cut Holes
    ctx.globalCompositeOperation = 'destination-out';

    tokens.forEach(token => {
        // üü¢ CRITICAL CHECK: If token has no sight, SKIP IT!
        if (token.dataset.hasSight !== "true") return;

        const tokenRect = token.getBoundingClientRect();
        
        // Calculate Center
        const screenX = tokenRect.left - rect.left + (tokenRect.width / 2);
        const screenY = tokenRect.top - rect.top + (tokenRect.height / 2);
        const x = screenX * scaleX;
        const y = screenY * scaleY;

        // Calculate Radius (3 squares = ~150px)
        const gridSizeInput = document.getElementById('grid-size-input');
        const gridSizeVal = gridSizeInput ? (parseInt(gridSizeInput.value) || 50) : 50;
        const radius = (gridSizeVal * 3) * scaleX; 

        if (!Number.isFinite(x) || !Number.isFinite(y) || !Number.isFinite(radius)) return;

        // Draw Soft Gradient Hole
        const gradient = ctx.createRadialGradient(x, y, radius * 0.4, x, y, radius);
        gradient.addColorStop(0, 'rgba(0,0,0,1)'); 
        gradient.addColorStop(1, 'rgba(0,0,0,0)'); 

        ctx.fillStyle = gradient;
        ctx.beginPath();
        ctx.arc(x, y, radius, 0, Math.PI * 2);
        ctx.fill();
    });

    ctx.globalCompositeOperation = 'source-over';

    // Broadcast change to players
    if(window.fog && window.fog.broadcast) {
        window.fog.broadcast();
    }
};

// ==========================================
// üü¢ WALL DELETION & MANAGEMENT
// ==========================================

window.isWallEraserActive = false;

// 1. TOGGLE ERASER MODE
window.toggleWallEraser = () => {
    
    // Turn off Draw Mode if active
    if(window.isDrawingWall) window.toggleWallTool();

    window.isWallEraserActive = !window.isWallEraserActive;
    const btn = document.getElementById('btn-wall-eraser');
    const container = document.getElementById('dm-map-container');
    const tokenLayer = document.getElementById('vtt-token-layer');

    if (window.isWallEraserActive) {
        btn.classList.add('text-red-500', 'bg-white/10');
        container.style.cursor = 'not-allowed'; // Visual cue (Cancel cursor)
        
        // Pass clicks through tokens so we can delete walls behind them
        tokenLayer.style.pointerEvents = 'none'; 
        
        container.addEventListener('mousedown', deleteWallAtClick);
    } else {
        btn.classList.remove('text-red-500', 'bg-white/10');
        container.style.cursor = 'default';
        tokenLayer.style.pointerEvents = 'auto';
        container.removeEventListener('mousedown', deleteWallAtClick);
    }
};

// 2. DELETE LOGIC (Math: Point to Line Segment Distance)
function deleteWallAtClick(e) {
    if(!window.isWallEraserActive) return;

    const rect = document.getElementById('dm-map-container').getBoundingClientRect();
    const clickX = e.clientX - rect.left;
    const clickY = e.clientY - rect.top;
    
    // Threshold: How close you must click to the line (in pixels)
    const threshold = 10; 

    // Find closest wall
    let indexToDelete = -1;
    let closestDist = Infinity;

    window.walls.forEach((wall, index) => {
        const dist = pointToSegmentDistance(clickX, clickY, wall.x1, wall.y1, wall.x2, wall.y2);
        if (dist < threshold && dist < closestDist) {
            closestDist = dist;
            indexToDelete = index;
        }
    });

    if (indexToDelete !== -1) {
        // Remove the wall
        window.walls.splice(indexToDelete, 1);
        renderWalls(); // Redraw
        window.showToast("Wall Deleted", "success");
        
        // Update Vision Immediately if "Eye" is active
        if (window.fog && window.fog.save) window.revealTokenVision();
        window.saveActiveWalls();
    }
}

// üü¢ BONUS: UNDO LAST WALL
window.undoLastWall = () => {
    
    if(window.walls.length > 0) {
        window.walls.pop();
        renderWalls();
        window.showToast("Undo: Last wall removed");
        window.saveActiveWalls();
    }
};

// --- GEOMETRY HELPER: Distance from Point (p) to Line Segment (v-w) ---
function pointToSegmentDistance(px, py, x1, y1, x2, y2) {
    const l2 = (x2 - x1) ** 2 + (y2 - y1) ** 2; // Length squared
    if (l2 === 0) return Math.sqrt((px - x1) ** 2 + (py - y1) ** 2); // Line is a dot

    // Projection 't' falls between 0 and 1
    let t = ((px - x1) * (x2 - x1) + (py - y1) * (y2 - y1)) / l2;
    t = Math.max(0, Math.min(1, t)); // Clamp to segment

    // Projection Point
    const projX = x1 + t * (x2 - x1);
    const projY = y1 + t * (y2 - y1);

    // Distance
    return Math.sqrt((px - projX) ** 2 + (py - projY) ** 2);
}

// ==========================================
// üü¢ VISUAL GRID SYSTEM
// ==========================================

window.isGridVisible = false;

// 1. TOGGLE VISIBILITY
window.toggleGridVisibility = () => {
    
    window.isGridVisible = !window.isGridVisible;
    const btn = document.getElementById('btn-grid-vis');
    
    if (window.isGridVisible) {
        btn.classList.add('text-cyan-400', 'bg-white/10');
        btn.classList.remove('text-gray-400');
        window.renderGrid(); // Draw immediately
    } else {
        btn.classList.remove('text-cyan-400', 'bg-white/10');
        btn.classList.add('text-gray-400');
        document.getElementById('grid-layer').innerHTML = ''; // Clear lines
    }
};

// ==========================================
// üü¢ RENDER GRID (DM Side - Saves Native Size)
// ==========================================
window.renderGrid = () => {
    

    // 1. Get Elements
    const container = document.getElementById('dm-map-container');
    const img = document.getElementById('active-battlemap'); // Get Map Image
    const svg = document.getElementById('grid-layer');
    const sizeInput = document.getElementById('grid-size-input');
    const colorInput = document.getElementById('grid-color');
    const widthInput = document.getElementById('grid-width');
    const opacityInput = document.getElementById('grid-opacity');

    if (!sizeInput || !colorInput || !widthInput || !opacityInput) return;

    // 2. Read Values (What YOU see on screen)
    const screenPixelSize = parseInt(sizeInput.value) || 50; 
    const color = colorInput.value || '#06b6d4';
    const width = widthInput.value || 1;
    const opacity = opacityInput.value || 0.6;

    // 3. Calculate "Native" Size (Relative to full image)
    let scale = 1;
    if (img && img.naturalWidth > 0 && container.offsetWidth > 0) {
        scale = container.offsetWidth / img.naturalWidth;
    }
    const nativeSize = screenPixelSize / scale; // This is the "Real" size on the map file

    // 4. Save "Native Size" to Database
    if(window.updateAllTokenSizes) window.updateAllTokenSizes();

    if (window.auth && window.auth.currentUser && window.db) {
        if (window.gridSaveTimer) clearTimeout(window.gridSaveTimer);
        window.gridSaveTimer = setTimeout(() => {
            const uid = window.auth.currentUser.uid;
            const uplinkRef = window.doc(window.db, 'artifacts', 'default', 'sessions', uid, 'singles', 'shared_uplink');
            
            window.setDoc(uplinkRef, { 
                gridSettings: { 
                    size: nativeSize, // üü¢ SAVE NATIVE SIZE (Not screen size)
                    color, width, opacity, 
                    visible: window.isGridVisible 
                } 
            }, { merge: true }).catch(err => console.error("Grid sync failed:", err));
        }, 500); 
    }

    // Update Labels
    if(document.getElementById('grid-width-val')) 
        document.getElementById('grid-width-val').innerText = `${width}px`;
    if(document.getElementById('grid-opacity-val')) 
        document.getElementById('grid-opacity-val').innerText = `${Math.round(opacity * 100)}%`;

    // 5. Draw (Use Screen Pixels so it looks right to YOU)
    if (!window.isGridVisible) {
        if(svg) svg.innerHTML = '';
        return;
    }
    if (!container || !svg || screenPixelSize < 5) return;

    svg.style.opacity = opacity;
    const widthPx = container.offsetWidth;
    const heightPx = container.offsetHeight;
    let html = '';

    // Draw using the Slider Value directly (Screen Pixels)
    for (let x = screenPixelSize; x < widthPx; x += screenPixelSize) {
        html += `<line x1="${x}" y1="0" x2="${x}" y2="${heightPx}" stroke="${color}" stroke-width="${width}" vector-effect="non-scaling-stroke" />`;
    }
    for (let y = screenPixelSize; y < heightPx; y += screenPixelSize) {
        html += `<line x1="0" y1="${y}" x2="${widthPx}" y2="${y}" stroke="${color}" stroke-width="${width}" vector-effect="non-scaling-stroke" />`;
    }
    svg.innerHTML = html;
};

// üü¢ AUTO-UPDATE LISTENER
// This ensures that when you resize the window or upload a new map, the grid updates.
window.addEventListener('resize', () => {
    if(window.isGridVisible) window.renderGrid();
});

// Hook into your existing map upload to refresh grid
const originalHandleUpload = window.handleMapUpload;


// ==========================================
// üü¢ TOKEN CONTEXT MENU & RESIZING
// ==========================================

window.selectedTokenId = null;

// 1. OPEN CONTEXT MENU (Right-Click on Token)
window.handleTokenContextMenu = (e, tokenId) => {
    e.preventDefault(); // Stop default browser menu
    e.stopPropagation(); // Stop map click

    window.selectedTokenId = tokenId;
    const menu = document.getElementById('token-context-menu');
    
    // Position menu at mouse
    menu.style.left = `${e.pageX}px`;
    menu.style.top = `${e.pageY}px`;
    menu.classList.remove('hidden');

    // Close menu when clicking elsewhere
    const closeMenu = () => {
        menu.classList.add('hidden');
        document.removeEventListener('click', closeMenu);
    };
    // Small delay to prevent immediate closing
    setTimeout(() => document.addEventListener('click', closeMenu), 10);
};

// 2. SET SIZE (Saves to Firebase)
window.setTokenSize = async (sizeMultiplier) => {
    if (!window.selectedTokenId || !window.auth.currentUser) return;
    
    try {
        await window.updateDoc(window.doc(window.db, `artifacts/default/sessions/${window.userId}/vtt_tokens`, window.selectedTokenId), {
            size: sizeMultiplier
        });
        window.showToast(`Size set to ${sizeMultiplier}x`);
    } catch (err) {
        console.error("Error resizing token:", err);
    }
};

// 3. DELETE TOKEN
window.deleteSelectedToken = async () => {
    if (!window.selectedTokenId || !window.auth.currentUser) return;
    
    if(confirm("Delete this token?")) {
        try {
            await window.deleteDoc(window.doc(window.db, `artifacts/default/sessions/${window.userId}/vtt_tokens`, window.selectedTokenId));
            window.showToast("Token Deleted");
        } catch (err) {
            console.error("Error deleting token:", err);
        }
    }
};

// üü¢ FIXED: Tokens stay 50px regardless of Grid Size
window.updateAllTokenSizes = () => {
    // 1. Define a fixed base size (e.g., 50px)
    // This stops them from resizing when you change the grid slider
    const fixedBaseSize = 50; 
    
    document.querySelectorAll('.token').forEach(el => {
        const mult = parseFloat(el.dataset.size || 1);
        
        // Calculate size based on the FIXED value, not the input
        const finalSize = fixedBaseSize * mult;
        
        el.style.width = `${finalSize}px`;
        el.style.height = `${finalSize}px`;
    });
};

// üü¢ CUSTOM SIZE PROMPT
window.promptTokenCustomSize = () => {
    if (!window.selectedTokenId) return;

    // 1. Get Current Grid Size (Reference)
    const gridInput = document.getElementById('grid-size-input');
    const currentGridSize = parseInt(gridInput.value) || 50;

    // 2. Ask User
    const input = prompt(`Enter desired size in pixels (Current Grid: ${currentGridSize}px):`, currentGridSize);
    
    // 3. Validate
    if (!input) return; // User cancelled
    const desiredPixels = parseFloat(input);
    if (isNaN(desiredPixels) || desiredPixels <= 0) return alert("Please enter a valid number.");

    // 4. Calculate Multiplier (Desired / Grid)
    // Example: Want 100px on 50px grid -> 100/50 = 2x multiplier
    const newMultiplier = desiredPixels / currentGridSize;

    // 5. Save using existing function
    window.setTokenSize(newMultiplier);
    
    // Hide menu manually since prompt stops event propagation sometimes
    document.getElementById('token-context-menu').classList.add('hidden');
};

// ==========================================
// üü¢ NOTES SEARCH FUNCTION
// ==========================================
window.filterNotes = () => {
    // 1. Get the search text
    const searchInput = document.getElementById('notes-search');
    const filter = searchInput.value.toLowerCase();
    
    // 2. Define all the lists we need to search through
    const listIds = [
        'prepNotes-list', 
        'pcNotes-list', 
        'enemyNotes-list', 
        'npcNotes-list', 
        'lootNotes-list'
    ];

    // 3. Loop through every list
    listIds.forEach(id => {
        const list = document.getElementById(id);
        if (!list) return;

        // Get all notes (children) inside this list
        const notes = list.children;

        for (let i = 0; i < notes.length; i++) {
            const note = notes[i];
            // Get all text inside the note (Title + Content)
            const text = note.innerText || note.textContent;

            // 4. Check for match
            if (text.toLowerCase().indexOf(filter) > -1) {
                note.style.display = ""; // Show it (reverts to default flex/block)
            } else {
                note.style.display = "none"; // Hide it
            }
        }
    });
};

// üü¢ LOAD SAVED SETTINGS ON STARTUP
window.loadGridSettings = () => {
    const saved = localStorage.getItem('vtt_grid_settings');
    if (saved) {
        const settings = JSON.parse(saved);
        
        // Restore values into inputs
        if(document.getElementById('grid-size-input')) 
            document.getElementById('grid-size-input').value = settings.size || 50;
        
        if(document.getElementById('grid-color')) 
            document.getElementById('grid-color').value = settings.color || '#06b6d4';
            
        if(document.getElementById('grid-width')) 
            document.getElementById('grid-width').value = settings.width || 1;
            
        if(document.getElementById('grid-opacity')) 
            document.getElementById('grid-opacity').value = settings.opacity || 0.6;
            
        // Apply them visually
        window.renderGrid();
    }
};

// üü¢ CALL THIS AT THE END OF YOUR SCRIPT
window.loadGridSettings();

// Inside index.html script

// 1. Find your Fill Fog Logic and replace/update it:
window.fillFog = () => {
    const canvas = document.getElementById('fow-canvas');
    if (!canvas) return;
    const ctx = canvas.getContext('2d');

    // A. Fill the canvas with solid black
    ctx.globalCompositeOperation = 'source-over';
    ctx.fillStyle = '#000000';
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    // B. üü¢ CRITICAL: Send this update to the players
    if (window.fog && window.fog.broadcast) {
        window.fog.broadcast(); 
        window.showToast("Fog filled & synced!", "success");
    } else {
        console.error("Broadcast function missing! Players won't see the change.");
    }
};

// üü¢ COMPLETE CLEAR FUNCTION (Wipes Image, Fog, Walls, AND TOKENS)
window.clearUplinkImage = async () => {
    const user = window.auth.currentUser;
    if (!user) return alert("Please log in.");
    
    // 1. Confirm before wiping everything
    if(!confirm("Are you sure? This will delete the Map, Fog, Walls, and ALL Tokens.")) return;

    try {
        const batch = window.writeBatch(window.db);

        // 2. Clear Map, Fog, and Walls (Update the 'shared_uplink' doc)
        const uplinkRef = window.doc(window.db, 'artifacts', 'default', 'sessions', user.uid, 'singles', 'shared_uplink');
        batch.set(uplinkRef, { 
            activeImage: null, 
            fogData: null, 
            walls: [] 
        }, { merge: true });

        // 3. Delete All Tokens (Find every token and mark it for deletion)
        const tokenCol = window.collection(window.db, `artifacts/default/sessions/${user.uid}/vtt_tokens`);
        const tokenSnap = await window.getDocs(tokenCol);
        
        tokenSnap.forEach(doc => {
            batch.delete(doc.ref);
        });

        // 4. Commit all changes at once
        await batch.commit();

        // 5. UI Updates
        if (document.getElementById('uplink-status')) document.getElementById('uplink-status').innerText = "Uplink Terminated.";
        if (window.showToast) window.showToast("‚úÖ Map & Tokens Cleared.", "success");
        console.log("Visuals cleared.");

    } catch (err) {
        console.error("Clear Error:", err);
        alert("Error clearing map: " + err.message);
    }
};

setTimeout(() => { 
        if(window.fog) window.fog.init(); 
    }, 1000);

 window.toggleTokenVision = async () => {
    if (!window.selectedTokenId) return;
    
    // 1. Get current state from the DOM element
    const tokenEl = document.getElementById(`token-${window.selectedTokenId}`);
    const currentSight = tokenEl.dataset.hasSight === "true";
    const newSight = !currentSight; // Flip it

    // 2. Update Database
    await window.updateDoc(window.doc(window.db, `artifacts/default/sessions/${window.userId}/vtt_tokens`, window.selectedTokenId), { 
        hasSight: newSight 
    });

    // 3. Update Visuals
    tokenEl.dataset.hasSight = newSight;
    if (newSight) {
        window.showToast("Vision Enabled");
        window.revealTokenVision();
    } else {
        window.showToast("Vision Disabled");
        // We don't auto-fill fog back in (too complex), but it stops clearing moving forward.
    }
    document.getElementById('token-context-menu').classList.add('hidden');
};

</script>

    <!-- Login Modal -->
<div id="login-modal" class="hidden fixed inset-0 z-[100] bg-black bg-opacity-80 flex items-center justify-center p-4 backdrop-blur-sm">
    <div class="card w-full max-w-md p-8 rounded-xl shadow-2xl border border-gray-600">
        <h3 class="text-2xl font-bold text-indigo-300 mb-2 text-center">üõ°Ô∏è Open Session</h3>
        <p class="text-gray-400 text-sm mb-6 text-center">Enter a Session Name and Password to create or load a shared room.</p>
        
        <div class="space-y-4">
    <div>
        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Username or Email</label>
        <input type="text" 
               id="session-name-input" 
               class="w-full p-3 rounded-lg input-style border-2 border-indigo-900/50 focus:border-indigo-500 outline-none transition" 
               placeholder="Enter Username">
    </div>

    <div>
        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Password</label>
        <input type="password" 
               id="session-pass-input" 
               class="w-full p-3 rounded-lg input-style border-2 border-indigo-900/50 focus:border-indigo-500 outline-none transition" 
               placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
    </div>
</div>
        
        <div id="login-status" class="h-6 text-red-400 text-xs mt-2"></div>
        
        <div class="flex gap-3 mt-4">
            <button onclick="closeLoginModal()" class="flex-1 bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 rounded-lg transition">Cancel</button>
            <button onclick="handleSessionLogin()" class="flex-1 bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 rounded-lg transition shadow-lg shadow-indigo-900/50">Connect</button>
        </div>
    </div>
    
</div>

<div id="share-modal" class="hidden fixed inset-0 z-[100] bg-black bg-opacity-80 flex items-center justify-center p-4 backdrop-blur-sm" onclick="this.classList.add('hidden')">
    <div class="card w-full max-w-sm p-6 rounded-xl shadow-2xl border border-blue-500/50 text-center bg-gray-900 relative" onclick="event.stopPropagation()">
        
        <button onclick="document.getElementById('share-modal').classList.add('hidden')" class="absolute top-2 right-2 text-gray-400 hover:text-white transition">‚úï</button>
        
        <h3 class="text-xl font-bold text-blue-300 mb-2">Scan to Join</h3>
        <p class="text-gray-400 text-xs mb-4">Players can scan this to open the toolkit on their phones.</p>
        
        <div class="bg-white p-2 rounded-lg inline-block shadow-lg">
            <img src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=https://deadseagul.github.io/DM-Toolkit/&color=000000" alt="Aegis DM Toolkit QR Code" class="rounded w-48 h-48">
        </div>
        
        <div class="mt-4">
            <p class="text-[10px] text-gray-500 font-mono bg-gray-800 p-2 rounded select-all break-all border border-gray-700">
                https://deadseagul.github.io/DM-Toolkit/
            </p>
        </div>
        
        <button onclick="navigator.clipboard.writeText('https://deadseagul.github.io/DM-Toolkit/'); alert('Link Copied!')" class="mt-3 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 rounded-lg text-sm transition shadow-lg">
            üìã Copy Link
        </button>
    </div>
</div>

<div id="save-campaign-modal" class="hidden fixed inset-0 z-[150] bg-black bg-opacity-80 flex items-center justify-center p-4 backdrop-blur-sm">
    <div class="card w-full max-w-sm p-6 rounded-xl shadow-2xl border border-indigo-500/50 bg-gray-900">
        <h3 class="text-xl font-bold text-indigo-300 mb-2">Save to Campaign</h3>
        <p class="text-gray-400 text-xs mb-4">Choose where to store this note.</p>
        
        <div class="space-y-3">
            <div>
                <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">Select Campaign</label>
                <select id="save-campaign-select" class="w-full p-2 rounded bg-gray-800 text-white border border-gray-700 text-sm focus:border-indigo-500 outline-none">
                    </select>
            </div>
            
            <div class="flex gap-2 pt-2">
                <button onclick="window.resolveSavePromise(null)" class="flex-1 bg-gray-700 hover:bg-gray-600 text-white text-xs font-bold py-2 rounded transition">Cancel</button>
                <button onclick="window.confirmSaveCampaign()" class="flex-1 bg-indigo-600 hover:bg-indigo-500 text-white text-xs font-bold py-2 rounded transition shadow-lg">Save</button>
            </div>
        </div>
    </div>
</div>

<button onclick="window.switchTab('help')" class="fixed bottom-6 right-6 z-50 w-12 h-12 bg-indigo-600 hover:bg-indigo-500 text-white rounded-full shadow-2xl border-2 border-indigo-400 flex items-center justify-center transition transform hover:scale-110 active:scale-95 group" title="Go to Help">
    <span class="text-xl font-bold group-hover:animate-bounce">?</span>
</button>

<div id="toast-container" class="fixed bottom-20 left-1/2 transform -translate-x-1/2 z-[200] flex flex-col gap-2 pointer-events-none"></div>
        

<div id="welcome-modal" class="hidden fixed inset-0 z-[300] bg-black bg-opacity-90 flex items-center justify-center p-4 backdrop-blur-md">
    <div class="card w-full max-w-lg p-8 rounded-xl shadow-2xl border-2 border-indigo-500/50 bg-gray-900 text-center relative overflow-hidden">
        
        <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-indigo-500 via-purple-500 to-indigo-500"></div>

        <h2 class="text-3xl font-bold text-white mb-2 font-serif tracking-wide">Welcome to Aegis</h2>
        <p class="text-indigo-400 text-sm font-bold uppercase tracking-widest mb-6">The Ultimate DM Toolkit</p>
        
        <div class="text-gray-300 text-sm space-y-4 mb-8 leading-relaxed">
            <p>You have discovered a comprehensive suite of tools designed to help Dungeon Masters run smoother sessions.</p>
            <ul class="text-left bg-gray-800/50 p-4 rounded-lg border border-gray-700 space-y-2 mx-auto max-w-sm">
                <li>‚öîÔ∏è <strong>Combat Tracker</strong> with Auto-Rolling</li>
                <li>üó∫Ô∏è <strong>Map Creator</strong> & Campaign Manager</li>
                <li>üëπ <strong>AI Generators</strong> for Loot, NPCs & Lore</li>
                <li>üîä <strong>Soundboard</strong> & Ambience Player</li>
            </ul>
            <p>Everything is saved to your browser automatically. Create an account to sync across devices!</p>
            
            <p class="text-indigo-300 font-semibold">üí° Need instructions? Check out the Help Tab!</p>
        </div>

        <div class="flex flex-col sm:flex-row gap-3 justify-center">
            <button onclick="window.closeWelcome()" class="bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 px-8 rounded-lg shadow-lg transition transform hover:scale-105">
                ‚öîÔ∏è Enter Toolkit
            </button>
            
            <a href="https://ko-fi.com/aegisdmtool" target="_blank" class="flex items-center justify-center gap-2 bg-yellow-600/20 hover:bg-yellow-600/40 text-yellow-200 border border-yellow-600/50 font-bold py-3 px-6 rounded-lg transition">
                <span>‚òï</span> Leave a Tip
            </a>
        </div>
        
        <p class="mt-6 text-[10px] text-gray-500">Version 1.0 ‚Ä¢ Built by DeadSeagul</p>
    </div>
</div>

<div id="session-gatekeeper" class="fixed inset-0 z-[9999] bg-gray-900 flex flex-col items-center justify-center p-4 transition-opacity duration-500 hidden">
    
    <div class="absolute inset-0 overflow-hidden pointer-events-none opacity-20">
        <div class="absolute top-[-10%] left-[-10%] w-[50%] h-[50%] bg-purple-900 rounded-full blur-[150px]"></div>
        <div class="absolute bottom-[-10%] right-[-10%] w-[50%] h-[50%] bg-indigo-900 rounded-full blur-[150px]"></div>
    </div>

    <div class="relative bg-gray-800/90 p-8 rounded-2xl shadow-2xl border border-gray-700 w-full max-w-md backdrop-blur-xl text-center">
        
        <div class="mb-6 flex justify-center">
            <svg class="w-20 h-20 drop-shadow-lg" viewBox="0 0 64 64">
                <path d="M32 4 L12 14 V30 C12 43 21 54 32 58 C43 54 52 43 52 30 V14 Z" fill="#1f2933" stroke="#f4d28b" stroke-width="2.5" />
                <path d="M31 10 L33 10 L33 48 L32 52 L31 48 Z" fill="#cbd5e1" stroke="#94a3b8" stroke-width="1"/>
                <polygon points="32,18 24,24 24,34 32,40 40,34 40,24" fill="#8b4513" stroke="#f4d28b" stroke-width="1.5" />
                <text x="32" y="30" text-anchor="middle" font-size="8" fill="#f9f9f9">20</text>
            </svg>
        </div>

        <h1 class="text-3xl font-bold text-white mb-2 font-serif tracking-wide">Aegis DM Toolkit</h1>
        
        <p id="gate-subtitle" class="text-indigo-400 text-xs font-bold uppercase tracking-[0.2em] mb-4 transition-all">Welcome Back</p>

        <div id="signup-instruction" class="hidden mb-6 p-3 bg-cyan-950/30 border border-cyan-800/50 rounded-lg">
            <p class="text-[10px] text-cyan-300 font-medium leading-relaxed">
                <span class="text-cyan-400 font-bold block mb-1">SIGN UP WITH EMAIL</span>
                Please use a valid email address to ensure you can recover your session data later.
            </p>
        </div>

        <div class="space-y-4 text-left">
            <div>
                <label id="gate-label" class="block text-[10px] font-bold text-gray-500 uppercase mb-1 ml-1">Email or Session Name</label>
                <input type="text" id="gate-email" class="w-full p-4 rounded-lg bg-gray-900 border border-gray-700 text-white focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 outline-none transition" placeholder="Enter your credentials">
            </div>
            <div>
                <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1 ml-1">Password</label>
                <input type="password" id="gate-pass" class="w-full p-4 rounded-lg bg-gray-900 border border-gray-700 text-white focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 outline-none transition" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
            </div>
        </div>


<div id="newsletter-container" class="hidden flex items-start gap-3 p-3 bg-indigo-950/20 border border-indigo-900/30 rounded-lg mt-4">
    <div class="flex items-center h-5">
        <input id="signup-newsletter" type="checkbox" checked
               class="w-4 h-4 text-indigo-600 bg-gray-900 border-gray-700 rounded focus:ring-indigo-500 cursor-pointer">
    </div>
    <label for="signup-newsletter" class="text-[10px] leading-tight text-gray-400 uppercase tracking-wider cursor-pointer">
        Receive <span class="text-indigo-400 font-bold">Raven Scrolls</span> (Updates & DM Tips)
    </label>
</div>

        <div class="flex justify-between items-center mt-3 px-1">
            <button onclick="window.handleGatekeeperReset()" class="text-[9px] font-bold text-gray-500 hover:text-indigo-400 transition uppercase tracking-widest">
                Forgot Password?
            </button>
            <button id="auth-toggle-btn" onclick="window.toggleAuthMode()" class="text-[9px] font-bold text-indigo-400 hover:text-indigo-300 transition uppercase tracking-widest">
                Need an Account? Sign Up
            </button>
        </div>

        <div id="gate-status" class="h-6 text-red-400 text-xs mt-3 font-bold"></div>

        <button id="auth-submit-btn" onclick="window.handleAuthAction()" 
                class="w-full mt-2 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-500 hover:to-purple-500 text-white font-bold py-4 rounded-lg shadow-lg shadow-indigo-900/50 transition transform hover:scale-[1.02] active:scale-95">
            ENTER SESSION
        </button>
        
        <p id="gate-footer-note" class="mt-6 text-[9px] text-gray-600 uppercase tracking-tighter">
            Secure session encryption enabled
        </p>
    </div>
</div>

        <div id="gear-sidebar" class="fixed right-0 top-1/3 z-[100] flex items-start transition-transform duration-300 translate-x-[180px]">
    
    <button onclick="window.toggleGearSidebar()" class="bg-yellow-600 hover:bg-yellow-500 text-white p-2 rounded-l-lg shadow-xl border-l border-t border-b border-yellow-400/50 flex flex-col items-center gap-2 group">
        <span class="text-xs font-bold [writing-mode:vertical-lr] uppercase tracking-widest py-2">Essential Gear</span>
        <span id="gear-arrow" class="text-xs transition-transform duration-300">‚óÄ</span>
    </button>

    <div class="w-[180px] bg-gray-900 border border-yellow-600/30 p-3 shadow-2xl rounded-br-lg">
        <h4 class="text-[10px] font-bold text-yellow-500 uppercase tracking-widest mb-3 border-b border-gray-700 pb-1 text-center">Top Picks</h4>

        
        <div class="space-y-2">
            
            <a href="https://amzn.to/4jfgKRh" target="_blank" class="block p-2 rounded bg-gray-800 hover:bg-gray-700 border border-gray-700 transition text-center group">
                <p class="text-[10px] text-gray-200 group-hover:text-white font-semibold">Player's Handbook</p>
            </a>

            <a href="https://amzn.to/48Vy0aI" target="_blank" class="block p-2 rounded bg-gray-800 hover:bg-gray-700 border border-gray-700 transition text-center group">
                <p class="text-[10px] text-gray-200 group-hover:text-white font-semibold">Player Character Sheets</p>
            </a>
            
            <a href="https://amzn.to/4qn2lVl" target="_blank" class="block p-2 rounded bg-gray-800 hover:bg-gray-700 border border-gray-700 transition text-center group">
                <p class="text-[10px] text-gray-200 group-hover:text-white font-semibold">Dungeon Master's Guide</p>
            </a>

            <a href="https://amzn.to/4arU261" target="_blank" class="block p-2 rounded bg-gray-800 hover:bg-gray-700 border border-gray-700 transition text-center group">
                <p class="text-[10px] text-gray-200 group-hover:text-white font-semibold">Monster Manual</p>
            </a>

            <a href="https://amzn.to/4q0cJCQ" target="_blank" class="block p-2 rounded bg-gray-800 hover:bg-gray-700 border border-gray-700 transition text-center group">
                <p class="text-[10px] text-gray-200 group-hover:text-white font-semibold">Dice Set</p>
            </a>

            <a href="https://amzn.to/49s6Gkj" target="_blank" class="block p-2 rounded bg-gray-800 hover:bg-gray-700 border border-gray-700 transition text-center group">
                <p class="text-[10px] text-gray-200 group-hover:text-white font-semibold">Metal Cheese Dice Set</p>
            </a>

            <a href="https://amzn.to/497kbVn" target="_blank" class="block p-2 rounded bg-gray-800 hover:bg-gray-700 border border-gray-700 transition text-center group">
                <p class="text-[10px] text-gray-200 group-hover:text-white font-semibold">Mimic Dice Storage Chest</p>
            </a>

            <a href="https://amzn.to/3Li2NFt" target="_blank" class="block p-2 rounded bg-gray-800 hover:bg-gray-700 border border-gray-700 transition text-center group">
                <p class="text-[10px] text-gray-200 group-hover:text-white font-semibold">150+ Dice Storage Bag</p>
            </a>

            <a href="https://amzn.to/4asxrpS" target="_blank" class="block p-2 rounded bg-gray-800 hover:bg-gray-700 border border-gray-700 transition text-center group">
                <p class="text-[10px] text-gray-200 group-hover:text-white font-semibold">Dice Tower</p>
            </a>

            <a href="https://amzn.to/4bhvyg0" target="_blank" class="block p-2 rounded bg-gray-800 hover:bg-gray-700 border border-gray-700 transition text-center group">
                <p class="text-[10px] text-gray-200 group-hover:text-white font-semibold">Condition Rings</p>
            </a>

            <a href="https://amzn.to/49oqCoe" target="_blank" class="block p-2 rounded bg-gray-800 hover:bg-gray-700 border border-gray-700 transition text-center group">
                <p class="text-[10px] text-gray-200 group-hover:text-white font-semibold">Foldable Battle Mat with DM Screen, Game Tokens, Dice Set - 2-Sided Wet & Dry Erase Terrain, Ultimate DND Starter Set, Accessories, Gift for Dungeon Master & Player</p>
            </a>
            
        </div>

        <p class="text-[8px] text-gray-500 mt-4 italic text-center leading-tight">
            As an Amazon Associate I earn from qualifying purchases.
        </p>
    </div>
</div>

        <div id="ad-spotlight" 
     class="hidden md:block fixed bottom-6 right-6 z-[9999] pointer-events-none transition-all duration-700 ease-[cubic-bezier(0.175,0.885,0.32,1.275)]"
     style="opacity: 0; transform: translateY(150px);">
    
    <a id="ad-link" href="#" target="_blank" 
   onclick="window.sendEvent('click_affiliate', { item_name: document.getElementById('ad-name').innerText })" 
       class="block w-72 bg-gray-900 border-2 border-yellow-600 rounded-xl p-4 shadow-2xl pointer-events-auto hover:scale-105 transition-transform duration-200">
        
        <div class="flex gap-4 items-center">
            <div class="w-20 h-20 bg-white rounded-lg flex-shrink-0 overflow-hidden p-1 flex items-center justify-center">
                <img id="ad-img" src="" class="max-w-full max-h-full object-contain">
            </div>
            
            <div class="flex-1 min-w-0">
                <p class="m-0 text-[10px] text-yellow-500 font-black uppercase tracking-widest">DM Selection</p>
                <h5 id="ad-name" class="my-1 text-sm font-bold text-white leading-tight font-sans truncate"></h5>
                <div class="inline-block bg-yellow-600 text-black text-[10px] font-bold px-2 py-1 rounded">
                    VIEW ON AMAZON ‚ûú
                </div>
            </div>
        </div>

        <p class="mt-3 text-[8px] text-gray-400 italic text-center border-t border-gray-700 pt-2">
            Affiliate Link: Supports the Toolkit!
        </p>
    </a>
</div>

<div id="settings-modal" class="fixed inset-0 bg-black/80 hidden items-center justify-center z-[100]">
    <div class="bg-gray-800 p-6 rounded-xl border border-gray-600 shadow-2xl max-w-md w-full relative">
        
        <div class="flex justify-between items-center mb-6 border-b border-gray-700 pb-4">
            <h2 class="text-xl font-bold text-white">‚öôÔ∏è User Settings</h2>
            <button onclick="document.getElementById('settings-modal').classList.add('hidden')" 
                class="text-gray-400 hover:text-white">‚úï</button>
        </div>

        <div class="mb-6 border-t border-gray-700 pt-4">
    <label class="block text-sm font-bold text-cyan-400 mb-2">Login Username</label>
    <div class="flex gap-2">
        <input id="settings-username-input" type="text" placeholder="New Username" 
            class="flex-1 bg-gray-900 border border-gray-700 text-white p-2 rounded focus:outline-none focus:border-cyan-500">
        
        <button onclick="window.changeLoginUsername()" 
            class="bg-red-900/50 hover:bg-red-700 text-red-200 px-4 py-2 rounded border border-red-800 transition-colors">
            Update ID
        </button>
    </div>
    <p id="settings-username-status" class="text-xs mt-2 text-gray-500">
        ‚ö†Ô∏è Changing this will change how you log in.
    </p>
</div>

        <div class="mb-6">
    <label class="block text-sm font-bold text-cyan-400 mb-2">
        Recovery Email (Optional)
    </label>
    <div class="flex gap-2">
        <input id="settings-email-input" type="text" placeholder="name@example.com" 
            class="flex-1 bg-gray-900 border border-gray-700 text-white p-2 rounded focus:outline-none focus:border-cyan-500">
        
        <button onclick="window.linkRealEmail()" 
            class="bg-indigo-600 hover:bg-indigo-500 text-white font-bold px-4 py-2 rounded border border-indigo-500 transition-colors">
            Save
        </button>
    </div>
    
    <p id="settings-email-status" class="text-xs mt-2 text-gray-500">
        Add an email to recover your account if you forget your password.
    </p>
</div>

        <div class="mb-6 pt-4 border-t border-gray-700">
            <label class="text-xs font-bold text-gray-400 uppercase block mb-2">Password Management</label>
            <div class="flex justify-between items-center bg-gray-900 p-3 rounded border border-gray-700">
                <span class="text-gray-300 text-sm">Need to change it?</span>
                <button onclick="window.triggerPasswordReset()" 
                    class="text-cyan-400 hover:text-cyan-300 text-sm font-bold border border-cyan-500/30 bg-cyan-900/20 px-3 py-1.5 rounded hover:bg-cyan-900/40 transition-colors">
                    Send Reset Link üìß
                </button>
            </div>
        </div>

        <div class="mb-6 pt-4 border-t border-gray-700">
    <div class="flex justify-between items-center bg-gray-900 p-3 rounded-lg border border-gray-700/50 shadow-inner">
        <span class="text-xs font-bold text-gray-500 uppercase tracking-widest">Billing</span>
        
        <button onclick="window.handleBilling()" class="text-xs font-bold text-indigo-400 hover:text-white hover:underline transition-colors flex items-center gap-2">
            Manage Subscription <span class="text-gray-600">‚Üí</span>
        </button>
    </div>
</div>

        <div class="mt-6 border-t border-gray-800 pt-4">
    <div class="flex items-center justify-between bg-black/30 p-4 rounded-xl border border-gray-700/50 shadow-inner">
        <div class="flex items-center gap-3">
            <span class="text-2xl drop-shadow-[0_0_8px_rgba(99,102,241,0.5)]">üìú</span>
            <div>
                <p class="text-white text-xs font-bold uppercase tracking-widest">Raven Scrolls</p>
                <p id="newsletter-status-text" class="text-gray-400 text-[9px] uppercase tracking-tighter">Status: Loading...</p>
            </div>
        </div>
        <label class="relative inline-flex items-center cursor-pointer">
            <input type="checkbox" id="settings-newsletter-toggle" onchange="window.toggleNewsletter(this.checked)" class="sr-only peer">
            <div class="w-10 h-5 bg-gray-700 rounded-full peer peer-checked:bg-indigo-600 transition-all duration-300
                        after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white 
                        after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:after:translate-x-5 
                        shadow-[inset_0_2px_4px_rgba(0,0,0,0.3)]">
            </div>
        </label>
    </div>
</div>

        <div class="pt-4 border-t border-gray-700">
    <button onclick="window.safeLogout()" 
        class="w-full text-red-400 hover:text-red-300 text-sm font-bold py-2">
        Log Out
    </button>
</div>

    </div>
</div>

<a href="https://www.patreon.com/cw/DeadSeagul" target="_blank" 
   class="fixed bottom-24 right-6 z-[9999] flex items-center justify-center w-14 h-14 bg-[#FF424D] rounded-full shadow-lg hover:scale-110 hover:shadow-2xl hover:bg-[#ff5e67] transition-all duration-300 group">
    
    <svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 fill-white">
        <path d="M0 .48v23.04h4.22V.48zm15.385 0c-4.764 0-8.641 3.88-8.641 8.65 0 4.755 3.877 8.63 8.641 8.63 4.756 0 8.615-3.875 8.615-8.63 0-4.77-3.859-8.65-8.615-8.65z"/>
    </svg>

    <span class="absolute right-16 scale-0 group-hover:scale-100 transition-all bg-gray-900 text-white text-[10px] font-bold uppercase tracking-wider py-1.5 px-3 rounded border border-gray-700 whitespace-nowrap shadow-xl">
        Battlemaps on Patreon!
    </span>
</a>

<div id="token-modal" class="hidden fixed inset-0 z-[100] flex items-center justify-center bg-black/80 backdrop-blur-sm">
    <div class="bg-gray-900 border border-gray-700 p-6 rounded-xl shadow-2xl w-full max-w-sm relative">
        <h3 class="text-indigo-400 font-bold text-lg mb-4 uppercase tracking-widest flex items-center gap-2">
            <span>‚ôüÔ∏è</span> Forge Token
        </h3>
        
        <div class="mb-3">
            <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">Token Name</label>
            <input type="text" id="new-token-name" placeholder="e.g. Goblin King" class="w-full bg-[#0b0c10] border border-gray-700 text-white p-2.5 rounded outline-none focus:border-indigo-500 transition text-sm font-bold">
        </div>

        <div class="mb-3">
            <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">Size Category</label>
            <select id="new-token-size" class="w-full bg-[#0b0c10] border border-gray-700 text-white p-2.5 rounded outline-none focus:border-indigo-500 transition text-xs font-bold cursor-pointer">
                <option value="0.5">Tiny (0.5x)</option>
                <option value="1" selected>Medium / Small (1x)</option>
                <option value="2">Large (2x)</option>
                <option value="3">Huge (3x)</option>
                <option value="4">Gargantuan (4x)</option>
            </select>
        </div>

        <div class="mb-6">
            <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">Token Image</label>
            <input type="file" id="new-token-file" accept="image/*" class="w-full text-xs text-gray-400 file:bg-gray-800 file:text-indigo-300 file:font-bold file:border-0 file:py-2 file:px-4 file:rounded file:mr-4 hover:file:bg-gray-700 cursor-pointer border border-gray-800 rounded p-1">
        </div>

        <div class="flex items-center gap-2 mb-4 bg-gray-800 p-2 rounded border border-gray-600">
    <input type="checkbox" id="new-token-vision" class="w-5 h-5 accent-indigo-500 cursor-pointer">
    <label for="new-token-vision" class="text-xs text-gray-300 cursor-pointer select-none font-bold">
        üëÅÔ∏è Enable Vision (Clears Fog)
    </label>
</div>

        <div class="flex gap-3">
            <button onclick="window.closeTokenModal()" class="flex-1 bg-gray-800 hover:bg-gray-700 text-gray-300 py-2.5 rounded-lg font-bold text-xs uppercase tracking-wider transition">Cancel</button>
            <button onclick="window.confirmCreateToken()" id="btn-create-token" class="flex-1 bg-indigo-600 hover:bg-indigo-500 text-white py-2.5 rounded-lg font-bold text-xs uppercase tracking-wider shadow-lg transition transform active:scale-95">Create Token</button>
        </div>
    </div>
</div>

<div id="pro-modal" class="fixed inset-0 z-[100] hidden flex items-center justify-center bg-black/90 backdrop-blur-sm p-4 animate-fade-in">
    <div class="relative w-full max-w-3xl rounded-2xl border border-yellow-500/30 bg-[#0b0c10] shadow-[0_0_50px_rgba(234,179,8,0.2)] overflow-hidden">
        
        <div class="bg-gradient-to-r from-yellow-900/40 to-black p-8 text-center border-b border-yellow-500/20">
            <h2 class="text-4xl font-black text-transparent bg-clip-text bg-gradient-to-r from-yellow-400 to-amber-200 uppercase tracking-tighter">
                Aegis <span class="text-white">Pro</span>
            </h2>
            <p class="text-yellow-500/80 font-bold tracking-widest text-xs mt-2">UNLOCK THE FULL ARSENAL</p>
            <button onclick="document.getElementById('pro-modal').classList.add('hidden')" class="absolute top-4 right-4 text-gray-500 hover:text-white text-2xl">&times;</button>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2">
            <div class="p-8 border-b md:border-b-0 md:border-r border-gray-800">
                <h3 class="text-xl font-bold text-gray-400 mb-4">Cadet (Free)</h3>
                <ul class="space-y-3 text-sm text-gray-500">
                    <li class="flex gap-2"><span>‚úÖ</span> Unlimited Combat Tracking</li>
                    <li class="flex gap-2"><span>‚úÖ</span> Basic VTT (Tokens & Maps)</li>
                    <li class="flex gap-2"><span>‚úÖ</span> Standard Dice Roller</li>
                    <li class="flex gap-2"><span>‚úÖ</span> And All Other Basic Features!</li>
                    
                </ul>
                <button id="free-tier-btn" onclick="document.getElementById('pro-modal').classList.add('hidden')" class="mt-8 w-full py-3 rounded border border-gray-700 text-gray-400 hover:bg-gray-800 font-bold text-xs uppercase">
    Current Plan
</button>
            </div>

            <div class="p-8 bg-yellow-900/5 relative">
                <div class="absolute top-0 right-0 bg-yellow-500 text-black text-[9px] font-black px-2 py-1 uppercase">Recommended</div>
                
                <h3 class="text-xl font-bold text-yellow-400 mb-4">Warlord (Pro)</h3>
                
                <ul class="space-y-3 text-sm text-gray-300">
                    <li class="flex gap-2"><span class="text-yellow-400">üëë</span> <strong>Support the Adventure!</li>
                    <li class="flex gap-2"><span class="text-yellow-400">üëë</span> <strong>Website Customization (Change Website Color and Notes UI)</li>
                    <li class="flex gap-2"><span class="text-yellow-400">üëë</span> <strong>Get rid of Pop-Up Ads</li>
                </ul>
                
                <button id="pro-tier-btn" onclick="window.redirectToStripe()" class="mt-8 w-full py-4 rounded bg-gradient-to-r from-yellow-600 to-amber-500 hover:from-yellow-500 hover:to-amber-400 text-black font-black text-sm uppercase shadow-lg shadow-yellow-900/50 transition-all transform hover:scale-105 flex items-center justify-center gap-2">
    <span>üí≥</span> Upgrade Instantly ($5)
</button>
                
                <p class="text-center text-[10px] text-gray-500 mt-3">
                    Secure payment via Stripe. Activates instantly.
                </p>
            </div>
        </div>
    </div>
</div>

<div id="pro-success-modal" class="fixed inset-0 bg-black/90 hidden z-50 flex items-center justify-center backdrop-blur-sm">
    <div class="bg-gradient-to-b from-yellow-900 to-black border-2 border-yellow-500 p-8 rounded-xl max-w-md text-center shadow-[0_0_50px_rgba(234,179,8,0.3)] transform transition-all scale-100">
        <div class="text-6xl mb-4 animate-bounce">üëë</div>
        <h2 class="text-3xl font-black text-transparent bg-clip-text bg-gradient-to-r from-yellow-400 to-white mb-2">
            WARLORD UNLOCKED
        </h2>
        <p class="text-gray-300 mb-6">
            Your payment was successful. You now have unlimited access to all Pro features.
        </p>
        <button onclick="document.getElementById('pro-success-modal').classList.add('hidden')" class="px-8 py-3 bg-yellow-500 hover:bg-yellow-400 text-black font-bold rounded uppercase tracking-wider">
            Let's Roll
        </button>
    </div>
</div>

<div id="pro-theme-bar" class="fixed bottom-4 right-20 z-[9999] flex flex-row-reverse items-center gap-3 group">
    
    <button class="w-10 h-10 rounded-full bg-gray-800/80 backdrop-blur border border-gray-600 shadow-xl flex items-center justify-center text-gray-300 hover:bg-indigo-600 hover:text-white hover:border-indigo-400 hover:scale-110 transition-all duration-300 z-10">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01" />
        </svg>
    </button>

    <div class="flex gap-2 bg-gray-900/90 backdrop-blur-md p-2 rounded-full border border-white/10 shadow-2xl transition-all duration-300 opacity-0 translate-x-4 pointer-events-none group-hover:opacity-100 group-hover:translate-x-0 group-hover:pointer-events-auto">
        
        <button onclick="window.applyTheme('#030712', '#111827', '#4f46e5')" 
                title="Original Dark"
                class="w-8 h-8 rounded-full border-2 border-transparent hover:scale-110 transition shadow-inner"
                style="background: #030712; border-color: #4f46e5;"></button>

        <button onclick="window.applyTheme('#0f172a', '#1e293b', '#6366f1')" 
                title="Midnight Blue"
                class="w-8 h-8 rounded-full border-2 border-transparent hover:scale-110 transition shadow-inner"
                style="background: #0f172a; border-color: #6366f1;"></button>
        
        <button onclick="window.applyTheme('#1a0f0f', '#2d1a1a', '#f87171')" 
                title="Crimson"
                class="w-8 h-8 rounded-full border-2 border-transparent hover:scale-110 transition shadow-inner"
                style="background: #1a0f0f; border-color: #f87171;"></button>
        
        <button onclick="window.applyTheme('#0b1410', '#13241b', '#34d399')" 
                title="Emerald"
                class="w-8 h-8 rounded-full border-2 border-transparent hover:scale-110 transition shadow-inner"
                style="background: #0b1410; border-color: #34d399;"></button>

        <button onclick="window.applyTheme('#000000', '#111111', '#ffffff')" 
                title="The Void"
                class="w-8 h-8 rounded-full border-2 border-transparent hover:scale-110 transition shadow-inner"
                style="background: #000000; border-color: #ffffff;"></button>

        <button onclick="document.body.classList.toggle('pro-theme')" 
                title="Toggle Pro Mode"
                class="px-2 h-8 rounded-full bg-yellow-500 flex items-center justify-center text-black text-[9px] font-black hover:scale-105 transition uppercase">
            PRO
        </button>
    </div>
</div>

<div id="scene-modal" class="fixed inset-0 z-[10000] hidden bg-black/80 backdrop-blur-sm flex items-center justify-center p-4">
    <div class="bg-gray-900 border border-white/10 w-full max-w-4xl max-h-[80vh] rounded-2xl shadow-2xl flex flex-col overflow-hidden">
        
        <div class="p-6 border-b border-white/5 flex justify-between items-center bg-gray-800/50">
            <div>
                <h2 class="text-xl font-black text-white uppercase tracking-tighter">Tactical Archive</h2>
                <p class="text-xs text-gray-400">Select a saved scene to deploy to the VTT</p>
            </div>
            <button onclick="document.getElementById('scene-modal').classList.add('hidden')" class="text-gray-500 hover:text-white transition text-2xl">&times;</button>
        </div>

        <div id="scene-gallery-grid" class="flex-1 overflow-y-auto p-6 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
            <div class="col-span-full text-center py-20 text-gray-600 animate-pulse">Scanning Archive...</div>
        </div>

        <div class="p-4 bg-black/20 border-t border-white/5 text-center">
            <button onclick="document.getElementById('scene-modal').classList.add('hidden')" class="px-6 py-2 bg-gray-800 text-gray-300 rounded-full text-xs font-bold hover:bg-gray-700 transition">Close Archive</button>
        </div>
    </div>
</div>

<div id="note-preview-modal" class="fixed inset-0 bg-black/80 hidden z-[100] flex items-center justify-center backdrop-blur-sm animate-fade-in p-4">
    <div class="bg-gray-900 border border-gray-700 rounded-xl w-full max-w-2xl max-h-[85vh] flex flex-col shadow-2xl relative">
        
        <div class="flex justify-between items-center p-4 border-b border-gray-800 bg-gray-900/50 rounded-t-xl">
            <h3 id="preview-title" class="text-xl font-bold text-indigo-400 truncate pr-4">Note Title</h3>
            <button onclick="document.getElementById('note-preview-modal').classList.add('hidden')" class="text-gray-500 hover:text-white transition">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>

        <div id="preview-content-area" class="flex-1 overflow-y-auto p-6 text-gray-300 font-sans leading-relaxed text-base custom-scrollbar prose prose-invert max-w-none">
            </div>

        <div class="p-4 border-t border-gray-800 bg-black/20 rounded-b-xl flex justify-between items-center">
            <span id="preview-date" class="text-xs text-gray-600 font-mono">Last updated...</span>
            <div class="flex gap-3">
                <button onclick="document.getElementById('note-preview-modal').classList.add('hidden')" class="px-4 py-2 text-sm text-gray-400 hover:text-white font-bold transition">Close</button>
                <button id="preview-edit-btn" class="px-6 py-2 bg-indigo-600 hover:bg-indigo-500 text-white text-sm font-bold rounded shadow-lg transition flex items-center gap-2">
                    <span>‚úèÔ∏è</span> Edit Note
                </button>
            </div>
        </div>
    </div>
</div>

<div id="json-import-modal" class="hidden fixed inset-0 z-[100] flex items-center justify-center bg-black/80 backdrop-blur-sm">
    <div class="bg-gray-900 border border-gray-700 w-full max-w-2xl rounded-xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
        
        <div class="bg-gray-800 p-4 border-b border-gray-700 flex justify-between items-center">
            <h3 class="text-indigo-400 font-bold uppercase tracking-wider text-sm">Import 5e.tools Data</h3>
            <button onclick="document.getElementById('json-import-modal').classList.add('hidden')" class="text-gray-500 hover:text-white">‚úï</button>
        </div>

        <div class="p-6 space-y-4 flex-1 overflow-y-auto">
            <div class="flex items-center gap-3">
                <label class="text-xs text-gray-400 font-bold uppercase">Target Tab:</label>
                <select id="json-import-category" class="bg-black/50 border border-gray-700 text-gray-200 text-xs rounded px-3 py-2 focus:border-indigo-500 outline-none w-48">
                    <option value="enemyNotes" selected>Enemies</option>
                    <option value="npcNotes">NPCs</option>
                    <option value="lootNotes">Loot</option>
                    <option value="pcNotes">PCs</option>
                    <option value="prepNotes">General / Prep</option>
                </select>
            </div>
            <p class="text-[10px] text-gray-500">Paste the JSON code for a Monster, Spell, or Item below.</p>
            <textarea id="json-import-input" class="w-full h-64 bg-black/50 border border-gray-700 rounded-lg p-3 text-xs font-mono text-green-400 focus:outline-none resize-none" placeholder='{ "name": "Goblin", ... }'></textarea>
        </div>

        <div class="bg-gray-800 p-4 border-t border-gray-700 flex justify-end gap-3">
            <button onclick="document.getElementById('json-import-modal').classList.add('hidden')" class="px-4 py-2 text-xs text-gray-400 hover:text-white">Cancel</button>
            <button onclick="window.submitJsonImport()" class="px-6 py-2 bg-indigo-600 hover:bg-indigo-500 text-white text-xs font-bold uppercase tracking-wide rounded-lg transition">Import Note</button>
        </div>
    </div>
</div>

<div id="token-context-menu" class="hidden absolute z-[100] bg-gray-900 border border-gray-600 rounded-lg shadow-2xl overflow-hidden min-w-[120px] flex flex-col py-1">
    <div class="px-3 py-1 text-[10px] font-bold text-gray-500 uppercase tracking-wider">Set Size</div>

<button onclick="window.setTokenSize(0.5)" class="text-left px-4 py-2 text-xs text-gray-300 hover:bg-indigo-600 hover:text-white transition">Tiny (0.5x)</button>
<button onclick="window.setTokenSize(1)" class="text-left px-4 py-2 text-xs text-gray-300 hover:bg-indigo-600 hover:text-white transition">Medium (1x)</button>
<button onclick="window.setTokenSize(2)" class="text-left px-4 py-2 text-xs text-gray-300 hover:bg-indigo-600 hover:text-white transition">Large (2x)</button>
<button onclick="window.setTokenSize(3)" class="text-left px-4 py-2 text-xs text-gray-300 hover:bg-indigo-600 hover:text-white transition">Huge (3x)</button>

<button onclick="window.promptTokenCustomSize()" class="text-left px-4 py-2 text-xs text-indigo-300 hover:bg-indigo-600 hover:text-white transition font-bold border-t border-gray-700 mt-1">
    ‚öôÔ∏è Custom (px)...
</button>

<button onclick="window.toggleTokenVision()" class="text-left px-4 py-2 text-xs text-indigo-300 hover:bg-indigo-600 hover:text-white transition w-full">
    üëÅÔ∏è Toggle Vision
</button>

<div class="h-px bg-gray-700 my-1"></div>
    
    <button onclick="window.deleteSelectedToken()" class="text-left px-4 py-2 text-xs text-red-400 hover:bg-red-900/50 transition flex items-center gap-2">
        <span>üóëÔ∏è</span> Delete
    </button>
</div>

</body>
</html>
<footer class="mt-12 pb-6 text-center select-none z-10 relative">
            <p class="text-[10px] text-gray-400 uppercase tracking-widest font-semibold opacity-50 hover:opacity-100 transition duration-300 cursor-default">
                ¬© 2025 DeadSeagul ‚Ä¢ Aegis DM Toolkit
            </p>
        </footer>

    </div>
